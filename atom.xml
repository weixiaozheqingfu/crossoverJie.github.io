<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>crossoverJie&#39;s Blog</title>
  <subtitle>baller</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://crossoverjie.top/"/>
  <updated>2018-06-07T12:45:12.511Z</updated>
  <id>http://crossoverjie.top/</id>
  
  <author>
    <name>crossoverJie</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>åˆ†å¸ƒå¼å·¥å…·çš„ä¸€æ¬¡å°å‡çº§â«</title>
    <link href="http://crossoverjie.top/2018/06/07/distributed-lock/distributed-lock-redis-update/"/>
    <id>http://crossoverjie.top/2018/06/07/distributed-lock/distributed-lock-redis-update/</id>
    <published>2018-06-07T14:20:46.000Z</published>
    <updated>2018-06-07T12:45:12.511Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fs2s4f0jf4j31g80ytn6i.jpg" alt=""></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰åœ¨åš <a href="https://crossoverjie.top/2018/05/07/ssm/SSM18-seconds-kill/#distributed-redis-tool-%E2%AC%86%EF%B8%8Fv1-0-3">ç§’æ€æ¶æ„å®è·µ</a> æ—¶æœ‰æåˆ°å¯¹ <a href="https://github.com/crossoverJie/distributed-redis-tool" target="_blank" rel="external">distributed-redis-tool</a> çš„ä¸€æ¬¡å°å‡çº§ï¼Œä½†æ˜¯æ²¡æœ‰ç»†è¯´ã€‚</p>
<p>å…¶å®ä¸»è¦åŸå› æ˜¯ï¼š</p>
<blockquote>
<p>ç§’æ€æ—¶æˆ‘åšå‹æµ‹ï¼šç”±äºé›†æˆäº†è¿™ä¸ªé™æµç»„ä»¶ï¼Œå¹¶å‘åˆæ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥å¯¼è‡´è¿æ¥ã€æ–­å¼€ Redis éå¸¸é¢‘ç¹ã€‚<br>æœ€ç»ˆå¯¼è‡´è·å–ä¸äº† Redis connection çš„å¼‚å¸¸ã€‚</p>
</blockquote>
<h2 id="æ± åŒ–æŠ€æœ¯"><a href="#æ± åŒ–æŠ€æœ¯" class="headerlink" title="æ± åŒ–æŠ€æœ¯"></a>æ± åŒ–æŠ€æœ¯</h2><p>è¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å¯¹ç¨€ç¼ºèµ„æºä½¿ç”¨ä¸å–„å¯¼è‡´çš„ã€‚</p>
<p>ä½•ä¸ºç¨€ç¼ºèµ„æºï¼Ÿå¸¸è§çš„æœ‰ï¼š</p>
<ul>
<li>çº¿ç¨‹</li>
<li>æ•°æ®åº“è¿æ¥</li>
<li>ç½‘ç»œè¿æ¥ç­‰</li>
</ul>
<p>è¿™äº›èµ„æºéƒ½æœ‰å…±åŒçš„ç‰¹ç‚¹ï¼š<strong>åˆ›å»ºé”€æ¯æˆæœ¬è¾ƒé«˜</strong>ã€‚</p>
<a id="more"></a>
<p>è¿™é‡Œæ¶‰åŠåˆ°çš„ Redis è¿æ¥ä¹Ÿå±äºè¯¥ç±»èµ„æºã€‚</p>
<p>æˆ‘ä»¬å¸Œæœ›å°†è¿™äº›ç¨€æœ‰èµ„æºç®¡ç†èµ·æ¥æ”¾åˆ°ä¸€ä¸ªæ± å­é‡Œï¼Œå½“éœ€è¦æ—¶å°±ä»ä¸­è·å–ï¼Œç”¨å®Œå°±æ”¾å›å»ï¼Œä¸å¤Ÿç”¨æ—¶å°±ç­‰å¾…ï¼ˆæˆ–è¿”å›ï¼‰ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬åªéœ€è¦åˆå§‹åŒ–å¹¶ç»´æŠ¤å¥½è¿™ä¸ªæ± å­ï¼Œå°±èƒ½é¿å…é¢‘ç¹çš„åˆ›å»ºã€é”€æ¯è¿™äº›èµ„æºï¼ˆä¹Ÿæœ‰èµ„æºé•¿æœŸæœªä½¿ç”¨éœ€è¦ç¼©å®¹çš„æƒ…å†µï¼‰ã€‚</p>
<p>é€šå¸¸æˆ‘ä»¬ç§°è¿™é¡¹å§¿åŠ¿ä¸ºæ± åŒ–æŠ€æœ¯ï¼Œå¦‚å¸¸è§çš„ï¼š</p>
<ul>
<li>çº¿ç¨‹æ± </li>
<li>å„ç§èµ„æºçš„è¿æ¥æ± ç­‰ã€‚</li>
</ul>
<p>ä¸ºæ­¤æˆ‘å°†ä½¿ç”¨åˆ° Redis çš„ <a href="https://crossoverjie.top/%2F2018%2F03%2F29%2Fdistributed-lock%2Fdistributed-lock-redis%2F">åˆ†å¸ƒå¼é”</a>ã€<a href="https://crossoverjie.top/2018/04/28/sbc/sbc7-Distributed-Limit/">åˆ†å¸ƒå¼é™æµ</a> éƒ½å‡çº§ä¸ºåˆ©ç”¨è¿æ¥æ± æ¥è·å– Redis çš„è¿æ¥ã€‚</p>
<p>è¿™é‡Œä»¥<a href="https://github.com/crossoverJie/distributed-redis-tool#distributed-lock" target="_blank" rel="external">åˆ†å¸ƒå¼é”</a>ä¸ºä¾‹ï¼š</p>
<p>å°†ä½¿ç”¨çš„ api ä¿®æ”¹ä¸ºï¼š</p>
<p>åŸæœ‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLockConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RedisLock <span class="title">build</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">//Need to get Redis connection </span></div><div class="line">        RedisLock redisLock = <span class="keyword">new</span> RedisLock() ;</div><div class="line">        HostAndPort hostAndPort = <span class="keyword">new</span> HostAndPort(<span class="string">"127.0.0.1"</span>,<span class="number">7000</span>) ;</div><div class="line">        JedisCluster jedisCluster = <span class="keyword">new</span> JedisCluster(hostAndPort) ;</div><div class="line">        RedisLock redisLock = <span class="keyword">new</span> RedisLock.Builder(jedisCluster)</div><div class="line">                .lockPrefix(<span class="string">"lock_test"</span>)</div><div class="line">                .sleepTime(<span class="number">100</span>)</div><div class="line">                .build();</div><div class="line">                </div><div class="line">        <span class="keyword">return</span> redisLock ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLockConfig</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(RedisLockConfig.class);</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> JedisConnectionFactory jedisConnectionFactory;</div><div class="line">    </div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RedisLock <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">        RedisLock redisLock = <span class="keyword">new</span> RedisLock.Builder(jedisConnectionFactory,RedisToolsConstant.SINGLE)</div><div class="line">                .lockPrefix(<span class="string">"lock_"</span>)</div><div class="line">                .sleepTime(<span class="number">100</span>)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> redisLock;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å°†ä»¥å‰çš„ Jedis ä¿®æ”¹ä¸º <code>JedisConnectionFactory</code>ï¼Œåç»­çš„ Redis è¿æ¥å°±å¯é€šè¿‡è¿™ä¸ªå¯¹è±¡è·å–ã€‚</p>
<p>å¹¶ä¸”æ˜¾ç¤ºçš„ä¼ å…¥ä½¿ç”¨ RedisCluster è¿˜æ˜¯å•æœºçš„ Redisã€‚</p>
<p>æ‰€ä»¥åœ¨çœŸæ­£æ“ä½œ Redis æ—¶éœ€è¦ä¿®æ”¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(String key, String request)</span> </span>&#123;</div><div class="line">    <span class="comment">//get connection</span></div><div class="line">    Object connection = getConnection();</div><div class="line">    String result ;</div><div class="line">    <span class="keyword">if</span> (connection <span class="keyword">instanceof</span> Jedis)&#123;</div><div class="line">        result =  ((Jedis) connection).set(lockPrefix + key, request, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, <span class="number">10</span> * TIME);</div><div class="line">        ((Jedis) connection).close();</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        result = ((JedisCluster) connection).set(lockPrefix + key, request, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, <span class="number">10</span> * TIME);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ((JedisCluster) connection).close();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            logger.error(<span class="string">"IOException"</span>,e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (LOCK_MSG.equals(result)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//è·å–è¿æ¥</span></div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</div><div class="line">    Object connection ;</div><div class="line">    <span class="keyword">if</span> (type == RedisToolsConstant.SINGLE)&#123;</div><div class="line">        RedisConnection redisConnection = jedisConnectionFactory.getConnection();</div><div class="line">        connection = redisConnection.getNativeConnection();</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        RedisClusterConnection clusterConnection = jedisConnectionFactory.getClusterConnection();</div><div class="line">        connection = clusterConnection.getNativeConnection() ;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> connection;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€å¤§çš„æ”¹å˜å°±æ˜¯å°†åŸæœ‰æ“ä½œ Redis çš„å¯¹è±¡ï¼ˆ<code>T extends JedisCommands</code>ï¼‰æ”¹ä¸ºä»è¿æ¥æ± ä¸­è·å–ã€‚</p>
<p>ç”±äºä½¿ç”¨äº† <code>org.springframework.data.redis.connection.jedis.JedisConnectionFactory</code> ä½œä¸º Redis è¿æ¥æ± ã€‚</p>
<p>æ‰€ä»¥éœ€è¦å†ä½¿ç”¨æ—¶æ„ä»¶å¥½è¿™ä¸ªå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</div><div class="line">config.setMaxIdle(<span class="number">10</span>);</div><div class="line">config.setMaxTotal(<span class="number">300</span>);</div><div class="line">config.setMaxWaitMillis(<span class="number">10000</span>);</div><div class="line">config.setTestOnBorrow(<span class="keyword">true</span>);</div><div class="line">config.setTestOnReturn(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">RedisClusterConfiguration redisClusterConfiguration = <span class="keyword">new</span> RedisClusterConfiguration();</div><div class="line">redisClusterConfiguration.addClusterNode(<span class="keyword">new</span> RedisNode(<span class="string">"10.19.13.51"</span>, <span class="number">7000</span>));</div><div class="line"></div><div class="line"><span class="comment">//å•æœº</span></div><div class="line">JedisConnectionFactory jedisConnectionFactory = <span class="keyword">new</span> JedisConnectionFactory(config);</div><div class="line"></div><div class="line"><span class="comment">//é›†ç¾¤</span></div><div class="line"><span class="comment">//JedisConnectionFactory jedisConnectionFactory = new JedisConnectionFactory(redisClusterConfiguration) ;</span></div><div class="line">jedisConnectionFactory.setHostName(<span class="string">"47.98.194.60"</span>);</div><div class="line">jedisConnectionFactory.setPort(<span class="number">6379</span>);</div><div class="line">jedisConnectionFactory.setPassword(<span class="string">""</span>);</div><div class="line">jedisConnectionFactory.setTimeout(<span class="number">100000</span>);</div><div class="line">jedisConnectionFactory.afterPropertiesSet();</div><div class="line"><span class="comment">//jedisConnectionFactory.setShardInfo(new JedisShardInfo("47.98.194.60", 6379));</span></div><div class="line"><span class="comment">//JedisCluster jedisCluster = new JedisCluster(hostAndPort);</span></div><div class="line"></div><div class="line">HostAndPort hostAndPort = <span class="keyword">new</span> HostAndPort(<span class="string">"10.19.13.51"</span>, <span class="number">7000</span>);</div><div class="line">JedisCluster jedisCluster = <span class="keyword">new</span> JedisCluster(hostAndPort);</div><div class="line">redisLock = <span class="keyword">new</span> RedisLock.Builder(jedisConnectionFactory, RedisToolsConstant.SINGLE)</div><div class="line">        .lockPrefix(<span class="string">"lock_"</span>)</div><div class="line">        .sleepTime(<span class="number">100</span>)</div><div class="line">        .build();</div></pre></td></tr></table></figure>
<p>çœ‹èµ·æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦æ„å»ºå¯¹è±¡çš„è¾ƒå¤šã€‚</p>
<p>ä½†æ•´åˆ Spring ä½¿ç”¨æ—¶å°±è¦æ¸…æ™°è®¸å¤šã€‚</p>
<h2 id="é…åˆ-Spring"><a href="#é…åˆ-Spring" class="headerlink" title="é…åˆ Spring"></a>é…åˆ Spring</h2><p>Spring å¾ˆå¤§çš„ä¸€ä¸ªä½œç”¨å°±æ˜¯å¸®æˆ‘ä»¬ç®¡ç†å¯¹è±¡ï¼Œæ‰€ä»¥åƒä¸Šæ–‡é‚£äº›çœ‹ä¼¼å¾ˆå¤æ‚çš„å¯¹è±¡éƒ½å¯ä»¥äº¤ç”±å®ƒæ¥ç®¡ç†ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- jedis é…ç½® --&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"JedispoolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxIdle&#125;"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxTotal&#125;"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxWait&#125;"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnBorrow"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.testOnBorrow&#125;"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnReturn"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.testOnBorrow&#125;"</span>/&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"> <span class="comment">&lt;!-- redisæœåŠ¡å™¨ä¸­å¿ƒ --&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.jedis.JedisConnectionFactory"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolConfig"</span> <span class="attr">ref</span>=<span class="string">"JedispoolConfig"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.port&#125;"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hostName"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.host&#125;"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.password&#125;"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.timeout&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.core.RedisTemplate"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"keySerializer"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.serializer.StringRedisSerializer"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"valueSerializer"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.serializer.StringRedisSerializer"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>è¿™ä¸ªå…¶å®æ²¡å¤šå°‘å¥½è¯´çš„ï¼Œå°±ç®—æ˜¯æ¢æˆ SpringBoot ä¹Ÿæ˜¯åˆ›å»º <code>JedispoolConfig,connectionFactory,redisTemplate</code> è¿™äº› bean å³å¯ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ¢ä¸ºè¿æ¥æ± ä¹‹åå†è¿›è¡Œå‹æµ‹è‡ªç„¶æ²¡æœ‰å‡ºç°è·å–ä¸äº† Redis è¿æ¥çš„å¼‚å¸¸ï¼ˆå¹¶å‘è¾¾åˆ°ä¸€å®šçš„é‡ä¹Ÿä¼šå‡ºé”™ï¼‰è¯´æ˜æ›´æ–°æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</p>
<p>æ¨èæœ‰ç”¨åˆ°è¯¥ç»„ä»¶çš„æœ‹å‹éƒ½å‡çº§ä¸‹ï¼Œä¹Ÿæ¬¢è¿æå‡º Issues å’Œ PRã€‚</p>
<p>é¡¹ç›®åœ°å€ï¼š</p>
<p><a href="https://github.com/crossoverJie/distributed-redis-tool" target="_blank" rel="external">https://github.com/crossoverJie/distributed-redis-tool</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws4.sinaimg.cn/large/006tNc79ly1fs2s4f0jf4j31g80ytn6i.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ä¹‹å‰åœ¨åš &lt;a href=&quot;https://crossoverjie.top/2018/05/07/ssm/SSM18-seconds-kill/#distributed-redis-tool-%E2%AC%86%EF%B8%8Fv1-0-3&quot;&gt;ç§’æ€æ¶æ„å®è·µ&lt;/a&gt; æ—¶æœ‰æåˆ°å¯¹ &lt;a href=&quot;https://github.com/crossoverJie/distributed-redis-tool&quot;&gt;distributed-redis-tool&lt;/a&gt; çš„ä¸€æ¬¡å°å‡çº§ï¼Œä½†æ˜¯æ²¡æœ‰ç»†è¯´ã€‚&lt;/p&gt;
&lt;p&gt;å…¶å®ä¸»è¦åŸå› æ˜¯ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ç§’æ€æ—¶æˆ‘åšå‹æµ‹ï¼šç”±äºé›†æˆäº†è¿™ä¸ªé™æµç»„ä»¶ï¼Œå¹¶å‘åˆæ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥å¯¼è‡´è¿æ¥ã€æ–­å¼€ Redis éå¸¸é¢‘ç¹ã€‚&lt;br&gt;æœ€ç»ˆå¯¼è‡´è·å–ä¸äº† Redis connection çš„å¼‚å¸¸ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;æ± åŒ–æŠ€æœ¯&quot;&gt;&lt;a href=&quot;#æ± åŒ–æŠ€æœ¯&quot; class=&quot;headerlink&quot; title=&quot;æ± åŒ–æŠ€æœ¯&quot;&gt;&lt;/a&gt;æ± åŒ–æŠ€æœ¯&lt;/h2&gt;&lt;p&gt;è¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å¯¹ç¨€ç¼ºèµ„æºä½¿ç”¨ä¸å–„å¯¼è‡´çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä½•ä¸ºç¨€ç¼ºèµ„æºï¼Ÿå¸¸è§çš„æœ‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;çº¿ç¨‹&lt;/li&gt;
&lt;li&gt;æ•°æ®åº“è¿æ¥&lt;/li&gt;
&lt;li&gt;ç½‘ç»œè¿æ¥ç­‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™äº›èµ„æºéƒ½æœ‰å…±åŒçš„ç‰¹ç‚¹ï¼š&lt;strong&gt;åˆ›å»ºé”€æ¯æˆæœ¬è¾ƒé«˜&lt;/strong&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Distributed Tools" scheme="http://crossoverjie.top/categories/Distributed-Tools/"/>
    
    
      <category term="Distributed Lock" scheme="http://crossoverjie.top/tags/Distributed-Lock/"/>
    
      <category term="Distributed Limited" scheme="http://crossoverjie.top/tags/Distributed-Limited/"/>
    
  </entry>
  
  <entry>
    <title>è®°äº 2018 å¹´é«˜è€ƒï¼</title>
    <link href="http://crossoverjie.top/2018/06/06/exam/2018-06-07-The-university-entrance-exam/"/>
    <id>http://crossoverjie.top/2018/06/06/exam/2018-06-07-The-university-entrance-exam/</id>
    <published>2018-06-06T14:20:46.000Z</published>
    <updated>2018-06-07T17:31:04.795Z</updated>
    
    <content type="html"><![CDATA[<h2 id="2012-02-28"><a href="#2012-02-28" class="headerlink" title="2012/02/28"></a>2012/02/28</h2><p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fs328nqn2ej30go0b3q5q.jpg" alt=""></p>
<blockquote>
<p>2012å¹´äºŒæœˆäºŒåå…«æ—¥ã€‚</p>
</blockquote>
<p>è¿™å¤©å­¦æ ¡ä¸¾è¡Œäº†<code>é«˜è€ƒ 100 å¤©èª“å¸ˆå¤§ä¼š</code>ï¼Œå½“æ—¶å®Œå…¨ä¸çŸ¥é“æ„å‘³ç€ä»€ä¹ˆï¼Œåªæ„Ÿè§‰ç°åœºçƒ­è¡€æ²¸è…¾ã€æ¿€æƒ…é«˜æ¶¨ï¼Œå¿ƒé‡Œå‘Šè¯‰è‡ªå·±å°±ç®—åªå‰©ä¸‹ 100 å¤©æˆ‘ä¹Ÿèƒ½è€ƒä¸Šæ¸…åå…¶æ¬¡ä¹Ÿæ˜¯åŒ—å¤§ã€‚</p>
<h2 id="2012-06-03"><a href="#2012-06-03" class="headerlink" title="2012/06/03"></a>2012/06/03</h2><blockquote>
<p>2012å¹´å…­æœˆä¸‰æ—¥ã€‚</p>
</blockquote>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fs32g2rjm9j30im0dyq5e.jpg" alt=""></p>
<p>æ™šè‡ªä¹ æ‹¿å‡ºå‰æ®µæ—¶é—´åˆšæ‹çš„æ¯•ä¸šåˆç…§ï¼Œæ¨æ­»æ‘„å½±å¸ˆï¼Œæ²¡æœ‰æŠ“æ‹åˆ°æˆ‘æœ€å¸…çš„è§’åº¦ğŸ˜¡ã€‚</p>
<a id="more"></a>
<h2 id="2012-06-04"><a href="#2012-06-04" class="headerlink" title="2012/06/04"></a>2012/06/04</h2><blockquote>
<p>2012å¹´å…­æœˆå››æ—¥ã€‚</p>
</blockquote>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fs32bu42c5j30im0dymyj.jpg" alt=""></p>
<p>ç¦»æ ¡å‰çš„æœ€åä¸€æ™šï¼Œæˆ‘ä»¬åƒå¾€å¸¸æ¯å‘¨çš„éŸ³ä¹æ™šè‡ªä¹ ä¸€æ ·ï¼Œç”±éŸ³ä¹å§”å‘˜ï¼ˆ@çŒªå¨…ï¼‰å¸¦ç€å¤§å®¶å”±å¯ç±³å°å­çš„é’æ˜¥çºªå¿µå†Œã€‚</p>
<p>å°çº¢å§ï¼ˆç­ä¸»ä»»ï¼‰ç‰¹åˆ«çš„æ²¡æ¥æŸ¥å²—ã€‚</p>
<p>å¿ƒé‡Œæƒ³ç€ï¼Œè¿™å°±æ˜¯é’æ˜¥å˜›ï¼Ÿä¹Ÿä¸è¿‡å¦‚æ­¤ã€‚</p>
<p>å¤§å®¶æ‹¿ç€çƒ­å’Œçš„æ‰‹æœºï¼ˆæ‰å‘çš„ï¼Œå¹³æ—¶ä¼šæ”¶ï¼‰è‚†æ„çš„æ‹ç€ç…§ç‰‡ï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fs32o22ln1j30im0dyq5b.jpg" alt=""></p>
<p>é‚£æ—¶æ²¡æœ‰ç¾é¢œã€æ²¡æœ‰ä¿®å›¾ï¼Œä¸€åˆ‡éƒ½æ˜¯é‚£ä¹ˆå’Œè°ã€‚</p>
<h2 id="2012-06-05"><a href="#2012-06-05" class="headerlink" title="2012/06/05"></a>2012/06/05</h2><blockquote>
<p>2012å¹´å…­æœˆäº”æ—¥ã€‚</p>
</blockquote>
<p>æ˜¯è¿›æ´¥ï¼ˆæ±Ÿæ´¥ï¼‰èµ¶è€ƒï¼Œèµ°æ—¶ç‰¹åœ°åœ¨å…­é£Ÿå ‚ä¹°äº†ä¸€ä¸ªåŒ…å­ï¼Œæ²¡æƒ³åˆ°æ˜¯åœ¨å­¦æ ¡æœ€åä¸€é¡¿æ—©é¤ã€‚</p>
<p>è½¦ä¸Šå¤§å®¶æœ‰è¯´æœ‰ç¬‘ï¼Œå—¯ï¼Œå°±åƒæ˜¯èµ„æ·±å¯¼æ¸¸å¸¦çš„ä¸€ä¸ªä½ä»·æ—…æ¸¸å›¢ï¼Œæ¯äººå¿ƒé‡Œå……æ»¡äº†æƒŠå–œå´ä¸çŸ¥å³å°†é¢ä¸´ä»€ä¹ˆã€‚</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fs335w7e4bj30im0dytae.jpg" alt=""></p>
<h2 id="2012-06-07"><a href="#2012-06-07" class="headerlink" title="2012/06/07"></a>2012/06/07</h2><blockquote>
<p>2012å¹´å…­æœˆä¸ƒæ—¥ã€‚</p>
</blockquote>
<p>å¤§å®¶åœ¨å„è‡ªçš„è€ƒåœºå¥‹ç¬”ç–¾ä¹¦ï¼Œç”¨ä¸¤å¤©å››åœºè€ƒè¯•æ¥ä¸ºé«˜ä¸­ä¸‰å¹´ç”»ä¸Šå¥å·ã€‚</p>
<p>æœ‰çš„æ¢¦æƒ³è¿›å…¥ç†æƒ³çš„å¤§å­¦ã€å’Œå¿ƒä»ªçš„ <code>TA</code> é•¿ç›¸å®å®ˆï¼Œå½“ç„¶ä¹Ÿæœ‰å›å®¶ç»§æ‰¿ç™¾ä¸‡å®¶äº§ğŸ˜‚ã€‚</p>
<p>è€Œæˆ‘å½“æ—¶åªæƒ³å¿«é€Ÿçš„ç»“æŸè¿™ä¸€åˆ‡ï¼Œé«˜ä¸­ä¸‰å¹´ï¼Œç‰¹åˆ«æ˜¯é«˜ä¸‰è¿™å¹´çœŸçš„æ˜¯å¤Ÿäº†ã€‚æ¯å¤©åšä¸å®Œçš„å·å­ï¼ŒèƒŒä¸å®Œçš„è¯—è¯ï¼Œè¿˜å¾—æƒ³ç€ä¸ºé™ˆå®¶è€ç¥–å®—å‡ºä¸€ä½æ­£å„¿å…«ç»çš„å¤§å­¦ç”Ÿã€‚</p>
<p>æ‰€ä»¥è€ƒè¯•å®Œå…¨é‡‡ç”¨äººå·åˆä¸€çš„å¿ƒæ€ï¼ˆèƒ½åšå°±åšï¼Œä¸ä¼šå°±è¿‡ï¼‰å¿«é€Ÿçš„è¿‡å®Œäº†è¿™ä¸¤å¤©ã€‚</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fs34gry1b2j30i20r3djq.jpg" alt=""></p>
<p>è¿™äº›ä½œæ–‡é¢˜ç›®è¿˜çœ‹å¾—æ‡‚å˜›ã€‚ã€‚</p>
<h2 id="2018-06-07"><a href="#2018-06-07" class="headerlink" title="2018/06/07"></a>2018/06/07</h2><blockquote>
<p><strong>2018</strong>å¹´å…­æœˆä¸ƒæ—¥ã€‚</p>
</blockquote>
<p>é«˜ä¸­å­¦è¿‡è®¸å¤šå…³äºæ—¶å…‰é£é€çš„æˆè¯­ã€å¤è¯—ï¼Œä½†éƒ½æ²¡æœ‰äº²èº«ä½“ä¼šé‚£ä¹ˆæ·±åˆ»ï¼</p>
<p>å…­å¹´æ—¶é—´ï¼Œçº¢äº†æ¨±æ¡ƒï¼Œç»¿äº†èŠ­è•‰ã€‚</p>
<p>æœ‰çš„æ­¥å…¥èŒåœºã€å‡èŒåŠ è–ªã€æ±‚å©šæˆåŠŸã€ç©¿ä¸Šå©šçº±ã€ç»„å»ºå®¶åº­ã€åˆä¸ºäººæ¯ã€‚</p>
<p>æ¯äººéƒ½è¿‡ç€å„è‡ªçš„ç”Ÿæ´»ï¼Œä½†ä¸€æ—¦ç›¸è§å°±æœ‰æ•°ä¸å°½çš„è¯é¢˜ï¼ˆ@æ±Ÿæºï¼‰ï¼Œé€ƒè¯¾æ‰“çƒã€ç¿»å¢™ä¸Šç½‘ã€æš—æ‹å¥³ç¥ã€å¤©å¤©å‘ä¸Šã€ä½œä¸šå·å­ã€‚</p>
<p>è¿™å¥è¯é€ç»™é«˜2012çº§10ç­çš„æ‰€æœ‰åŒå­¦ï¼š</p>
<p><strong><em>æ„¿ä½ å‡ºèµ°åŠç”Ÿï¼Œå½’æ¥ä»æ˜¯å°‘å¹´</em></strong></p>
<p>ä¸€å¤§æ³¢å›¾ç‰‡å³å°†è¢­æ¥ï¼š</p>
<p>æ‘†æ‹è™½å¥½ï¼Œä¸è¦æŠ½çƒŸå“¦ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fs33jy8cg6j30im0dyq50.jpg" alt=""></p>
<p>å°çº¢å§ç”Ÿæ—¥å¿«ä¹ï¼Œæ°¸è¿œåå…«ï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fs33lewu4rj30im0ccjtt.jpg" alt=""></p>
<p>é›†ä½“ç”Ÿæ—¥ï¼Œå¹´å¹´åå…«ï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fs33o1d2i8j30im0ceab5.jpg" alt=""></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fs33o8y925j30im0ceta5.jpg" alt=""></p>
<p>çŠ¶å…ƒä¹¦æ‘Šï¼Œä¸æ˜¯ç¬¬ä¸€ä¸å–ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fs34c6khchj30im0dytcg.jpg" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;2012-02-28&quot;&gt;&lt;a href=&quot;#2012-02-28&quot; class=&quot;headerlink&quot; title=&quot;2012/02/28&quot;&gt;&lt;/a&gt;2012/02/28&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://ws4.sinaimg.cn/large/006tNc79gy1fs328nqn2ej30go0b3q5q.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;2012å¹´äºŒæœˆäºŒåå…«æ—¥ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™å¤©å­¦æ ¡ä¸¾è¡Œäº†&lt;code&gt;é«˜è€ƒ 100 å¤©èª“å¸ˆå¤§ä¼š&lt;/code&gt;ï¼Œå½“æ—¶å®Œå…¨ä¸çŸ¥é“æ„å‘³ç€ä»€ä¹ˆï¼Œåªæ„Ÿè§‰ç°åœºçƒ­è¡€æ²¸è…¾ã€æ¿€æƒ…é«˜æ¶¨ï¼Œå¿ƒé‡Œå‘Šè¯‰è‡ªå·±å°±ç®—åªå‰©ä¸‹ 100 å¤©æˆ‘ä¹Ÿèƒ½è€ƒä¸Šæ¸…åå…¶æ¬¡ä¹Ÿæ˜¯åŒ—å¤§ã€‚&lt;/p&gt;
&lt;h2 id=&quot;2012-06-03&quot;&gt;&lt;a href=&quot;#2012-06-03&quot; class=&quot;headerlink&quot; title=&quot;2012/06/03&quot;&gt;&lt;/a&gt;2012/06/03&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;2012å¹´å…­æœˆä¸‰æ—¥ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tNc79gy1fs32g2rjm9j30im0dyq5e.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ™šè‡ªä¹ æ‹¿å‡ºå‰æ®µæ—¶é—´åˆšæ‹çš„æ¯•ä¸šåˆç…§ï¼Œæ¨æ­»æ‘„å½±å¸ˆï¼Œæ²¡æœ‰æŠ“æ‹åˆ°æˆ‘æœ€å¸…çš„è§’åº¦ğŸ˜¡ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å°æƒ…ç»ª" scheme="http://crossoverjie.top/categories/%E5%B0%8F%E6%83%85%E7%BB%AA/"/>
    
    
  </entry>
  
  <entry>
    <title>Netty(ä¸€) SpringBoot æ•´åˆé•¿è¿æ¥å¿ƒè·³æœºåˆ¶</title>
    <link href="http://crossoverjie.top/2018/05/24/netty/Netty(1)TCP-Heartbeat/"/>
    <id>http://crossoverjie.top/2018/05/24/netty/Netty(1)TCP-Heartbeat/</id>
    <published>2018-05-23T17:02:54.000Z</published>
    <updated>2018-05-27T18:30:39.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.loli.net/2018/05/25/5b0774828db53.jpeg" alt="photo-1522204657746-fccce0824cfd.jpeg"></p>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Netty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ NIO ç½‘ç»œæ¡†æ¶ï¼Œæœ¬æ–‡åŸºäº SpringBoot ä»¥å¸¸è§çš„å¿ƒè·³æœºåˆ¶æ¥è®¤è¯† Nettyã€‚</p>
<p>æœ€ç»ˆèƒ½è¾¾åˆ°çš„æ•ˆæœï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯æ¯éš” N ç§’æ£€æµ‹æ˜¯å¦éœ€è¦å‘é€å¿ƒè·³ã€‚</li>
<li>æœåŠ¡ç«¯ä¹Ÿæ¯éš” N ç§’æ£€æµ‹æ˜¯å¦éœ€è¦å‘é€å¿ƒè·³ã€‚</li>
<li>æœåŠ¡ç«¯å¯ä»¥ä¸»åŠ¨ push æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯ã€‚</li>
<li>åŸºäº SpringBoot ç›‘æ§ï¼Œå¯ä»¥æŸ¥çœ‹å®æ—¶è¿æ¥ä»¥åŠå„ç§åº”ç”¨ä¿¡æ¯ã€‚</li>
</ul>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://crossoverjie.top/uploads/netty-Heartbeat.gif" alt="show"></p>
<a id="more"></a>
<h1 id="IdleStateHandler"><a href="#IdleStateHandler" class="headerlink" title="IdleStateHandler"></a>IdleStateHandler</h1><p>Netty å¯ä»¥ä½¿ç”¨ IdleStateHandler æ¥å®ç°è¿æ¥ç®¡ç†ï¼Œå½“è¿æ¥ç©ºé—²æ—¶é—´å¤ªé•¿ï¼ˆæ²¡æœ‰å‘é€ã€æ¥æ”¶æ¶ˆæ¯ï¼‰æ—¶åˆ™ä¼šè§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œæˆ‘ä»¬ä¾¿å¯åœ¨è¯¥äº‹ä»¶ä¸­å®ç°å¿ƒè·³æœºåˆ¶ã€‚</p>
<h2 id="å®¢æˆ·ç«¯å¿ƒè·³"><a href="#å®¢æˆ·ç«¯å¿ƒè·³" class="headerlink" title="å®¢æˆ·ç«¯å¿ƒè·³"></a>å®¢æˆ·ç«¯å¿ƒè·³</h2><p>å½“å®¢æˆ·ç«¯ç©ºé—²äº† N ç§’æ²¡æœ‰ç»™æœåŠ¡ç«¯å‘é€æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨å‘é€ä¸€ä¸ªå¿ƒè·³æ¥ç»´æŒè¿æ¥ã€‚</p>
<p>æ ¸å¿ƒä»£ç ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoClientHandle</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">ByteBuf</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(EchoClientHandle.class);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent)&#123;</div><div class="line">            IdleStateEvent idleStateEvent = (IdleStateEvent) evt ;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (idleStateEvent.state() == IdleState.WRITER_IDLE)&#123;</div><div class="line">                LOGGER.info(<span class="string">"å·²ç» 10 ç§’æ²¡æœ‰å‘é€ä¿¡æ¯ï¼"</span>);</div><div class="line">                <span class="comment">//å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯</span></div><div class="line">                CustomProtocol heartBeat = SpringBeanFactory.getBean(<span class="string">"heartBeat"</span>, CustomProtocol.class);</div><div class="line">                ctx.writeAndFlush(heartBeat).addListener(ChannelFutureListener.CLOSE_ON_FAILURE) ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.userEventTriggered(ctx, evt);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext channelHandlerContext, ByteBuf in)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//ä»æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯æ—¶è¢«è°ƒç”¨</span></div><div class="line">        LOGGER.info(<span class="string">"å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯=&#123;&#125;"</span>,in.toString(CharsetUtil.UTF_8)) ;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®ç°éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨äº‹ä»¶å›è°ƒä¸­å‘é€ä¸€ä¸ªæ¶ˆæ¯å³å¯ã€‚</p>
<p>ç”±äºæ•´åˆäº† SpringBoot ï¼Œæ‰€ä»¥å‘é€çš„å¿ƒè·³ä¿¡æ¯æ˜¯ä¸€ä¸ªå•ä¾‹çš„ Beanã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartBeatConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;channel.id&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id ;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Bean</span>(value = <span class="string">"heartBeat"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> CustomProtocol <span class="title">heartBeat</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CustomProtocol(id,<span class="string">"ping"</span>) ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæ¶‰åŠåˆ°äº†è‡ªå®šä¹‰åè®®çš„å†…å®¹ï¼Œè¯·ç»§ç»­æŸ¥çœ‹ä¸‹æ–‡ã€‚</p>
<p>å½“ç„¶å°‘ä¸äº†å¯åŠ¨å¼•å¯¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(HeartbeatClient.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;netty.server.port&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> nettyPort;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;netty.server.host&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String host;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> SocketChannel channel;</div><div class="line"></div><div class="line">    <span class="meta">@PostConstruct</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</div><div class="line">        bootstrap.group(group)</div><div class="line">                .channel(NioSocketChannel.class)</div><div class="line">                .handler(<span class="keyword">new</span> CustomerHandleInitializer())</div><div class="line">        ;</div><div class="line"></div><div class="line">        ChannelFuture future = bootstrap.connect(host, nettyPort).sync();</div><div class="line">        <span class="keyword">if</span> (future.isSuccess()) &#123;</div><div class="line">            LOGGER.info(<span class="string">"å¯åŠ¨ Netty æˆåŠŸ"</span>);</div><div class="line">        &#125;</div><div class="line">        channel = (SocketChannel) future.channel();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerHandleInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">Channel</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ch.pipeline()</div><div class="line">                <span class="comment">//10 ç§’æ²¡å‘é€æ¶ˆæ¯ å°†IdleStateHandler æ·»åŠ åˆ° ChannelPipeline ä¸­</span></div><div class="line">                .addLast(<span class="keyword">new</span> IdleStateHandler(<span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>))</div><div class="line">                .addLast(<span class="keyword">new</span> HeartbeatEncode())</div><div class="line">                .addLast(<span class="keyword">new</span> EchoClientHandle())</div><div class="line">        ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥å½“åº”ç”¨å¯åŠ¨æ¯éš” 10 ç§’ä¼šæ£€æµ‹æ˜¯å¦å‘é€è¿‡æ¶ˆæ¯ï¼Œä¸ç„¶å°±ä¼šå‘é€å¿ƒè·³ä¿¡æ¯ã€‚</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1frqd863hrhj31kw04taed.jpg" alt=""></p>
<h2 id="æœåŠ¡ç«¯å¿ƒè·³"><a href="#æœåŠ¡ç«¯å¿ƒè·³" class="headerlink" title="æœåŠ¡ç«¯å¿ƒè·³"></a>æœåŠ¡ç«¯å¿ƒè·³</h2><p>æœåŠ¡å™¨ç«¯çš„å¿ƒè·³å…¶å®ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¹Ÿéœ€è¦åœ¨ ChannelPipeline ä¸­æ·»åŠ ä¸€ä¸ª IdleStateHandler ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartBeatSimpleHandle</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">CustomProtocol</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(HeartBeatSimpleHandle.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteBuf HEART_BEAT =  Unpooled.unreleasableBuffer(Unpooled.copiedBuffer(<span class="keyword">new</span> CustomProtocol(<span class="number">123456L</span>,<span class="string">"pong"</span>).toString(),CharsetUtil.UTF_8));</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å–æ¶ˆç»‘å®š</div><div class="line">     * <span class="doctag">@param</span> ctx</div><div class="line">     * <span class="doctag">@throws</span> Exception</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        NettySocketHolder.remove((NioSocketChannel) ctx.channel());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent)&#123;</div><div class="line">            IdleStateEvent idleStateEvent = (IdleStateEvent) evt ;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (idleStateEvent.state() == IdleState.READER_IDLE)&#123;</div><div class="line">                LOGGER.info(<span class="string">"å·²ç»5ç§’æ²¡æœ‰æ”¶åˆ°ä¿¡æ¯ï¼"</span>);</div><div class="line">                <span class="comment">//å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯</span></div><div class="line">                ctx.writeAndFlush(HEART_BEAT).addListener(ChannelFutureListener.CLOSE_ON_FAILURE) ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.userEventTriggered(ctx, evt);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, CustomProtocol customProtocol)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        LOGGER.info(<span class="string">"æ”¶åˆ°customProtocol=&#123;&#125;"</span>, customProtocol);</div><div class="line"></div><div class="line">        <span class="comment">//ä¿å­˜å®¢æˆ·ç«¯ä¸ Channel ä¹‹é—´çš„å…³ç³»</span></div><div class="line">        NettySocketHolder.put(customProtocol.getId(),(NioSocketChannel)ctx.channel()) ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>è¿™é‡Œæœ‰ç‚¹éœ€è¦æ³¨æ„</strong>ï¼š</p>
<p>å½“æœ‰å¤šä¸ªå®¢æˆ·ç«¯è¿ä¸Šæ¥æ—¶ï¼ŒæœåŠ¡ç«¯éœ€è¦åŒºåˆ†å¼€ï¼Œä¸ç„¶å“åº”æ¶ˆæ¯å°±ä¼šå‘ç”Ÿæ··ä¹±ã€‚</p>
<p>æ‰€ä»¥æ¯å½“æœ‰ä¸ªè¿æ¥ä¸Šæ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½å°†å½“å‰çš„ Channel ä¸è¿ä¸Šçš„å®¢æˆ·ç«¯ ID è¿›è¡Œå…³è”ï¼ˆ<strong>å› æ­¤æ¯ä¸ªè¿ä¸Šçš„å®¢æˆ·ç«¯ ID éƒ½å¿…é¡»å”¯ä¸€</strong>ï¼‰ã€‚</p>
<p>è¿™é‡Œé‡‡ç”¨äº†ä¸€ä¸ª Map æ¥ä¿å­˜è¿™ä¸ªå…³ç³»ï¼Œå¹¶ä¸”åœ¨æ–­å¼€è¿æ¥æ—¶è‡ªåŠ¨å–æ¶ˆè¿™ä¸ªå…³è”ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettySocketHolder</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Long, NioSocketChannel&gt; MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Long id, NioSocketChannel socketChannel)</span> </span>&#123;</div><div class="line">        MAP.put(id, socketChannel);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NioSocketChannel <span class="title">get</span><span class="params">(Long id)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> MAP.get(id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Long, NioSocketChannel&gt; <span class="title">getMAP</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> MAP;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(NioSocketChannel nioSocketChannel)</span> </span>&#123;</div><div class="line">        MAP.entrySet().stream().filter(entry -&gt; entry.getValue() == nioSocketChannel).forEach(entry -&gt; MAP.remove(entry.getKey()));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯åŠ¨å¼•å¯¼ç¨‹åºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">Component</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartBeatServer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(HeartBeatServer.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> EventLoopGroup boss = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line">    <span class="keyword">private</span> EventLoopGroup work = <span class="keyword">new</span> NioEventLoopGroup();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;netty.server.port&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> nettyPort;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¯åŠ¨ Netty</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> InterruptedException</div><div class="line">     */</div><div class="line">    <span class="meta">@PostConstruct</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">        ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap()</div><div class="line">                .group(boss, work)</div><div class="line">                .channel(NioServerSocketChannel.class)</div><div class="line">                .localAddress(<span class="keyword">new</span> InetSocketAddress(nettyPort))</div><div class="line">                <span class="comment">//ä¿æŒé•¿è¿æ¥</span></div><div class="line">                .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>)</div><div class="line">                .childHandler(<span class="keyword">new</span> HeartbeatInitializer());</div><div class="line"></div><div class="line">        ChannelFuture future = bootstrap.bind().sync();</div><div class="line">        <span class="keyword">if</span> (future.isSuccess()) &#123;</div><div class="line">            LOGGER.info(<span class="string">"å¯åŠ¨ Netty æˆåŠŸ"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é”€æ¯</div><div class="line">     */</div><div class="line">    <span class="meta">@PreDestroy</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        boss.shutdownGracefully().syncUninterruptibly();</div><div class="line">        work.shutdownGracefully().syncUninterruptibly();</div><div class="line">        LOGGER.info(<span class="string">"å…³é—­ Netty æˆåŠŸ"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;    </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">Channel</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ch.pipeline()</div><div class="line">                <span class="comment">//äº”ç§’æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ å°†IdleStateHandler æ·»åŠ åˆ° ChannelPipeline ä¸­</span></div><div class="line">                .addLast(<span class="keyword">new</span> IdleStateHandler(<span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>))</div><div class="line">                .addLast(<span class="keyword">new</span> HeartbeatDecoder())</div><div class="line">                .addLast(<span class="keyword">new</span> HeartBeatSimpleHandle());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¹Ÿæ˜¯åŒæ ·å°†IdleStateHandler æ·»åŠ åˆ° ChannelPipeline ä¸­ï¼Œä¹Ÿä¼šæœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯5ç§’æ ¡éªŒä¸€æ¬¡æ˜¯å¦æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œå¦åˆ™å°±ä¸»åŠ¨å‘é€ä¸€æ¬¡è¯·æ±‚ã€‚</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1frqe2hbxjfj31kw06rtej.jpg" alt=""></p>
<p>å› ä¸ºæµ‹è¯•æ˜¯æœ‰ä¸¤ä¸ªå®¢æˆ·ç«¯è¿ä¸Šæ‰€ä»¥æœ‰ä¸¤ä¸ªæ—¥å¿—ã€‚</p>
<h2 id="è‡ªå®šä¹‰åè®®"><a href="#è‡ªå®šä¹‰åè®®" class="headerlink" title="è‡ªå®šä¹‰åè®®"></a>è‡ªå®šä¹‰åè®®</h2><p>ä¸Šæ–‡å…¶å®éƒ½çœ‹åˆ°äº†ï¼šæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯é‡‡ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„ POJO è¿›è¡Œé€šè®¯çš„ã€‚</p>
<p>æ‰€ä»¥éœ€è¦åœ¨å®¢æˆ·ç«¯è¿›è¡Œç¼–ç ï¼ŒæœåŠ¡ç«¯è¿›è¡Œè§£ç ï¼Œä¹Ÿéƒ½åªéœ€è¦å„è‡ªå®ç°ä¸€ä¸ªç¼–è§£ç å™¨å³å¯ã€‚</p>
<p>CustomProtocolï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomProtocol</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4671171056588401542L</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id ;</div><div class="line">    <span class="keyword">private</span> String content ;</div><div class="line">    <span class="comment">//çœç•¥ getter/setter</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯çš„ç¼–ç å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatEncode</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">CustomProtocol</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, CustomProtocol msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        out.writeLong(msg.getId()) ;</div><div class="line">        out.writeBytes(msg.getContent().getBytes()) ;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯çš„å‰å…«ä¸ªå­—èŠ‚ä¸º headerï¼Œå‰©ä½™çš„å…¨æ˜¯ contentã€‚</p>
<p>æœåŠ¡ç«¯çš„è§£ç å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> id = in.readLong() ;</div><div class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[in.readableBytes()] ;</div><div class="line">        in.readBytes(bytes) ;</div><div class="line">        String content = <span class="keyword">new</span> String(bytes) ;</div><div class="line"></div><div class="line">        CustomProtocol customProtocol = <span class="keyword">new</span> CustomProtocol() ;</div><div class="line">        customProtocol.setId(id);</div><div class="line">        customProtocol.setContent(content) ;</div><div class="line">        out.add(customProtocol) ;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åªéœ€è¦æŒ‰ç…§åˆšæ‰çš„è§„åˆ™è¿›è¡Œè§£ç å³å¯ã€‚</p>
<h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>å…¶å®è”æƒ³åˆ° IdleStateHandler çš„åŠŸèƒ½ï¼Œè‡ªç„¶ä¹Ÿèƒ½æƒ³åˆ°å®ƒå®ç°çš„åŸç†ï¼š</p>
<blockquote>
<p>åº”è¯¥ä¼šå­˜åœ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹å»å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚</p>
</blockquote>
<p>æ¥çœ‹çœ‹å®ƒçš„æºç ï¼š</p>
<p>é¦–å…ˆæ˜¯æ„é€ å‡½æ•°:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public IdleStateHandler(</div><div class="line">        int readerIdleTimeSeconds,</div><div class="line">        int writerIdleTimeSeconds,</div><div class="line">        int allIdleTimeSeconds) &#123;</div><div class="line"></div><div class="line">    this(readerIdleTimeSeconds, writerIdleTimeSeconds, allIdleTimeSeconds,</div><div class="line">         TimeUnit.SECONDS);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯åˆå§‹åŒ–äº†å‡ ä¸ªæ•°æ®ï¼š</p>
<ul>
<li>readerIdleTimeSecondsï¼šä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ•°æ®è¯»å–</li>
<li>writerIdleTimeSecondsï¼šä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ•°æ®å‘é€</li>
<li>allIdleTimeSecondsï¼šä»¥ä¸Šä¸¤ç§æ»¡è¶³å…¶ä¸­ä¸€ä¸ªå³å¯</li>
</ul>
<p>å› ä¸º IdleStateHandler ä¹Ÿæ˜¯ä¸€ç§ ChannelHandlerï¼Œæ‰€ä»¥ä¼šåœ¨ <code>channelActive</code> ä¸­åˆå§‹åŒ–ä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// This method will be invoked only if this handler was added</span></div><div class="line">    <span class="comment">// before channelActive() event is fired.  If a user adds this handler</span></div><div class="line">    <span class="comment">// after the channelActive() event, initialize() will be called by beforeAdd().</span></div><div class="line">    initialize(ctx);</div><div class="line">    <span class="keyword">super</span>.channelActive(ctx);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">    <span class="comment">// Avoid the case where destroy() is called before scheduling timeouts.</span></div><div class="line">    <span class="comment">// See: https://github.com/netty/netty/issues/143</span></div><div class="line">    <span class="keyword">switch</span> (state) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">    <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    state = <span class="number">1</span>;</div><div class="line">    initOutputChanged(ctx);</div><div class="line"></div><div class="line">    lastReadTime = lastWriteTime = ticksInNanos();</div><div class="line">    <span class="keyword">if</span> (readerIdleTimeNanos &gt; <span class="number">0</span>) &#123;</div><div class="line">        readerIdleTimeout = schedule(ctx, <span class="keyword">new</span> ReaderIdleTimeoutTask(ctx),</div><div class="line">                readerIdleTimeNanos, TimeUnit.NANOSECONDS);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (writerIdleTimeNanos &gt; <span class="number">0</span>) &#123;</div><div class="line">        writerIdleTimeout = schedule(ctx, <span class="keyword">new</span> WriterIdleTimeoutTask(ctx),</div><div class="line">                writerIdleTimeNanos, TimeUnit.NANOSECONDS);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (allIdleTimeNanos &gt; <span class="number">0</span>) &#123;</div><div class="line">        allIdleTimeout = schedule(ctx, <span class="keyword">new</span> AllIdleTimeoutTask(ctx),</div><div class="line">                allIdleTimeNanos, TimeUnit.NANOSECONDS);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯ä¼šæŒ‰ç…§æˆ‘ä»¬ç»™å®šçš„æ—¶é—´åˆå§‹åŒ–å‡ºå®šæ—¶ä»»åŠ¡ã€‚</p>
<p>æ¥ç€åœ¨ä»»åŠ¡çœŸæ­£æ‰§è¡Œæ—¶è¿›è¡Œåˆ¤æ–­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderIdleTimeoutTask</span> <span class="keyword">extends</span> <span class="title">AbstractIdleTask</span> </span>&#123;</div><div class="line"></div><div class="line">    ReaderIdleTimeoutTask(ChannelHandlerContext ctx) &#123;</div><div class="line">        <span class="keyword">super</span>(ctx);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> nextDelay = readerIdleTimeNanos;</div><div class="line">        <span class="keyword">if</span> (!reading) &#123;</div><div class="line">            nextDelay -= ticksInNanos() - lastReadTime;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (nextDelay &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Reader is idle - set a new timeout and notify the callback.</span></div><div class="line">            readerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, readerIdleTimeNanos, TimeUnit.NANOSECONDS);</div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> first = firstReaderIdleEvent;</div><div class="line">            firstReaderIdleEvent = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                IdleStateEvent event = newIdleStateEvent(IdleState.READER_IDLE, first);</div><div class="line">                channelIdle(ctx, event);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                ctx.fireExceptionCaught(t);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Read occurred before the timeout - set a new timeout with shorter delay.</span></div><div class="line">            readerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ»¡è¶³æ¡ä»¶åˆ™ä¼šç”Ÿæˆä¸€ä¸ª IdleStateEvent äº‹ä»¶ã€‚</p>
<h1 id="SpringBoot-ç›‘æ§"><a href="#SpringBoot-ç›‘æ§" class="headerlink" title="SpringBoot ç›‘æ§"></a>SpringBoot ç›‘æ§</h1><p>ç”±äºæ•´åˆäº† SpringBoot ä¹‹åä¸ä½†å¯ä»¥åˆ©ç”¨ Spring å¸®æˆ‘ä»¬ç®¡ç†å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨å®ƒæ¥åšåº”ç”¨ç›‘æ§ã€‚</p>
<h2 id="actuator-ç›‘æ§"><a href="#actuator-ç›‘æ§" class="headerlink" title="actuator ç›‘æ§"></a>actuator ç›‘æ§</h2><p>å½“æˆ‘ä»¬ä¸ºå¼•å…¥äº†:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>å°±å¼€å¯äº† SpringBoot çš„ actuator ç›‘æ§åŠŸèƒ½ï¼Œä»–å¯ä»¥æš´éœ²å‡ºå¾ˆå¤šç›‘æ§ç«¯ç‚¹ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚</p>
<p>å¦‚ä¸€äº›åº”ç”¨ä¸­çš„ä¸€äº›ç»Ÿè®¡æ•°æ®ï¼š<br><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1frqeyocotnj31kw0b8tiy.jpg" alt=""></p>
<p>å­˜åœ¨çš„ Beansï¼š<br><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1frqez1kr3dj31kw0onawi.jpg" alt=""></p>
<p>æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html" target="_blank" rel="external">https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html</a></p>
<p>ä½†æ˜¯å¦‚æœæˆ‘æƒ³ç›‘æ§ç°åœ¨æˆ‘çš„æœåŠ¡ç«¯æœ‰å¤šå°‘å®¢æˆ·ç«¯è¿ä¸Šæ¥äº†ï¼Œåˆ†åˆ«çš„ ID æ˜¯å¤šå°‘ï¼Ÿ</p>
<p>å…¶å®å°±æ˜¯å®æ—¶æŸ¥çœ‹æˆ‘å†…éƒ¨å®šä¹‰çš„é‚£ä¸ªå…³è”å…³ç³»çš„ Mapã€‚</p>
<p>è¿™å°±éœ€è¦æš´éœ²è‡ªå®šä¹‰ç«¯ç‚¹äº†ã€‚</p>
<h2 id="è‡ªå®šä¹‰ç«¯ç‚¹"><a href="#è‡ªå®šä¹‰ç«¯ç‚¹" class="headerlink" title="è‡ªå®šä¹‰ç«¯ç‚¹"></a>è‡ªå®šä¹‰ç«¯ç‚¹</h2><p>æš´éœ²çš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼š</p>
<p>ç»§æ‰¿ AbstractEndpoint å¹¶å¤å†™å…¶ä¸­çš„ invoke å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomEndpoint</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span>&lt;<span class="title">Map</span>&lt;<span class="title">Long</span>,<span class="title">NioSocketChannel</span>&gt;&gt; </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç›‘æ§ç«¯ç‚¹çš„ è®¿é—®åœ°å€</div><div class="line">     * <span class="doctag">@param</span> id</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomEndpoint</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">        <span class="comment">//false è¡¨ç¤ºä¸æ˜¯æ•æ„Ÿç«¯ç‚¹</span></div><div class="line">        <span class="keyword">super</span>(id, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Long, NioSocketChannel&gt; <span class="title">invoke</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> NettySocketHolder.getMAP();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯è¿”å›äº† Map ä¸­çš„æ•°æ®ã€‚</p>
<p>å†é…ç½®ä¸€ä¸ªè¯¥ç±»å‹çš„ Bean å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EndPointConfig</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;monitor.channel.map.key&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String channelMap;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> CustomEndpoint <span class="title">buildEndPoint</span><span class="params">()</span></span>&#123;</div><div class="line">        CustomEndpoint customEndpoint = <span class="keyword">new</span> CustomEndpoint(channelMap) ;</div><div class="line">        <span class="keyword">return</span> customEndpoint ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ <code>monitor.channel.map.key</code> æ¥è®¿é—®äº†ï¼š</p>
<p>ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥æ—¶ï¼š<br><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1frqf7ic0wqj31kw07rq7a.jpg" alt=""></p>
<p>ä¸¤ä¸ªå®¢æˆ·ç«¯è¿æ¥æ—¶ï¼š<br><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1frqf8omlzkj31kw07xq7y.jpg" alt=""></p>
<h2 id="æ•´åˆ-SBA"><a href="#æ•´åˆ-SBA" class="headerlink" title="æ•´åˆ SBA"></a>æ•´åˆ SBA</h2><p>è¿™æ ·å…¶å®ç›‘æ§åŠŸèƒ½å·²ç»å¯ä»¥æ»¡è¶³äº†ï¼Œä½†èƒ½ä¸èƒ½å±•ç¤ºçš„æ›´ç¾è§‚ã€å¹¶ä¸”å¤šä¸ªåº”ç”¨ä¹Ÿå¯ä»¥æ–¹ä¾¿æŸ¥çœ‹å‘¢ï¼Ÿ</p>
<p>æœ‰è¿™æ ·çš„å¼€æºå·¥å…·å¸®æˆ‘ä»¬åšåˆ°äº†ï¼š</p>
<p><a href="https://github.com/codecentric/spring-boot-admin" target="_blank" rel="external">https://github.com/codecentric/spring-boot-admin</a></p>
<p>ç®€å•æ¥è¯´æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥å·¥å…·å°† actuator æš´éœ²å‡ºæ¥çš„æ¥å£å¯è§†åŒ–å¹¶èšåˆçš„å±•ç¤ºåœ¨é¡µé¢ä¸­ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1frqfbz359wj31kw0p513n.jpg" alt=""></p>
<p>æ¥å…¥ä¹Ÿå¾ˆç®€å•ï¼Œé¦–å…ˆéœ€è¦å¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.codecentric<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-admin-starter-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>å¹¶åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># å…³é—­å¥åº·æ£€æŸ¥æƒé™</div><div class="line">management.security.enabled=false</div><div class="line"># SpringAdmin åœ°å€</div><div class="line">spring.boot.admin.url=http://127.0.0.1:8888</div></pre></td></tr></table></figure>
<p>åœ¨å¯åŠ¨åº”ç”¨ä¹‹å‰å…ˆè®² SpringBootAdmin éƒ¨ç½²å¥½ï¼š</p>
<p>è¿™ä¸ªåº”ç”¨å°±æ˜¯ä¸€ä¸ªçº¯ç²¹çš„ SpringBoot ï¼Œåªéœ€è¦åœ¨ä¸»å‡½æ•°ä¸ŠåŠ å…¥ <code>@EnableAdminServer</code> æ³¨è§£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableAutoConfiguration</span></div><div class="line"><span class="meta">@EnableAdminServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminApplication</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		SpringApplication.run(AdminApplication.class, args);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¼•å…¥ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.codecentric<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-admin-starter-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.codecentric<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-admin-server-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>ä¹‹åç›´æ¥å¯åŠ¨å°±è¡Œäº†ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬åœ¨ SpringBootAdmin çš„é¡µé¢ä¸­å°±å¯ä»¥æŸ¥çœ‹å¾ˆå¤šåº”ç”¨ä¿¡æ¯äº†ã€‚</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1frqfjuof2rj31kw10ldqk.jpg" alt=""></p>
<p>æ›´å¤šå†…å®¹è¯·å‚è€ƒå®˜æ–¹æŒ‡å—ï¼š</p>
<p><a href="http://codecentric.github.io/spring-boot-admin/1.5.6/" target="_blank" rel="external">http://codecentric.github.io/spring-boot-admin/1.5.6/</a></p>
<h3 id="è‡ªå®šä¹‰ç›‘æ§æ•°æ®"><a href="#è‡ªå®šä¹‰ç›‘æ§æ•°æ®" class="headerlink" title="è‡ªå®šä¹‰ç›‘æ§æ•°æ®"></a>è‡ªå®šä¹‰ç›‘æ§æ•°æ®</h3><p>å…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥å€ŸåŠ© actuator ä»¥åŠè¿™ä¸ªå¯è§†åŒ–é¡µé¢å¸®æˆ‘ä»¬ç›‘æ§ä¸€äº›ç®€å•çš„åº¦é‡ä¿¡æ¯ã€‚</p>
<p>æ¯”å¦‚æˆ‘åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸­å†™äº†ä¸¤ä¸ª Rest æ¥å£ç”¨äºå‘å¯¹æ–¹å‘é€æ¶ˆæ¯ã€‚</p>
<p>åªæ˜¯æƒ³è¦è®°å½•åˆ†åˆ«å‘é€äº†å¤šå°‘æ¬¡ï¼š</p>
<p>å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç»Ÿè®¡ service</div><div class="line">     */</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> CounterService counterService;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> HeartbeatClient heartbeatClient ;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å‘æœåŠ¡ç«¯å‘æ¶ˆæ¯</div><div class="line">     * <span class="doctag">@param</span> sendMsgReqVO</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯"</span>)</div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"sendMsg"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> BaseResponse&lt;SendMsgResVO&gt; <span class="title">sendMsg</span><span class="params">(@RequestBody SendMsgReqVO sendMsgReqVO)</span></span>&#123;</div><div class="line">        BaseResponse&lt;SendMsgResVO&gt; res = <span class="keyword">new</span> BaseResponse();</div><div class="line">        heartbeatClient.sendMsg(<span class="keyword">new</span> CustomProtocol(sendMsgReqVO.getId(),sendMsgReqVO.getMsg())) ;</div><div class="line"></div><div class="line">        <span class="comment">// åˆ©ç”¨ actuator æ¥è‡ªå¢</span></div><div class="line">        counterService.increment(Constants.COUNTER_CLIENT_PUSH_COUNT);</div><div class="line"></div><div class="line">        SendMsgResVO sendMsgResVO = <span class="keyword">new</span> SendMsgResVO() ;</div><div class="line">        sendMsgResVO.setMsg(<span class="string">"OK"</span>) ;</div><div class="line">        res.setCode(StatusEnum.SUCCESS.getCode()) ;</div><div class="line">        res.setMessage(StatusEnum.SUCCESS.getMessage()) ;</div><div class="line">        res.setDataBody(sendMsgResVO) ;</div><div class="line">        <span class="keyword">return</span> res ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åªè¦æˆ‘ä»¬å¼•å…¥äº† actuator çš„åŒ…ï¼Œé‚£å°±å¯ä»¥ç›´æ¥æ³¨å…¥ counterService ï¼Œåˆ©ç”¨å®ƒæ¥å¸®æˆ‘ä»¬è®°å½•æ•°æ®ã€‚</p>
<p>å½“æˆ‘ä»¬è°ƒç”¨è¯¥æ¥å£æ—¶ï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1frqfv3vx0ej31hk0g6dj5.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1frqfvof9lpj31kw07l0z8.jpg" alt=""></p>
<p>åœ¨ç›‘æ§é¡µé¢ä¸­å¯ä»¥æŸ¥è¯¢åˆšæ‰çš„è°ƒç”¨æƒ…å†µï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1frqfwembi6j31kw0o0dot.jpg" alt=""></p>
<p>æœåŠ¡ç«¯ä¸»åŠ¨ push æ¶ˆæ¯ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œåªæ˜¯éœ€è¦åœ¨å‘é€æ—¶å€™æ ¹æ®å®¢æˆ·ç«¯çš„ ID æŸ¥è¯¢åˆ°å…·ä½“çš„ Channel å‘é€ï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1frqfy9dcu5j31hu0f277i.jpg" alt=""></p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1frqfz0aticj31kw05jgol.jpg" alt=""></p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1frqfztzxd8j31kw0iyn0t.jpg" alt=""></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªç®€å• Netty å¿ƒè·³ç¤ºä¾‹ï¼Œå¹¶æ¼”ç¤ºäº† SpringBoot çš„ç›‘æ§ï¼Œä¹‹åä¼šç»§ç»­æ›´æ–° Netty ç›¸å…³å†…å®¹ï¼Œæ¬¢è¿å…³æ³¨åŠæŒ‡æ­£ã€‚</p>
<p>æœ¬æ–‡æ‰€æœ‰ä»£ç ï¼š</p>
<p><a href="https://github.com/crossoverJie/netty-action" target="_blank" rel="external">https://github.com/crossoverJie/netty-action</a></p>
<h1 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h1><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://i.loli.net/2018/05/25/5b0774828db53.jpeg&quot; alt=&quot;photo-1522204657746-fccce0824cfd.jpeg&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;Netty æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ NIO ç½‘ç»œæ¡†æ¶ï¼Œæœ¬æ–‡åŸºäº SpringBoot ä»¥å¸¸è§çš„å¿ƒè·³æœºåˆ¶æ¥è®¤è¯† Nettyã€‚&lt;/p&gt;
&lt;p&gt;æœ€ç»ˆèƒ½è¾¾åˆ°çš„æ•ˆæœï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®¢æˆ·ç«¯æ¯éš” N ç§’æ£€æµ‹æ˜¯å¦éœ€è¦å‘é€å¿ƒè·³ã€‚&lt;/li&gt;
&lt;li&gt;æœåŠ¡ç«¯ä¹Ÿæ¯éš” N ç§’æ£€æµ‹æ˜¯å¦éœ€è¦å‘é€å¿ƒè·³ã€‚&lt;/li&gt;
&lt;li&gt;æœåŠ¡ç«¯å¯ä»¥ä¸»åŠ¨ push æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯ã€‚&lt;/li&gt;
&lt;li&gt;åŸºäº SpringBoot ç›‘æ§ï¼Œå¯ä»¥æŸ¥çœ‹å®æ—¶è¿æ¥ä»¥åŠå„ç§åº”ç”¨ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ•ˆæœå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://crossoverjie.top/uploads/netty-Heartbeat.gif&quot; alt=&quot;show&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Netty" scheme="http://crossoverjie.top/categories/Netty/"/>
    
    
      <category term="SpringBoot" scheme="http://crossoverjie.top/tags/SpringBoot/"/>
    
      <category term="TCP" scheme="http://crossoverjie.top/tags/TCP/"/>
    
      <category term="Heartbeat" scheme="http://crossoverjie.top/tags/Heartbeat/"/>
    
  </entry>
  
  <entry>
    <title>1K star+ çš„é¡¹ç›®æ˜¯å¦‚ä½•ç‚¼æˆçš„ï¼Ÿ</title>
    <link href="http://crossoverjie.top/2018/05/15/skill/1Kstar/"/>
    <id>http://crossoverjie.top/2018/05/15/skill/1Kstar/</id>
    <published>2018-05-14T17:00:44.000Z</published>
    <updated>2018-05-14T16:26:25.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.loli.net/2018/05/14/5af935ddc27e1.jpg" alt="alarm-clock-art-background-1037993.jpg"></p>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>é¦–å…ˆæ ‡é¢˜å…šä¸€ä¸‹ï¼Œå…¶å®è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯è®°å½•æˆ‘çš„ç¬¬äºŒä¸ªè¿‡ <code>1K star</code> çš„é¡¹ç›® <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">Java-Interview</a>ï¼Œé¡ºä¾¿åˆ†äº«ä¸‹å…¶ä¸­çš„è¿‡ç¨‹åŠç»éªŒã€‚</p>
<p><img src="https://i.loli.net/2018/05/15/5af9b89e8bff8.png" alt="4.png"></p>
<h1 id="éœ€æ±‚é€‰æ‹©"><a href="#éœ€æ±‚é€‰æ‹©" class="headerlink" title="éœ€æ±‚é€‰æ‹©"></a>éœ€æ±‚é€‰æ‹©</h1><h2 id="Java-Interview"><a href="#Java-Interview" class="headerlink" title="Java-Interview"></a><a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">Java-Interview</a></h2><p>ä¹‹æ‰€ä»¥è¦åšè¿™ä¸ªé¡¹ç›®ä¸»è¦æ˜¯å½“æ—¶æˆ‘æ­£åœ¨é¢é˜¿é‡Œçš„ä¸¤ä¸ªéƒ¨é—¨ï¼Œéå¸¸å¹¸è¿çš„æ˜¯æŠ€æœ¯é¢éƒ½è¿‡äº†ã€‚å…¶ä¸­çš„è¿‡ç¨‹çœŸæ˜¯è®©æˆ‘å—ç›ŠåŒªæµ…æ›´æ˜¯å°è±¡æ·±åˆ»ï¼Œæ‰€ä»¥å°±æƒ³æŠŠæœŸé—´çš„é—®é¢˜è®°å½•ä¸‹æ¥ï¼ŒåŠ ä¸Šè‡ªå·±çš„ç†è§£å¸Œæœ›èƒ½å¯¹å…¶ä»–æœ‹å‹èµ·åˆ°å¸®åŠ©ã€‚</p>
<p>æ­£å¥½é‚£æ®µæ—¶é—´ä¹Ÿæ˜¯ä¼ è¯´ä¸­çš„<code>é‡‘ä¸‰é“¶å››</code>ï¼Œæ‰€ä»¥æ— å½¢ä¸­ä¹Ÿå«é¡ºåŠ¿è€Œä¸ºå§ğŸ˜ã€‚</p>
<a id="more"></a>
<h2 id="SSM"><a href="#SSM" class="headerlink" title="SSM"></a><a href="https://github.com/crossoverJie/SSM" target="_blank" rel="external">SSM</a></h2><p>è¿™ä¸ªé¡¹ç›®çš„å†å²å°±æ¯”è¾ƒæ‚ ä¹…äº†ï¼Œæˆ‘çœ‹äº†ä¸‹ç¬¬ä¸€æ¬¡æäº¤å·®ä¸å¤šæ˜¯ä¸¤å¹´å‰ã€‚</p>
<p>ä»è¿™ä¸ªåå­—ä¹Ÿå¯ä»¥çœ‹å‡ºå½“åˆè¿˜æ˜¯ä¸€ä¸ªåˆšå…¥è¡Œæ²¡å¤šä¹…çš„å°èœé¸Ÿï¼Œå› ä¸ºä¹‹å‰åœ¨å­¦ Java çš„æ—¶å€™çœŸçš„èµ°äº†å¾ˆå¤šå†¤æ‰è·¯ï¼Œæ‰€ä»¥ä»å¤´å¼€å§‹è®°å½•åˆ°ç°åœ¨æ•´ä¸ªè¿‡ç¨‹æ‰€å­¦åˆ°çš„ä¸œè¥¿ï¼Œè¸©è¿‡çš„å‘ã€‚</p>
<p>ç”±äºæ˜¯é¢å‘å°ç™½ï¼Œå…¥é—¨ç®€å•ï¼Œä¸Šæ‰‹è¾ƒå¿«ä¹Ÿå–çš„äº†ä¸€å®šçš„å…³æ³¨ã€‚</p>
<p>å…¶å®ä»è¿™ä¸¤ä¸ªé¡¹ç›®å¯ä»¥çœ‹å‡ºé€‰æ‹©ä¸€ä¸ª<strong>æ–¹å‘æ˜¯å¾ˆé‡è¦çš„</strong>ã€‚</p>
<p>ä»¥åŠè¯¥é¡¹ç›®è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œé•¿æœŸçš„è§„åˆ’ï¼Œå—ä¼—æ˜¯å“ªäº›éƒ½è¦è€ƒè™‘æ¸…æ¥š(æ€ä¹ˆæœ‰ç‚¹åƒåšäº§å“ğŸ˜…ï¼Œå…¶å®è¿™å°±æ˜¯ä½ è‡ªå·±çš„äº§å“)ã€‚</p>
<p>æ¯”å¦‚è¿™ä¸¤ä¸ªé¡¹ç›®çš„ç›®æ ‡ï¼š</p>
<ul>
<li>Java-Interviewï¼šæŒç»­æ›´æ–°é¢è¯•é—®é¢˜ï¼Œå¸Œæœ›èƒ½è®©é¢è¯•è€…çŸ¥å…¶ç„¶ä¹ŸçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</li>
<li>SSMï¼šåšä¸»ä»å°ç™½åˆ°ç°åœ¨å®é™…å¼€å‘æ‰€é‡åˆ°çš„é—®é¢˜è®°å½•ï¼Œä»¥åŠå®æˆ˜ç»éªŒï¼Œç°åœ¨é€æ¸ä¼šåˆ†äº«ä¸€äº›éš¾ç‚¹ä»¥åŠåº•å±‚ã€‚å—ä¼—å¤§å¤šæ˜¯å°ç™½ã€‚</li>
</ul>
<h1 id="æ–‡æ¡£å¾ˆé‡è¦"><a href="#æ–‡æ¡£å¾ˆé‡è¦" class="headerlink" title="æ–‡æ¡£å¾ˆé‡è¦"></a>æ–‡æ¡£å¾ˆé‡è¦</h1><p>æ—¢ç„¶é¡¹ç›®åšå‡ºæ¥æ˜¯ç»™äººç”¨çš„ï¼Œé‚£æ–‡æ¡£å°±æ˜¾å¾—è‡³å…³é‡è¦äº†ã€‚</p>
<p>å°±åƒæ—¥å¸¸å’Œå‰ç«¯æ€¼æ¥å£æ—¶ï¼Œæœ‰ä¸€ä¸ªæ ‡å‡†çš„æ–‡æ¡£è¾“å‡ºæ¯”åœ¨ç™½æ¿ä¸ŠæŠ˜è…¾åŠå¤©è¦é«˜çš„å¤šã€‚</p>
<p><img src="https://i.loli.net/2018/05/14/5af9491b5b119.png" alt="C0DA2F29-C334-46BC-8BED-14CD6B6C5349.png"></p>
<p>å…¶å®ä»”ç»†è§‚å¯Ÿ GitHub ä¸Šçƒ­é—¨çš„é¡¹ç›®ï¼Œä¼šå‘ç°ä»–ä»¬çš„æ–‡æ¡£å‡ ä¹éƒ½æœ‰ä¸€äº›å…±åŒç»“æ„ï¼š</p>
<ul>
<li>ç®€å•æè¿°é¡¹ç›®æ˜¯å¹²ä»€ä¹ˆçš„ã€‚</li>
<li>å¿«é€Ÿå¯åŠ¨ã€‚</li>
<li>æœ€è¿‘æ›´æ–°ã€‚</li>
<li>Q/A ç­”ç–‘ã€‚</li>
<li>é¡¹ç›®æˆªå›¾ã€‚</li>
</ul>
<p>ä¸»è¦ç›®çš„å°±æ˜¯è¦ç®€å•æ˜“è¯»ï¼Œå¿«é€Ÿä¸Šæ‰‹ã€‚</p>
<p>ç„¶åæŠŠä¸€äº›å¤æ‚çš„å¦‚ç³»ç»Ÿè®¾è®¡ã€å¼€å‘æŒ‡å—ç­‰å¯ä»¥æ”¾åˆ° wiki ä¸­ã€‚</p>
<blockquote>
<p>åˆ‡è®°ä¸è¦ä»€ä¹ˆä¸œè¥¿éƒ½å¾€ README.MD ä¸­å†™ï¼Œä¿æŒä¸€ä¸ªç®€æ´çš„æ–‡æ¡£å¯ä»¥åŠ åˆ†å“¦ã€‚</p>
</blockquote>
<p>å½“ç„¶ä¹Ÿå¯ä»¥åœ¨é¦–é¡µåŠ å…¥ä¸€äº›å¾½ç« å¦‚ï¼š</p>
<p><img src="https://i.loli.net/2018/05/15/5af9b66c55453.png" alt="3.png"></p>
<p>ä¹Ÿèƒ½èµ·åˆ°ä¸€äº›ç§¯æä½œç”¨ã€‚</p>
<h1 id="ç§¯ææ¨è"><a href="#ç§¯ææ¨è" class="headerlink" title="ç§¯ææ¨è"></a>ç§¯ææ¨è</h1><p>ä»£ç è´¨é‡è¿™ä¸ªå°±ä¸å¤šè¯´äº†ï¼Œè¿™åº”è¯¥æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ã€‚</p>
<p>ä¿—è¯è¯´ï¼šé…’é¦™ä¸æ€•å··å­æ·±ã€‚</p>
<p>ä½†å¯¹äºåšå¼€æºé¡¹ç›®æ¥è¯´å°±ä¸å¤ªé€‚åº”äº†ï¼Œå½“ä½ å¹¸è¾›è‹¦è‹¦åšäº†ä¸€ä¸ªè‡ªè®¤ä¸ºå¾ˆä¸é”™çš„é¡¹ç›®ï¼Œç»“æœä¸€å¹´è¿‡å»äº†éƒ½æ— äººé—®æ´¥ï¼Œè¿™ä¸å…ä¼šæœ‰ç‚¹æ‰“å‡»ç§¯ææ€§ã€‚</p>
<p>æ‰€ä»¥é€‚å½“çš„è‡ªæˆ‘æ¨èå°±å¾ˆæœ‰å¿…è¦äº†ã€‚</p>
<p><img src="https://i.loli.net/2018/05/14/5af94d4c99929.png" alt="7D819139-647F-43E3-9DB2-AB80A3E6BC7B.png"></p>
<p><img src="https://i.loli.net/2018/05/14/5af94dd69c3ef.jpg" alt="1.jpg"></p>
<p><img src="https://i.loli.net/2018/05/14/5af94ea82ab5d.png" alt="2.png"></p>
<p>ä¸Šå›¾æ˜¯æˆ‘åšå®¢ã€é¡¹ç›®çš„ä¸»è¦æµé‡æ¥æºã€‚</p>
<p>ä¸‹é¢æ˜¯æˆ‘è‡ªèº«ä½“éªŒæ¯”è¾ƒä¼˜è´¨çš„æ¨èæ¸ é“ï¼š</p>
<ul>
<li><a href="https://toutiao.io/u/257810/" target="_blank" rel="external">å¼€å‘è€…å¤´æ¡</a>ï¼šç”±äºæˆªå›¾çš„æ—¶å€™æ²¡æœ‰æ–°å‘æ–‡ç« ï¼Œä¹‹å‰é‚£ç¯‡<a href="https://toutiao.io/posts/zavy6s" target="_blank" rel="external">ç§’æ€æ¶æ„å®è·µ</a>å‘äº†ä¹‹ååšå®¢ 80% çš„æµé‡éƒ½æ˜¯ä»å¤´æ¡è¿‡æ¥çš„ï¼Œè€Œä¸”è´¨é‡å¾ˆé«˜ï¼Œä¸å¾—ä¸ç‚¹ä¸ªèµã€‚</li>
<li><a href="http://ifeve.com/author/crossoverjie/" target="_blank" rel="external">å¹¶å‘ç¼–ç¨‹ç½‘</a>: å¹¶å‘ç¼–ç¨‹ç½‘æ˜¯ç”±é˜¿é‡Œå¤§ç‰›æ¸…è‹±(ä¹°äº†é‚£æœ¬ã€Šå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹å°±è¢«åœˆç²‰äº†)åˆ›åŠçš„ï¼Œå…¶ä¸­çš„æ–‡ç« è´¨é‡æ™®éè¾ƒé«˜(å¯¼è‡´ä¹Ÿä¼šæœ‰ä¸€ç‚¹å†™ä½œé—¨æ§›)ã€‚ç”±äºç½‘ç«™çš„æµé‡ä¹Ÿæ¯”è¾ƒé«˜ï¼Œåªè¦ä½ çš„æ–‡ç« è´¨é‡ä¸é”™è‚¯å®šä¼šå¾—åˆ°å¥½å¤„ã€‚</li>
<li><a href="https://juejin.im/user/576d4aaf7db2a20054ea4544" target="_blank" rel="external">æ˜é‡‘</a>ï¼šæ˜é‡‘è¿™ä¸¤å¹´ä¹Ÿæ¯”è¾ƒç«ï¼Œæ˜¯ä¸“é—¨åšå¼€å‘è€…å†…å®¹çš„ï¼Œä¹Ÿæ˜¯ç½‘ç«™æµé‡ä¸é”™ã€‚</li>
<li><a href="https://my.oschina.net/crossoverjie/blog" target="_blank" rel="external">å¼€æºä¸­å›½</a>ï¼šå¼€æºä¸­å›½çš„åšå®¢ä¹Ÿä¸é”™ï¼Œè‡ªå·±ä¹Ÿæœ‰ä»£ç æ‰˜ç®¡ï¼Œä½†æˆ‘è¿˜æ˜¯æ›´å–œæ¬¢ç”¨ GitHubï¼Œä¸€èˆ¬ä¸Šäº†ç¼–è¾‘æ¨èéƒ½ä¼šæœ‰ä¸é”™çš„è®¿é—®é‡ã€‚</li>
<li><a href="https://www.v2ex.com/member/crossoverJie" target="_blank" rel="external">V2EX</a>ï¼šå¤§åé¼é¼çš„ V ç«™ï¼Œå…¶å®å—ä¼—è¾ƒå°‘ï¼Œæ­£å› ä¸ºå¦‚æ­¤ä¹Ÿå½¢æˆäº†ç‹¬æœ‰çš„æ–‡åŒ–ï¼Œå› æ­¤ä¹Ÿæ˜¯æˆ‘æ¯å¤©æ¯”é€›(æ‘¸é±¼)çš„ç½‘ç«™ï¼Œç”±äºå—ä¼—å¤§å¤šæ˜¯å¼€å‘è€…æ‰€ä»¥ä¹Ÿèƒ½å¾—åˆ°å¾ˆå¤šæœ‰ç”¨çš„åé¦ˆã€‚</li>
<li>å¤§ä½¬æ¨èï¼šæœ€å¿«æ·çš„æ–¹å¼å…¶å®å°±æ˜¯å£å£ç›¸ä¼ ï¼Œå…¶ä¸­å½“ç„¶æ˜¯å¤§ä½¬çš„æ•ˆç‡æœ€é«˜ã€‚ä¹‹å‰æœ‰ä¸ª<a href="http://www.ityouknow.com/" target="_blank" rel="external">çº¯æ´çš„å¾®ç¬‘</a>ã€<a href="http://blog.didispace.com/" target="_blank" rel="external">ç¨‹åºçŒ¿DD</a> éƒ½æŠ•è¿‡ç¨¿ï¼Œä¹Ÿèƒ½å¸¦æ¥ä¸é”™çš„æµé‡ã€‚</li>
<li><a href="https://www.jianshu.com/u/e2d07947c112" target="_blank" rel="external">ç®€ä¹¦</a>:æœ¬æ¥ä¸æƒ³æ¨èç®€ä¹¦çš„ï¼ˆä¹‹å‰çš„äº‹ä»¶ä»¥åŠç°åœ¨é¸¡æ±¤å¤ªå¤šï¼‰ï¼Œä½†æ˜¯æµé‡è¿˜å¯ä»¥ï¼Œç°åœ¨å°±çº¯ç²¹å½“åšåšå®¢å¤‡ä»½çš„å·¥å…·äº†ã€‚</li>
</ul>
<blockquote>
<p>åšæŒä¸‹æ¥ä¹‹åä¼šå‘ç°ï¼šåªè¦è‡ªå·±åšæŒã€ä¿è¯è´¨é‡æœ€åä¼šå½¢æˆè‡ªå·±çš„é˜…è¯»åœˆå­ï¼Œåˆ°åé¢ç”šè‡³ä¼šæœ‰å…¶ä»–æœ‹å‹ä¸»åŠ¨æ¥æ‰¾ä½ åˆ†äº«ï¼Œè¿™äº›éƒ½æ˜¯è‡ªæˆ‘æå‡çš„è¿‡ç¨‹ã€‚</p>
</blockquote>
<h1 id="ä¸å¿˜åˆå¿ƒ"><a href="#ä¸å¿˜åˆå¿ƒ" class="headerlink" title="ä¸å¿˜åˆå¿ƒ"></a>ä¸å¿˜åˆå¿ƒ</h1><p>å½“åˆåšçš„ç¬¬ä¸€ä¸ªå¼€æºé¡¹ç›®å°±æ˜¯ <a href="https://github.com/crossoverJie/SSM" target="_blank" rel="external">SSM</a>ï¼Œå®Œå…¨å—å¤Ÿå­¦ä¹ æ—¶æ‰¾èµ„æ–™çš„ç—›è‹¦ï¼Œä¹Ÿå¾—åˆ°äº†å¾ˆå¤šäººçš„å¸®åŠ©ï¼Œæ‰€ä»¥æ‰æœ‰äº†è¯¥é¡¹ç›®ã€‚</p>
<p>å¹³æ—¶å·¥ä½œä¸­æˆ–å¤šæˆ–å°‘éƒ½ä¼šç”¨åˆ°å¼€æºé¡¹ç›®ï¼Œå…¶å®æˆ‘ä»¬å¤§éƒ¨åˆ†äººä¹Ÿå†™ä¸å‡º Springã€Guava è¿™æ ·çš„é¡¹ç›®ï¼Œåªæ˜¯å†è¿™è¿‡ç¨‹ä¸­å¯ä»¥å‚ä¸è¿›å»ï¼Œæ”¶è·ä¹Ÿæ˜¯éå¸¸ä¸°å¯Œçš„ã€‚</p>
<p>ä¸¤å¹´å‰å‚ä¸å¼€æºåˆ°ç°åœ¨æœ‰æ”¶åˆ°é¢è¯•é‚€è¯·ã€ç‰©è´¨å¥–åŠ±è¿™äº›éƒ½æ˜¯æ­£é¢ç§¯æçš„ï¼Œå¯ä»¥é¼“åŠ±æˆ‘ä»¬æ¥ç€åšä¸‹å»ã€‚</p>
<p>ä½†æœ€å¤šçš„è¿˜æ˜¯åœ¨è¿™è¿‡ç¨‹ä¸­ç»“è¯†äº†å¾ˆå¤šæœ‹å‹ï¼ŒæŠ€æœ¯èƒ½åŠ›æå‡ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œè¿™äº›éƒ½æ˜¯ä¿æŒè‡ªæˆ‘å¯æŒç»­å‘å±•çš„å¿…è¦æ¡ä»¶ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://i.loli.net/2018/05/14/5af935ddc27e1.jpg&quot; alt=&quot;alarm-clock-art-background-1037993.jpg&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;é¦–å…ˆæ ‡é¢˜å…šä¸€ä¸‹ï¼Œå…¶å®è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯è®°å½•æˆ‘çš„ç¬¬äºŒä¸ªè¿‡ &lt;code&gt;1K star&lt;/code&gt; çš„é¡¹ç›® &lt;a href=&quot;https://github.com/crossoverJie/Java-Interview&quot;&gt;Java-Interview&lt;/a&gt;ï¼Œé¡ºä¾¿åˆ†äº«ä¸‹å…¶ä¸­çš„è¿‡ç¨‹åŠç»éªŒã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2018/05/15/5af9b89e8bff8.png&quot; alt=&quot;4.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;éœ€æ±‚é€‰æ‹©&quot;&gt;&lt;a href=&quot;#éœ€æ±‚é€‰æ‹©&quot; class=&quot;headerlink&quot; title=&quot;éœ€æ±‚é€‰æ‹©&quot;&gt;&lt;/a&gt;éœ€æ±‚é€‰æ‹©&lt;/h1&gt;&lt;h2 id=&quot;Java-Interview&quot;&gt;&lt;a href=&quot;#Java-Interview&quot; class=&quot;headerlink&quot; title=&quot;Java-Interview&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://github.com/crossoverJie/Java-Interview&quot;&gt;Java-Interview&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;ä¹‹æ‰€ä»¥è¦åšè¿™ä¸ªé¡¹ç›®ä¸»è¦æ˜¯å½“æ—¶æˆ‘æ­£åœ¨é¢é˜¿é‡Œçš„ä¸¤ä¸ªéƒ¨é—¨ï¼Œéå¸¸å¹¸è¿çš„æ˜¯æŠ€æœ¯é¢éƒ½è¿‡äº†ã€‚å…¶ä¸­çš„è¿‡ç¨‹çœŸæ˜¯è®©æˆ‘å—ç›ŠåŒªæµ…æ›´æ˜¯å°è±¡æ·±åˆ»ï¼Œæ‰€ä»¥å°±æƒ³æŠŠæœŸé—´çš„é—®é¢˜è®°å½•ä¸‹æ¥ï¼ŒåŠ ä¸Šè‡ªå·±çš„ç†è§£å¸Œæœ›èƒ½å¯¹å…¶ä»–æœ‹å‹èµ·åˆ°å¸®åŠ©ã€‚&lt;/p&gt;
&lt;p&gt;æ­£å¥½é‚£æ®µæ—¶é—´ä¹Ÿæ˜¯ä¼ è¯´ä¸­çš„&lt;code&gt;é‡‘ä¸‰é“¶å››&lt;/code&gt;ï¼Œæ‰€ä»¥æ— å½¢ä¸­ä¹Ÿå«é¡ºåŠ¿è€Œä¸ºå§ğŸ˜ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="å°æŠ€å·§" scheme="http://crossoverjie.top/categories/%E5%B0%8F%E6%8A%80%E5%B7%A7/"/>
    
    
      <category term="GitHub" scheme="http://crossoverjie.top/tags/GitHub/"/>
    
  </entry>
  
  <entry>
    <title>SSM(åå…«) ç§’æ€æ¶æ„å®è·µ</title>
    <link href="http://crossoverjie.top/2018/05/07/ssm/SSM18-seconds-kill/"/>
    <id>http://crossoverjie.top/2018/05/07/ssm/SSM18-seconds-kill/</id>
    <published>2018-05-06T17:12:54.000Z</published>
    <updated>2018-05-07T18:28:27.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fr1z9k79lrj31kw11zwt8.jpg" alt=""></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰åœ¨ <a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/Spike.md" target="_blank" rel="external">Java-Interview</a> ä¸­æåˆ°è¿‡ç§’æ€æ¶æ„çš„è®¾è®¡ï¼Œè¿™æ¬¡åŸºäºå…¶ä¸­çš„ç†è®ºç®€å•å®ç°äº†ä¸€ä¸‹ã€‚</p>
<blockquote>
<p>æœ¬æ¬¡é‡‡ç”¨å¾ªåºæ¸è¿›çš„æ–¹å¼é€æ­¥æé«˜æ€§èƒ½è¾¾åˆ°å¹¶å‘ç§’æ€çš„æ•ˆæœï¼Œæ–‡ç« è¾ƒé•¿è¯·å‡†å¤‡å¥½ç“œå­æ¿å‡³(liushuizhangğŸ˜‚)ã€‚</p>
</blockquote>
<p>æœ¬æ–‡æ‰€æœ‰æ¶‰åŠçš„ä»£ç ï¼š</p>
<ul>
<li><a href="https://github.com/crossoverJie/SSM" target="_blank" rel="external">https://github.com/crossoverJie/SSM</a></li>
<li><a href="https://github.com/crossoverJie/distributed-redis-tool" target="_blank" rel="external">https://github.com/crossoverJie/distributed-redis-tool</a></li>
</ul>
<p>æœ€ç»ˆæ¶æ„å›¾ï¼š</p>
<p><img src="https://i.loli.net/2018/05/08/5af079ea8618b.png" alt="ç³»ç»Ÿæ¶æ„è®¾è®¡.png"></p>
<a id="more"></a>
<p>å…ˆç®€å•æ ¹æ®è¿™ä¸ªå›¾è°ˆä¸‹è¯·æ±‚çš„æµè½¬ï¼Œå› ä¸ºåé¢ä¸ç®¡æ€ä¹ˆæ”¹è¿›è¿™ä¸ªéƒ½æ˜¯æ²¡æœ‰å˜çš„ã€‚</p>
<ul>
<li>å‰ç«¯è¯·æ±‚è¿›å…¥ <code>web</code> å±‚ï¼Œå¯¹åº”çš„ä»£ç å°±æ˜¯ <code>controller</code>ã€‚</li>
<li>ä¹‹åå°†çœŸæ­£çš„åº“å­˜æ ¡éªŒã€ä¸‹å•ç­‰è¯·æ±‚å‘å¾€ <code>Service</code> å±‚ï¼ˆå…¶ä¸­ RPC è°ƒç”¨ä¾ç„¶é‡‡ç”¨çš„ <code>dubbo</code>ï¼Œåªæ˜¯æ›´æ–°ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œæœ¬æ¬¡ä¸ä¼šè¿‡å¤šè®¨è®º dubbo ç›¸å…³çš„ç»†èŠ‚ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æŸ¥çœ‹ <a href="https://crossoverjie.top/%2F2017%2F04%2F07%2FSSM11%2F">åŸºäºdubboçš„åˆ†å¸ƒå¼æ¶æ„</a>ï¼‰ã€‚</li>
<li><code>Service</code> å±‚å†å¯¹æ•°æ®è¿›è¡Œè½åœ°ï¼Œä¸‹å•å®Œæˆã€‚</li>
</ul>
<h2 id="æ— é™åˆ¶"><a href="#æ— é™åˆ¶" class="headerlink" title="æ— é™åˆ¶"></a>æ— é™åˆ¶</h2><p>å…¶å®æŠ›å¼€ç§’æ€è¿™ä¸ªåœºæ™¯æ¥è¯´æ­£å¸¸çš„ä¸€ä¸ªä¸‹å•æµç¨‹å¯ä»¥ç®€å•åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p>
<ul>
<li>æ ¡éªŒåº“å­˜</li>
<li>æ‰£åº“å­˜</li>
<li>åˆ›å»ºè®¢å•</li>
<li>æ”¯ä»˜</li>
</ul>
<p>åŸºäºä¸Šæ–‡çš„æ¶æ„æ‰€ä»¥æˆ‘ä»¬æœ‰äº†ä»¥ä¸‹å®ç°ï¼š</p>
<p>å…ˆçœ‹çœ‹å®é™…é¡¹ç›®çš„ç»“æ„ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fr38jkau5kj30jk07a754.jpg" alt=""></p>
<p>è¿˜æ˜¯å’Œä»¥å‰ä¸€æ ·ï¼š</p>
<ul>
<li>æä¾›å‡ºä¸€ä¸ª <code>API</code> ç”¨äº <code>Service</code> å±‚å®ç°ï¼Œä»¥åŠ <code>web</code> å±‚æ¶ˆè´¹ã€‚</li>
<li>web å±‚ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ª <code>SpringMVC</code>ã€‚</li>
<li><code>Service</code> å±‚åˆ™æ˜¯çœŸæ­£çš„æ•°æ®è½åœ°ã€‚</li>
<li><code>SSM-SECONDS-KILL-ORDER-CONSUMER</code> åˆ™æ˜¯åæ–‡ä¼šæåˆ°çš„ <code>Kafka</code> æ¶ˆè´¹ã€‚</li>
</ul>
<p>æ•°æ®åº“ä¹Ÿæ˜¯åªæœ‰ç®€å•çš„ä¸¤å¼ è¡¨æ¨¡æ‹Ÿä¸‹å•ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`stock`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'åç§°'</span>,</div><div class="line">  <span class="string">`count`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'åº“å­˜'</span>,</div><div class="line">  <span class="string">`sale`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'å·²å”®'</span>,</div><div class="line">  <span class="string">`version`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'ä¹è§‚é”ï¼Œç‰ˆæœ¬å·'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`stock_order`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`sid`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'åº“å­˜ID'</span>,</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'å•†å“åç§°'</span>,</div><div class="line">  <span class="string">`create_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'åˆ›å»ºæ—¶é—´'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">55</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>
<p>web å±‚ <code>controller</code> å®ç°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="keyword">private</span> StockService stockService;</div><div class="line"></div><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="keyword">private</span> OrderService orderService;</div><div class="line"></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/createWrongOrder/&#123;sid&#125;"</span>)</div><div class="line"><span class="meta">@ResponseBody</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">createWrongOrder</span><span class="params">(@PathVariable <span class="keyword">int</span> sid)</span> </span>&#123;</div><div class="line">    logger.info(<span class="string">"sid=[&#123;&#125;]"</span>, sid);</div><div class="line">    <span class="keyword">int</span> id = <span class="number">0</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        id = orderService.createWrongOrder(sid);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logger.error(<span class="string">"Exception"</span>,e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> String.valueOf(id);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ web ä½œä¸ºä¸€ä¸ªæ¶ˆè´¹è€…è°ƒç”¨çœ‹ <code>OrderService</code> æä¾›å‡ºæ¥çš„ dubbo æœåŠ¡ã€‚</p>
<p>Service å±‚ï¼Œ<code>OrderService</code> å®ç°ï¼š</p>
<p>é¦–å…ˆæ˜¯å¯¹ API çš„å®ç°(ä¼šåœ¨ API æä¾›å‡ºæ¥å£)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span>(name = <span class="string">"DBOrderService"</span>)</div><div class="line">    <span class="keyword">private</span> com.crossoverJie.seconds.kill.service.OrderService orderService ;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createWrongOrder</span><span class="params">(<span class="keyword">int</span> sid)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">return</span> orderService.createWrongOrder(sid);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œåªæ˜¯ç®€å•è°ƒç”¨äº† <code>DBOrderService</code> ä¸­çš„å®ç°ï¼ŒDBOrderService æ‰æ˜¯çœŸæ­£çš„æ•°æ®è½åœ°ï¼Œä¹Ÿå°±æ˜¯å†™æ•°æ®åº“äº†ã€‚</p>
<p>DBOrderService å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">Transactional(rollbackFor = Exception.class)</div><div class="line"><span class="meta">@Service</span>(value = <span class="string">"DBOrderService"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</div><div class="line">    <span class="meta">@Resource</span>(name = <span class="string">"DBStockService"</span>)</div><div class="line">    <span class="keyword">private</span> com.crossoverJie.seconds.kill.service.StockService stockService;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> StockOrderMapper orderMapper;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createWrongOrder</span><span class="params">(<span class="keyword">int</span> sid)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//æ ¡éªŒåº“å­˜</span></div><div class="line">        Stock stock = checkStock(sid);</div><div class="line"></div><div class="line">        <span class="comment">//æ‰£åº“å­˜</span></div><div class="line">        saleStock(stock);</div><div class="line"></div><div class="line">        <span class="comment">//åˆ›å»ºè®¢å•</span></div><div class="line">        <span class="keyword">int</span> id = createOrder(stock);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> Stock <span class="title">checkStock</span><span class="params">(<span class="keyword">int</span> sid)</span> </span>&#123;</div><div class="line">        Stock stock = stockService.getStockById(sid);</div><div class="line">        <span class="keyword">if</span> (stock.getSale().equals(stock.getCount())) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"åº“å­˜ä¸è¶³"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> stock;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">saleStock</span><span class="params">(Stock stock)</span> </span>&#123;</div><div class="line">        stock.setSale(stock.getSale() + <span class="number">1</span>);</div><div class="line">        <span class="keyword">return</span> stockService.updateStockById(stock);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createOrder</span><span class="params">(Stock stock)</span> </span>&#123;</div><div class="line">        StockOrder order = <span class="keyword">new</span> StockOrder();</div><div class="line">        order.setSid(stock.getId());</div><div class="line">        order.setName(stock.getName());</div><div class="line">        <span class="keyword">int</span> id = orderMapper.insertSelective(order);</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;        </div><div class="line">        </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p> é¢„å…ˆåˆå§‹åŒ–äº† 10 æ¡åº“å­˜ã€‚</p>
</blockquote>
<p>æ‰‹åŠ¨è°ƒç”¨ä¸‹ <code>createWrongOrder/1</code> æ¥å£å‘ç°ï¼š</p>
<p>åº“å­˜è¡¨ï¼š<br><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fr38x4wqhcj30g404ajrg.jpg" alt=""></p>
<p>è®¢å•è¡¨ï¼š<br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fr38xpcdn7j30f0040glq.jpg" alt=""></p>
<p>ä¸€åˆ‡çœ‹èµ·æ¥éƒ½æ²¡æœ‰é—®é¢˜ï¼Œæ•°æ®ä¹Ÿæ­£å¸¸ã€‚</p>
<p>ä½†æ˜¯å½“ç”¨ <code>JMeter</code> å¹¶å‘æµ‹è¯•æ—¶ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fr391hontsj31ge0b8dgt.jpg" alt=""></p>
<p>æµ‹è¯•é…ç½®æ˜¯ï¼š300ä¸ªçº¿ç¨‹å¹¶å‘ï¼Œæµ‹è¯•ä¸¤è½®æ¥çœ‹çœ‹æ•°æ®åº“ä¸­çš„ç»“æœï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fr393xxc0rj31ge0463z6.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fr3939yo1bj30c4062t8s.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fr393pxvf3j30j60d60v4.jpg" alt=""></p>
<p>è¯·æ±‚éƒ½å“åº”æˆåŠŸï¼Œåº“å­˜ç¡®å®ä¹Ÿæ‰£å®Œäº†ï¼Œä½†æ˜¯è®¢å•å´ç”Ÿæˆäº† <strong>124</strong> æ¡è®°å½•ã€‚</p>
<p>è¿™æ˜¾ç„¶æ˜¯å…¸å‹çš„è¶…å–ç°è±¡ã€‚</p>
<blockquote>
<p>å…¶å®ç°åœ¨å†å»æ‰‹åŠ¨è°ƒç”¨æ¥å£ä¼šè¿”å›åº“å­˜ä¸è¶³ï¼Œä½†ä¸ºæ—¶æ™šçŸ£ã€‚</p>
</blockquote>
<h2 id="ä¹è§‚é”æ›´æ–°"><a href="#ä¹è§‚é”æ›´æ–°" class="headerlink" title="ä¹è§‚é”æ›´æ–°"></a>ä¹è§‚é”æ›´æ–°</h2><p>æ€ä¹ˆæ¥é¿å…ä¸Šè¿°çš„ç°è±¡å‘¢ï¼Ÿ</p>
<p>æœ€ç®€å•çš„åšæ³•è‡ªç„¶æ˜¯ä¹è§‚é”äº†ï¼Œè¿™é‡Œä¸è¿‡å¤šè®¨è®ºè¿™ä¸ªï¼Œä¸ç†Ÿæ‚‰çš„æœ‹å‹å¯ä»¥çœ‹ä¸‹<a href="http://crossoverjie.top/%2F2017%2F07%2F09%2FSSM15%2F">è¿™ç¯‡</a>ã€‚</p>
<p>æ¥çœ‹çœ‹å…·ä½“å®ç°ï¼š</p>
<blockquote>
<p>å…¶å®å…¶ä»–çš„éƒ½æ²¡æ€ä¹ˆæ”¹ï¼Œä¸»è¦æ˜¯ Service å±‚ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createOptimisticOrder</span><span class="params">(<span class="keyword">int</span> sid)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//æ ¡éªŒåº“å­˜</span></div><div class="line">    Stock stock = checkStock(sid);</div><div class="line"></div><div class="line">    <span class="comment">//ä¹è§‚é”æ›´æ–°åº“å­˜</span></div><div class="line">    saleStockOptimistic(stock);</div><div class="line"></div><div class="line">    <span class="comment">//åˆ›å»ºè®¢å•</span></div><div class="line">    <span class="keyword">int</span> id = createOrder(stock);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saleStockOptimistic</span><span class="params">(Stock stock)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> count = stockService.updateStockByOptimistic(stock);</div><div class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"å¹¶å‘æ›´æ–°åº“å­˜å¤±è´¥"</span>) ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹åº”çš„ XMLï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateByOptimistic"</span> <span class="attr">parameterType</span>=<span class="string">"com.crossoverJie.seconds.kill.pojo.Stock"</span>&gt;</span></div><div class="line">    update stock</div><div class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></div><div class="line">        sale = sale + 1,</div><div class="line">        version = version + 1,</div><div class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></div><div class="line"></div><div class="line">    WHERE id = #&#123;id,jdbcType=INTEGER&#125;</div><div class="line">    AND version = #&#123;version,jdbcType=INTEGER&#125;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></div></pre></td></tr></table></figure>
<p>åŒæ ·çš„æµ‹è¯•æ¡ä»¶ï¼Œæˆ‘ä»¬å†è¿›è¡Œä¸Šé¢çš„æµ‹è¯• <code>/createOptimisticOrder/1</code>ï¼š</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fr39fxn691j31g603adgg.jpg" alt=""></p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fr39dlobs1j30ca042wej.jpg" alt=""></p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fr39dwfmrzj30f60gqgn7.jpg" alt=""></p>
<p>è¿™æ¬¡å‘ç°æ— è®ºæ˜¯åº“å­˜è®¢å•éƒ½æ˜¯ OK çš„ã€‚</p>
<p>æŸ¥çœ‹æ—¥å¿—å‘ç°ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fr39hxcbsgj31kw0jhu0y.jpg" alt=""></p>
<p>å¾ˆå¤šå¹¶å‘è¯·æ±‚ä¼šå“åº”é”™è¯¯ï¼Œè¿™å°±è¾¾åˆ°äº†æ•ˆæœã€‚</p>
<h3 id="æé«˜ååé‡"><a href="#æé«˜ååé‡" class="headerlink" title="æé«˜ååé‡"></a>æé«˜ååé‡</h3><p>ä¸ºäº†è¿›ä¸€æ­¥æé«˜ç§’æ€æ—¶çš„ååé‡ä»¥åŠå“åº”æ•ˆç‡ï¼Œè¿™é‡Œçš„ web å’Œ Service éƒ½è¿›è¡Œäº†æ¨ªå‘æ‰©å±•ã€‚</p>
<ul>
<li>web åˆ©ç”¨ Nginx è¿›è¡Œè´Ÿè½½ã€‚</li>
<li>Service ä¹Ÿæ˜¯å¤šå°åº”ç”¨ã€‚</li>
</ul>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fr39lm8iyjj31kw0ad784.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fr39lvxnunj31kw0adaeh.jpg" alt=""></p>
<p>å†ç”¨ JMeter æµ‹è¯•æ—¶å¯ä»¥ç›´è§‚çš„çœ‹åˆ°æ•ˆæœã€‚</p>
<blockquote>
<p>ç”±äºæˆ‘æ˜¯åœ¨é˜¿é‡Œäº‘çš„ä¸€å°å°æ°´ç®¡æœåŠ¡å™¨è¿›è¡Œæµ‹è¯•çš„ï¼ŒåŠ ä¸Šé…ç½®ä¸é«˜ã€åº”ç”¨éƒ½åœ¨åŒä¸€å°ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å®Œå…¨ä½“ç°å‡ºæ€§èƒ½ä¸Šçš„ä¼˜åŠ¿ï¼ˆ <code>Nginx</code> åšè´Ÿè½½è½¬å‘æ—¶å€™ä¹Ÿä¼šå¢åŠ é¢å¤–çš„ç½‘ç»œæ¶ˆè€—ï¼‰ã€‚</p>
</blockquote>
<h3 id="shell-è„šæœ¬å®ç°ç®€å•çš„-CI"><a href="#shell-è„šæœ¬å®ç°ç®€å•çš„-CI" class="headerlink" title="shell è„šæœ¬å®ç°ç®€å•çš„ CI"></a>shell è„šæœ¬å®ç°ç®€å•çš„ CI</h3><p>ç”±äºåº”ç”¨å¤šå°éƒ¨ç½²ä¹‹åï¼Œæ‰‹åŠ¨å‘ç‰ˆæµ‹è¯•çš„ç—›è‹¦ç›¸ä¿¡ç»å†è¿‡çš„éƒ½æœ‰ä½“ä¼šã€‚</p>
<p>è¿™æ¬¡å¹¶æ²¡æœ‰ç²¾åŠ›å»æ­å»ºå®Œæ•´çš„ CI CDï¼Œåªæ˜¯å†™äº†ä¸€ä¸ªç®€å•çš„è„šæœ¬å®ç°äº†è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå¸Œæœ›å¯¹è¿™æ–¹é¢æ²¡æœ‰ç»éªŒçš„åŒå­¦å¸¦æ¥ä¸€ç‚¹å¯å‘ï¼š</p>
<h4 id="æ„å»º-web"><a href="#æ„å»º-web" class="headerlink" title="æ„å»º web"></a>æ„å»º web</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"></div><div class="line"># æ„å»º web æ¶ˆè´¹è€…</div><div class="line"></div><div class="line">#read appname</div><div class="line"></div><div class="line">appname=&quot;consumer&quot;</div><div class="line">echo &quot;input=&quot;$appname</div><div class="line"></div><div class="line">PID=$(ps -ef | grep $appname | grep -v grep | awk &apos;&#123;print $2&#125;&apos;)</div><div class="line"></div><div class="line"># éå†æ€æ‰ pid</div><div class="line">for var in $&#123;PID[@]&#125;;</div><div class="line">do</div><div class="line">    echo &quot;loop pid= $var&quot;</div><div class="line">    kill -9 $var</div><div class="line">done</div><div class="line"></div><div class="line">echo &quot;kill $appname success&quot;</div><div class="line"></div><div class="line">cd ..</div><div class="line"></div><div class="line">git pull</div><div class="line"></div><div class="line">cd SSM-SECONDS-KILL</div><div class="line"></div><div class="line">mvn -Dmaven.test.skip=true clean package</div><div class="line"></div><div class="line">echo &quot;build war success&quot;</div><div class="line"></div><div class="line">cp /home/crossoverJie/SSM/SSM-SECONDS-KILL/SSM-SECONDS-KILL-WEB/target/SSM-SECONDS-KILL-WEB-2.2.0-SNAPSHOT.war /home/crossoverJie/tomcat/tomcat-dubbo-consumer-8083/webapps</div><div class="line">echo &quot;cp tomcat-dubbo-consumer-8083/webapps ok!&quot;</div><div class="line"></div><div class="line">cp /home/crossoverJie/SSM/SSM-SECONDS-KILL/SSM-SECONDS-KILL-WEB/target/SSM-SECONDS-KILL-WEB-2.2.0-SNAPSHOT.war /home/crossoverJie/tomcat/tomcat-dubbo-consumer-7083-slave/webapps</div><div class="line">echo &quot;cp tomcat-dubbo-consumer-7083-slave/webapps ok!&quot;</div><div class="line"></div><div class="line">sh /home/crossoverJie/tomcat/tomcat-dubbo-consumer-8083/bin/startup.sh</div><div class="line">echo &quot;tomcat-dubbo-consumer-8083/bin/startup.sh success&quot;</div><div class="line"></div><div class="line">sh /home/crossoverJie/tomcat/tomcat-dubbo-consumer-7083-slave/bin/startup.sh</div><div class="line">echo &quot;tomcat-dubbo-consumer-7083-slave/bin/startup.sh success&quot;</div><div class="line"></div><div class="line">echo &quot;start $appname success&quot;</div></pre></td></tr></table></figure>
<h4 id="æ„å»º-Service"><a href="#æ„å»º-Service" class="headerlink" title="æ„å»º Service"></a>æ„å»º Service</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"># æ„å»ºæœåŠ¡æä¾›è€…</div><div class="line"></div><div class="line">#read appname</div><div class="line"></div><div class="line">appname=&quot;provider&quot;</div><div class="line"></div><div class="line">echo &quot;input=&quot;$appname</div><div class="line"></div><div class="line"></div><div class="line">PID=$(ps -ef | grep $appname | grep -v grep | awk &apos;&#123;print $2&#125;&apos;)</div><div class="line"></div><div class="line">#if [ $? -eq 0 ]; then</div><div class="line">#    echo &quot;process id:$PID&quot;</div><div class="line">#else</div><div class="line">#    echo &quot;process $appname not exit&quot;</div><div class="line">#    exit</div><div class="line">#fi</div><div class="line"></div><div class="line"># éå†æ€æ‰ pid</div><div class="line">for var in $&#123;PID[@]&#125;;</div><div class="line">do</div><div class="line">    echo &quot;loop pid= $var&quot;</div><div class="line">    kill -9 $var</div><div class="line">done</div><div class="line"></div><div class="line">echo &quot;kill $appname success&quot;</div><div class="line"></div><div class="line"></div><div class="line">cd ..</div><div class="line"></div><div class="line">git pull</div><div class="line"></div><div class="line">cd SSM-SECONDS-KILL</div><div class="line"></div><div class="line">mvn -Dmaven.test.skip=true clean package</div><div class="line"></div><div class="line">echo &quot;build war success&quot;</div><div class="line"></div><div class="line">cp /home/crossoverJie/SSM/SSM-SECONDS-KILL/SSM-SECONDS-KILL-SERVICE/target/SSM-SECONDS-KILL-SERVICE-2.2.0-SNAPSHOT.war /home/crossoverJie/tomcat/tomcat-dubbo-provider-8080/webapps</div><div class="line"></div><div class="line">echo &quot;cp tomcat-dubbo-provider-8080/webapps ok!&quot;</div><div class="line"></div><div class="line">cp /home/crossoverJie/SSM/SSM-SECONDS-KILL/SSM-SECONDS-KILL-SERVICE/target/SSM-SECONDS-KILL-SERVICE-2.2.0-SNAPSHOT.war /home/crossoverJie/tomcat/tomcat-dubbo-provider-7080-slave/webapps</div><div class="line"></div><div class="line">echo &quot;cp tomcat-dubbo-provider-7080-slave/webapps ok!&quot;</div><div class="line"></div><div class="line">sh /home/crossoverJie/tomcat/tomcat-dubbo-provider-8080/bin/startup.sh</div><div class="line">echo &quot;tomcat-dubbo-provider-8080/bin/startup.sh success&quot;</div><div class="line"></div><div class="line">sh /home/crossoverJie/tomcat/tomcat-dubbo-provider-7080-slave/bin/startup.sh</div><div class="line">echo &quot;tomcat-dubbo-provider-8080/bin/startup.sh success&quot;</div><div class="line"></div><div class="line">echo &quot;start $appname success&quot;</div></pre></td></tr></table></figure>
<p>ä¹‹åæ¯å½“æˆ‘æœ‰æ›´æ–°ï¼Œåªéœ€è¦æ‰§è¡Œè¿™ä¸¤ä¸ªè„šæœ¬å°±å¯ä»¥å¸®æˆ‘è‡ªåŠ¨æ„å»ºã€‚</p>
<p>éƒ½æ˜¯æœ€åŸºç¡€çš„ Linux å‘½ä»¤ï¼Œç›¸ä¿¡å¤§å®¶éƒ½çœ‹å¾—æ˜ç™½ã€‚</p>
<h2 id="ä¹è§‚é”æ›´æ–°-åˆ†å¸ƒå¼é™æµ"><a href="#ä¹è§‚é”æ›´æ–°-åˆ†å¸ƒå¼é™æµ" class="headerlink" title="ä¹è§‚é”æ›´æ–° + åˆ†å¸ƒå¼é™æµ"></a>ä¹è§‚é”æ›´æ–° + åˆ†å¸ƒå¼é™æµ</h2><p>ä¸Šæ–‡çš„ç»“æœçœ‹ä¼¼æ²¡æœ‰é—®é¢˜ï¼Œå…¶å®è¿˜å·®å¾—è¿œå‘¢ã€‚</p>
<p>è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿäº† 300 ä¸ªå¹¶å‘æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å½“è¯·æ±‚è¾¾åˆ°äº† 3000 ï¼Œ3Wï¼Œ300W å‘¢ï¼Ÿ</p>
<p>è™½è¯´å¯ä»¥æ¨ªå‘æ‰©å±•å¯ä»¥æ”¯æ’‘æ›´å¤šçš„è¯·æ±‚ã€‚</p>
<p>ä½†æ˜¯èƒ½ä¸èƒ½åˆ©ç”¨æœ€å°‘çš„èµ„æºè§£å†³é—®é¢˜å‘¢ï¼Ÿ</p>
<p>å…¶å®ä»”ç»†åˆ†æä¸‹ä¼šå‘ç°ï¼š</p>
<blockquote>
<p>å‡è®¾æˆ‘çš„å•†å“ä¸€å…±åªæœ‰ 10 ä¸ªåº“å­˜ï¼Œé‚£ä¹ˆæ— è®ºä½ å¤šå°‘äººæ¥ä¹°å…¶å®æœ€ç»ˆä¹Ÿæœ€å¤šåªæœ‰ 10 äººå¯ä»¥ä¸‹å•æˆåŠŸã€‚</p>
</blockquote>
<p>æ‰€ä»¥å…¶ä¸­ä¼šæœ‰ <code>99%</code> çš„è¯·æ±‚éƒ½æ˜¯æ— æ•ˆçš„ã€‚</p>
<p>å¤§å®¶éƒ½çŸ¥é“ï¼šå¤§å¤šæ•°åº”ç”¨æ•°æ®åº“éƒ½æ˜¯å‹å€’éª†é©¼çš„æœ€åä¸€æ ¹ç¨»è‰ã€‚</p>
<p>é€šè¿‡ <code>Druid</code> çš„ç›‘æ§æ¥çœ‹çœ‹ä¹‹å‰è¯·æ±‚æ•°æ®åº“çš„æƒ…å†µï¼š</p>
<p>å› ä¸º Service æ˜¯ä¸¤ä¸ªåº”ç”¨ã€‚<br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fr3a1zpp5lj31kw0h277s.jpg" alt=""></p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fr3a2c0vvdj31kw0g4n0m.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fr3a3xwslqj319g10cthl.jpg" alt=""></p>
<p>æ•°æ®åº“ä¹Ÿæœ‰ 20 å¤šä¸ªè¿æ¥ã€‚</p>
<p>æ€ä¹ˆæ ·æ¥ä¼˜åŒ–å‘¢ï¼Ÿ<br>å…¶å®å¾ˆå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯<a href="http://crossoverjie.top/2018/04/28/sbc/sbc7-Distributed-Limit/">åˆ†å¸ƒå¼é™æµ</a>ã€‚</p>
<p>æˆ‘ä»¬å°†å¹¶å‘æ§åˆ¶åœ¨ä¸€ä¸ªå¯æ§çš„èŒƒå›´ä¹‹å†…ï¼Œç„¶åå¿«é€Ÿå¤±è´¥è¿™æ ·å°±èƒ½æœ€å¤§ç¨‹åº¦çš„ä¿æŠ¤ç³»ç»Ÿã€‚</p>
<h3 id="distributed-redis-tool-â¬†ï¸v1-0-3"><a href="#distributed-redis-tool-â¬†ï¸v1-0-3" class="headerlink" title="distributed-redis-tool â¬†ï¸v1.0.3"></a>distributed-redis-tool â¬†ï¸v1.0.3</h3><p>ä¸ºæ­¤è¿˜å¯¹ <a href="https://github.com/crossoverJie/distributed-redis-tool" target="_blank" rel="external">https://github.com/crossoverJie/distributed-redis-tool</a> è¿›è¡Œäº†å°å°çš„å‡çº§ã€‚</p>
<p>å› ä¸ºåŠ ä¸Šè¯¥ç»„ä»¶ä¹‹åæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šç»è¿‡ Redisï¼Œæ‰€ä»¥å¯¹ Redis èµ„æºçš„ä½¿ç”¨ä¹Ÿæ˜¯è¦éå¸¸å°å¿ƒã€‚</p>
<h4 id="API-æ›´æ–°"><a href="#API-æ›´æ–°" class="headerlink" title="API æ›´æ–°"></a>API æ›´æ–°</h4><p>ä¿®æ”¹ä¹‹åçš„ API å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLimitConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(RedisLimitConfig.class);</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.limit&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> limit;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> JedisConnectionFactory jedisConnectionFactory;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RedisLimit <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">        RedisLimit redisLimit = <span class="keyword">new</span> RedisLimit.Builder(jedisConnectionFactory, RedisToolsConstant.SINGLE)</div><div class="line">                .limit(limit)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> redisLimit;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæ„å»ºå™¨æ”¹ç”¨äº† <code>JedisConnectionFactory</code>ï¼Œæ‰€ä»¥å¾—é…åˆ Spring æ¥ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>å¹¶åœ¨åˆå§‹åŒ–æ—¶æ˜¾ç¤ºä¼ å…¥ Redis æ˜¯ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²è¿˜æ˜¯å•æœºï¼ˆå¼ºçƒˆå»ºè®®é›†ç¾¤ï¼Œé™æµä¹‹åå¯¹ Redis è¿˜æ˜¯æœ‰ä¸€å®šçš„å‹åŠ›ï¼‰ã€‚</p>
<h5 id="é™æµå®ç°"><a href="#é™æµå®ç°" class="headerlink" title="é™æµå®ç°"></a>é™æµå®ç°</h5><p>æ—¢ç„¶ API æ›´æ–°äº†ï¼Œå®ç°è‡ªç„¶ä¹Ÿè¦ä¿®æ”¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * limit traffic</div><div class="line"> * <span class="doctag">@return</span> if true</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limit</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//get connection</span></div><div class="line">    Object connection = getConnection();</div><div class="line"></div><div class="line">    Object result = limitRequest(connection);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (FAIL_CODE != (Long) result) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">limitRequest</span><span class="params">(Object connection)</span> </span>&#123;</div><div class="line">    Object result = <span class="keyword">null</span>;</div><div class="line">    String key = String.valueOf(System.currentTimeMillis() / <span class="number">1000</span>);</div><div class="line">    <span class="keyword">if</span> (connection <span class="keyword">instanceof</span> Jedis)&#123;</div><div class="line">        result = ((Jedis)connection).eval(script, Collections.singletonList(key), Collections.singletonList(String.valueOf(limit)));</div><div class="line">        ((Jedis) connection).close();</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        result = ((JedisCluster) connection).eval(script, Collections.singletonList(key), Collections.singletonList(String.valueOf(limit)));</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ((JedisCluster) connection).close();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            logger.error(<span class="string">"IOException"</span>,e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</div><div class="line">    Object connection ;</div><div class="line">    <span class="keyword">if</span> (type == RedisToolsConstant.SINGLE)&#123;</div><div class="line">        RedisConnection redisConnection = jedisConnectionFactory.getConnection();</div><div class="line">        connection = redisConnection.getNativeConnection();</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        RedisClusterConnection clusterConnection = jedisConnectionFactory.getClusterConnection();</div><div class="line">        connection = clusterConnection.getNativeConnection() ;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> connection;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯åŸç”Ÿçš„ Spring åº”ç”¨å¾—é‡‡ç”¨ <code>@SpringControllerLimit(errorCode = 200)</code> æ³¨è§£ã€‚</p>
<p>å®é™…ä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<p>web ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * ä¹è§‚é”æ›´æ–°åº“å­˜ é™æµ</div><div class="line"> * <span class="doctag">@param</span> sid</div><div class="line"> * <span class="doctag">@return</span></div><div class="line"> */</div><div class="line"><span class="meta">@SpringControllerLimit</span>(errorCode = <span class="number">200</span>)</div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/createOptimisticLimitOrder/&#123;sid&#125;"</span>)</div><div class="line"><span class="meta">@ResponseBody</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">createOptimisticLimitOrder</span><span class="params">(@PathVariable <span class="keyword">int</span> sid)</span> </span>&#123;</div><div class="line">    logger.info(<span class="string">"sid=[&#123;&#125;]"</span>, sid);</div><div class="line">    <span class="keyword">int</span> id = <span class="number">0</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        id = orderService.createOptimisticOrder(sid);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logger.error(<span class="string">"Exception"</span>,e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> String.valueOf(id);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Service ç«¯å°±æ²¡ä»€ä¹ˆæ›´æ–°äº†ï¼Œä¾ç„¶æ˜¯é‡‡ç”¨çš„ä¹è§‚é”æ›´æ–°æ•°æ®åº“ã€‚</p>
<p>å†å‹æµ‹çœ‹ä¸‹æ•ˆæœ <code>/createOptimisticLimitOrderByRedis/1</code>ï¼š</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fr3amu17zuj30e603ewej.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fr3an1x3pqj30oy0fwq4p.jpg" alt=""></p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fr3aml0c8rj31ek0ssn3g.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fr3ank9otcj31kw0d4die.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fr3anxbb0hj31kw0cjtbb.jpg" alt=""></p>
<p>é¦–å…ˆæ˜¯çœ‹ç»“æœæ²¡æœ‰é—®é¢˜ï¼Œå†çœ‹æ•°æ®åº“è¿æ¥ä»¥åŠå¹¶å‘è¯·æ±‚æ•°éƒ½æœ‰<strong>æ˜æ˜¾çš„ä¸‹é™</strong>ã€‚</p>
<h2 id="ä¹è§‚é”æ›´æ–°-åˆ†å¸ƒå¼é™æµ-Redis-ç¼“å­˜"><a href="#ä¹è§‚é”æ›´æ–°-åˆ†å¸ƒå¼é™æµ-Redis-ç¼“å­˜" class="headerlink" title="ä¹è§‚é”æ›´æ–° + åˆ†å¸ƒå¼é™æµ + Redis ç¼“å­˜"></a>ä¹è§‚é”æ›´æ–° + åˆ†å¸ƒå¼é™æµ + Redis ç¼“å­˜</h2><p>å…¶å®ä»”ç»†è§‚å¯Ÿ Druid ç›‘æ§æ•°æ®å‘ç°è¿™ä¸ª SQL è¢«å¤šæ¬¡æŸ¥è¯¢ï¼š</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fr3aq7shudj31kw0bomzp.jpg" alt=""></p>
<p>å…¶å®è¿™æ˜¯å®æ—¶æŸ¥è¯¢åº“å­˜çš„ SQLï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨æ¯æ¬¡ä¸‹å•ä¹‹å‰åˆ¤æ–­æ˜¯å¦è¿˜æœ‰åº“å­˜ã€‚</p>
<p><strong>è¿™ä¹Ÿæ˜¯ä¸ªä¼˜åŒ–ç‚¹</strong>ã€‚</p>
<p>è¿™ç§æ•°æ®æˆ‘ä»¬å®Œå…¨å¯ä»¥æ”¾åœ¨å†…å­˜ä¸­ï¼Œæ•ˆç‡æ¯”åœ¨æ•°æ®åº“è¦é«˜å¾ˆå¤šã€‚</p>
<p>ç”±äºæˆ‘ä»¬çš„åº”ç”¨æ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ‰€ä»¥å †å†…ç¼“å­˜æ˜¾ç„¶ä¸åˆé€‚ï¼ŒRedis å°±éå¸¸é€‚åˆã€‚</p>
<p>è¿™æ¬¡ä¸»è¦æ”¹é€ çš„æ˜¯ Service å±‚ï¼š</p>
<ul>
<li>æ¯æ¬¡æŸ¥è¯¢åº“å­˜æ—¶èµ° Redisã€‚</li>
<li>æ‰£åº“å­˜æ—¶æ›´æ–° Redisã€‚</li>
<li>éœ€è¦æå‰å°†åº“å­˜ä¿¡æ¯å†™å…¥ Redisï¼ˆæ‰‹åŠ¨æˆ–è€…ç¨‹åºè‡ªåŠ¨éƒ½å¯ä»¥ï¼‰ã€‚</li>
</ul>
<p>ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createOptimisticOrderUseRedis</span><span class="params">(<span class="keyword">int</span> sid)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">//æ£€éªŒåº“å­˜ï¼Œä» Redis è·å–</span></div><div class="line">    Stock stock = checkStockByRedis(sid);</div><div class="line"></div><div class="line">    <span class="comment">//ä¹è§‚é”æ›´æ–°åº“å­˜ ä»¥åŠæ›´æ–° Redis</span></div><div class="line">    saleStockOptimisticByRedis(stock);</div><div class="line"></div><div class="line">    <span class="comment">//åˆ›å»ºè®¢å•</span></div><div class="line">    <span class="keyword">int</span> id = createOrder(stock);</div><div class="line">    <span class="keyword">return</span> id ;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Stock <span class="title">checkStockByRedis</span><span class="params">(<span class="keyword">int</span> sid)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    Integer count = Integer.parseInt(redisTemplate.opsForValue().get(RedisKeysConstant.STOCK_COUNT + sid));</div><div class="line">    Integer sale = Integer.parseInt(redisTemplate.opsForValue().get(RedisKeysConstant.STOCK_SALE + sid));</div><div class="line">    <span class="keyword">if</span> (count.equals(sale))&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"åº“å­˜ä¸è¶³ Redis currentCount="</span> + sale);</div><div class="line">    &#125;</div><div class="line">    Integer version = Integer.parseInt(redisTemplate.opsForValue().get(RedisKeysConstant.STOCK_VERSION + sid));</div><div class="line">    Stock stock = <span class="keyword">new</span> Stock() ;</div><div class="line">    stock.setId(sid);</div><div class="line">    stock.setCount(count);</div><div class="line">    stock.setSale(sale);</div><div class="line">    stock.setVersion(version);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> stock;</div><div class="line">&#125;    </div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * ä¹è§‚é”æ›´æ–°æ•°æ®åº“ è¿˜è¦æ›´æ–° Redis</div><div class="line"> * <span class="doctag">@param</span> stock</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saleStockOptimisticByRedis</span><span class="params">(Stock stock)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> count = stockService.updateStockByOptimistic(stock);</div><div class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"å¹¶å‘æ›´æ–°åº“å­˜å¤±è´¥"</span>) ;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//è‡ªå¢</span></div><div class="line">    redisTemplate.opsForValue().increment(RedisKeysConstant.STOCK_SALE + stock.getId(),<span class="number">1</span>) ;</div><div class="line">    redisTemplate.opsForValue().increment(RedisKeysConstant.STOCK_VERSION + stock.getId(),<span class="number">1</span>) ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‹æµ‹çœ‹çœ‹å®é™…æ•ˆæœ <code>/createOptimisticLimitOrderByRedis/1</code>ï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fr3b419f2aj30by04g0ss.jpg" alt=""></p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fr3b48vebkj30gk0cy0u3.jpg" alt=""></p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fr3b55kyv6j31kw0dijtx.jpg" alt=""></p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fr3b5n1n21j31kw0c2acg.jpg" alt=""></p>
<p>æœ€åå‘ç°æ•°æ®æ²¡é—®é¢˜ï¼Œæ•°æ®åº“çš„è¯·æ±‚ä¸å¹¶å‘ä¹Ÿéƒ½ä¸‹æ¥äº†ã€‚</p>
<h2 id="ä¹è§‚é”æ›´æ–°-åˆ†å¸ƒå¼é™æµ-Redis-ç¼“å­˜-Kafka-å¼‚æ­¥"><a href="#ä¹è§‚é”æ›´æ–°-åˆ†å¸ƒå¼é™æµ-Redis-ç¼“å­˜-Kafka-å¼‚æ­¥" class="headerlink" title="ä¹è§‚é”æ›´æ–° + åˆ†å¸ƒå¼é™æµ + Redis ç¼“å­˜ + Kafka å¼‚æ­¥"></a>ä¹è§‚é”æ›´æ–° + åˆ†å¸ƒå¼é™æµ + Redis ç¼“å­˜ + Kafka å¼‚æ­¥</h2><p>æœ€åçš„ä¼˜åŒ–è¿˜æ˜¯æƒ³å¦‚ä½•æ¥å†æ¬¡æé«˜ååé‡ä»¥åŠæ€§èƒ½çš„ã€‚</p>
<p>æˆ‘ä»¬ä¸Šæ–‡æ‰€æœ‰ä¾‹å­å…¶å®éƒ½æ˜¯åŒæ­¥è¯·æ±‚ï¼Œå®Œå…¨å¯ä»¥åˆ©ç”¨åŒæ­¥è½¬å¼‚æ­¥æ¥æé«˜æ€§èƒ½å•Šã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å°†å†™è®¢å•ä»¥åŠæ›´æ–°åº“å­˜çš„æ“ä½œè¿›è¡Œå¼‚æ­¥åŒ–ï¼Œåˆ©ç”¨ <code>Kafka</code> æ¥è¿›è¡Œè§£è€¦å’Œé˜Ÿåˆ—çš„ä½œç”¨ã€‚</p>
<p>æ¯å½“ä¸€ä¸ªè¯·æ±‚é€šè¿‡äº†é™æµåˆ°è¾¾äº† Service å±‚é€šè¿‡äº†åº“å­˜æ ¡éªŒä¹‹åå°±å°†è®¢å•ä¿¡æ¯å‘ç»™ Kafka ï¼Œè¿™æ ·ä¸€ä¸ªè¯·æ±‚å°±å¯ä»¥ç›´æ¥è¿”å›äº†ã€‚</p>
<p>æ¶ˆè´¹ç¨‹åºå†å¯¹æ•°æ®è¿›è¡Œå…¥åº“è½åœ°ã€‚</p>
<p>å› ä¸ºå¼‚æ­¥äº†ï¼Œæ‰€ä»¥æœ€ç»ˆéœ€è¦é‡‡å–å›è°ƒæˆ–è€…æ˜¯å…¶ä»–æé†’çš„æ–¹å¼æé†’ç”¨æˆ·è´­ä¹°å®Œæˆã€‚</p>
<p>è¿™é‡Œä»£ç è¾ƒå¤šå°±ä¸è´´äº†ï¼Œæ¶ˆè´¹ç¨‹åºå…¶å®å°±æ˜¯æŠŠä¹‹å‰çš„ Service å±‚çš„é€»è¾‘é‡å†™äº†ä¸€éï¼Œä¸è¿‡é‡‡ç”¨çš„æ˜¯ SpringBootã€‚</p>
<p>æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹ä¸‹ã€‚</p>
<p><a href="https://github.com/crossoverJie/SSM/tree/master/SSM-SECONDS-KILL/SSM-SECONDS-KILL-ORDER-CONSUMER" target="_blank" rel="external">https://github.com/crossoverJie/SSM/tree/master/SSM-SECONDS-KILL/SSM-SECONDS-KILL-ORDER-CONSUMER</a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å…¶å®ç»è¿‡ä¸Šé¢çš„ä¸€é¡¿ä¼˜åŒ–æ€»ç»“èµ·æ¥æ— éå°±æ˜¯ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>å°½é‡å°†è¯·æ±‚æ‹¦æˆªåœ¨ä¸Šæ¸¸ã€‚</li>
<li>è¿˜å¯ä»¥æ ¹æ® UID è¿›è¡Œé™æµã€‚</li>
<li>æœ€å¤§ç¨‹åº¦çš„å‡å°‘è¯·æ±‚è½åˆ° DBã€‚</li>
<li>å¤šåˆ©ç”¨ç¼“å­˜ã€‚</li>
<li>åŒæ­¥æ“ä½œå¼‚æ­¥åŒ–ã€‚</li>
<li>fail fastï¼Œå°½æ—©å¤±è´¥ï¼Œä¿æŠ¤åº”ç”¨ã€‚</li>
</ul>
<p>ç å­—ä¸æ˜“ï¼Œè¿™åº”è¯¥æ˜¯æˆ‘å†™è¿‡å­—æ•°æœ€å¤šçš„äº†ï¼Œæƒ³æƒ³å½“å¹´é«˜ä¸­ 800 å­—çš„ä½œæ–‡éƒ½æ†‹ä¸å‡ºæ¥ğŸ˜‚ï¼Œå¯æƒ³è€ŒçŸ¥æ˜¯æœ‰å¤šéš¾å¾—äº†ã€‚</p>
<p><strong>ä»¥ä¸Šå†…å®¹æ¬¢è¿è®¨è®º</strong>ã€‚</p>
<h3 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h3><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tKfTcly1fr1z9k79lrj31kw11zwt8.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ä¹‹å‰åœ¨ &lt;a href=&quot;https://github.com/crossoverJie/Java-Interview/blob/master/MD/Spike.md&quot;&gt;Java-Interview&lt;/a&gt; ä¸­æåˆ°è¿‡ç§’æ€æ¶æ„çš„è®¾è®¡ï¼Œè¿™æ¬¡åŸºäºå…¶ä¸­çš„ç†è®ºç®€å•å®ç°äº†ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ¬æ¬¡é‡‡ç”¨å¾ªåºæ¸è¿›çš„æ–¹å¼é€æ­¥æé«˜æ€§èƒ½è¾¾åˆ°å¹¶å‘ç§’æ€çš„æ•ˆæœï¼Œæ–‡ç« è¾ƒé•¿è¯·å‡†å¤‡å¥½ç“œå­æ¿å‡³(liushuizhangğŸ˜‚)ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æœ¬æ–‡æ‰€æœ‰æ¶‰åŠçš„ä»£ç ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/crossoverJie/SSM&quot;&gt;https://github.com/crossoverJie/SSM&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/crossoverJie/distributed-redis-tool&quot;&gt;https://github.com/crossoverJie/distributed-redis-tool&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æœ€ç»ˆæ¶æ„å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2018/05/08/5af079ea8618b.png&quot; alt=&quot;ç³»ç»Ÿæ¶æ„è®¾è®¡.png&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="SSM" scheme="http://crossoverjie.top/categories/SSM/"/>
    
      <category term="Distributed Tools" scheme="http://crossoverjie.top/categories/SSM/Distributed-Tools/"/>
    
    
      <category term="Java" scheme="http://crossoverjie.top/tags/Java/"/>
    
      <category term="Kafka" scheme="http://crossoverjie.top/tags/Kafka/"/>
    
      <category term="Redis" scheme="http://crossoverjie.top/tags/Redis/"/>
    
      <category term="SpringBoot" scheme="http://crossoverjie.top/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>sbc(ä¸ƒ)åˆ†å¸ƒå¼é™æµ</title>
    <link href="http://crossoverjie.top/2018/04/28/sbc/sbc7-Distributed-Limit/"/>
    <id>http://crossoverjie.top/2018/04/28/sbc/sbc7-Distributed-Limit/</id>
    <published>2018-04-27T17:03:12.000Z</published>
    <updated>2018-06-07T10:09:59.680Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fqrle104hwj31i6104aig.jpg" alt=""></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡æ¥ç€ä¸Šæ–‡<a href="http://crossoverjie.top/2017/08/11/sbc4/">åº”ç”¨é™æµ</a>è¿›è¡Œè®¨è®ºã€‚</p>
<p>ä¹‹å‰è°ˆåˆ°çš„é™æµæ–¹æ¡ˆåªèƒ½é’ˆå¯¹äºå•ä¸ª JVM æœ‰æ•ˆï¼Œä¹Ÿå°±æ˜¯å•æœºåº”ç”¨ã€‚è€Œå¯¹äºç°åœ¨æ™®éçš„åˆ†å¸ƒå¼åº”ç”¨ä¹Ÿå¾—æœ‰ä¸€ä¸ªåˆ†å¸ƒå¼é™æµçš„æ–¹æ¡ˆã€‚</p>
<p>åŸºäºæ­¤å°è¯•å†™äº†è¿™ä¸ªç»„ä»¶ï¼š</p>
<p><a href="https://github.com/crossoverJie/distributed-redis-tool" target="_blank" rel="external">https://github.com/crossoverJie/distributed-redis-tool</a></p>
<h2 id="DEMO"><a href="#DEMO" class="headerlink" title="DEMO"></a>DEMO</h2><p>ä»¥ä¸‹é‡‡ç”¨çš„æ˜¯</p>
<p><a href="https://github.com/crossoverJie/springboot-cloud" target="_blank" rel="external">https://github.com/crossoverJie/springboot-cloud</a></p>
<p>æ¥åšæ¼”ç¤ºã€‚</p>
<p>åœ¨ Order åº”ç”¨æä¾›çš„æ¥å£ä¸­é‡‡å–äº†é™æµã€‚é¦–å…ˆæ˜¯é…ç½®äº†é™æµå·¥å…·çš„ Bean:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLimitConfig</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.limit&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> limit;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> JedisConnectionFactory jedisConnectionFactory;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RedisLimit <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">        RedisClusterConnection clusterConnection = jedisConnectionFactory.getClusterConnection();</div><div class="line">        JedisCluster jedisCluster = (JedisCluster) clusterConnection.getNativeConnection();</div><div class="line">        RedisLimit redisLimit = <span class="keyword">new</span> RedisLimit.Builder&lt;&gt;(jedisCluster)</div><div class="line">                .limit(limit)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> redisLimit;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ¥ç€åœ¨ Controller ä½¿ç”¨ç»„ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="keyword">private</span> RedisLimit redisLimit ;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="meta">@CheckReqNo</span></div><div class="line"><span class="function"><span class="keyword">public</span> BaseResponse&lt;OrderNoResVO&gt; <span class="title">getOrderNo</span><span class="params">(@RequestBody OrderNoReqVO orderNoReq)</span> </span>&#123;</div><div class="line">    BaseResponse&lt;OrderNoResVO&gt; res = <span class="keyword">new</span> BaseResponse();</div><div class="line"></div><div class="line">    <span class="comment">//é™æµ</span></div><div class="line">    <span class="keyword">boolean</span> limit = redisLimit.limit();</div><div class="line">    <span class="keyword">if</span> (!limit)&#123;</div><div class="line">        res.setCode(StatusEnum.REQUEST_LIMIT.getCode());</div><div class="line">        res.setMessage(StatusEnum.REQUEST_LIMIT.getMessage());</div><div class="line">        <span class="keyword">return</span> res ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    res.setReqNo(orderNoReq.getReqNo());</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == orderNoReq.getAppId())&#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SBCException(StatusEnum.FAIL);</div><div class="line">    &#125;</div><div class="line">    OrderNoResVO orderNoRes = <span class="keyword">new</span> OrderNoResVO() ;</div><div class="line">    orderNoRes.setOrderId(DateUtil.getLongTime());</div><div class="line">    res.setCode(StatusEnum.SUCCESS.getCode());</div><div class="line">    res.setMessage(StatusEnum.SUCCESS.getMessage());</div><div class="line">    res.setDataBody(orderNoRes);</div><div class="line">    <span class="keyword">return</span> res ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œä¹Ÿæä¾›äº†æ³¨è§£:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="meta">@ControllerLimit</span></div><div class="line"><span class="function"><span class="keyword">public</span> BaseResponse&lt;OrderNoResVO&gt; <span class="title">getOrderNoLimit</span><span class="params">(@RequestBody OrderNoReqVO orderNoReq)</span> </span>&#123;</div><div class="line">    BaseResponse&lt;OrderNoResVO&gt; res = <span class="keyword">new</span> BaseResponse();</div><div class="line">    <span class="comment">// ä¸šåŠ¡é€»è¾‘</span></div><div class="line">    <span class="keyword">return</span> res ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¯¥æ³¨è§£æ‹¦æˆªäº† http è¯·æ±‚ï¼Œä¼šå†è¯·æ±‚è¾¾åˆ°é˜ˆå€¼æ—¶ç›´æ¥è¿”å›ã€‚</p>
<p>æ™®é€šæ–¹æ³•ä¹Ÿå¯ä½¿ç”¨:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@CommonLimit</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>ä¼šåœ¨è°ƒç”¨è¾¾åˆ°é˜ˆå€¼æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>ä¸ºäº†æ¨¡æ‹Ÿå¹¶å‘ï¼Œåœ¨ <a href="https://github.com/crossoverJie/springboot-cloud/blob/master/sbc-user/user/src/main/java/com/crossoverJie/sbcuser/controller/UserController.java#L72-L91" target="_blank" rel="external">User</a> åº”ç”¨ä¸­å¼€å¯äº† 10 ä¸ªçº¿ç¨‹è°ƒç”¨ Order(<strong>é™æµæ¬¡æ•°ä¸º5</strong>) æ¥å£(ä¹Ÿå¯ä½¿ç”¨ä¸“ä¸šçš„å¹¶å‘æµ‹è¯•å·¥å…· JMeter ç­‰)ã€‚</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> BaseResponse&lt;UserResVO&gt; <span class="title">getUserByFeign</span><span class="params">(@RequestBody UserReqVO userReq)</span> </span>&#123;</div><div class="line">    <span class="comment">//è°ƒç”¨è¿œç¨‹æœåŠ¡</span></div><div class="line">    OrderNoReqVO vo = <span class="keyword">new</span> OrderNoReqVO();</div><div class="line">    vo.setAppId(<span class="number">1L</span>);</div><div class="line">    vo.setReqNo(userReq.getReqNo());</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">        executorService.execute(<span class="keyword">new</span> Worker(vo, orderServiceClient));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    UserRes userRes = <span class="keyword">new</span> UserRes();</div><div class="line">    userRes.setUserId(<span class="number">123</span>);</div><div class="line">    userRes.setUserName(<span class="string">"å¼ ä¸‰"</span>);</div><div class="line"></div><div class="line">    userRes.setReqNo(userReq.getReqNo());</div><div class="line">    userRes.setCode(StatusEnum.SUCCESS.getCode());</div><div class="line">    userRes.setMessage(<span class="string">"æˆåŠŸ"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> userRes;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> OrderNoReqVO vo;</div><div class="line">    <span class="keyword">private</span> OrderServiceClient orderServiceClient;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Worker</span><span class="params">(OrderNoReqVO vo, OrderServiceClient orderServiceClient)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.vo = vo;</div><div class="line">        <span class="keyword">this</span>.orderServiceClient = orderServiceClient;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        BaseResponse&lt;OrderNoResVO&gt; orderNo = orderServiceClient.getOrderNoCommonLimit(vo);</div><div class="line">        logger.info(<span class="string">"è¿œç¨‹è¿”å›:"</span> + JSON.toJSONString(orderNo));</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>ä¸ºäº†éªŒè¯åˆ†å¸ƒå¼æ•ˆæœå¯åŠ¨äº†ä¸¤ä¸ª Order åº”ç”¨ã€‚</p>
</blockquote>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fqrnxt2l8lj313x09rwfm.jpg" alt=""></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fqrlvvj8cbj31kw0f1wws.jpg" alt=""></p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fqrlznycdnj31kw0gbh0n.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fqrm0jpbjjj31kw04wgq9.jpg" alt=""></p>
<h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>å®ç°åŸç†å…¶å®å¾ˆç®€å•ã€‚æ—¢ç„¶è¦è¾¾åˆ°åˆ†å¸ƒå¼å…¨å±€é™æµçš„æ•ˆæœï¼Œé‚£è‡ªç„¶éœ€è¦ä¸€ä¸ªç¬¬ä¸‰æ–¹ç»„ä»¶æ¥è®°å½•è¯·æ±‚çš„æ¬¡æ•°ã€‚</p>
<p>å…¶ä¸­ Redis å°±éå¸¸é€‚åˆè¿™æ ·çš„åœºæ™¯ã€‚</p>
<ul>
<li>æ¯æ¬¡è¯·æ±‚æ—¶å°†å½“å‰æ—¶é—´(ç²¾ç¡®åˆ°ç§’)ä½œä¸º Key å†™å…¥åˆ° Redis ä¸­ï¼Œè¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 2 ç§’ï¼ŒRedis å°†è¯¥ Key çš„å€¼è¿›è¡Œè‡ªå¢ã€‚</li>
<li>å½“è¾¾åˆ°é˜ˆå€¼æ—¶è¿”å›é”™è¯¯ã€‚</li>
<li>å†™å…¥ Redis çš„æ“ä½œç”¨ Lua è„šæœ¬æ¥å®Œæˆï¼Œåˆ©ç”¨ Redis çš„å•çº¿ç¨‹æœºåˆ¶å¯ä»¥ä¿è¯æ¯ä¸ª Redis è¯·æ±‚çš„åŸå­æ€§ã€‚</li>
</ul>
<p>Lua è„šæœ¬å¦‚ä¸‹:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--lua ä¸‹æ ‡ä» 1 å¼€å§‹</span></div><div class="line"><span class="comment">-- é™æµ key</span></div><div class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</div><div class="line"><span class="comment">-- é™æµå¤§å°</span></div><div class="line"><span class="keyword">local</span> limit = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</div><div class="line"></div><div class="line"><span class="comment">-- è·å–å½“å‰æµé‡å¤§å°</span></div><div class="line"><span class="keyword">local</span> curentLimit = <span class="built_in">tonumber</span>(redis.call(<span class="string">'get'</span>, key) <span class="keyword">or</span> <span class="string">"0"</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> curentLimit + <span class="number">1</span> &gt; limit <span class="keyword">then</span></div><div class="line">    <span class="comment">-- è¾¾åˆ°é™æµå¤§å° è¿”å›</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"><span class="keyword">else</span></div><div class="line">    <span class="comment">-- æ²¡æœ‰è¾¾åˆ°é˜ˆå€¼ value + 1</span></div><div class="line">    redis.call(<span class="string">"INCRBY"</span>, key, <span class="number">1</span>)</div><div class="line">    redis.call(<span class="string">"EXPIRE"</span>, key, <span class="number">2</span>)</div><div class="line">    <span class="keyword">return</span> curentLimit + <span class="number">1</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>Java ä¸­çš„è°ƒç”¨é€»è¾‘:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limit</span><span class="params">()</span> </span>&#123;</div><div class="line">    String key = String.valueOf(System.currentTimeMillis() / <span class="number">1000</span>);</div><div class="line">    Object result = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (jedis <span class="keyword">instanceof</span> Jedis) &#123;</div><div class="line">        result = ((Jedis) <span class="keyword">this</span>.jedis).eval(script, Collections.singletonList(key), Collections.singletonList(String.valueOf(limit)));</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jedis <span class="keyword">instanceof</span> JedisCluster) &#123;</div><div class="line">        result = ((JedisCluster) <span class="keyword">this</span>.jedis).eval(script, Collections.singletonList(key), Collections.singletonList(String.valueOf(limit)));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//throw new RuntimeException("instance is error") ;</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (FAIL_CODE != (Long) result) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥åªéœ€è¦åœ¨éœ€è¦é™æµçš„åœ°æ–¹è°ƒç”¨è¯¥æ–¹æ³•å¯¹è¿”å›å€¼è¿›è¡Œåˆ¤æ–­å³å¯è¾¾åˆ°é™æµçš„ç›®çš„ã€‚</p>
<p>å½“ç„¶è¿™åªæ˜¯åˆ©ç”¨ Redis åšäº†ä¸€ä¸ªç²—æš´çš„è®¡æ•°å™¨ï¼Œå¦‚æœæƒ³å®ç°ç±»ä¼¼äºä¸Šæ–‡ä¸­çš„ä»¤ç‰Œæ¡¶ç®—æ³•å¯ä»¥åŸºäº Lua è‡ªè¡Œå®ç°ã€‚</p>
<h3 id="Builder-æ„å»ºå™¨"><a href="#Builder-æ„å»ºå™¨" class="headerlink" title="Builder æ„å»ºå™¨"></a>Builder æ„å»ºå™¨</h3><p>åœ¨è®¾è®¡è¿™ä¸ªç»„ä»¶æ—¶æƒ³å°½é‡çš„æä¾›ç»™ä½¿ç”¨è€…æ¸…æ™°ã€å¯è¯»æ€§ã€ä¸æ˜“å‡ºé”™çš„ APIã€‚</p>
<blockquote>
<p>æ¯”å¦‚ç¬¬ä¸€æ­¥ï¼Œå¦‚ä½•æ„å»ºä¸€ä¸ªé™æµå¯¹è±¡ã€‚</p>
</blockquote>
<p>æœ€å¸¸ç”¨çš„æ–¹å¼è‡ªç„¶å°±æ˜¯æ„é€ å‡½æ•°ï¼Œå¦‚æœæœ‰å¤šä¸ªåŸŸåˆ™å¯ä»¥é‡‡ç”¨é‡å æ„é€ å™¨çš„æ–¹å¼:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>ç¼ºç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼šå¦‚æœå‚æ•°è¿‡å¤šä¼šå¯¼è‡´éš¾ä»¥é˜…è¯»ï¼Œç”šè‡³å¦‚æœå‚æ•°ç±»å‹ä¸€è‡´çš„æƒ…å†µä¸‹å®¢æˆ·ç«¯é¢ å€’äº†é¡ºåºï¼Œä½†ä¸ä¼šå¼•èµ·è­¦å‘Šä»è€Œå‡ºç°éš¾ä»¥é¢„æµ‹çš„ç»“æœã€‚</p>
<p>ç¬¬äºŒç§æ–¹æ¡ˆå¯ä»¥é‡‡ç”¨ JavaBean æ¨¡å¼ï¼Œåˆ©ç”¨ <code>setter</code> æ–¹æ³•è¿›è¡Œæ„å»º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">A a = <span class="keyword">new</span> A();</div><div class="line">a.setA(a);</div><div class="line">a.setB(b);</div></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼æ¸…æ™°æ˜“è¯»ï¼Œä½†å´å®¹æ˜“è®©å¯¹è±¡å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œä½¿å¯¹è±¡å¤„äºçº¿ç¨‹ä¸å®‰å…¨çš„çŠ¶æ€ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œé‡‡ç”¨äº†ç¬¬ä¸‰ç§åˆ›å»ºå¯¹è±¡çš„æ–¹å¼ï¼Œæ„å»ºå™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLimit</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> JedisCommands jedis;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> limit = <span class="number">200</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FAIL_CODE = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * lua script</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String script;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RedisLimit</span><span class="params">(Builder builder)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.limit = builder.limit ;</div><div class="line">        <span class="keyword">this</span>.jedis = builder.jedis ;</div><div class="line">        buildScript();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * limit traffic</div><div class="line">     * <span class="doctag">@return</span> if true</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">limit</span><span class="params">()</span> </span>&#123;</div><div class="line">        String key = String.valueOf(System.currentTimeMillis() / <span class="number">1000</span>);</div><div class="line">        Object result = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (jedis <span class="keyword">instanceof</span> Jedis) &#123;</div><div class="line">            result = ((Jedis) <span class="keyword">this</span>.jedis).eval(script, Collections.singletonList(key), Collections.singletonList(String.valueOf(limit)));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jedis <span class="keyword">instanceof</span> JedisCluster) &#123;</div><div class="line">            result = ((JedisCluster) <span class="keyword">this</span>.jedis).eval(script, Collections.singletonList(key), Collections.singletonList(String.valueOf(limit)));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//throw new RuntimeException("instance is error") ;</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (FAIL_CODE != (Long) result) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * read lua script</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildScript</span><span class="params">()</span> </span>&#123;</div><div class="line">        script = ScriptUtil.getScript(<span class="string">"limit.lua"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     *  the builder</div><div class="line">     * <span class="doctag">@param</span> &lt;T&gt;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">JedisCommands</span>&gt;</span>&#123;</div><div class="line">        <span class="keyword">private</span> T jedis = <span class="keyword">null</span> ;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> limit = <span class="number">200</span>;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(T jedis)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.jedis = jedis ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">limit</span><span class="params">(<span class="keyword">int</span> limit)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.limit = limit ;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> RedisLimit <span class="title">build</span><span class="params">()</span></span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RedisLimit(<span class="keyword">this</span>) ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å®¢æˆ·ç«¯åœ¨ä½¿ç”¨æ—¶:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RedisLimit redisLimit = <span class="keyword">new</span> RedisLimit.Builder&lt;&gt;(jedisCluster)</div><div class="line">                .limit(limit)</div><div class="line">                .build();</div></pre></td></tr></table></figure>
<p>æ›´åŠ çš„ç®€å•ç›´æ¥ï¼Œå¹¶ä¸”é¿å…äº†å°†åˆ›å»ºè¿‡ç¨‹åˆ†æˆäº†å¤šä¸ªå­æ­¥éª¤ã€‚</p>
<p>è¿™åœ¨æœ‰å¤šä¸ªæ„é€ å‚æ•°ï¼Œä½†åˆä¸æ˜¯å¿…é€‰å­—æ®µæ—¶å¾ˆæœ‰ä½œç”¨ã€‚</p>
<p>å› æ­¤é¡ºä¾¿å°†åˆ†å¸ƒå¼é”çš„æ„å»ºå™¨æ–¹å¼ä¹Ÿä¸€å¹¶æ›´æ–°äº†ï¼š</p>
<p><a href="https://github.com/crossoverJie/distributed-redis-tool#features" target="_blank" rel="external">https://github.com/crossoverJie/distributed-redis-tool#features</a></p>
<blockquote>
<p>æ›´å¤šå†…å®¹å¯ä»¥å‚è€ƒ Effective Java</p>
</blockquote>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>ä»ä¸Šæ–‡å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨è¿‡ç¨‹å°±æ˜¯è°ƒç”¨ <code>limit</code> æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//é™æµ</span></div><div class="line"> <span class="keyword">boolean</span> limit = redisLimit.limit();</div><div class="line"> <span class="keyword">if</span> (!limit)&#123;</div><div class="line">    <span class="comment">//å…·ä½“é™æµé€»è¾‘</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>ä¸ºäº†å‡å°‘ä¾µå…¥æ€§ï¼Œä¹Ÿä¸ºäº†ç®€åŒ–å®¢æˆ·ç«¯æä¾›äº†ä¸¤ç§æ³¨è§£æ–¹å¼ã€‚</p>
<h4 id="ControllerLimit"><a href="#ControllerLimit" class="headerlink" title="@ControllerLimit"></a>@ControllerLimit</h4><p>è¯¥æ³¨è§£å¯ä»¥ä½œç”¨äº <code>@RequestMapping</code> ä¿®é¥°çš„æ¥å£ä¸­ï¼Œå¹¶ä¼šåœ¨é™æµåæä¾›é™æµå“åº”ã€‚</p>
<p>å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebIntercept</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(WebIntercept.class);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RedisLimit redisLimit;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</div><div class="line">        registry.addInterceptor(<span class="keyword">new</span> CustomInterceptor())</div><div class="line">                .addPathPatterns(<span class="string">"/**"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></div><div class="line">                                 Object handler) <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">if</span> (redisLimit == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"redisLimit is null"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> HandlerMethod) &#123;</div><div class="line">                HandlerMethod method = (HandlerMethod) handler;</div><div class="line"></div><div class="line">                ControllerLimit annotation = method.getMethodAnnotation(ControllerLimit.class);</div><div class="line">                <span class="keyword">if</span> (annotation == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">//skip</span></div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">boolean</span> limit = redisLimit.limit();</div><div class="line">                <span class="keyword">if</span> (!limit) &#123;</div><div class="line">                    logger.warn(<span class="string">"request has bean limit"</span>);</div><div class="line">                    response.sendError(<span class="number">500</span>, <span class="string">"request limit"</span>);</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯å®ç°äº† SpringMVC ä¸­çš„æ‹¦æˆªå™¨ï¼Œå¹¶åœ¨æ‹¦æˆªè¿‡ç¨‹ä¸­åˆ¤æ–­æ˜¯å¦æœ‰ä½¿ç”¨æ³¨è§£ï¼Œä»è€Œè°ƒç”¨é™æµé€»è¾‘ã€‚</p>
<p><strong>å‰ææ˜¯åº”ç”¨éœ€è¦æ‰«æåˆ°è¯¥ç±»ï¼Œè®© Spring è¿›è¡Œç®¡ç†ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ComponentScan</span>(value = <span class="string">"com.crossoverjie.distributed.intercept"</span>)</div></pre></td></tr></table></figure>
<h4 id="CommonLimit"><a href="#CommonLimit" class="headerlink" title="@CommonLimit"></a>@CommonLimit</h4><p>å½“ç„¶ä¹Ÿå¯ä»¥åœ¨æ™®é€šæ–¹æ³•ä¸­ä½¿ç”¨ã€‚å®ç°åŸç†åˆ™æ˜¯ Spring AOP (SpringMVC çš„æ‹¦æˆªå™¨æœ¬è´¨ä¹Ÿæ˜¯ AOP)ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@EnableAspectJAutoProxy</span>(proxyTargetClass = <span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonAspect</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(CommonAspect.class);</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RedisLimit redisLimit ;</div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.crossoverjie.distributed.annotation.CommonLimit)"</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="meta">@Before</span>(<span class="string">"check()"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (redisLimit == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"redisLimit is null"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> limit = redisLimit.limit();</div><div class="line">        <span class="keyword">if</span> (!limit) &#123;</div><div class="line">            logger.warn(<span class="string">"request has bean limit"</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"request has bean limit"</span>) ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¾ˆç®€å•ï¼Œä¹Ÿæ˜¯åœ¨æ‹¦æˆªè¿‡ç¨‹ä¸­è°ƒç”¨é™æµã€‚</p>
<p>å½“ç„¶ä½¿ç”¨æ—¶ä¹Ÿå¾—æ‰«æåˆ°è¯¥åŒ…:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ComponentScan</span>(value = <span class="string">"com.crossoverjie.distributed.intercept"</span>)</div></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><strong>é™æµ</strong>åœ¨ä¸€ä¸ªé«˜å¹¶å‘å¤§æµé‡çš„ç³»ç»Ÿä¸­æ˜¯ä¿æŠ¤åº”ç”¨çš„ä¸€ä¸ªåˆ©å™¨ï¼Œæˆç†Ÿçš„æ–¹æ¡ˆä¹Ÿå¾ˆå¤šï¼Œå¸Œæœ›å¯¹åˆšäº†è§£è¿™ä¸€å—çš„æœ‹å‹æä¾›ä¸€äº›æ€è·¯ã€‚</p>
<p>ä»¥ä¸Šæ‰€æœ‰çš„æºç ï¼š</p>
<ul>
<li><a href="https://github.com/crossoverJie/distributed-redis-tool" target="_blank" rel="external">https://github.com/crossoverJie/distributed-redis-tool</a></li>
<li><a href="https://github.com/crossoverJie/springboot-cloud" target="_blank" rel="external">https://github.com/crossoverJie/springboot-cloud</a></li>
</ul>
<p>æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç‚¹ä¸ª Star æˆ–æ˜¯æäº¤ PRã€‚</p>
<h3 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h3><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws3.sinaimg.cn/large/006tKfTcly1fqrle104hwj31i6104aig.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡æ¥ç€ä¸Šæ–‡&lt;a href=&quot;http://crossoverjie.top/2017/08/11/sbc4/&quot;&gt;åº”ç”¨é™æµ&lt;/a&gt;è¿›è¡Œè®¨è®ºã€‚&lt;/p&gt;
&lt;p&gt;ä¹‹å‰è°ˆåˆ°çš„é™æµæ–¹æ¡ˆåªèƒ½é’ˆå¯¹äºå•ä¸ª JVM æœ‰æ•ˆï¼Œä¹Ÿå°±æ˜¯å•æœºåº”ç”¨ã€‚è€Œå¯¹äºç°åœ¨æ™®éçš„åˆ†å¸ƒå¼åº”ç”¨ä¹Ÿå¾—æœ‰ä¸€ä¸ªåˆ†å¸ƒå¼é™æµçš„æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;p&gt;åŸºäºæ­¤å°è¯•å†™äº†è¿™ä¸ªç»„ä»¶ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/crossoverJie/distributed-redis-tool&quot;&gt;https://github.com/crossoverJie/distributed-redis-tool&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;DEMO&quot;&gt;&lt;a href=&quot;#DEMO&quot; class=&quot;headerlink&quot; title=&quot;DEMO&quot;&gt;&lt;/a&gt;DEMO&lt;/h2&gt;&lt;p&gt;ä»¥ä¸‹é‡‡ç”¨çš„æ˜¯&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/crossoverJie/springboot-cloud&quot;&gt;https://github.com/crossoverJie/springboot-cloud&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ¥åšæ¼”ç¤ºã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ Order åº”ç”¨æä¾›çš„æ¥å£ä¸­é‡‡å–äº†é™æµã€‚é¦–å…ˆæ˜¯é…ç½®äº†é™æµå·¥å…·çš„ Bean:&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Configuration&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RedisLimitConfig&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;redis.limit&amp;#125;&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; limit;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Autowired&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; JedisConnectionFactory jedisConnectionFactory;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Bean&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; RedisLimit &lt;span class=&quot;title&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        RedisClusterConnection clusterConnection = jedisConnectionFactory.getClusterConnection();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        JedisCluster jedisCluster = (JedisCluster) clusterConnection.getNativeConnection();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        RedisLimit redisLimit = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RedisLimit.Builder&amp;lt;&amp;gt;(jedisCluster)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                .limit(limit)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                .build();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; redisLimit;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æ¥ç€åœ¨ Controller ä½¿ç”¨ç»„ä»¶ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Autowired&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; RedisLimit redisLimit ;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@CheckReqNo&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; BaseResponse&amp;lt;OrderNoResVO&amp;gt; &lt;span class=&quot;title&quot;&gt;getOrderNo&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(@RequestBody OrderNoReqVO orderNoReq)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    BaseResponse&amp;lt;OrderNoResVO&amp;gt; res = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BaseResponse();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//é™æµ&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; limit = redisLimit.limit();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!limit)&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        res.setCode(StatusEnum.REQUEST_LIMIT.getCode());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        res.setMessage(StatusEnum.REQUEST_LIMIT.getMessage());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; res ;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    res.setReqNo(orderNoReq.getReqNo());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; == orderNoReq.getAppId())&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; SBCException(StatusEnum.FAIL);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    OrderNoResVO orderNoRes = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; OrderNoResVO() ;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    orderNoRes.setOrderId(DateUtil.getLongTime());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    res.setCode(StatusEnum.SUCCESS.getCode());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    res.setMessage(StatusEnum.SUCCESS.getMessage());&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    res.setDataBody(orderNoRes);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; res ;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œä¹Ÿæä¾›äº†æ³¨è§£:&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@ControllerLimit&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; BaseResponse&amp;lt;OrderNoResVO&amp;gt; &lt;span class=&quot;title&quot;&gt;getOrderNoLimit&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(@RequestBody OrderNoReqVO orderNoReq)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    BaseResponse&amp;lt;OrderNoResVO&amp;gt; res = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; BaseResponse();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// ä¸šåŠ¡é€»è¾‘&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; res ;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;è¯¥æ³¨è§£æ‹¦æˆªäº† http è¯·æ±‚ï¼Œä¼šå†è¯·æ±‚è¾¾åˆ°é˜ˆå€¼æ—¶ç›´æ¥è¿”å›ã€‚&lt;/p&gt;
&lt;p&gt;æ™®é€šæ–¹æ³•ä¹Ÿå¯ä½¿ç”¨:&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@CommonLimit&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;doSomething&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&amp;#123;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä¼šåœ¨è°ƒç”¨è¾¾åˆ°é˜ˆå€¼æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†æ¨¡æ‹Ÿå¹¶å‘ï¼Œåœ¨ &lt;a href=&quot;https://github.com/crossoverJie/springboot-cloud/blob/master/sbc-user/user/src/main/java/com/crossoverJie/sbcuser/controller/UserController.java#L72-L91&quot;&gt;User&lt;/a&gt; åº”ç”¨ä¸­å¼€å¯äº† 10 ä¸ªçº¿ç¨‹è°ƒç”¨ Order(&lt;strong&gt;é™æµæ¬¡æ•°ä¸º5&lt;/strong&gt;) æ¥å£(ä¹Ÿå¯ä½¿ç”¨ä¸“ä¸šçš„å¹¶å‘æµ‹è¯•å·¥å…· JMeter ç­‰)ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="sbc" scheme="http://crossoverjie.top/categories/sbc/"/>
    
      <category term="Distributed Tools" scheme="http://crossoverjie.top/categories/sbc/Distributed-Tools/"/>
    
    
      <category term="Distributed Limited" scheme="http://crossoverjie.top/tags/Distributed-Limited/"/>
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘å¯¹äºåˆå­¦è€…ä»€ä¹ˆæ˜¯æœ€å¥½çš„ç¼–ç¨‹è¯­è¨€ï¼Ÿ</title>
    <link href="http://crossoverjie.top/2018/04/12/translation/translation-What%20Is%20The%20Best%20Programming%20Language%20to%20Start/"/>
    <id>http://crossoverjie.top/2018/04/12/translation/translation-What Is The Best Programming Language to Start/</id>
    <published>2018-04-11T17:02:13.000Z</published>
    <updated>2018-04-12T14:45:21.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åŸæ–‡é“¾æ¥"><a href="#åŸæ–‡é“¾æ¥" class="headerlink" title="åŸæ–‡é“¾æ¥"></a><a href="https://hackernoon.com/what-is-the-best-programming-language-to-start-8ca8fb5e9a60" target="_blank" rel="external">åŸæ–‡é“¾æ¥</a></h3><p>Pythonï¼ŸJavaï¼ŸRubyï¼ŸJavaScriptï¼Ÿæœ‰éå¸¸å¤šçš„é€‰æ‹©ã€‚é€‰æ‹©ä¸€ç§ç¼–ç¨‹è¯­è¨€å¼€å§‹ä½ çš„ç¼–ç ä¹‹æ—…ä¸åº”è¯¥æ˜¯ä¸€ä»¶è‰°å·¨çš„ä»»åŠ¡ã€‚</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fq952y5gn6j318g0p0q88.jpg" alt=""></p>
<p>äº‹å®ä¸Šï¼šä½ å°†è¦å­¦ä¹ çš„è¯­è¨€å¹¶ä¸æ˜¯ç‰¹åˆ«é‡è¦ï¼Œæ›´é‡è¦çš„æ˜¯å­¦ä¹ ç¼–ç¨‹çš„ç†å¿µã€‚å¯¹äºä»»ä½•ç¼–ç¨‹è¯­è¨€æ¥è¯´çŸ¥è¯†çš„å¯ä¼ é€’æ€§éƒ½æ˜¯è‡³å…³é‡è¦çš„ã€‚</p>
<p>æˆ‘å­¦ä¹ çš„ç¬¬ä¸€é—¨è¯­è¨€æ˜¯ Javaï¼Œå­¦ä¹ äº†å¾ªç¯ï¼Œwhile å¾ªç¯ï¼Œæ¡ä»¶ï¼Œå‡½æ•°ï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹å’Œè®¸å¤šç¼–ç¨‹ç†å¿µã€‚</p>
<p>ç„¶è€Œï¼Œé€‰æ‹©ä¸€é—¨èƒ½åœ¨ç¼–ç¨‹é¢†åŸŸè½»æ¾æ‰¾åˆ°å·¥ä½œçš„è¯­è¨€æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚å¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œæˆ‘è¿™é‡Œæœ‰ä¸€ä»½åˆ—è¡¨æ¨èç»™ä½ ï¼š</p>
<a id="more"></a>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>Python åœ¨ç¾å›½å¤§å­¦é‡Œæ˜¯æœ€å—æ¬¢è¿çš„å…¥é—¨å‹è¯­è¨€ã€‚</p>
<p>å°±åƒ JavaScript ä¸€æ ·ï¼ŒPython ä¹Ÿéå¸¸çµæ´»ï¼Œç°åœ¨è¢«ç”¨äºæ„å»ºç”Ÿç‰©ä¿¡æ¯å­¦çš„ web åº”ç”¨ã€‚æˆ‘å¼ºçƒˆæ¨èä½ å­¦ä¹  Pythonï¼Œå®ƒæ˜¯å¾ˆæ£’çš„å…¥é—¨é€‰æ‹©ã€‚</p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>Java æ˜¯ä¼ä¸šç¯å¢ƒä¸­ä½¿ç”¨æœ€å¤šçš„è¯­è¨€ï¼Œæ ¹æ® TIOBE ç»Ÿè®¡ Java é•¿å¹´å æ®ç¼–ç¨‹è¯­è¨€æ¦œé¦–ã€‚åŒæ—¶ Java æ˜¯å¼ºç±»å‹åœ°é™æ€è¯­è¨€ï¼Œå¯ä»¥æ›´å®¹æ˜“åœ°å»æè¿°ä¸€äº›ç¼–ç¨‹ç†å¿µã€‚</p>
<p>Java ä½œä¸ºæœ€å¸¸ä½¿ç”¨çš„è¯­è¨€ï¼Œä½ å¯ä»¥å¾ˆè½»æ¾åœ°åœ¨è¿™æ®µç¼–ç¨‹ä¹‹æ—…ä¸­æ‰¾åˆ° Java çš„ç›¸å…³è¯¾ç¨‹å’ŒæŒ‡å—æ¥è·å¾—å¸®åŠ©ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨ Java æ„å»ºæœåŠ¡ç«¯åº”ç”¨ã€Android APP ç­‰åº”ç”¨ç¨‹åºã€‚</p>
<h3 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h3><p>Ruby æ˜¯æˆ‘æœ€å–œæ¬¢çš„ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒç¼–å†™ç®€å•ï¼Œå®¹æ˜“ç†è§£å¹¶ä¸”ä½¿ç”¨é¡ºæ‰‹ã€‚</p>
<p>å°±åƒ JavaScript ä¸€æ ·ï¼Œå®ƒå­¦èµ·æ¥ç®€å•ä½†æ˜¯ä¸æ˜“æŒæ¡ã€‚Ruby åœ¨å¾ˆå¤šå…¬å¸ä¸­è¢«å¹¿æ³›åº”ç”¨ï¼Œæ¯”å¦‚ Airbnb, EBANX, Shopify, Twitter, GitHub ç­‰ç­‰ã€‚å®ƒè¿˜æœ‰ä¸€ä¸ªè¶…èµçš„ 7*24 å°æ—¶çš„åœ¨çº¿ç¤¾åŒºéšæ—¶æä¾›å¸®åŠ©ã€‚<br>Ruby ä»¥  Ruby on Rails æ¡†æ¶è‘—ç§°ï¼Œå®ƒå¯ä»¥å¸®ä½ å¾ˆè½»æ¾çš„æ„å»ºæ•´ä¸ª web åº”ç”¨ã€‚</p>
<h3 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h3><p>JavaScript æ˜¯æˆ‘ç”¨è¿‡çš„æœ€çµæ´»çš„è¯­è¨€ä¹‹ä¸€ã€‚</p>
<p>ä½ èƒ½ç”¨å®ƒæ„å»ºæ§åˆ¶å°ç¨‹åºï¼Œæ¡Œé¢è½¯ä»¶ï¼Œæ‰‹æœº APPï¼Œå‰ç«¯å¼€å‘ï¼Œåç«¯å¼€å‘ç­‰ç­‰ã€‚å®ƒæ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„ç¼–ç¨‹è¯­è¨€ï¼Œç®€å•æ˜“å­¦ä½†éš¾ä»¥æŒæ¡ã€‚</p>
<p>æˆ‘å»ºè®®ä½ å­¦ä¹ å¹¶æŒæ¡ JavaScript ï¼Œä½†ä¸æ˜¯ä½œä¸ºç¬¬ä¸€é—¨è¯­è¨€ã€‚</p>
<p>å¯¹äºåˆå­¦è€…æ¥è¯´ JavaScript å¾ˆéš¾è°ƒè¯•å¹¶ä¸”ä¸å®¹æ˜“å­¦ä¹ ç¼–ç¨‹ç†å¿µæ¯”å¦‚å¼‚æ­¥ï¼ŒåŸå‹ï¼Œé¢å‘å¯¹è±¡ç­‰ç­‰ã€‚</p>
<h3 id="ä¸è¦çº ç»“è¯­è¨€"><a href="#ä¸è¦çº ç»“è¯­è¨€" class="headerlink" title="ä¸è¦çº ç»“è¯­è¨€"></a>ä¸è¦çº ç»“è¯­è¨€</h3><p>ä½ éœ€è¦é€šè¿‡é€‰æ‹©ä¸€é—¨è¯­è¨€æ¥å­¦ä¹ ç¼–ç¨‹ç†å¿µï¼Œå½“ä½ å­¦å®Œä¹‹åä½ å°†èŠ±è´¹è¾ƒå°çš„å­¦ä¹ æ›²çº¿æ¥å­¦ä¹ ä»»ä½•å…¶ä»–çš„è¯­è¨€ã€‚</p>
<p>å¦‚æœä½ æƒ³è¦å­¦ä¹ å¦‚ä½•å­¦ä¹ ä¸€é—¨æ–°è¯­è¨€çš„è¯ï¼Œå¯ä»¥é˜…è¯»æˆ‘çš„æ–‡ç«  â€œ<a href="https://hackernoon.com/what-is-the-best-programming-language-to-start-8ca8fb5e9a60" target="_blank" rel="external">How to Learn a New Programming Language or Framework</a>â€ï¼Œå°†ä¼šéå¸¸æœ‰ç”¨ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;åŸæ–‡é“¾æ¥&quot;&gt;&lt;a href=&quot;#åŸæ–‡é“¾æ¥&quot; class=&quot;headerlink&quot; title=&quot;åŸæ–‡é“¾æ¥&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://hackernoon.com/what-is-the-best-programming-language-to-start-8ca8fb5e9a60&quot;&gt;åŸæ–‡é“¾æ¥&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Pythonï¼ŸJavaï¼ŸRubyï¼ŸJavaScriptï¼Ÿæœ‰éå¸¸å¤šçš„é€‰æ‹©ã€‚é€‰æ‹©ä¸€ç§ç¼–ç¨‹è¯­è¨€å¼€å§‹ä½ çš„ç¼–ç ä¹‹æ—…ä¸åº”è¯¥æ˜¯ä¸€ä»¶è‰°å·¨çš„ä»»åŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tKfTcgy1fq952y5gn6j318g0p0q88.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;äº‹å®ä¸Šï¼šä½ å°†è¦å­¦ä¹ çš„è¯­è¨€å¹¶ä¸æ˜¯ç‰¹åˆ«é‡è¦ï¼Œæ›´é‡è¦çš„æ˜¯å­¦ä¹ ç¼–ç¨‹çš„ç†å¿µã€‚å¯¹äºä»»ä½•ç¼–ç¨‹è¯­è¨€æ¥è¯´çŸ¥è¯†çš„å¯ä¼ é€’æ€§éƒ½æ˜¯è‡³å…³é‡è¦çš„ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘å­¦ä¹ çš„ç¬¬ä¸€é—¨è¯­è¨€æ˜¯ Javaï¼Œå­¦ä¹ äº†å¾ªç¯ï¼Œwhile å¾ªç¯ï¼Œæ¡ä»¶ï¼Œå‡½æ•°ï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹å’Œè®¸å¤šç¼–ç¨‹ç†å¿µã€‚&lt;/p&gt;
&lt;p&gt;ç„¶è€Œï¼Œé€‰æ‹©ä¸€é—¨èƒ½åœ¨ç¼–ç¨‹é¢†åŸŸè½»æ¾æ‰¾åˆ°å·¥ä½œçš„è¯­è¨€æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚å¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œæˆ‘è¿™é‡Œæœ‰ä¸€ä»½åˆ—è¡¨æ¨èç»™ä½ ï¼š&lt;/p&gt;
    
    </summary>
    
      <category term="ç¿»è¯‘" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
  </entry>
  
  <entry>
    <title>åŠ¨æ‰‹å®ç°ä¸€ä¸ª LRU cache</title>
    <link href="http://crossoverjie.top/2018/04/07/algorithm/LRU-cache/"/>
    <id>http://crossoverjie.top/2018/04/07/algorithm/LRU-cache/</id>
    <published>2018-04-06T17:01:36.000Z</published>
    <updated>2018-04-07T04:46:19.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fq3fey7n97j31340o8myw.jpg" alt=""></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>LRU æ˜¯ <code>Least Recently Used</code> çš„ç®€å†™ï¼Œå­—é¢æ„æ€åˆ™æ˜¯<code>æœ€è¿‘æœ€å°‘ä½¿ç”¨</code>ã€‚</p>
<p>é€šå¸¸ç”¨äºç¼“å­˜çš„æ·˜æ±°ç­–ç•¥å®ç°ï¼Œç”±äºç¼“å­˜çš„å†…å­˜éå¸¸å®è´µï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®æŸç§è§„åˆ™æ¥å‰”é™¤æ•°æ®ä¿è¯å†…å­˜ä¸è¢«æ’‘æ»¡ã€‚</p>
<p>å¦‚å¸¸ç”¨çš„ Redis å°±æœ‰ä»¥ä¸‹å‡ ç§ç­–ç•¥ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç­–ç•¥</th>
<th style="text-align:center">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">volatile-lru</td>
<td style="text-align:center">ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</td>
</tr>
<tr>
<td style="text-align:center">volatile-ttl</td>
<td style="text-align:center">ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°</td>
</tr>
<tr>
<td style="text-align:center">volatile-random</td>
<td style="text-align:center">ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°</td>
</tr>
<tr>
<td style="text-align:center">allkeys-lru</td>
<td style="text-align:center">ä»æ‰€æœ‰æ•°æ®é›†ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</td>
</tr>
<tr>
<td style="text-align:center">allkeys-random</td>
<td style="text-align:center">ä»æ‰€æœ‰æ•°æ®é›†ä¸­ä»»æ„é€‰æ‹©æ•°æ®è¿›è¡Œæ·˜æ±°</td>
</tr>
<tr>
<td style="text-align:center">no-envicition</td>
<td style="text-align:center">ç¦æ­¢é©±é€æ•°æ®</td>
</tr>
</tbody>
</table>
<blockquote>
<p>æ‘˜æŠ„è‡ª:<a href="https://github.com/CyC2018/Interview-Notebook/blob/master/notes/Redis.md#%E5%8D%81%E4%B8%89%E6%95%B0%E6%8D%AE%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5" target="_blank" rel="external">https://github.com/CyC2018/Interview-Notebook/blob/master/notes/Redis.md#%E5%8D%81%E4%B8%89%E6%95%B0%E6%8D%AE%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5</a></p>
</blockquote>
<a id="more"></a>
<h2 id="å®ç°ä¸€"><a href="#å®ç°ä¸€" class="headerlink" title="å®ç°ä¸€"></a>å®ç°ä¸€</h2><p>ä¹‹å‰ä¹Ÿæœ‰æ¥è§¦è¿‡ä¸€é“é¢è¯•é¢˜ï¼Œå¤§æ¦‚éœ€æ±‚æ˜¯ï¼š</p>
<ul>
<li>å®ç°ä¸€ä¸ª LRU ç¼“å­˜ï¼Œå½“ç¼“å­˜æ•°æ®è¾¾åˆ° N ä¹‹åéœ€è¦æ·˜æ±°æ‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®ã€‚</li>
<li>N å°æ—¶ä¹‹å†…æ²¡æœ‰è¢«è®¿é—®çš„æ•°æ®ä¹Ÿéœ€è¦æ·˜æ±°æ‰ã€‚</li>
</ul>
<p>ä»¥ä¸‹æ˜¯æˆ‘çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRUAbstractMap</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">util</span>.<span class="title">AbstractMap</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(LRUAbstractMap.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ£€æŸ¥æ˜¯å¦è¶…æœŸçº¿ç¨‹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> ExecutorService checkTimePool ;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * map æœ€å¤§size</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_SIZE = <span class="number">1024</span> ;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ArrayBlockingQueue&lt;Node&gt; QUEUE = <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(MAX_SIZE) ;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é»˜è®¤å¤§å°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_ARRAY_SIZE =<span class="number">1024</span> ;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°ç»„é•¿åº¦</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> arraySize ;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°ç»„</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Object[] arrays ;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆ¤æ–­æ˜¯å¦åœæ­¢ flag</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">true</span> ;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¶…æ—¶æ—¶é—´</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Long EXPIRE_TIME = <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span> ;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•´ä¸ª Map çš„å¤§å°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> AtomicInteger size  ;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUAbstractMap</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">        arraySize = DEFAULT_ARRAY_SIZE;</div><div class="line">        arrays = <span class="keyword">new</span> Object[arraySize] ;</div><div class="line"></div><div class="line">        <span class="comment">//å¼€å¯ä¸€ä¸ªçº¿ç¨‹æ£€æŸ¥æœ€å…ˆæ”¾å…¥é˜Ÿåˆ—çš„å€¼æ˜¯å¦è¶…æœŸ</span></div><div class="line">        executeCheckTime();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¼€å¯ä¸€ä¸ªçº¿ç¨‹æ£€æŸ¥æœ€å…ˆæ”¾å…¥é˜Ÿåˆ—çš„å€¼æ˜¯å¦è¶…æœŸ è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeCheckTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        ThreadFactory namedThreadFactory = <span class="keyword">new</span> ThreadFactoryBuilder()</div><div class="line">                .setNameFormat(<span class="string">"check-thread-%d"</span>)</div><div class="line">                .setDaemon(<span class="keyword">true</span>)</div><div class="line">                .build();</div><div class="line">        checkTimePool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</div><div class="line">                <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1</span>),namedThreadFactory,<span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</div><div class="line">        checkTimePool.execute(<span class="keyword">new</span> CheckTimeThread()) ;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Set&lt;Entry&gt; <span class="title">entrySet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.keySet();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> hash = hash(key);</div><div class="line">        <span class="keyword">int</span> index = hash % arraySize ;</div><div class="line">        Node currentNode = (Node) arrays[index] ;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (currentNode == <span class="keyword">null</span>)&#123;</div><div class="line">            arrays[index] = <span class="keyword">new</span> Node(<span class="keyword">null</span>,<span class="keyword">null</span>, key, value);</div><div class="line"></div><div class="line">            <span class="comment">//å†™å…¥é˜Ÿåˆ—</span></div><div class="line">            QUEUE.offer((Node) arrays[index]) ;</div><div class="line"></div><div class="line">            sizeUp();</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            Node cNode = currentNode ;</div><div class="line">            Node nNode = cNode ;</div><div class="line"></div><div class="line">            <span class="comment">//å­˜åœ¨å°±è¦†ç›–</span></div><div class="line">            <span class="keyword">if</span> (nNode.key == key)&#123;</div><div class="line">                cNode.val = value ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">while</span> (nNode.next != <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="comment">//key å­˜åœ¨ å°±è¦†ç›– ç®€å•åˆ¤æ–­</span></div><div class="line">                <span class="keyword">if</span> (nNode.key == key)&#123;</div><div class="line">                    nNode.val = value ;</div><div class="line">                    <span class="keyword">break</span> ;</div><div class="line">                &#125;<span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">//ä¸å­˜åœ¨å°±æ–°å¢é“¾è¡¨</span></div><div class="line">                    sizeUp();</div><div class="line">                    Node node = <span class="keyword">new</span> Node(nNode,<span class="keyword">null</span>,key,value) ;</div><div class="line"></div><div class="line">                    <span class="comment">//å†™å…¥é˜Ÿåˆ—</span></div><div class="line">                    QUEUE.offer(currentNode) ;</div><div class="line"></div><div class="line">                    cNode.next = node ;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                nNode = nNode.next ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> hash = hash(key) ;</div><div class="line">        <span class="keyword">int</span> index = hash % arraySize ;</div><div class="line">        Node currentNode = (Node) arrays[index] ;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (currentNode == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span> ;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (currentNode.next == <span class="keyword">null</span>)&#123;</div><div class="line"></div><div class="line">            <span class="comment">//æ›´æ–°æ—¶é—´</span></div><div class="line">            currentNode.setUpdateTime(System.currentTimeMillis());</div><div class="line"></div><div class="line">            <span class="comment">//æ²¡æœ‰å†²çª</span></div><div class="line">            <span class="keyword">return</span> currentNode ;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Node nNode = currentNode ;</div><div class="line">        <span class="keyword">while</span> (nNode.next != <span class="keyword">null</span>)&#123;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (nNode.key == key)&#123;</div><div class="line"></div><div class="line">                <span class="comment">//æ›´æ–°æ—¶é—´</span></div><div class="line">                currentNode.setUpdateTime(System.currentTimeMillis());</div><div class="line"></div><div class="line">                <span class="keyword">return</span> nNode ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            nNode = nNode.next ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.get(key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> hash = hash(key) ;</div><div class="line">        <span class="keyword">int</span> index = hash % arraySize ;</div><div class="line">        Node currentNode = (Node) arrays[index] ;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (currentNode == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span> ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (currentNode.key == key)&#123;</div><div class="line">            sizeDown();</div><div class="line">            arrays[index] = <span class="keyword">null</span> ;</div><div class="line"></div><div class="line">            <span class="comment">//ç§»é™¤é˜Ÿåˆ—</span></div><div class="line">            QUEUE.poll();</div><div class="line">            <span class="keyword">return</span> currentNode ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Node nNode = currentNode ;</div><div class="line">        <span class="keyword">while</span> (nNode.next != <span class="keyword">null</span>)&#123;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (nNode.key == key)&#123;</div><div class="line">                sizeDown();</div><div class="line">                <span class="comment">//åœ¨é“¾è¡¨ä¸­æ‰¾åˆ°äº† æŠŠä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„ next æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line">                nNode.pre.next = nNode.next ;</div><div class="line">                nNode = <span class="keyword">null</span> ;</div><div class="line"></div><div class="line">                <span class="comment">//ç§»é™¤é˜Ÿåˆ—</span></div><div class="line">                QUEUE.poll();</div><div class="line"></div><div class="line">                <span class="keyword">return</span> nNode;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            nNode = nNode.next ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.remove(key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¢åŠ size</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sizeUp</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//åœ¨putå€¼æ—¶å€™è®¤ä¸ºé‡Œè¾¹å·²ç»æœ‰æ•°æ®äº†</span></div><div class="line">        flag = <span class="keyword">true</span> ;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (size == <span class="keyword">null</span>)&#123;</div><div class="line">            size = <span class="keyword">new</span> AtomicInteger() ;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> size = <span class="keyword">this</span>.size.incrementAndGet();</div><div class="line">        <span class="keyword">if</span> (size &gt;= MAX_SIZE) &#123;</div><div class="line">            <span class="comment">//æ‰¾åˆ°é˜Ÿåˆ—å¤´çš„æ•°æ®</span></div><div class="line">            Node node = QUEUE.poll() ;</div><div class="line">            <span class="keyword">if</span> (node == <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"data error"</span>) ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//ç§»é™¤è¯¥ key</span></div><div class="line">            Object key = node.key ;</div><div class="line">            remove(key) ;</div><div class="line">            lruCallback() ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ•°é‡å‡å°</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sizeDown</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (QUEUE.size() == <span class="number">0</span>)&#123;</div><div class="line">            flag = <span class="keyword">false</span> ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.size.decrementAndGet() ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size.get() ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é“¾è¡¨</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</div><div class="line">        <span class="keyword">private</span> Node next ;</div><div class="line">        <span class="keyword">private</span> Node pre ;</div><div class="line">        <span class="keyword">private</span> Object key ;</div><div class="line">        <span class="keyword">private</span> Object val ;</div><div class="line">        <span class="keyword">private</span> Long updateTime ;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(Node pre,Node next, Object key, Object val)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.pre = pre ;</div><div class="line">            <span class="keyword">this</span>.next = next;</div><div class="line">            <span class="keyword">this</span>.key = key;</div><div class="line">            <span class="keyword">this</span>.val = val;</div><div class="line">            <span class="keyword">this</span>.updateTime = System.currentTimeMillis() ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUpdateTime</span><span class="params">(Long updateTime)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.updateTime = updateTime;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">getUpdateTime</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> updateTime;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"Node&#123;"</span> +</div><div class="line">                    <span class="string">"key="</span> + key +</div><div class="line">                    <span class="string">", val="</span> + val +</div><div class="line">                    <span class="string">'&#125;'</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * copy HashMap çš„ hash å®ç°</div><div class="line">     * <span class="doctag">@param</span> key</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> h;</div><div class="line">        <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">lruCallback</span><span class="params">()</span></span>&#123;</div><div class="line">        LOGGER.debug(<span class="string">"lruCallback"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckTimeThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">while</span> (flag)&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Node node = QUEUE.poll();</div><div class="line">                    <span class="keyword">if</span> (node == <span class="keyword">null</span>)&#123;</div><div class="line">                        <span class="keyword">continue</span> ;</div><div class="line">                    &#125;</div><div class="line">                    Long updateTime = node.getUpdateTime() ;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> ((updateTime - System.currentTimeMillis()) &gt;= EXPIRE_TIME)&#123;</div><div class="line">                        remove(node.key) ;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    LOGGER.error(<span class="string">"InterruptedException"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç›´æ¥ä»:</p>
<p><a href="https://github.com/crossoverJie/Java-Interview/blob/master/src/main/java/com/crossoverjie/actual/LRUAbstractMap.java" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview/blob/master/src/main/java/com/crossoverjie/actual/LRUAbstractMap.java</a></p>
<p>ä¸‹è½½ä»£ç æœ¬åœ°è¿è¡Œã€‚</p>
<p>ä»£ç çœ‹ç€æ¯”è¾ƒå¤šï¼Œå…¶å®å®ç°çš„æ€è·¯è¿˜æ˜¯æ¯”è¾ƒç®€å•ï¼š</p>
<ul>
<li>é‡‡ç”¨äº†ä¸ HashMap ä¸€æ ·çš„ä¿å­˜æ•°æ®æ–¹å¼ï¼Œåªæ˜¯è‡ªå·±æ‰‹åŠ¨å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆã€‚</li>
<li>å†…éƒ¨é‡‡ç”¨äº†ä¸€ä¸ªé˜Ÿåˆ—æ¥ä¿å­˜æ¯æ¬¡å†™å…¥çš„æ•°æ®ã€‚</li>
<li>å†™å…¥çš„æ—¶å€™åˆ¤æ–­ç¼“å­˜æ˜¯å¦å¤§äºäº†é˜ˆå€¼ Nï¼Œå¦‚æœæ»¡è¶³åˆ™æ ¹æ®é˜Ÿåˆ—çš„ FIFO ç‰¹æ€§å°†é˜Ÿåˆ—å¤´çš„æ•°æ®åˆ é™¤ã€‚å› ä¸ºé˜Ÿåˆ—å¤´çš„æ•°æ®è‚¯å®šæ˜¯æœ€å…ˆæ”¾è¿›å»çš„ã€‚</li>
<li>å†å¼€å¯äº†ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ç”¨äºåˆ¤æ–­æœ€å…ˆæ”¾è¿›å»çš„æ•°æ®æ˜¯å¦è¶…æœŸï¼ˆå› ä¸ºå°±ç®—è¶…æœŸä¹Ÿæ˜¯æœ€å…ˆæ”¾è¿›å»çš„æ•°æ®æœ€æœ‰å¯èƒ½æ»¡è¶³è¶…æœŸæ¡ä»¶ã€‚ï¼‰</li>
<li>è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹å¯ä»¥æ›´å¥½çš„è¡¨æ˜å…¶ç›®çš„ï¼ˆæœ€åçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹æœ€ç»ˆæœ‰å¯èƒ½å¯¼è‡´ç¨‹åºä¸èƒ½æ­£å¸¸é€€å‡ºï¼Œå› ä¸ºè¯¥çº¿ç¨‹ä¸€ç›´åœ¨è¿è¡Œï¼Œå®ˆæŠ¤çº¿ç¨‹åˆ™ä¸ä¼šæœ‰è¿™ä¸ªæƒ…å†µã€‚ï¼‰</li>
</ul>
<p>ä»¥ä¸Šä»£ç å¤§ä½“åŠŸèƒ½æ»¡è¶³äº†ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªè‡´å‘½é—®é¢˜ã€‚</p>
<p>å°±æ˜¯æœ€è¿‘<strong>æœ€å°‘ä½¿ç”¨</strong>æ²¡æœ‰æ»¡è¶³ï¼Œåˆ é™¤çš„æ•°æ®éƒ½æ˜¯æœ€å…ˆæ”¾å…¥çš„æ•°æ®ã€‚</p>
<blockquote>
<p>ä¸è¿‡å…¶ä¸­çš„ <code>put get</code> æµç¨‹ç®—æ˜¯ä¸€ä¸ªç®€æ˜“çš„ HashMap å®ç°ï¼Œå¯ä»¥å¯¹ HashMap åŠ æ·±ä¸€äº›ç†è§£ã€‚</p>
</blockquote>
<h2 id="å®ç°äºŒ"><a href="#å®ç°äºŒ" class="headerlink" title="å®ç°äºŒ"></a>å®ç°äºŒ</h2><p>å› æ­¤å¦‚ä½•æ¥å®ç°ä¸€ä¸ªå®Œæ•´çš„ LRU ç¼“å­˜å‘¢ï¼Œè¿™æ¬¡ä¸è€ƒè™‘è¿‡æœŸæ—¶é—´çš„é—®é¢˜ã€‚</p>
<p>å…¶å®ä»ä¸Šä¸€ä¸ªå®ç°ä¹Ÿèƒ½æƒ³åˆ°ä¸€äº›æ€è·¯ï¼š</p>
<ul>
<li>è¦è®°å½•æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œé‚£è‡³å°‘éœ€è¦ä¸€ä¸ªæœ‰åºçš„é›†åˆæ¥ä¿è¯å†™å…¥çš„é¡ºåºã€‚</li>
<li>åœ¨ä½¿ç”¨äº†æ•°æ®ä¹‹åèƒ½å¤Ÿæ›´æ–°å®ƒçš„é¡ºåºã€‚</li>
</ul>
<p>åŸºäºä»¥ä¸Šä¸¤ç‚¹å¾ˆå®¹æ˜“æƒ³åˆ°ä¸€ä¸ªå¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼š<strong>é“¾è¡¨</strong>ã€‚</p>
<ol>
<li>æ¯æ¬¡å†™å…¥æ•°æ®æ—¶å°†æ•°æ®æ”¾å…¥é“¾è¡¨å¤´ç»“ç‚¹ã€‚</li>
<li>ä½¿ç”¨æ•°æ®æ—¶å€™å°†æ•°æ®<strong>ç§»åŠ¨åˆ°å¤´ç»“ç‚¹</strong>ã€‚</li>
<li>ç¼“å­˜æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶ç§»é™¤é“¾è¡¨å°¾éƒ¨æ•°æ®ã€‚</li>
</ol>
<p>å› æ­¤æœ‰äº†ä»¥ä¸‹å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRUMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K, V&gt; cacheMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€å¤§ç¼“å­˜å¤§å°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cacheSize;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * èŠ‚ç‚¹å¤§å°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> nodeCount;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¤´ç»“ç‚¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Node&lt;K, V&gt; header;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å°¾ç»“ç‚¹</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Node&lt;K, V&gt; tailer;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUMap</span><span class="params">(<span class="keyword">int</span> cacheSize)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.cacheSize = cacheSize;</div><div class="line">        <span class="comment">//å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ä¸ºç©º</span></div><div class="line">        header = <span class="keyword">new</span> Node&lt;&gt;();</div><div class="line">        header.next = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="comment">//å°¾ç»“ç‚¹çš„ä¸Šä¸€ä¸ªç»“ç‚¹ä¸ºç©º</span></div><div class="line">        tailer = <span class="keyword">new</span> Node&lt;&gt;();</div><div class="line">        tailer.tail = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="comment">//åŒå‘é“¾è¡¨ å¤´ç»“ç‚¹çš„ä¸Šç»“ç‚¹æŒ‡å‘å°¾ç»“ç‚¹</span></div><div class="line">        header.tail = tailer;</div><div class="line"></div><div class="line">        <span class="comment">//å°¾ç»“ç‚¹çš„ä¸‹ç»“ç‚¹æŒ‡å‘å¤´ç»“ç‚¹</span></div><div class="line">        tailer.next = header;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">        cacheMap.put(key, value);</div><div class="line"></div><div class="line">        <span class="comment">//åŒå‘é“¾è¡¨ä¸­æ·»åŠ ç»“ç‚¹</span></div><div class="line">        addNode(key, value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K key)</span></span>&#123;</div><div class="line"></div><div class="line">        Node&lt;K, V&gt; node = getNode(key);</div><div class="line"></div><div class="line">        <span class="comment">//ç§»åŠ¨åˆ°å¤´ç»“ç‚¹</span></div><div class="line">        moveToHead(node) ;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> cacheMap.get(key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveToHead</span><span class="params">(Node&lt;K,V&gt; node)</span></span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//å¦‚æœæ˜¯æœ€åçš„ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line">        <span class="keyword">if</span> (node.tail == <span class="keyword">null</span>)&#123;</div><div class="line">            node.next.tail = <span class="keyword">null</span> ;</div><div class="line">            tailer = node.next ;</div><div class="line">            nodeCount -- ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//å¦‚æœæ˜¯æœ¬æ¥å°±æ˜¯å¤´èŠ‚ç‚¹ ä¸ä½œå¤„ç†</span></div><div class="line">        <span class="keyword">if</span> (node.next == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">return</span> ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//å¦‚æœå¤„äºä¸­é—´èŠ‚ç‚¹</span></div><div class="line">        <span class="keyword">if</span> (node.tail != <span class="keyword">null</span> &amp;&amp; node.next != <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="comment">//å®ƒçš„ä¸Šä¸€èŠ‚ç‚¹æŒ‡å‘å®ƒçš„ä¸‹ä¸€èŠ‚ç‚¹ ä¹Ÿå°±åˆ é™¤å½“å‰èŠ‚ç‚¹</span></div><div class="line">            node.tail.next = node.next ;</div><div class="line">            nodeCount -- ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//æœ€ååœ¨å¤´éƒ¨å¢åŠ å½“å‰èŠ‚ç‚¹</span></div><div class="line">        <span class="comment">//æ³¨æ„è¿™é‡Œéœ€è¦é‡æ–° new ä¸€ä¸ªå¯¹è±¡ï¼Œä¸ç„¶åŸæœ¬çš„node è¿˜æœ‰ç€ä¸‹é¢çš„å¼•ç”¨ï¼Œä¼šé€ æˆå†…å­˜æº¢å‡ºã€‚</span></div><div class="line">        node = <span class="keyword">new</span> Node&lt;&gt;(node.getKey(),node.getValue()) ;</div><div class="line">        addHead(node) ;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é“¾è¡¨æŸ¥è¯¢ æ•ˆç‡è¾ƒä½</div><div class="line">     * <span class="doctag">@param</span> key</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(K key)</span></span>&#123;</div><div class="line">        Node&lt;K,V&gt; node = tailer ;</div><div class="line">        <span class="keyword">while</span> (node != <span class="keyword">null</span>)&#123;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (node.getKey().equals(key))&#123;</div><div class="line">                <span class="keyword">return</span> node ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            node = node.next ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span> ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å†™å…¥å¤´ç»“ç‚¹</div><div class="line">     * <span class="doctag">@param</span> key</div><div class="line">     * <span class="doctag">@param</span> value</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addNode</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line"></div><div class="line">        Node&lt;K, V&gt; node = <span class="keyword">new</span> Node&lt;&gt;(key, value);</div><div class="line"></div><div class="line">        <span class="comment">//å®¹é‡æ»¡äº†åˆ é™¤æœ€åä¸€ä¸ª</span></div><div class="line">        <span class="keyword">if</span> (cacheSize == nodeCount) &#123;</div><div class="line">            <span class="comment">//åˆ é™¤å°¾ç»“ç‚¹</span></div><div class="line">            delTail();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//å†™å…¥å¤´ç»“ç‚¹</span></div><div class="line">        addHead(node);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ·»åŠ å¤´ç»“ç‚¹</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> node</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addHead</span><span class="params">(Node&lt;K, V&gt; node)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//å†™å…¥å¤´ç»“ç‚¹</span></div><div class="line">        header.next = node;</div><div class="line">        node.tail = header;</div><div class="line">        header = node;</div><div class="line">        nodeCount++;</div><div class="line"></div><div class="line">        <span class="comment">//å¦‚æœå†™å…¥çš„æ•°æ®å¤§äº2ä¸ª å°±å°†åˆå§‹åŒ–çš„å¤´å°¾ç»“ç‚¹åˆ é™¤</span></div><div class="line">        <span class="keyword">if</span> (nodeCount == <span class="number">2</span>) &#123;</div><div class="line">            tailer.next.next.tail = <span class="keyword">null</span>;</div><div class="line">            tailer = tailer.next.next;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;    </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">delTail</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//æŠŠå°¾ç»“ç‚¹ä»ç¼“å­˜ä¸­åˆ é™¤</span></div><div class="line">        cacheMap.remove(tailer.getKey());</div><div class="line"></div><div class="line">        <span class="comment">//åˆ é™¤å°¾ç»“ç‚¹</span></div><div class="line">        tailer.next.tail = <span class="keyword">null</span>;</div><div class="line">        tailer = tailer.next;</div><div class="line"></div><div class="line">        nodeCount--;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> K key;</div><div class="line">        <span class="keyword">private</span> V value;</div><div class="line">        Node&lt;K, V&gt; tail;</div><div class="line">        Node&lt;K, V&gt; next;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.key = key;</div><div class="line">            <span class="keyword">this</span>.value = value;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">()</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> K <span class="title">getKey</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> key;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(K key)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.key = key;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> V <span class="title">getValue</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> value;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(V value)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.value = value;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder() ;</div><div class="line">        Node&lt;K,V&gt; node = tailer ;</div><div class="line">        <span class="keyword">while</span> (node != <span class="keyword">null</span>)&#123;</div><div class="line">            sb.append(node.getKey()).append(<span class="string">":"</span>)</div><div class="line">                    .append(node.getValue())</div><div class="line">                    .append(<span class="string">"--&gt;"</span>) ;</div><div class="line"></div><div class="line">            node = node.next ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">return</span> sb.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æºç ï¼š<br><a href="https://github.com/crossoverJie/Java-Interview/blob/master/src/main/java/com/crossoverjie/actual/LRUMap.java" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview/blob/master/src/main/java/com/crossoverjie/actual/LRUMap.java</a></p>
<p>å®é™…æ•ˆæœï¼Œå†™å…¥æ—¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        LRUMap&lt;String,Integer&gt; lruMap = <span class="keyword">new</span> LRUMap(<span class="number">3</span>) ;</div><div class="line">        lruMap.put(<span class="string">"1"</span>,<span class="number">1</span>) ;</div><div class="line">        lruMap.put(<span class="string">"2"</span>,<span class="number">2</span>) ;</div><div class="line">        lruMap.put(<span class="string">"3"</span>,<span class="number">3</span>) ;</div><div class="line"></div><div class="line">        System.out.println(lruMap.toString());</div><div class="line"></div><div class="line">        lruMap.put(<span class="string">"4"</span>,<span class="number">4</span>) ;</div><div class="line">        System.out.println(lruMap.toString());</div><div class="line"></div><div class="line">        lruMap.put(<span class="string">"5"</span>,<span class="number">5</span>) ;</div><div class="line">        System.out.println(lruMap.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">//è¾“å‡ºï¼š</span></div><div class="line"><span class="number">1</span>:<span class="number">1</span>--&gt;<span class="number">2</span>:<span class="number">2</span>--&gt;<span class="number">3</span>:<span class="number">3</span>--&gt;</div><div class="line"><span class="number">2</span>:<span class="number">2</span>--&gt;<span class="number">3</span>:<span class="number">3</span>--&gt;<span class="number">4</span>:<span class="number">4</span>--&gt;</div><div class="line"><span class="number">3</span>:<span class="number">3</span>--&gt;<span class="number">4</span>:<span class="number">4</span>--&gt;<span class="number">5</span>:<span class="number">5</span>--&gt;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ—¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        LRUMap&lt;String,Integer&gt; lruMap = <span class="keyword">new</span> LRUMap(<span class="number">3</span>) ;</div><div class="line">        lruMap.put(<span class="string">"1"</span>,<span class="number">1</span>) ;</div><div class="line">        lruMap.put(<span class="string">"2"</span>,<span class="number">2</span>) ;</div><div class="line">        lruMap.put(<span class="string">"3"</span>,<span class="number">3</span>) ;</div><div class="line"></div><div class="line">        System.out.println(lruMap.toString());</div><div class="line">        System.out.println(<span class="string">"=============="</span>);</div><div class="line"></div><div class="line">        Integer integer = lruMap.get(<span class="string">"1"</span>);</div><div class="line">        System.out.println(integer);</div><div class="line">        System.out.println(<span class="string">"=============="</span>);</div><div class="line">        System.out.println(lruMap.toString());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="comment">//è¾“å‡º</span></div><div class="line"><span class="number">1</span>:<span class="number">1</span>--&gt;<span class="number">2</span>:<span class="number">2</span>--&gt;<span class="number">3</span>:<span class="number">3</span>--&gt;</div><div class="line">==============</div><div class="line"><span class="number">1</span></div><div class="line">==============</div><div class="line"><span class="number">2</span>:<span class="number">2</span>--&gt;<span class="number">3</span>:<span class="number">3</span>--&gt;<span class="number">1</span>:<span class="number">1</span>--&gt;</div></pre></td></tr></table></figure>
<p>å®ç°æ€è·¯å’Œä¸Šæ–‡æåˆ°çš„ä¸€è‡´ï¼Œè¯´ä¸‹é‡ç‚¹ï¼š</p>
<ul>
<li>æ•°æ®æ˜¯ç›´æ¥åˆ©ç”¨ HashMap æ¥å­˜æ”¾çš„ã€‚</li>
<li>å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥å­˜æ”¾æ•°æ®ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªå¤´ç»“ç‚¹ headerï¼Œä»¥åŠå°¾ç»“ç‚¹ tailerã€‚</li>
<li>æ¯æ¬¡å†™å…¥å¤´ç»“ç‚¹ï¼Œåˆ é™¤å°¾ç»“ç‚¹æ—¶éƒ½æ˜¯ä¾èµ–äº header tailerï¼Œå¦‚æœçœ‹ç€æ¯”è¾ƒæ‡µå»ºè®®è‡ªå·±å®ç°ä¸€ä¸ªé“¾è¡¨ç†Ÿæ‚‰ä¸‹ï¼Œæˆ–ç»“åˆä¸‹æ–‡çš„å¯¹è±¡å…³ç³»å›¾ä¸€èµ·ç†è§£ã€‚</li>
<li>ä½¿ç”¨æ•°æ®ç§»åŠ¨åˆ°é“¾è¡¨å¤´æ—¶ï¼Œç¬¬ä¸€æ­¥æ˜¯éœ€è¦åœ¨åŒå‘é“¾è¡¨ä¸­æ‰¾åˆ°è¯¥èŠ‚ç‚¹ã€‚è¿™é‡Œå°±ä½“ç°å‡ºé“¾è¡¨çš„é—®é¢˜äº†ã€‚æŸ¥æ‰¾æ•ˆç‡å¾ˆä½ï¼Œæœ€å·®éœ€è¦ <code>O(N)</code>ã€‚ä¹‹åä¾èµ–äºå½“å‰èŠ‚ç‚¹è¿›è¡Œç§»åŠ¨ã€‚</li>
<li>åœ¨å†™å…¥å¤´ç»“ç‚¹æ—¶æœ‰åˆ¤æ–­é“¾è¡¨å¤§å°ç­‰äº 2 æ—¶éœ€è¦åˆ é™¤åˆå§‹åŒ–çš„å¤´å°¾ç»“ç‚¹ã€‚è¿™æ˜¯å› ä¸ºåˆå§‹åŒ–æ—¶å€™ç”Ÿæˆäº†ä¸¤ä¸ªåŒå‘èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ•°æ®åªæ˜¯ä¸ºäº†å½¢æˆä¸€ä¸ªæ•°æ®ç»“æ„ã€‚å½“çœŸå®æ•°æ®è¿›æ¥ä¹‹åéœ€è¦åˆ é™¤ä»¥æ–¹ä¾¿åç»­çš„æ“ä½œï¼ˆè¿™ç‚¹å¯ä»¥ç»§ç»­ä¼˜åŒ–ï¼‰ã€‚</li>
<li>ä»¥ä¸Šçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œéœ€è¦ä½¿ç”¨è€…è‡ªè¡Œæ§åˆ¶ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯å¯¹è±¡å…³ç³»å›¾ï¼š</p>
<h3 id="åˆå§‹åŒ–æ—¶"><a href="#åˆå§‹åŒ–æ—¶" class="headerlink" title="åˆå§‹åŒ–æ—¶"></a>åˆå§‹åŒ–æ—¶</h3><p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fq3h4xsf4cj30dh09hglr.jpg" alt=""></p>
<h3 id="å†™å…¥æ•°æ®æ—¶"><a href="#å†™å…¥æ•°æ®æ—¶" class="headerlink" title="å†™å…¥æ•°æ®æ—¶"></a>å†™å…¥æ•°æ®æ—¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LRUMap&lt;String,Integer&gt; lruMap = <span class="keyword">new</span> LRUMap(<span class="number">3</span>) ;</div><div class="line">lruMap.put(<span class="string">"1"</span>,<span class="number">1</span>) ;</div></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fq3h892nalj30ef09jdg2.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lruMap.put(<span class="string">"2"</span>,<span class="number">2</span>) ;</div></pre></td></tr></table></figure>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fq3hayffy1j30jr0b6q3a.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lruMap.put(<span class="string">"3"</span>,<span class="number">3</span>) ;</div></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fq3hcfq95pj30gp0bot93.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lruMap.put(<span class="string">"4"</span>,<span class="number">4</span>) ;</div></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fq3hfl5r8ij30kn0b374s.jpg" alt=""></p>
<h3 id="è·å–æ•°æ®æ—¶"><a href="#è·å–æ•°æ®æ—¶" class="headerlink" title="è·å–æ•°æ®æ—¶"></a>è·å–æ•°æ®æ—¶</h3><p>æ•°æ®å’Œä¸Šæ–‡ä¸€æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Integer integer = lruMap.get(<span class="string">"2"</span>);</div></pre></td></tr></table></figure>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fq3hjbou5pj30k70aj3yy.jpg" alt=""></p>
<p>é€šè¿‡ä»¥ä¸Šå‡ å¼ å›¾åº”è¯¥æ˜¯å¾ˆå¥½ç†è§£æ•°æ®æ˜¯å¦‚ä½•å­˜æ”¾çš„äº†ã€‚</p>
<h2 id="å®ç°ä¸‰"><a href="#å®ç°ä¸‰" class="headerlink" title="å®ç°ä¸‰"></a>å®ç°ä¸‰</h2><p>å…¶å®å¦‚æœå¯¹ Java çš„é›†åˆæ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œä¼šå‘ç°ä¸Šæ–‡çš„ç»“æ„å’Œ LinkedHashMap éå¸¸ç±»ä¼¼ã€‚</p>
<p>å¯¹æ­¤ä¸å¤ªç†Ÿæ‚‰çš„æœ‹å‹å¯ä»¥å…ˆäº†è§£ä¸‹ <a href="http://crossoverjie.top/2018/02/06/LinkedHashMap/">LinkedHashMap åº•å±‚åˆ†æ</a> ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥å€ŸåŠ©äºå®ƒæ¥å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRULinkedMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æœ€å¤§ç¼“å­˜å¤§å°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cacheSize;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> LinkedHashMap&lt;K,V&gt; cacheMap ;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRULinkedMap</span><span class="params">(<span class="keyword">int</span> cacheSize)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.cacheSize = cacheSize;</div><div class="line"></div><div class="line">        cacheMap = <span class="keyword">new</span> LinkedHashMap(<span class="number">16</span>,<span class="number">0.75F</span>,<span class="keyword">true</span>)&#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry eldest)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (cacheSize + <span class="number">1</span> == cacheMap.size())&#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span> ;</div><div class="line">                &#125;<span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span> ;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(K key,V value)</span></span>&#123;</div><div class="line">        cacheMap.put(key,value) ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K key)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> cacheMap.get(key) ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> Collection&lt;Map.Entry&lt;K, V&gt;&gt; getAll() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;Map.Entry&lt;K, V&gt;&gt;(cacheMap.entrySet());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æºç ï¼š<br><a href="https://github.com/crossoverJie/Java-Interview/blob/master/src/main/java/com/crossoverjie/actual/LRULinkedMap.java" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview/blob/master/src/main/java/com/crossoverjie/actual/LRULinkedMap.java</a></p>
<p>è¿™æ¬¡å°±æ¯”è¾ƒç®€æ´äº†ï¼Œä¹Ÿå°±å‡ è¡Œä»£ç ï¼ˆå…·ä½“çš„é€»è¾‘ LinkedHashMap å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†ï¼‰</p>
<p>å®é™…æ•ˆæœ:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        LRULinkedMap&lt;String,Integer&gt; map = <span class="keyword">new</span> LRULinkedMap(<span class="number">3</span>) ;</div><div class="line">        map.put(<span class="string">"1"</span>,<span class="number">1</span>);</div><div class="line">        map.put(<span class="string">"2"</span>,<span class="number">2</span>);</div><div class="line">        map.put(<span class="string">"3"</span>,<span class="number">3</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; e : map.getAll())&#123;</div><div class="line">            System.out.print(e.getKey() + <span class="string">" : "</span> + e.getValue() + <span class="string">"\t"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">""</span>);</div><div class="line">        map.put(<span class="string">"4"</span>,<span class="number">4</span>);</div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; e : map.getAll())&#123;</div><div class="line">            System.out.print(e.getKey() + <span class="string">" : "</span> + e.getValue() + <span class="string">"\t"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="comment">//è¾“å‡º</span></div><div class="line"><span class="number">1</span> : <span class="number">1</span>	<span class="number">2</span> : <span class="number">2</span>	<span class="number">3</span> : <span class="number">3</span>	</div><div class="line"><span class="number">2</span> : <span class="number">2</span>	<span class="number">3</span> : <span class="number">3</span>	<span class="number">4</span> : <span class="number">4</span></div></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ—¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        LRULinkedMap&lt;String,Integer&gt; map = <span class="keyword">new</span> LRULinkedMap(<span class="number">4</span>) ;</div><div class="line">        map.put(<span class="string">"1"</span>,<span class="number">1</span>);</div><div class="line">        map.put(<span class="string">"2"</span>,<span class="number">2</span>);</div><div class="line">        map.put(<span class="string">"3"</span>,<span class="number">3</span>);</div><div class="line">        map.put(<span class="string">"4"</span>,<span class="number">4</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; e : map.getAll())&#123;</div><div class="line">            System.out.print(e.getKey() + <span class="string">" : "</span> + e.getValue() + <span class="string">"\t"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">""</span>);</div><div class="line">        map.get(<span class="string">"1"</span>) ;</div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; e : map.getAll())&#123;</div><div class="line">            System.out.print(e.getKey() + <span class="string">" : "</span> + e.getValue() + <span class="string">"\t"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//è¾“å‡º</span></div><div class="line"><span class="number">1</span> : <span class="number">1</span>	<span class="number">2</span> : <span class="number">2</span>	<span class="number">3</span> : <span class="number">3</span>	<span class="number">4</span> : <span class="number">4</span>	</div><div class="line"><span class="number">2</span> : <span class="number">2</span>	<span class="number">3</span> : <span class="number">3</span>	<span class="number">4</span> : <span class="number">4</span>	<span class="number">1</span> : <span class="number">1</span></div></pre></td></tr></table></figure>
<p>LinkedHashMap å†…éƒ¨ä¹Ÿæœ‰ç»´æŠ¤ä¸€ä¸ªåŒå‘é˜Ÿåˆ—ï¼Œåœ¨åˆå§‹åŒ–æ—¶ä¹Ÿä¼šç»™å®šä¸€ä¸ªç¼“å­˜å¤§å°çš„é˜ˆå€¼ã€‚åˆå§‹åŒ–æ—¶è‡ªå®šä¹‰æ˜¯å¦éœ€è¦åˆ é™¤æœ€è¿‘ä¸å¸¸ä½¿ç”¨çš„æ•°æ®ï¼Œå¦‚æœæ˜¯åˆ™ä¼šæŒ‰ç…§å®ç°äºŒä¸­çš„æ–¹å¼ç®¡ç†æ•°æ®ã€‚</p>
<p>å…¶å®ä¸»è¦ä»£ç å°±æ˜¯é‡å†™äº† LinkedHashMap çš„ removeEldestEntry æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K,V&gt; eldest)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®ƒé»˜è®¤æ˜¯è¿”å› falseï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šç®¡æœ‰æ²¡æœ‰è¶…è¿‡é˜ˆå€¼ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰å¤§äºäº†é˜ˆå€¼æ—¶è¿”å› trueï¼Œè¿™æ · LinkedHashMap å°±ä¼šå¸®æˆ‘ä»¬åˆ é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯å¯¹ LRU ç¼“å­˜çš„å®ç°ï¼Œäº†è§£äº†è¿™äº›è‡³å°‘åœ¨å¹³æ—¶ä½¿ç”¨æ—¶å¯ä»¥çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p>
<p>å½“ç„¶ä¸šç•Œä½¿ç”¨è¾ƒå¤šçš„è¿˜æœ‰ <a href="https://github.com/google/guava" target="_blank" rel="external">guava</a> çš„å®ç°ï¼Œå¹¶ä¸”å®ƒè¿˜æ”¯æŒå¤šç§è¿‡æœŸç­–ç•¥ã€‚</p>
<h2 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h2><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws1.sinaimg.cn/large/006tNc79gy1fq3fey7n97j31340o8myw.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;LRU æ˜¯ &lt;code&gt;Least Recently Used&lt;/code&gt; çš„ç®€å†™ï¼Œå­—é¢æ„æ€åˆ™æ˜¯&lt;code&gt;æœ€è¿‘æœ€å°‘ä½¿ç”¨&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;é€šå¸¸ç”¨äºç¼“å­˜çš„æ·˜æ±°ç­–ç•¥å®ç°ï¼Œç”±äºç¼“å­˜çš„å†…å­˜éå¸¸å®è´µï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®æŸç§è§„åˆ™æ¥å‰”é™¤æ•°æ®ä¿è¯å†…å­˜ä¸è¢«æ’‘æ»¡ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚å¸¸ç”¨çš„ Redis å°±æœ‰ä»¥ä¸‹å‡ ç§ç­–ç•¥ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:center&quot;&gt;ç­–ç•¥&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;volatile-lru&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;volatile-ttl&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­æŒ‘é€‰å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;volatile-random&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†ä¸­ä»»æ„é€‰æ‹©æ•°æ®æ·˜æ±°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;allkeys-lru&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;ä»æ‰€æœ‰æ•°æ®é›†ä¸­æŒ‘é€‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;allkeys-random&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;ä»æ‰€æœ‰æ•°æ®é›†ä¸­ä»»æ„é€‰æ‹©æ•°æ®è¿›è¡Œæ·˜æ±°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:center&quot;&gt;no-envicition&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;ç¦æ­¢é©±é€æ•°æ®&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;æ‘˜æŠ„è‡ª:&lt;a href=&quot;https://github.com/CyC2018/Interview-Notebook/blob/master/notes/Redis.md#%E5%8D%81%E4%B8%89%E6%95%B0%E6%8D%AE%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5&quot;&gt;https://github.com/CyC2018/Interview-Notebook/blob/master/notes/Redis.md#%E5%8D%81%E4%B8%89%E6%95%B0%E6%8D%AE%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="ç®—æ³•" scheme="http://crossoverjie.top/categories/%E7%AE%97%E6%B3%95/"/>
    
      <category term="LRU cache" scheme="http://crossoverjie.top/categories/%E7%AE%97%E6%B3%95/LRU-cache/"/>
    
    
  </entry>
  
  <entry>
    <title>åŸºäº Redis çš„åˆ†å¸ƒå¼é”</title>
    <link href="http://crossoverjie.top/2018/03/29/distributed-lock/distributed-lock-redis/"/>
    <id>http://crossoverjie.top/2018/03/29/distributed-lock/distributed-lock-redis/</id>
    <published>2018-03-29T12:10:36.000Z</published>
    <updated>2018-04-27T14:19:14.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fpvathnbf6j31kw11xwl3.jpg" alt=""></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åˆ†å¸ƒå¼é”åœ¨åˆ†å¸ƒå¼åº”ç”¨ä¸­åº”ç”¨å¹¿æ³›ï¼Œæƒ³è¦ææ‡‚ä¸€ä¸ªæ–°äº‹ç‰©é¦–å…ˆå¾—äº†è§£å®ƒçš„ç”±æ¥ï¼Œè¿™æ ·æ‰èƒ½æ›´åŠ çš„ç†è§£ç”šè‡³å¯ä»¥ä¸¾ä¸€åä¸‰ã€‚</p>
<p>é¦–å…ˆè°ˆåˆ°åˆ†å¸ƒå¼é”è‡ªç„¶ä¹Ÿå°±è”æƒ³åˆ°åˆ†å¸ƒå¼åº”ç”¨ã€‚</p>
<p>åœ¨æˆ‘ä»¬å°†åº”ç”¨æ‹†åˆ†ä¸ºåˆ†å¸ƒå¼åº”ç”¨ä¹‹å‰çš„å•æœºç³»ç»Ÿä¸­ï¼Œå¯¹ä¸€äº›å¹¶å‘åœºæ™¯è¯»å–å…¬å…±èµ„æºæ—¶å¦‚æ‰£åº“å­˜ï¼Œå–è½¦ç¥¨ä¹‹ç±»çš„éœ€æ±‚å¯ä»¥ç®€å•çš„ä½¿ç”¨<a href="http://crossoverjie.top/2018/01/14/Synchronize/">åŒæ­¥</a>æˆ–è€…æ˜¯<a href="http://crossoverjie.top/2018/01/25/ReentrantLock/">åŠ é”</a>å°±å¯ä»¥å®ç°ã€‚</p>
<p>ä½†æ˜¯åº”ç”¨åˆ†å¸ƒå¼äº†ä¹‹åç³»ç»Ÿç”±ä»¥å‰çš„å•è¿›ç¨‹å¤šçº¿ç¨‹çš„ç¨‹åºå˜ä¸ºäº†å¤šè¿›ç¨‹å¤šçº¿ç¨‹ï¼Œè¿™æ—¶ä½¿ç”¨ä»¥ä¸Šçš„è§£å†³æ–¹æ¡ˆæ˜æ˜¾å°±ä¸å¤Ÿäº†ã€‚</p>
<p>å› æ­¤ä¸šç•Œå¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆé€šå¸¸æ˜¯å€ŸåŠ©äºä¸€ä¸ªç¬¬ä¸‰æ–¹ç»„ä»¶å¹¶åˆ©ç”¨å®ƒè‡ªèº«çš„æ’ä»–æ€§æ¥è¾¾åˆ°å¤šè¿›ç¨‹çš„äº’æ–¥ã€‚å¦‚ï¼š</p>
<ul>
<li>åŸºäº DB çš„å”¯ä¸€ç´¢å¼•ã€‚</li>
<li>åŸºäº ZK çš„ä¸´æ—¶æœ‰åºèŠ‚ç‚¹ã€‚</li>
<li>åŸºäº Redis çš„ <code>NX EX</code> å‚æ•°ã€‚</li>
</ul>
<p>è¿™é‡Œä¸»è¦åŸºäº Redis è¿›è¡Œè®¨è®ºã€‚</p>
<a id="more"></a>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>æ—¢ç„¶æ˜¯é€‰ç”¨äº† Redisï¼Œé‚£ä¹ˆå®ƒå°±å¾—å…·æœ‰æ’ä»–æ€§æ‰è¡Œã€‚åŒæ—¶å®ƒæœ€å¥½ä¹Ÿæœ‰é”çš„ä¸€äº›åŸºæœ¬ç‰¹æ€§ï¼š</p>
<ul>
<li>é«˜æ€§èƒ½(åŠ ã€è§£é”æ—¶é«˜æ€§èƒ½)</li>
<li>å¯ä»¥ä½¿ç”¨é˜»å¡é”ä¸éé˜»å¡é”ã€‚</li>
<li>ä¸èƒ½å‡ºç°æ­»é”ã€‚</li>
<li>å¯ç”¨æ€§(ä¸èƒ½å‡ºç°èŠ‚ç‚¹ down æ‰ååŠ é”å¤±è´¥)ã€‚</li>
</ul>
<p>è¿™é‡Œåˆ©ç”¨ <code>Redis set key</code> æ—¶çš„ä¸€ä¸ª NX å‚æ•°å¯ä»¥ä¿è¯åœ¨è¿™ä¸ª key ä¸å­˜åœ¨çš„æƒ…å†µä¸‹å†™å…¥æˆåŠŸã€‚å¹¶ä¸”å†åŠ ä¸Š EX å‚æ•°å¯ä»¥è®©è¯¥ key åœ¨è¶…æ—¶ä¹‹åè‡ªåŠ¨åˆ é™¤ã€‚</p>
<p>æ‰€ä»¥åˆ©ç”¨ä»¥ä¸Šä¸¤ä¸ªç‰¹æ€§å¯ä»¥ä¿è¯åœ¨åŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹è·å¾—é”ï¼Œå¹¶ä¸”ä¸ä¼šå‡ºç°æ­»é”(æœ€åçš„æƒ…å†µå°±æ˜¯è¶…æ—¶è‡ªåŠ¨åˆ é™¤ key)ã€‚</p>
<h3 id="åŠ é”"><a href="#åŠ é”" class="headerlink" title="åŠ é”"></a>åŠ é”</h3><p>å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SET_IF_NOT_EXIST = <span class="string">"NX"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SET_WITH_EXPIRE_TIME = <span class="string">"PX"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span>  <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(String key, String request)</span> </span>&#123;</div><div class="line">    String result = <span class="keyword">this</span>.jedis.set(LOCK_PREFIX + key, request, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, <span class="number">10</span> * TIME);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (LOCK_MSG.equals(result))&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span> ;</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span> ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™é‡Œä½¿ç”¨çš„ jedis çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">String <span class="title">set</span><span class="params">(String key, String value, String nxxx, String expx, <span class="keyword">long</span> time)</span></span>;</div></pre></td></tr></table></figure>
<p>apiã€‚</p>
<p>è¯¥å‘½ä»¤å¯ä»¥ä¿è¯ NX EX çš„åŸå­æ€§ã€‚</p>
<p>ä¸€å®šä¸è¦æŠŠä¸¤ä¸ªå‘½ä»¤(NX EX)åˆ†å¼€æ‰§è¡Œï¼Œå¦‚æœåœ¨ NX ä¹‹åç¨‹åºå‡ºç°é—®é¢˜å°±æœ‰å¯èƒ½äº§ç”Ÿæ­»é”ã€‚</p>
<h4 id="é˜»å¡é”"><a href="#é˜»å¡é”" class="headerlink" title="é˜»å¡é”"></a>é˜»å¡é”</h4><p>åŒæ—¶ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªé˜»å¡é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä¸€ç›´é˜»å¡</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(String key, String request)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (;;)&#123;</div><div class="line">        String result = <span class="keyword">this</span>.jedis.set(LOCK_PREFIX + key, request, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, <span class="number">10</span> * TIME);</div><div class="line">        <span class="keyword">if</span> (LOCK_MSG.equals(result))&#123;</div><div class="line">            <span class="keyword">break</span> ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"> <span class="comment">//é˜²æ­¢ä¸€ç›´æ¶ˆè€— CPU 	</span></div><div class="line">        Thread.sleep(DEFAULT_SLEEP_TIME) ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"> <span class="comment">//è‡ªå®šä¹‰é˜»å¡æ—¶é—´</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, String request,<span class="keyword">int</span> blockTime)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (blockTime &gt;= <span class="number">0</span>)&#123;</div><div class="line"></div><div class="line">        String result = <span class="keyword">this</span>.jedis.set(LOCK_PREFIX + key, request, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, <span class="number">10</span> * TIME);</div><div class="line">        <span class="keyword">if</span> (LOCK_MSG.equals(result))&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span> ;</div><div class="line">        &#125;</div><div class="line">        blockTime -= DEFAULT_SLEEP_TIME ;</div><div class="line"></div><div class="line">        Thread.sleep(DEFAULT_SLEEP_TIME) ;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span> ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è§£é”"><a href="#è§£é”" class="headerlink" title="è§£é”"></a>è§£é”</h3><p>è§£é”ä¹Ÿå¾ˆç®€å•ï¼Œå…¶å®å°±æ˜¯æŠŠè¿™ä¸ª key åˆ æ‰å°±ä¸‡äº‹å¤§å‰äº†ï¼Œæ¯”å¦‚ä½¿ç”¨ <code>del key</code> å‘½ä»¤ã€‚</p>
<p>ä½†ç°å®å¾€å¾€æ²¡æœ‰é‚£ä¹ˆ easyã€‚</p>
<p>å¦‚æœè¿›ç¨‹ A è·å–äº†é”è®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Œä½†æ˜¯ç”±äºæ‰§è¡Œå‘¨æœŸè¾ƒé•¿å¯¼è‡´åˆ°äº†è¶…æ—¶æ—¶é—´ä¹‹åé”å°±è‡ªåŠ¨é‡Šæ”¾äº†ã€‚è¿™æ—¶è¿›ç¨‹ B è·å–äº†è¯¥é”æ‰§è¡Œå¾ˆå¿«å°±é‡Šæ”¾é”ã€‚è¿™æ ·å°±ä¼šå‡ºç°è¿›ç¨‹ B å°†è¿›ç¨‹ A çš„é”é‡Šæ”¾äº†ã€‚</p>
<p>æ‰€ä»¥æœ€å¥½çš„æ–¹å¼æ˜¯åœ¨æ¯æ¬¡è§£é”æ—¶éƒ½éœ€è¦åˆ¤æ–­é”<strong>æ˜¯å¦æ˜¯è‡ªå·±</strong>çš„ã€‚</p>
<p>è¿™æ—¶å°±éœ€è¦ç»“åˆåŠ é”æœºåˆ¶ä¸€èµ·å®ç°äº†ã€‚</p>
<p>åŠ é”æ—¶éœ€è¦ä¼ é€’ä¸€ä¸ªå‚æ•°ï¼Œå°†è¯¥å‚æ•°ä½œä¸ºè¿™ä¸ª key çš„ valueï¼Œè¿™æ ·æ¯æ¬¡è§£é”æ—¶åˆ¤æ–­ value æ˜¯å¦ç›¸ç­‰å³å¯ã€‚</p>
<p>æ‰€ä»¥è§£é”ä»£ç å°±ä¸èƒ½æ˜¯ç®€å•çš„ <code>del</code>äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span>  <span class="keyword">boolean</span> <span class="title">unlock</span><span class="params">(String key,String request)</span></span>&#123;</div><div class="line">    <span class="comment">//lua script</span></div><div class="line">    String script = <span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</div><div class="line"></div><div class="line">    Object result = <span class="keyword">null</span> ;</div><div class="line">    <span class="keyword">if</span> (jedis <span class="keyword">instanceof</span> Jedis)&#123;</div><div class="line">        result = ((Jedis)<span class="keyword">this</span>.jedis).eval(script, Collections.singletonList(LOCK_PREFIX + key), Collections.singletonList(request));</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (jedis <span class="keyword">instanceof</span> JedisCluster)&#123;</div><div class="line">        result = ((JedisCluster)<span class="keyword">this</span>.jedis).eval(script, Collections.singletonList(LOCK_PREFIX + key), Collections.singletonList(request));</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//throw new RuntimeException("instance is error") ;</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span> ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (UNLOCK_MSG.equals(result))&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span> ;</div><div class="line">    &#125;<span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span> ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ª <code>lua</code> è„šæœ¬æ¥åˆ¤æ–­ value æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰æ‰æ‰§è¡Œ del å‘½ä»¤ã€‚</p>
<p>ä½¿ç”¨ <code>lua</code> ä¹Ÿå¯ä»¥ä¿è¯è¿™é‡Œä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§ã€‚</p>
<p>å› æ­¤ä¸Šæ–‡æåˆ°çš„å››ä¸ªåŸºæœ¬ç‰¹æ€§ä¹Ÿèƒ½æ»¡è¶³äº†ï¼š</p>
<ul>
<li>ä½¿ç”¨ Redis å¯ä»¥ä¿è¯æ€§èƒ½ã€‚</li>
<li>é˜»å¡é”ä¸éé˜»å¡é”è§ä¸Šæ–‡ã€‚</li>
<li>åˆ©ç”¨è¶…æ—¶æœºåˆ¶è§£å†³äº†æ­»é”ã€‚</li>
<li>Redis æ”¯æŒé›†ç¾¤éƒ¨ç½²æé«˜äº†å¯ç”¨æ€§ã€‚</li>
</ul>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>æˆ‘è‡ªå·±æœ‰æ’¸äº†ä¸€ä¸ªå®Œæ•´çš„å®ç°ï¼Œå¹¶ä¸”å·²ç»ç”¨äºäº†ç”Ÿäº§ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥å¼€ç®±ä½¿ç”¨:</p>
<p>maven ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.crossoverjie.opensource<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>distributed-redis-lock<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>é…ç½® bean :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLockConfig</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RedisLock <span class="title">build</span><span class="params">()</span></span>&#123;</div><div class="line">        RedisLock redisLock = <span class="keyword">new</span> RedisLock() ;</div><div class="line">        HostAndPort hostAndPort = <span class="keyword">new</span> HostAndPort(<span class="string">"127.0.0.1"</span>,<span class="number">7000</span>) ;</div><div class="line">        JedisCluster jedisCluster = <span class="keyword">new</span> JedisCluster(hostAndPort) ;</div><div class="line">        <span class="comment">// Jedis æˆ– JedisCluster éƒ½å¯ä»¥</span></div><div class="line">        redisLock.setJedisCluster(jedisCluster) ;</div><div class="line">        <span class="keyword">return</span> redisLock ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="keyword">private</span> RedisLock redisLock ;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">use</span><span class="params">()</span> </span>&#123;</div><div class="line">    String key = <span class="string">"key"</span>;</div><div class="line">    String request = UUID.randomUUID().toString();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">boolean</span> locktest = redisLock.tryLock(key, request);</div><div class="line">        <span class="keyword">if</span> (!locktest) &#123;</div><div class="line">            System.out.println(<span class="string">"locked error"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//do something</span></div><div class="line"></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        redisLock.unlock(key,request) ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨å¾ˆç®€å•ã€‚è¿™é‡Œä¸»è¦æ˜¯æƒ³åˆ©ç”¨ Spring æ¥å¸®æˆ‘ä»¬ç®¡ç† RedisLock è¿™ä¸ªå•ä¾‹çš„ beanï¼Œæ‰€ä»¥åœ¨é‡Šæ”¾é”çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨(å› ä¸ºæ•´ä¸ªä¸Šä¸‹æ–‡åªæœ‰ä¸€ä¸ª RedisLock å®ä¾‹)çš„ä¼ å…¥ key ä»¥åŠ request(api çœ‹èµ·æ¥ä¸æ˜¯ç‰¹åˆ«ä¼˜é›…)ã€‚</p>
<p>ä¹Ÿå¯ä»¥åœ¨æ¯æ¬¡ä½¿ç”¨é”çš„æ—¶å€™ new ä¸€ä¸ª RedisLock ä¼ å…¥ key ä»¥åŠ requestï¼Œè¿™æ ·å€’æ˜¯åœ¨è§£é”æ—¶å¾ˆæ–¹ä¾¿ã€‚ä½†æ˜¯éœ€è¦è‡ªè¡Œç®¡ç† RedisLock çš„å®ä¾‹ã€‚å„æœ‰ä¼˜åŠ£å§ã€‚</p>
<p>é¡¹ç›®æºç åœ¨ï¼š</p>
<p><a href="https://github.com/crossoverJie/distributed-lock-redis" target="_blank" rel="external">https://github.com/crossoverJie/distributed-lock-redis</a></p>
<p>æ¬¢è¿è®¨è®ºã€‚</p>
<h2 id="å•æµ‹"><a href="#å•æµ‹" class="headerlink" title="å•æµ‹"></a>å•æµ‹</h2><p>åœ¨åšè¿™ä¸ªé¡¹ç›®çš„æ—¶å€™è®©æˆ‘ä¸å¾—ä¸æƒ³æä¸€ä¸‹<strong>å•æµ‹</strong>ã€‚</p>
<p>å› ä¸ºè¿™ä¸ªåº”ç”¨æ˜¯å¼ºä¾èµ–äºç¬¬ä¸‰æ–¹ç»„ä»¶çš„(Redis)ï¼Œä½†æ˜¯åœ¨å•æµ‹ä¸­æˆ‘ä»¬éœ€è¦æ’é™¤æ‰è¿™ç§ä¾èµ–ã€‚æ¯”å¦‚å…¶ä»–ä¼™ä¼´ fork äº†è¯¥é¡¹ç›®æƒ³åœ¨æœ¬åœ°è·‘ä¸€éå•æµ‹ï¼Œç»“æœè¿è¡Œä¸èµ·æ¥ï¼š</p>
<ol>
<li>æœ‰å¯èƒ½æ˜¯ Redis çš„ ipã€ç«¯å£å’Œå•æµ‹é‡Œçš„ä¸ä¸€è‡´ã€‚</li>
<li>Redis è‡ªèº«å¯èƒ½ä¹Ÿæœ‰é—®é¢˜ã€‚</li>
<li>ä¹Ÿæœ‰å¯èƒ½æ˜¯è¯¥åŒå­¦çš„ç¯å¢ƒä¸­å¹¶æ²¡æœ‰ Redisã€‚</li>
</ol>
<p>æ‰€ä»¥æœ€å¥½æ˜¯è¦æŠŠè¿™äº›å¤–éƒ¨ä¸ç¨³å®šçš„å› ç´ æ’é™¤æ‰ï¼Œå•æµ‹åªæµ‹æˆ‘ä»¬å†™å¥½çš„ä»£ç ã€‚</p>
<p>äºæ˜¯å°±å¯ä»¥å¼•å…¥å•æµ‹åˆ©å™¨ <code>Mock</code> äº†ã€‚</p>
<p>å®ƒçš„æƒ³æ³•å¾ˆç®€ç­”ï¼Œå°±æ˜¯è¦æŠŠä½ æ‰€ä¾èµ–çš„å¤–éƒ¨èµ„æºç»Ÿç»Ÿå±è”½æ‰ã€‚å¦‚ï¼šæ•°æ®åº“ã€å¤–éƒ¨æ¥å£ã€å¤–éƒ¨æ–‡ä»¶ç­‰ç­‰ã€‚</p>
<p>ä½¿ç”¨æ–¹å¼ä¹ŸæŒºç®€å•ï¼Œå¯ä»¥å‚è€ƒè¯¥é¡¹ç›®çš„å•æµ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryLock</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    String key = <span class="string">"test"</span>;</div><div class="line">    String request = UUID.randomUUID().toString();</div><div class="line">    Mockito.when(jedisCluster.set(Mockito.anyString(), Mockito.anyString(), Mockito.anyString(),</div><div class="line">            Mockito.anyString(), Mockito.anyLong())).thenReturn(<span class="string">"OK"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> locktest = redisLock.tryLock(key, request);</div><div class="line">    System.out.println(<span class="string">"locktest="</span> + locktest);</div><div class="line"></div><div class="line">    Assert.assertTrue(locktest);</div><div class="line"></div><div class="line">    <span class="comment">//check</span></div><div class="line">    Mockito.verify(jedisCluster).set(Mockito.anyString(), Mockito.anyString(), Mockito.anyString(),</div><div class="line">            Mockito.anyString(), Mockito.anyLong());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œåªæ˜¯ç®€å•æ¼”ç¤ºä¸‹ï¼Œå¯ä»¥çš„è¯ä¸‹æ¬¡ä»”ç»†åˆ†æåˆ†æã€‚</p>
<p>å®ƒçš„åŸç†å…¶å®ä¹ŸæŒºç®€å•ï¼Œdebug çš„è¯å¯ä»¥å¾ˆç›´æ¥çš„çœ‹å‡ºæ¥ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fpxho866hbj311u0ej42f.jpg" alt=""></p>
<p>è¿™é‡Œæˆ‘ä»¬æ‰€ä¾èµ–çš„ JedisCluster å…¶å®æ˜¯ä¸€ä¸ª <code>cglib ä»£ç†å¯¹è±¡</code>ã€‚æ‰€ä»¥ä¹Ÿä¸éš¾æƒ³åˆ°å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<p>æ¯”å¦‚è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° JedisCluster çš„ set å‡½æ•°å¹¶éœ€è¦å®ƒçš„è¿”å›å€¼ã€‚</p>
<p>Mock å°±å°†è¯¥å¯¹è±¡ä»£ç†äº†ï¼Œå¹¶åœ¨å®é™…æ‰§è¡Œ set æ–¹æ³•åç»™ä½ è¿”å›äº†ä¸€ä¸ªä½ è‡ªå®šä¹‰çš„å€¼ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥éšå¿ƒæ‰€æ¬²çš„æµ‹è¯•äº†ï¼Œ<strong>å®Œå…¨æŠŠå¤–éƒ¨ä¾èµ–æ‰€å±è”½äº†</strong>ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤ä¸€ä¸ªåŸºäº Redis çš„åˆ†å¸ƒå¼é”å®Œæˆï¼Œä½†æ˜¯ä¾ç„¶æœ‰äº›é—®é¢˜ã€‚</p>
<ul>
<li>å¦‚åœ¨ key è¶…æ—¶ä¹‹åä¸šåŠ¡å¹¶æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ä½†å´è‡ªåŠ¨é‡Šæ”¾é”äº†ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜ã€‚</li>
<li>å°±ç®— Redis æ˜¯é›†ç¾¤éƒ¨ç½²çš„ï¼Œå¦‚æœæ¯ä¸ªèŠ‚ç‚¹éƒ½åªæ˜¯ master æ²¡æœ‰ slaveï¼Œé‚£ä¹ˆ master å®•æœºæ—¶è¯¥èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ key åœ¨é‚£ä¸€æ—¶åˆ»éƒ½ç›¸å½“äºæ˜¯é‡Šæ”¾é”äº†ï¼Œè¿™æ ·ä¹Ÿä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚å°±ç®—æ˜¯æœ‰ slave èŠ‚ç‚¹ï¼Œä½†å¦‚æœåœ¨æ•°æ®åŒæ­¥åˆ° salve ä¹‹å‰ master å®•æœºä¹Ÿæ˜¯ä¼šå‡ºç°ä¸Šé¢çš„é—®é¢˜ã€‚</li>
</ul>
<p>æ„Ÿå…´è¶£çš„æœ‹å‹è¿˜å¯ä»¥å‚è€ƒ <a href="https://github.com/redisson/redisson" target="_blank" rel="external">Redisson</a> çš„å®ç°ã€‚</p>
<h2 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h2><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws3.sinaimg.cn/large/006tKfTcgy1fpvathnbf6j31kw11xwl3.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;åˆ†å¸ƒå¼é”åœ¨åˆ†å¸ƒå¼åº”ç”¨ä¸­åº”ç”¨å¹¿æ³›ï¼Œæƒ³è¦ææ‡‚ä¸€ä¸ªæ–°äº‹ç‰©é¦–å…ˆå¾—äº†è§£å®ƒçš„ç”±æ¥ï¼Œè¿™æ ·æ‰èƒ½æ›´åŠ çš„ç†è§£ç”šè‡³å¯ä»¥ä¸¾ä¸€åä¸‰ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆè°ˆåˆ°åˆ†å¸ƒå¼é”è‡ªç„¶ä¹Ÿå°±è”æƒ³åˆ°åˆ†å¸ƒå¼åº”ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨æˆ‘ä»¬å°†åº”ç”¨æ‹†åˆ†ä¸ºåˆ†å¸ƒå¼åº”ç”¨ä¹‹å‰çš„å•æœºç³»ç»Ÿä¸­ï¼Œå¯¹ä¸€äº›å¹¶å‘åœºæ™¯è¯»å–å…¬å…±èµ„æºæ—¶å¦‚æ‰£åº“å­˜ï¼Œå–è½¦ç¥¨ä¹‹ç±»çš„éœ€æ±‚å¯ä»¥ç®€å•çš„ä½¿ç”¨&lt;a href=&quot;http://crossoverjie.top/2018/01/14/Synchronize/&quot;&gt;åŒæ­¥&lt;/a&gt;æˆ–è€…æ˜¯&lt;a href=&quot;http://crossoverjie.top/2018/01/25/ReentrantLock/&quot;&gt;åŠ é”&lt;/a&gt;å°±å¯ä»¥å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯åº”ç”¨åˆ†å¸ƒå¼äº†ä¹‹åç³»ç»Ÿç”±ä»¥å‰çš„å•è¿›ç¨‹å¤šçº¿ç¨‹çš„ç¨‹åºå˜ä¸ºäº†å¤šè¿›ç¨‹å¤šçº¿ç¨‹ï¼Œè¿™æ—¶ä½¿ç”¨ä»¥ä¸Šçš„è§£å†³æ–¹æ¡ˆæ˜æ˜¾å°±ä¸å¤Ÿäº†ã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤ä¸šç•Œå¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆé€šå¸¸æ˜¯å€ŸåŠ©äºä¸€ä¸ªç¬¬ä¸‰æ–¹ç»„ä»¶å¹¶åˆ©ç”¨å®ƒè‡ªèº«çš„æ’ä»–æ€§æ¥è¾¾åˆ°å¤šè¿›ç¨‹çš„äº’æ–¥ã€‚å¦‚ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŸºäº DB çš„å”¯ä¸€ç´¢å¼•ã€‚&lt;/li&gt;
&lt;li&gt;åŸºäº ZK çš„ä¸´æ—¶æœ‰åºèŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;åŸºäº Redis çš„ &lt;code&gt;NX EX&lt;/code&gt; å‚æ•°ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™é‡Œä¸»è¦åŸºäº Redis è¿›è¡Œè®¨è®ºã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Distributed Tools" scheme="http://crossoverjie.top/categories/Distributed-Tools/"/>
    
    
      <category term="Distributed Lock" scheme="http://crossoverjie.top/tags/Distributed-Lock/"/>
    
  </entry>
  
  <entry>
    <title>Spring Bean ç”Ÿå‘½å‘¨æœŸ</title>
    <link href="http://crossoverjie.top/2018/03/21/spring/spring-bean-lifecycle/"/>
    <id>http://crossoverjie.top/2018/03/21/spring/spring-bean-lifecycle/</id>
    <published>2018-03-20T18:10:36.000Z</published>
    <updated>2018-03-21T14:21:54.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fpjstgeir9j30v90kujyq.jpg" alt=""></p>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>Spring Bean çš„ç”Ÿå‘½å‘¨æœŸåœ¨æ•´ä¸ª Spring ä¸­å æœ‰å¾ˆé‡è¦çš„ä½ç½®ï¼ŒæŒæ¡è¿™äº›å¯ä»¥åŠ æ·±å¯¹ Spring çš„ç†è§£ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹ç”Ÿå‘½å‘¨æœŸå›¾ï¼š</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fpjsamy6uoj30nt0cqq4i.jpg" alt=""></p>
<p>å†è°ˆç”Ÿå‘½å‘¨æœŸä¹‹å‰æœ‰ä¸€ç‚¹éœ€è¦å…ˆæ˜ç¡®ï¼š</p>
<blockquote>
<p>Spring åªå¸®æˆ‘ä»¬ç®¡ç†å•ä¾‹æ¨¡å¼ Bean çš„<strong>å®Œæ•´</strong>ç”Ÿå‘½å‘¨æœŸï¼Œå¯¹äº prototype çš„ bean ï¼ŒSpring åœ¨åˆ›å»ºå¥½äº¤ç»™ä½¿ç”¨è€…ä¹‹ååˆ™ä¸ä¼šå†ç®¡ç†åç»­çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
</blockquote>
<a id="more"></a>
<h3 id="æ³¨è§£æ–¹å¼"><a href="#æ³¨è§£æ–¹å¼" class="headerlink" title="æ³¨è§£æ–¹å¼"></a>æ³¨è§£æ–¹å¼</h3><p>åœ¨ bean åˆå§‹åŒ–æ—¶ä¼šç»å†å‡ ä¸ªé˜¶æ®µï¼Œé¦–å…ˆå¯ä»¥ä½¿ç”¨æ³¨è§£ <code>@PostConstruct</code>, <code>@PreDestroy</code> æ¥åœ¨ bean çš„åˆ›å»ºå’Œé”€æ¯é˜¶æ®µè¿›è¡Œè°ƒç”¨:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationBean</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(AnnotationBean.class);</div><div class="line"></div><div class="line">    <span class="meta">@PostConstruct</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</div><div class="line">        LOGGER.info(<span class="string">"AnnotationBean start"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@PreDestroy</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>&#123;</div><div class="line">        LOGGER.info(<span class="string">"AnnotationBean destroy"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="InitializingBean-DisposableBean-æ¥å£"><a href="#InitializingBean-DisposableBean-æ¥å£" class="headerlink" title="InitializingBean, DisposableBean æ¥å£"></a>InitializingBean, DisposableBean æ¥å£</h3><p>è¿˜å¯ä»¥å®ç° <code>InitializingBean,DisposableBean</code> è¿™ä¸¤ä¸ªæ¥å£ï¼Œä¹Ÿæ˜¯åœ¨åˆå§‹åŒ–ä»¥åŠé”€æ¯é˜¶æ®µè°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringLifeCycleService</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>,<span class="title">DisposableBean</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(SpringLifeCycleService.class);</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        LOGGER.info(<span class="string">"SpringLifeCycleService start"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        LOGGER.info(<span class="string">"SpringLifeCycleService destroy"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="è‡ªå®šä¹‰åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•"><a href="#è‡ªå®šä¹‰åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•" class="headerlink" title="è‡ªå®šä¹‰åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•"></a>è‡ªå®šä¹‰åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•</h3><p>ä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ–¹æ³•ç”¨äºåœ¨åˆå§‹åŒ–ã€é”€æ¯é˜¶æ®µè°ƒç”¨:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCycleConfig</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Bean</span>(initMethod = <span class="string">"start"</span>, destroyMethod = <span class="string">"destroy"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> SpringLifeCycle <span class="title">create</span><span class="params">()</span></span>&#123;</div><div class="line">        SpringLifeCycle springLifeCycle = <span class="keyword">new</span> SpringLifeCycle() ;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> springLifeCycle ;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringLifeCycle</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(SpringLifeCycle.class);</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</div><div class="line">        LOGGER.info(<span class="string">"SpringLifeCycle start"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>&#123;</div><div class="line">        LOGGER.info(<span class="string">"SpringLifeCycle destroy"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»¥ä¸Šæ˜¯åœ¨ SpringBoot ä¸­å¯ä»¥è¿™æ ·é…ç½®ï¼Œå¦‚æœæ˜¯åŸå§‹çš„åŸºäº XML ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.crossoverjie.spring.SpringLifeCycle"</span> <span class="attr">init-method</span>=<span class="string">"start"</span> <span class="attr">destroy-method</span>=<span class="string">"destroy"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<p>æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚</p>
<h3 id="å®ç°-Aware-æ¥å£"><a href="#å®ç°-Aware-æ¥å£" class="headerlink" title="å®ç° *Aware æ¥å£"></a>å®ç° *Aware æ¥å£</h3><p><code>*Aware</code> æ¥å£å¯ä»¥ç”¨äºåœ¨åˆå§‹åŒ– bean æ—¶è·å¾— Spring ä¸­çš„ä¸€äº›å¯¹è±¡ï¼Œå¦‚è·å– <code>Spring ä¸Šä¸‹æ–‡</code>ç­‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringLifeCycleAware</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(SpringLifeCycleAware.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ApplicationContext applicationContext ;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.applicationContext = applicationContext ;</div><div class="line">        LOGGER.info(<span class="string">"SpringLifeCycleAware start"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·åœ¨ <code>springLifeCycleAware</code> è¿™ä¸ª bean åˆå§‹åŒ–ä¼šå°±ä¼šè°ƒç”¨ <code>setApplicationContext</code> æ–¹æ³•ï¼Œå¹¶å¯ä»¥è·å¾— <code>applicationContext</code> å¯¹è±¡ã€‚</p>
<h3 id="BeanPostProcessor-å¢å¼ºå¤„ç†å™¨"><a href="#BeanPostProcessor-å¢å¼ºå¤„ç†å™¨" class="headerlink" title="BeanPostProcessor å¢å¼ºå¤„ç†å™¨"></a>BeanPostProcessor å¢å¼ºå¤„ç†å™¨</h3><p>å®ç° BeanPostProcessor æ¥å£ï¼ŒSpring ä¸­æ‰€æœ‰ bean åœ¨åšåˆå§‹åŒ–æ—¶éƒ½ä¼šè°ƒç”¨è¯¥æ¥å£ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ç”¨äºå¯¹ä¸€äº›ç‰¹æ®Šçš„ bean è¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringLifeCycleProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(SpringLifeCycleProcessor.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é¢„åˆå§‹åŒ– åˆå§‹åŒ–ä¹‹å‰è°ƒç”¨</div><div class="line">     * <span class="doctag">@param</span> bean</div><div class="line">     * <span class="doctag">@param</span> beanName</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> BeansException</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"annotationBean"</span>.equals(beanName))&#123;</div><div class="line">            LOGGER.info(<span class="string">"SpringLifeCycleProcessor start beanName=&#123;&#125;"</span>,beanName);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> bean;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ååˆå§‹åŒ–  bean åˆå§‹åŒ–å®Œæˆè°ƒç”¨</div><div class="line">     * <span class="doctag">@param</span> bean</div><div class="line">     * <span class="doctag">@param</span> beanName</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> BeansException</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (<span class="string">"annotationBean"</span>.equals(beanName))&#123;</div><div class="line">            LOGGER.info(<span class="string">"SpringLifeCycleProcessor end beanName=&#123;&#125;"</span>,beanName);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> bean;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¹‹åè§‚å¯Ÿç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">018-03-21 00:40:24.856 [restartedMain] INFO  c.c.s.p.SpringLifeCycleProcessor - SpringLifeCycleProcessor start beanName=annotationBean</div><div class="line">2018-03-21 00:40:24.860 [restartedMain] INFO  c.c.spring.annotation.AnnotationBean - AnnotationBean start</div><div class="line">2018-03-21 00:40:24.861 [restartedMain] INFO  c.c.s.p.SpringLifeCycleProcessor - SpringLifeCycleProcessor end beanName=annotationBean</div><div class="line">2018-03-21 00:40:24.864 [restartedMain] INFO  c.c.s.aware.SpringLifeCycleAware - SpringLifeCycleAware start</div><div class="line">2018-03-21 00:40:24.867 [restartedMain] INFO  c.c.s.service.SpringLifeCycleService - SpringLifeCycleService start</div><div class="line">2018-03-21 00:40:24.887 [restartedMain] INFO  c.c.spring.SpringLifeCycle - SpringLifeCycle start</div><div class="line">2018-03-21 00:40:25.062 [restartedMain] INFO  o.s.b.d.a.OptionalLiveReloadServer - LiveReload server is running on port 35729</div><div class="line">2018-03-21 00:40:25.122 [restartedMain] INFO  o.s.j.e.a.AnnotationMBeanExporter - Registering beans for JMX exposure on startup</div><div class="line">2018-03-21 00:40:25.140 [restartedMain] INFO  com.crossoverjie.Application - Started Application in 2.309 seconds (JVM running for 3.681)</div><div class="line">2018-03-21 00:40:25.143 [restartedMain] INFO  com.crossoverjie.Application - start ok!</div><div class="line">2018-03-21 00:40:25.153 [Thread-8] INFO  o.s.c.a.AnnotationConfigApplicationContext - Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@3913adad: startup date [Wed Mar 21 00:40:23 CST 2018]; root of context hierarchy</div><div class="line">2018-03-21 00:40:25.155 [Thread-8] INFO  o.s.j.e.a.AnnotationMBeanExporter - Unregistering JMX-exposed beans on shutdown</div><div class="line">2018-03-21 00:40:25.156 [Thread-8] INFO  c.c.spring.SpringLifeCycle - SpringLifeCycle destroy</div><div class="line">2018-03-21 00:40:25.156 [Thread-8] INFO  c.c.s.service.SpringLifeCycleService - SpringLifeCycleService destroy</div><div class="line">2018-03-21 00:40:25.156 [Thread-8] INFO  c.c.spring.annotation.AnnotationBean - AnnotationBean destroy</div></pre></td></tr></table></figure>
<p>ç›´åˆ° Spring ä¸Šä¸‹æ–‡é”€æ¯æ—¶åˆ™ä¼šè°ƒç”¨è‡ªå®šä¹‰çš„é”€æ¯æ–¹æ³•ä»¥åŠå®ç°äº† <code>DisposableBean</code> çš„ <code>destroy()</code> æ–¹æ³•ã€‚</p>
<h3 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h3><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tNc79gy1fpjstgeir9j30v90kujyq.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;Spring Bean çš„ç”Ÿå‘½å‘¨æœŸåœ¨æ•´ä¸ª Spring ä¸­å æœ‰å¾ˆé‡è¦çš„ä½ç½®ï¼ŒæŒæ¡è¿™äº›å¯ä»¥åŠ æ·±å¯¹ Spring çš„ç†è§£ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆçœ‹ä¸‹ç”Ÿå‘½å‘¨æœŸå›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws3.sinaimg.cn/large/006tNc79gy1fpjsamy6uoj30nt0cqq4i.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;å†è°ˆç”Ÿå‘½å‘¨æœŸä¹‹å‰æœ‰ä¸€ç‚¹éœ€è¦å…ˆæ˜ç¡®ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Spring åªå¸®æˆ‘ä»¬ç®¡ç†å•ä¾‹æ¨¡å¼ Bean çš„&lt;strong&gt;å®Œæ•´&lt;/strong&gt;ç”Ÿå‘½å‘¨æœŸï¼Œå¯¹äº prototype çš„ bean ï¼ŒSpring åœ¨åˆ›å»ºå¥½äº¤ç»™ä½¿ç”¨è€…ä¹‹ååˆ™ä¸ä¼šå†ç®¡ç†åç»­çš„ç”Ÿå‘½å‘¨æœŸã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Spring" scheme="http://crossoverjie.top/categories/Spring/"/>
    
    
      <category term="Spring" scheme="http://crossoverjie.top/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£çº¿ç¨‹é€šä¿¡</title>
    <link href="http://crossoverjie.top/2018/03/16/java-senior/thread-communication/"/>
    <id>http://crossoverjie.top/2018/03/16/java-senior/thread-communication/</id>
    <published>2018-03-16T12:10:36.000Z</published>
    <updated>2018-03-18T16:05:34.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fpey91u1opj30z00aogo6.jpg" alt=""></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¼€å‘ä¸­ä¸å…ä¼šé‡åˆ°éœ€è¦æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•é€šçŸ¥ä¸»çº¿ç¨‹å¤„ç†æŸäº›é€»è¾‘çš„åœºæ™¯ã€‚</p>
<p>æˆ–è€…æ˜¯çº¿ç¨‹ A åœ¨æ‰§è¡Œåˆ°æŸä¸ªæ¡ä»¶é€šçŸ¥çº¿ç¨‹ B æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚</p>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å®ç°ï¼š</p>
<h2 id="ç­‰å¾…é€šçŸ¥æœºåˆ¶"><a href="#ç­‰å¾…é€šçŸ¥æœºåˆ¶" class="headerlink" title="ç­‰å¾…é€šçŸ¥æœºåˆ¶"></a>ç­‰å¾…é€šçŸ¥æœºåˆ¶</h2><blockquote>
<p>ç­‰å¾…é€šçŸ¥æ¨¡å¼æ˜¯ Java ä¸­æ¯”è¾ƒç»å…¸çš„çº¿ç¨‹é€šä¿¡æ–¹å¼ã€‚</p>
</blockquote>
<p>ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡å¯¹åŒä¸€å¯¹è±¡è°ƒç”¨ç­‰å¾… wait() å’Œé€šçŸ¥ notify() æ–¹æ³•æ¥è¿›è¡Œé€šè®¯ã€‚</p>
<p>å¦‚ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡å¶æ•°ï¼š</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TwoThreadWaitNotify</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> start = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        TwoThreadWaitNotify twoThread = <span class="keyword">new</span> TwoThreadWaitNotify();</div><div class="line"></div><div class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> OuNum(twoThread));</div><div class="line">        t1.setName(<span class="string">"A"</span>);</div><div class="line"></div><div class="line"></div><div class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> JiNum(twoThread));</div><div class="line">        t2.setName(<span class="string">"B"</span>);</div><div class="line"></div><div class="line">        t1.start();</div><div class="line">        t2.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¶æ•°çº¿ç¨‹</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OuNum</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> TwoThreadWaitNotify number;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OuNum</span><span class="params">(TwoThreadWaitNotify number)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.number = number;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">            <span class="keyword">while</span> (number.start &lt;= <span class="number">100</span>) &#123;</div><div class="line">                <span class="keyword">synchronized</span> (TwoThreadWaitNotify.class) &#123;</div><div class="line">                    System.out.println(<span class="string">"å¶æ•°çº¿ç¨‹æŠ¢åˆ°é”äº†"</span>);</div><div class="line">                    <span class="keyword">if</span> (number.flag) &#123;</div><div class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">"+-+å¶æ•°"</span> + number.start);</div><div class="line">                        number.start++;</div><div class="line"></div><div class="line">                        number.flag = <span class="keyword">false</span>;</div><div class="line">                        TwoThreadWaitNotify.class.notify();</div><div class="line"></div><div class="line">                    &#125;<span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            TwoThreadWaitNotify.class.wait();</div><div class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å¥‡æ•°çº¿ç¨‹</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JiNum</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> TwoThreadWaitNotify number;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">JiNum</span><span class="params">(TwoThreadWaitNotify number)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.number = number;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">while</span> (number.start &lt;= <span class="number">100</span>) &#123;</div><div class="line">                <span class="keyword">synchronized</span> (TwoThreadWaitNotify.class) &#123;</div><div class="line">                    System.out.println(<span class="string">"å¥‡æ•°çº¿ç¨‹æŠ¢åˆ°é”äº†"</span>);</div><div class="line">                    <span class="keyword">if</span> (!number.flag) &#123;</div><div class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">"+-+å¥‡æ•°"</span> + number.start);</div><div class="line">                        number.start++;</div><div class="line"></div><div class="line">                        number.flag = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">                        TwoThreadWaitNotify.class.notify();</div><div class="line">                    &#125;<span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            TwoThreadWaitNotify.class.wait();</div><div class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">t2+-+å¥‡æ•°93</div><div class="line">t1+-+å¶æ•°94</div><div class="line">t2+-+å¥‡æ•°95</div><div class="line">t1+-+å¶æ•°96</div><div class="line">t2+-+å¥‡æ•°97</div><div class="line">t1+-+å¶æ•°98</div><div class="line">t2+-+å¥‡æ•°99</div><div class="line">t1+-+å¶æ•°100</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„çº¿ç¨‹ A å’Œçº¿ç¨‹ B éƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡ <code>TwoThreadWaitNotify.class</code> è·å–é”ï¼ŒA çº¿ç¨‹è°ƒç”¨äº†åŒæ­¥å¯¹è±¡çš„ wait() æ–¹æ³•é‡Šæ”¾äº†é”å¹¶è¿›å…¥ <code>WAITING</code> çŠ¶æ€ã€‚</p>
<p>B çº¿ç¨‹è°ƒç”¨äº† notify() æ–¹æ³•ï¼Œè¿™æ · A çº¿ç¨‹æ”¶åˆ°é€šçŸ¥ä¹‹åå°±å¯ä»¥ä» wait() æ–¹æ³•ä¸­è¿”å›ã€‚</p>
<p>è¿™é‡Œåˆ©ç”¨äº† <code>TwoThreadWaitNotify.class</code> å¯¹è±¡å®Œæˆäº†é€šä¿¡ã€‚</p>
<p>æœ‰ä¸€äº›éœ€è¦æ³¨æ„:</p>
<ul>
<li>wait() ã€nofify() ã€nofityAll() è°ƒç”¨çš„å‰æéƒ½æ˜¯è·å¾—äº†å¯¹è±¡çš„é”(ä¹Ÿå¯ç§°ä¸ºå¯¹è±¡ç›‘è§†å™¨)ã€‚</li>
<li>è°ƒç”¨ wait() æ–¹æ³•åçº¿ç¨‹ä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥ <code>WAITING</code> çŠ¶æ€ï¼Œè¯¥çº¿ç¨‹ä¹Ÿä¼šè¢«ç§»åŠ¨åˆ°<strong>ç­‰å¾…é˜Ÿåˆ—</strong>ä¸­ã€‚</li>
<li>è°ƒç”¨ notify() æ–¹æ³•ä¼šå°†<strong>ç­‰å¾…é˜Ÿåˆ—</strong>ä¸­çš„çº¿ç¨‹ç§»åŠ¨åˆ°<strong>åŒæ­¥é˜Ÿåˆ—</strong>ä¸­ï¼Œçº¿ç¨‹çŠ¶æ€ä¹Ÿä¼šæ›´æ–°ä¸º <code>BLOCKED</code></li>
<li>ä» wait() æ–¹æ³•è¿”å›çš„å‰ææ˜¯è°ƒç”¨ notify() æ–¹æ³•çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œwait() æ–¹æ³•çš„çº¿ç¨‹è·å¾—é”ã€‚</li>
</ul>
<p>ç­‰å¾…é€šçŸ¥æœ‰ç€ä¸€ä¸ªç»å…¸èŒƒå¼ï¼š</p>
<p>çº¿ç¨‹ A ä½œä¸ºæ¶ˆè´¹è€…ï¼š</p>
<ol>
<li>è·å–å¯¹è±¡çš„é”ã€‚</li>
<li>è¿›å…¥ while(åˆ¤æ–­æ¡ä»¶)ï¼Œå¹¶è°ƒç”¨ wait() æ–¹æ³•ã€‚</li>
<li>å½“æ¡ä»¶æ»¡è¶³è·³å‡ºå¾ªç¯æ‰§è¡Œå…·ä½“å¤„ç†é€»è¾‘ã€‚</li>
</ol>
<p>çº¿ç¨‹ B ä½œä¸ºç”Ÿäº§è€…:</p>
<ol>
<li>è·å–å¯¹è±¡é”ã€‚</li>
<li>æ›´æ”¹ä¸çº¿ç¨‹ A å…±ç”¨çš„åˆ¤æ–­æ¡ä»¶ã€‚</li>
<li>è°ƒç”¨ notify() æ–¹æ³•ã€‚</li>
</ol>
<p>ä¼ªä»£ç å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">//Thread A</div><div class="line"></div><div class="line">synchronized(Object)&#123;</div><div class="line">    while(æ¡ä»¶)&#123;</div><div class="line">        Object.wait();</div><div class="line">    &#125;</div><div class="line">    //do something</div><div class="line">&#125;</div><div class="line"></div><div class="line">//Thread B</div><div class="line">synchronized(Object)&#123;</div><div class="line">    æ¡ä»¶=false;//æ”¹å˜æ¡ä»¶</div><div class="line">    Object.notify();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="join-æ–¹æ³•"><a href="#join-æ–¹æ³•" class="headerlink" title="join() æ–¹æ³•"></a>join() æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LOGGER.info(<span class="string">"running"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">3000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;) ;</div><div class="line">    Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LOGGER.info(<span class="string">"running2"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">4000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;) ;</div><div class="line"></div><div class="line">    t1.start();</div><div class="line">    t2.start();</div><div class="line"></div><div class="line">    <span class="comment">//ç­‰å¾…çº¿ç¨‹1ç»ˆæ­¢</span></div><div class="line">    t1.join();</div><div class="line"></div><div class="line">    <span class="comment">//ç­‰å¾…çº¿ç¨‹2ç»ˆæ­¢</span></div><div class="line">    t2.join();</div><div class="line"></div><div class="line">    LOGGER.info(<span class="string">"main over"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2018-03-16 20:21:30.967 [Thread-1] INFO  c.c.actual.ThreadCommunication - running2</div><div class="line">2018-03-16 20:21:30.967 [Thread-0] INFO  c.c.actual.ThreadCommunication - running</div><div class="line">2018-03-16 20:21:34.972 [main] INFO  c.c.actual.ThreadCommunication - main over</div></pre></td></tr></table></figure>
<p>åœ¨  <code>t1.join()</code> æ—¶ä¼šä¸€ç›´é˜»å¡åˆ° t1 æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥æœ€ç»ˆä¸»çº¿ç¨‹ä¼šç­‰å¾… t1 å’Œ t2 çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚</p>
<p>å…¶å®ä»æºç å¯ä»¥çœ‹å‡ºï¼Œjoin() ä¹Ÿæ˜¯åˆ©ç”¨çš„ç­‰å¾…é€šçŸ¥æœºåˆ¶ï¼š</p>
<p>æ ¸å¿ƒé€»è¾‘:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (isAlive()) &#123;</div><div class="line">    wait(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ join çº¿ç¨‹å®Œæˆåä¼šè°ƒç”¨ notifyAll() æ–¹æ³•ï¼Œæ˜¯åœ¨ JVM å®ç°ä¸­è°ƒç”¨ï¼Œæ‰€ä»¥è¿™é‡Œçœ‹ä¸å‡ºæ¥ã€‚</p>
<h2 id="volatile-å…±äº«å†…å­˜"><a href="#volatile-å…±äº«å†…å­˜" class="headerlink" title="volatile å…±äº«å†…å­˜"></a>volatile å…±äº«å†…å­˜</h2><p>å› ä¸º Java æ˜¯é‡‡ç”¨å…±äº«å†…å­˜çš„æ–¹å¼è¿›è¡Œçº¿ç¨‹é€šä¿¡çš„ï¼Œæ‰€ä»¥å¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹å¼ç”¨ä¸»çº¿ç¨‹å…³é—­ A çº¿ç¨‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Volatile</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">true</span> ;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (flag)&#123;</div><div class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ­£åœ¨è¿è¡Œã€‚ã€‚ã€‚"</span>);</div><div class="line">        &#125;</div><div class="line">        System.out.println(Thread.currentThread().getName() +<span class="string">"æ‰§è¡Œå®Œæ¯•"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        Volatile aVolatile = <span class="keyword">new</span> Volatile();</div><div class="line">        <span class="keyword">new</span> Thread(aVolatile,<span class="string">"thread A"</span>).start();</div><div class="line"></div><div class="line"></div><div class="line">        System.out.println(<span class="string">"main çº¿ç¨‹æ­£åœ¨è¿è¡Œ"</span>) ;</div><div class="line"></div><div class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>) ;</div><div class="line"></div><div class="line">        aVolatile.stopThread();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopThread</span><span class="params">()</span></span>&#123;</div><div class="line">        flag = <span class="keyword">false</span> ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">thread Aæ­£åœ¨è¿è¡Œã€‚ã€‚ã€‚</div><div class="line">thread Aæ­£åœ¨è¿è¡Œã€‚ã€‚ã€‚</div><div class="line">thread Aæ­£åœ¨è¿è¡Œã€‚ã€‚ã€‚</div><div class="line">thread Aæ­£åœ¨è¿è¡Œã€‚ã€‚ã€‚</div><div class="line">thread Aæ‰§è¡Œå®Œæ¯•</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„ flag å­˜æ”¾äºä¸»å†…å­˜ä¸­ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹å’Œçº¿ç¨‹ A éƒ½å¯ä»¥çœ‹åˆ°ã€‚</p>
<p>flag é‡‡ç”¨ volatile ä¿®é¥°ä¸»è¦æ˜¯ä¸ºäº†å†…å­˜å¯è§æ€§ï¼Œæ›´å¤šå†…å®¹å¯ä»¥æŸ¥çœ‹<a href="http://crossoverjie.top/2018/03/09/volatile/">è¿™é‡Œ</a>ã€‚</p>
<h2 id="CountDownLatch-å¹¶å‘å·¥å…·"><a href="#CountDownLatch-å¹¶å‘å·¥å…·" class="headerlink" title="CountDownLatch å¹¶å‘å·¥å…·"></a>CountDownLatch å¹¶å‘å·¥å…·</h2><p>CountDownLatch å¯ä»¥å®ç° join ç›¸åŒçš„åŠŸèƒ½ï¼Œä½†æ˜¯æ›´åŠ çš„çµæ´»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">countDownLatch</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">    <span class="keyword">int</span> thread = <span class="number">3</span> ;</div><div class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">    <span class="keyword">final</span> CountDownLatch countDown = <span class="keyword">new</span> CountDownLatch(thread);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i= <span class="number">0</span> ;i&lt;thread ; i++)&#123;</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                LOGGER.info(<span class="string">"thread run"</span>);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">2000</span>);</div><div class="line">                    countDown.countDown();</div><div class="line"></div><div class="line">                    LOGGER.info(<span class="string">"thread end"</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    countDown.await();</div><div class="line">    <span class="keyword">long</span> stop = System.currentTimeMillis();</div><div class="line">    LOGGER.info(<span class="string">"main over total time=&#123;&#125;"</span>,stop-start);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">2018-03-16 20:19:44.126 [Thread-0] INFO  c.c.actual.ThreadCommunication - thread run</div><div class="line">2018-03-16 20:19:44.126 [Thread-2] INFO  c.c.actual.ThreadCommunication - thread run</div><div class="line">2018-03-16 20:19:44.126 [Thread-1] INFO  c.c.actual.ThreadCommunication - thread run</div><div class="line">2018-03-16 20:19:46.136 [Thread-2] INFO  c.c.actual.ThreadCommunication - thread end</div><div class="line">2018-03-16 20:19:46.136 [Thread-1] INFO  c.c.actual.ThreadCommunication - thread end</div><div class="line">2018-03-16 20:19:46.136 [Thread-0] INFO  c.c.actual.ThreadCommunication - thread end</div><div class="line">2018-03-16 20:19:46.136 [main] INFO  c.c.actual.ThreadCommunication - main over total time=2012</div></pre></td></tr></table></figure>
<p>CountDownLatch ä¹Ÿæ˜¯åŸºäº AQS(AbstractQueuedSynchronizer) å®ç°çš„ï¼Œæ›´å¤šå®ç°å‚è€ƒ <a href="http://crossoverjie.top/2018/01/25/ReentrantLock/">ReentrantLock å®ç°åŸç†</a></p>
<ul>
<li>åˆå§‹åŒ–ä¸€ä¸ª CountDownLatch æ—¶å‘Šè¯‰å¹¶å‘çš„çº¿ç¨‹ï¼Œç„¶ååœ¨æ¯ä¸ªçº¿ç¨‹å¤„ç†å®Œæ¯•ä¹‹åè°ƒç”¨ countDown() æ–¹æ³•ã€‚</li>
<li>è¯¥æ–¹æ³•ä¼šå°† AQS å†…ç½®çš„ä¸€ä¸ª state çŠ¶æ€ -1 ã€‚</li>
<li>æœ€ç»ˆåœ¨ä¸»çº¿ç¨‹è°ƒç”¨ await() æ–¹æ³•ï¼Œå®ƒä¼šé˜»å¡ç›´åˆ° <code>state == 0</code> çš„æ—¶å€™è¿”å›ã€‚</li>
</ul>
<h2 id="CyclicBarrier-å¹¶å‘å·¥å…·"><a href="#CyclicBarrier-å¹¶å‘å·¥å…·" class="headerlink" title="CyclicBarrier å¹¶å‘å·¥å…·"></a>CyclicBarrier å¹¶å‘å·¥å…·</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">cyclicBarrier</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">3</span>) ;</div><div class="line"></div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LOGGER.info(<span class="string">"thread run"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                cyclicBarrier.await() ;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            LOGGER.info(<span class="string">"thread end do something"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;).start();</div><div class="line"></div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LOGGER.info(<span class="string">"thread run"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                cyclicBarrier.await() ;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            LOGGER.info(<span class="string">"thread end do something"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;).start();</div><div class="line"></div><div class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LOGGER.info(<span class="string">"thread run"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">5000</span>);</div><div class="line">                cyclicBarrier.await() ;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            LOGGER.info(<span class="string">"thread end do something"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;).start();</div><div class="line"></div><div class="line">    LOGGER.info(<span class="string">"main thread"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CyclicBarrier ä¸­æ–‡åå«åšå±éšœæˆ–è€…æ˜¯æ …æ ï¼Œä¹Ÿå¯ä»¥ç”¨äºçº¿ç¨‹é—´é€šä¿¡ã€‚</p>
<p>å®ƒå¯ä»¥ç­‰å¾… N ä¸ªçº¿ç¨‹éƒ½è¾¾åˆ°æŸä¸ªçŠ¶æ€åç»§ç»­è¿è¡Œçš„æ•ˆæœã€‚</p>
<ol>
<li>é¦–å…ˆåˆå§‹åŒ–çº¿ç¨‹å‚ä¸è€…ã€‚</li>
<li>è°ƒç”¨ <code>await()</code> å°†ä¼šåœ¨æ‰€æœ‰å‚ä¸è€…çº¿ç¨‹éƒ½è°ƒç”¨ä¹‹å‰ç­‰å¾…ã€‚</li>
<li>ç›´åˆ°æ‰€æœ‰å‚ä¸è€…éƒ½è°ƒç”¨äº† <code>await()</code> åï¼Œæ‰€æœ‰çº¿ç¨‹ä» <code>await()</code> è¿”å›ç»§ç»­åç»­é€»è¾‘ã€‚</li>
</ol>
<p>è¿è¡Œç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">2018-03-18 22:40:00.731 [Thread-0] INFO  c.c.actual.ThreadCommunication - thread run</div><div class="line">2018-03-18 22:40:00.731 [Thread-1] INFO  c.c.actual.ThreadCommunication - thread run</div><div class="line">2018-03-18 22:40:00.731 [Thread-2] INFO  c.c.actual.ThreadCommunication - thread run</div><div class="line">2018-03-18 22:40:00.731 [main] INFO  c.c.actual.ThreadCommunication - main thread</div><div class="line">2018-03-18 22:40:05.741 [Thread-0] INFO  c.c.actual.ThreadCommunication - thread end do something</div><div class="line">2018-03-18 22:40:05.741 [Thread-1] INFO  c.c.actual.ThreadCommunication - thread end do something</div><div class="line">2018-03-18 22:40:05.741 [Thread-2] INFO  c.c.actual.ThreadCommunication - thread end do something</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºç”±äºå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä¼‘çœ äº†äº”ç§’ï¼Œæ‰€æœ‰å…¶ä½™æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¾—ç­‰å¾…è¿™ä¸ªçº¿ç¨‹è°ƒç”¨ <code>await()</code> ã€‚</p>
<p>è¯¥å·¥å…·å¯ä»¥å®ç° CountDownLatch åŒæ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯è¦æ›´åŠ çµæ´»ã€‚ç”šè‡³å¯ä»¥è°ƒç”¨ <code>reset()</code> æ–¹æ³•é‡ç½® CyclicBarrier (éœ€è¦è‡ªè¡Œæ•è· BrokenBarrierException å¤„ç†) ç„¶åé‡æ–°æ‰§è¡Œã€‚</p>
<h2 id="çº¿ç¨‹å“åº”ä¸­æ–­"><a href="#çº¿ç¨‹å“åº”ä¸­æ–­" class="headerlink" title="çº¿ç¨‹å“åº”ä¸­æ–­"></a>çº¿ç¨‹å“åº”ä¸­æ–­</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StopThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> ( !Thread.currentThread().isInterrupted()) &#123;</div><div class="line">            <span class="comment">// çº¿ç¨‹æ‰§è¡Œå…·ä½“é€»è¾‘</span></div><div class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"è¿è¡Œä¸­ã€‚ã€‚"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"é€€å‡ºã€‚ã€‚"</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> StopThread(), <span class="string">"thread A"</span>);</div><div class="line">        thread.start();</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"main çº¿ç¨‹æ­£åœ¨è¿è¡Œ"</span>) ;</div><div class="line"></div><div class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>) ;</div><div class="line">        thread.interrupt();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">thread Aè¿è¡Œä¸­ã€‚ã€‚</div><div class="line">thread Aè¿è¡Œä¸­ã€‚ã€‚</div><div class="line">thread Aé€€å‡ºã€‚ã€‚</div></pre></td></tr></table></figure>
<p>å¯ä»¥é‡‡ç”¨ä¸­æ–­çº¿ç¨‹çš„æ–¹å¼æ¥é€šä¿¡ï¼Œè°ƒç”¨äº† <code>thread.interrupt()</code> æ–¹æ³•å…¶å®å°±æ˜¯å°† thread ä¸­çš„ä¸€ä¸ªæ ‡å¿—å±æ€§ç½®ä¸ºäº† trueã€‚</p>
<p>å¹¶ä¸æ˜¯è¯´è°ƒç”¨äº†è¯¥æ–¹æ³•å°±å¯ä»¥ä¸­æ–­çº¿ç¨‹ï¼Œå¦‚æœä¸å¯¹è¿™ä¸ªæ ‡å¿—è¿›è¡Œå“åº”å…¶å®æ˜¯æ²¡æœ‰ä»€ä¹ˆä½œç”¨(è¿™é‡Œå¯¹è¿™ä¸ªæ ‡å¿—è¿›è¡Œäº†åˆ¤æ–­)ã€‚</p>
<p><strong>ä½†æ˜¯å¦‚æœæŠ›å‡ºäº† InterruptedException å¼‚å¸¸ï¼Œè¯¥æ ‡å¿—å°±ä¼šè¢« JVM é‡ç½®ä¸º falseã€‚</strong></p>
<h2 id="çº¿ç¨‹æ± -awaitTermination-æ–¹æ³•"><a href="#çº¿ç¨‹æ± -awaitTermination-æ–¹æ³•" class="headerlink" title="çº¿ç¨‹æ±  awaitTermination() æ–¹æ³•"></a>çº¿ç¨‹æ±  awaitTermination() æ–¹æ³•</h2><p>å¦‚æœæ˜¯ç”¨çº¿ç¨‹æ± æ¥ç®¡ç†çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ¥è®©ä¸»çº¿ç¨‹ç­‰å¾…çº¿ç¨‹æ± ä¸­æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executorService</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">    BlockingQueue&lt;Runnable&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">10</span>) ;</div><div class="line">    ThreadPoolExecutor poolExecutor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>,<span class="number">5</span>,<span class="number">1</span>, TimeUnit.MILLISECONDS,queue) ;</div><div class="line">    poolExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LOGGER.info(<span class="string">"running"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">3000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    poolExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LOGGER.info(<span class="string">"running2"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">2000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    poolExecutor.shutdown();</div><div class="line">    <span class="keyword">while</span> (!poolExecutor.awaitTermination(<span class="number">1</span>,TimeUnit.SECONDS))&#123;</div><div class="line">        LOGGER.info(<span class="string">"çº¿ç¨‹è¿˜åœ¨æ‰§è¡Œã€‚ã€‚ã€‚"</span>);</div><div class="line">    &#125;</div><div class="line">    LOGGER.info(<span class="string">"main over"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">2018-03-16 20:18:01.273 [pool-1-thread-2] INFO  c.c.actual.ThreadCommunication - running2</div><div class="line">2018-03-16 20:18:01.273 [pool-1-thread-1] INFO  c.c.actual.ThreadCommunication - running</div><div class="line">2018-03-16 20:18:02.273 [main] INFO  c.c.actual.ThreadCommunication - çº¿ç¨‹è¿˜åœ¨æ‰§è¡Œã€‚ã€‚ã€‚</div><div class="line">2018-03-16 20:18:03.278 [main] INFO  c.c.actual.ThreadCommunication - çº¿ç¨‹è¿˜åœ¨æ‰§è¡Œã€‚ã€‚ã€‚</div><div class="line">2018-03-16 20:18:04.278 [main] INFO  c.c.actual.ThreadCommunication - main over</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨è¿™ä¸ª <code>awaitTermination()</code> æ–¹æ³•çš„å‰æéœ€è¦å…³é—­çº¿ç¨‹æ± ï¼Œå¦‚è°ƒç”¨äº† <code>shutdown()</code> æ–¹æ³•ã€‚</p>
<p>è°ƒç”¨äº† <code>shutdown()</code> ä¹‹åçº¿ç¨‹æ± ä¼šåœæ­¢æ¥å—æ–°ä»»åŠ¡ï¼Œå¹¶ä¸”ä¼šå¹³æ»‘çš„å…³é—­çº¿ç¨‹æ± ä¸­ç°æœ‰çš„ä»»åŠ¡ã€‚</p>
<h2 id="ç®¡é“é€šä¿¡"><a href="#ç®¡é“é€šä¿¡" class="headerlink" title="ç®¡é“é€šä¿¡"></a>ç®¡é“é€šä¿¡</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">piped</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">//é¢å‘äºå­—ç¬¦ PipedInputStream é¢å‘äºå­—èŠ‚</span></div><div class="line">    PipedWriter writer = <span class="keyword">new</span> PipedWriter();</div><div class="line">    PipedReader reader = <span class="keyword">new</span> PipedReader();</div><div class="line"></div><div class="line">    <span class="comment">//è¾“å…¥è¾“å‡ºæµå»ºç«‹è¿æ¥</span></div><div class="line">    writer.connect(reader);</div><div class="line"></div><div class="line"></div><div class="line">    Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LOGGER.info(<span class="string">"running"</span>);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line"></div><div class="line">                    writer.write(i+<span class="string">""</span>);</div><div class="line">                    Thread.sleep(<span class="number">10</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    writer.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LOGGER.info(<span class="string">"running2"</span>);</div><div class="line">            <span class="keyword">int</span> msg = <span class="number">0</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">while</span> ((msg = reader.read()) != -<span class="number">1</span>) &#123;</div><div class="line">                    LOGGER.info(<span class="string">"msg=&#123;&#125;"</span>, (<span class="keyword">char</span>) msg);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    t1.start();</div><div class="line">    t2.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœ:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">2018-03-16 19:56:43.014 [Thread-0] INFO  c.c.actual.ThreadCommunication - running</div><div class="line">2018-03-16 19:56:43.014 [Thread-1] INFO  c.c.actual.ThreadCommunication - running2</div><div class="line">2018-03-16 19:56:43.130 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=0</div><div class="line">2018-03-16 19:56:43.132 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=1</div><div class="line">2018-03-16 19:56:43.132 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=2</div><div class="line">2018-03-16 19:56:43.133 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=3</div><div class="line">2018-03-16 19:56:43.133 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=4</div><div class="line">2018-03-16 19:56:43.133 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=5</div><div class="line">2018-03-16 19:56:43.133 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=6</div><div class="line">2018-03-16 19:56:43.134 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=7</div><div class="line">2018-03-16 19:56:43.134 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=8</div><div class="line">2018-03-16 19:56:43.134 [Thread-1] INFO  c.c.actual.ThreadCommunication - msg=9</div></pre></td></tr></table></figure>
<p>Java è™½è¯´æ˜¯åŸºäºå†…å­˜é€šä¿¡çš„ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨ç®¡é“é€šä¿¡ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¾“å…¥æµå’Œè¾“å‡ºæµéœ€è¦é¦–å…ˆå»ºç«‹è¿æ¥ã€‚è¿™æ ·çº¿ç¨‹ B å°±å¯ä»¥æ”¶åˆ°çº¿ç¨‹ A å‘å‡ºçš„æ¶ˆæ¯äº†ã€‚</p>
<p>å®é™…å¼€å‘ä¸­å¯ä»¥çµæ´»æ ¹æ®éœ€æ±‚é€‰æ‹©æœ€é€‚åˆçš„çº¿ç¨‹é€šä¿¡æ–¹å¼ã€‚</p>
<h2 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h2><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tKfTcly1fpey91u1opj30z00aogo6.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å¼€å‘ä¸­ä¸å…ä¼šé‡åˆ°éœ€è¦æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•é€šçŸ¥ä¸»çº¿ç¨‹å¤„ç†æŸäº›é€»è¾‘çš„åœºæ™¯ã€‚&lt;/p&gt;
&lt;p&gt;æˆ–è€…æ˜¯çº¿ç¨‹ A åœ¨æ‰§è¡Œåˆ°æŸä¸ªæ¡ä»¶é€šçŸ¥çº¿ç¨‹ B æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å®ç°ï¼š&lt;/p&gt;
&lt;h2 id=&quot;ç­‰å¾…é€šçŸ¥æœºåˆ¶&quot;&gt;&lt;a href=&quot;#ç­‰å¾…é€šçŸ¥æœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;ç­‰å¾…é€šçŸ¥æœºåˆ¶&quot;&gt;&lt;/a&gt;ç­‰å¾…é€šçŸ¥æœºåˆ¶&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;ç­‰å¾…é€šçŸ¥æ¨¡å¼æ˜¯ Java ä¸­æ¯”è¾ƒç»å…¸çš„çº¿ç¨‹é€šä¿¡æ–¹å¼ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡å¯¹åŒä¸€å¯¹è±¡è°ƒç”¨ç­‰å¾… wait() å’Œé€šçŸ¥ notify() æ–¹æ³•æ¥è¿›è¡Œé€šè®¯ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡å¶æ•°ï¼š&lt;/p&gt;
    
    </summary>
    
      <category term="Java è¿›é˜¶" scheme="http://crossoverjie.top/categories/Java-%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Java" scheme="http://crossoverjie.top/tags/Java/"/>
    
      <category term="Thread" scheme="http://crossoverjie.top/tags/Thread/"/>
    
      <category term="concurrent" scheme="http://crossoverjie.top/tags/concurrent/"/>
    
  </entry>
  
  <entry>
    <title>ä½ åº”è¯¥çŸ¥é“çš„ volatile å…³é”®å­—</title>
    <link href="http://crossoverjie.top/2018/03/09/volatile/"/>
    <id>http://crossoverjie.top/2018/03/09/volatile/</id>
    <published>2018-03-08T18:00:36.000Z</published>
    <updated>2018-03-08T17:42:16.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fp5xm7uykoj30v90kugng.jpg" alt=""></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸ç®¡æ˜¯åœ¨é¢è¯•è¿˜æ˜¯å®é™…å¼€å‘ä¸­ <code>volatile</code> éƒ½æ˜¯ä¸€ä¸ªåº”è¯¥æŒæ¡çš„æŠ€èƒ½ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹çœ‹ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªå…³é”®å­—ã€‚</p>
<h2 id="å†…å­˜å¯è§æ€§"><a href="#å†…å­˜å¯è§æ€§" class="headerlink" title="å†…å­˜å¯è§æ€§"></a>å†…å­˜å¯è§æ€§</h2><p>ç”±äº <code>Java</code> å†…å­˜æ¨¡å‹(<code>JMM</code>)è§„å®šï¼Œæ‰€æœ‰çš„å˜é‡éƒ½å­˜æ”¾åœ¨ä¸»å†…å­˜ä¸­ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç€è‡ªå·±çš„å·¥ä½œå†…å­˜(é«˜é€Ÿç¼“å­˜)ã€‚</p>
<p>çº¿ç¨‹åœ¨å·¥ä½œæ—¶ï¼Œéœ€è¦å°†ä¸»å†…å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°å·¥ä½œå†…å­˜ä¸­ã€‚è¿™æ ·å¯¹æ•°æ®çš„ä»»ä½•æ“ä½œéƒ½æ˜¯åŸºäºå·¥ä½œå†…å­˜(æ•ˆç‡æé«˜)ï¼Œå¹¶ä¸”ä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä»¥åŠå…¶ä»–çº¿ç¨‹å·¥ä½œå†…å­˜ä¸­çš„æ•°æ®ï¼Œä¹‹åå†å°†æ›´æ–°ä¹‹åçš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚</p>
<blockquote>
<p>è¿™é‡Œæ‰€æåˆ°çš„ä¸»å†…å­˜å¯ä»¥ç®€å•è®¤ä¸ºæ˜¯<strong>å †å†…å­˜</strong>ï¼Œè€Œå·¥ä½œå†…å­˜åˆ™å¯ä»¥è®¤ä¸ºæ˜¯<strong>æ ˆå†…å­˜</strong>ã€‚</p>
</blockquote>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fmouu3fpokj31ae0osjt1.jpg" alt=""></p>
<p>æ‰€ä»¥åœ¨å¹¶å‘è¿è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°çº¿ç¨‹ B æ‰€è¯»å–åˆ°çš„æ•°æ®æ˜¯çº¿ç¨‹ A æ›´æ–°ä¹‹å‰çš„æ•°æ®ã€‚</p>
<p>æ˜¾ç„¶è¿™è‚¯å®šæ˜¯ä¼šå‡ºé—®é¢˜çš„ï¼Œå› æ­¤ <code>volatile</code> çš„ä½œç”¨å‡ºç°äº†ï¼š</p>
<blockquote>
<p>å½“ä¸€ä¸ªå˜é‡è¢« <code>volatile</code> ä¿®é¥°æ—¶ï¼Œä»»ä½•çº¿ç¨‹å¯¹å®ƒçš„å†™æ“ä½œéƒ½ä¼šç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œå¹¶ä¸”ä¼šå¼ºåˆ¶è®©ç¼“å­˜äº†è¯¥å˜é‡çš„çº¿ç¨‹ä¸­çš„æ•°æ®æ¸…ç©ºï¼Œå¿…é¡»ä»ä¸»å†…å­˜é‡æ–°è¯»å–æœ€æ–°æ•°æ®ã€‚</p>
</blockquote>
<a id="more"></a>
<p><em><code>volatile</code> ä¿®é¥°ä¹‹åå¹¶ä¸æ˜¯è®©çº¿ç¨‹ç›´æ¥ä»ä¸»å†…å­˜ä¸­è·å–æ•°æ®ï¼Œä¾ç„¶éœ€è¦å°†å˜é‡æ‹·è´åˆ°å·¥ä½œå†…å­˜ä¸­</em>ã€‚</p>
<h3 id="å†…å­˜å¯è§æ€§çš„åº”ç”¨"><a href="#å†…å­˜å¯è§æ€§çš„åº”ç”¨" class="headerlink" title="å†…å­˜å¯è§æ€§çš„åº”ç”¨"></a>å†…å­˜å¯è§æ€§çš„åº”ç”¨</h3><p>å½“æˆ‘ä»¬éœ€è¦åœ¨ä¸¤ä¸ªçº¿ç¨‹é—´ä¾æ®ä¸»å†…å­˜é€šä¿¡æ—¶ï¼Œé€šä¿¡çš„é‚£ä¸ªå˜é‡å°±å¿…é¡»çš„ç”¨ <code>volatile</code> æ¥ä¿®é¥°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Volatile</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">true</span> ;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (flag)&#123;</div><div class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"æ­£åœ¨è¿è¡Œã€‚ã€‚ã€‚"</span>);</div><div class="line">        &#125;</div><div class="line">        System.out.println(Thread.currentThread().getName() +<span class="string">"æ‰§è¡Œå®Œæ¯•"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        Volatile aVolatile = <span class="keyword">new</span> Volatile();</div><div class="line">        <span class="keyword">new</span> Thread(aVolatile,<span class="string">"thread A"</span>).start();</div><div class="line"></div><div class="line"></div><div class="line">        System.out.println(<span class="string">"main çº¿ç¨‹æ­£åœ¨è¿è¡Œ"</span>) ;</div><div class="line"></div><div class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>) ;</div><div class="line"></div><div class="line">        aVolatile.stopThread();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopThread</span><span class="params">()</span></span>&#123;</div><div class="line">        flag = <span class="keyword">false</span> ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸»çº¿ç¨‹åœ¨ä¿®æ”¹äº†æ ‡å¿—ä½ä½¿å¾—çº¿ç¨‹ A ç«‹å³åœæ­¢ï¼Œå¦‚æœæ²¡æœ‰ç”¨ <code>volatile</code> ä¿®é¥°ï¼Œå°±æœ‰å¯èƒ½å‡ºç°å»¶è¿Ÿã€‚</p>
<p>ä½†è¿™é‡Œæœ‰ä¸ªè¯¯åŒºï¼Œè¿™æ ·çš„ä½¿ç”¨æ–¹å¼å®¹æ˜“ç»™äººçš„æ„Ÿè§‰æ˜¯ï¼š</p>
<blockquote>
<p>å¯¹ <code>volatile</code> ä¿®é¥°çš„å˜é‡è¿›è¡Œå¹¶å‘æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
</blockquote>
<p>è¿™é‡Œè¦é‡ç‚¹å¼ºè°ƒï¼Œ<code>volatile</code> å¹¶<strong>ä¸èƒ½</strong>ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼</p>
<p>å¦‚ä¸‹ç¨‹åº:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileInc</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count = <span class="number">0</span> ; <span class="comment">//ä½¿ç”¨ volatile ä¿®é¥°åŸºæœ¬æ•°æ®å†…å­˜ä¸èƒ½ä¿è¯åŸå­æ€§</span></div><div class="line"></div><div class="line">    <span class="comment">//private static AtomicInteger count = new AtomicInteger() ;</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10000</span> ;i++)&#123;</div><div class="line">            count ++ ;</div><div class="line">            <span class="comment">//count.incrementAndGet() ;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        VolatileInc volatileInc = <span class="keyword">new</span> VolatileInc() ;</div><div class="line">        Thread t1 = <span class="keyword">new</span> Thread(volatileInc,<span class="string">"t1"</span>) ;</div><div class="line">        Thread t2 = <span class="keyword">new</span> Thread(volatileInc,<span class="string">"t2"</span>) ;</div><div class="line">        t1.start();</div><div class="line">        <span class="comment">//t1.join();</span></div><div class="line"></div><div class="line">        t2.start();</div><div class="line">        <span class="comment">//t2.join();</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10000</span> ;i++)&#123;</div><div class="line">            count ++ ;</div><div class="line">            <span class="comment">//count.incrementAndGet();</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        System.out.println(<span class="string">"æœ€ç»ˆCount="</span>+count);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬ä¸‰ä¸ªçº¿ç¨‹(t1,t2,main)åŒæ—¶å¯¹ä¸€ä¸ª <code>int</code> è¿›è¡Œç´¯åŠ æ—¶ä¼šå‘ç°æœ€ç»ˆçš„å€¼éƒ½ä¼šå°äº 30000ã€‚</p>
<blockquote>
<p>è¿™æ˜¯å› ä¸ºè™½ç„¶ <code>volatile</code> ä¿è¯äº†å†…å­˜å¯è§æ€§ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¿åˆ°çš„å€¼éƒ½æ˜¯æœ€æ–°å€¼ï¼Œä½† <code>count ++</code> è¿™ä¸ªæ“ä½œå¹¶ä¸æ˜¯åŸå­çš„ï¼Œè¿™é‡Œé¢æ¶‰åŠåˆ°è·å–å€¼ã€è‡ªå¢ã€èµ‹å€¼çš„æ“ä½œå¹¶ä¸èƒ½åŒæ—¶å®Œæˆã€‚</p>
</blockquote>
<ul>
<li><p>æ‰€ä»¥æƒ³åˆ°è¾¾åˆ°çº¿ç¨‹å®‰å…¨å¯ä»¥ä½¿è¿™ä¸‰ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ(å…¶å®å°±æ˜¯å•çº¿ç¨‹ï¼Œæ²¡æœ‰å‘æŒ¥å¤šçº¿ç¨‹çš„ä¼˜åŠ¿)ã€‚</p>
</li>
<li><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>synchronize</code> æˆ–è€…æ˜¯é”çš„æ–¹å¼æ¥ä¿è¯åŸå­æ€§ã€‚</p>
</li>
<li><p>è¿˜å¯ä»¥ç”¨ <code>Atomic</code> åŒ…ä¸­ <code>AtomicInteger</code> æ¥æ›¿æ¢ <code>int</code>ï¼Œå®ƒåˆ©ç”¨äº† <code>CAS</code> ç®—æ³•æ¥ä¿è¯äº†åŸå­æ€§ã€‚</p>
</li>
</ul>
<h2 id="æŒ‡ä»¤é‡æ’"><a href="#æŒ‡ä»¤é‡æ’" class="headerlink" title="æŒ‡ä»¤é‡æ’"></a>æŒ‡ä»¤é‡æ’</h2><p>å†…å­˜å¯è§æ€§åªæ˜¯ <code>volatile</code> çš„å…¶ä¸­ä¸€ä¸ªè¯­ä¹‰ï¼Œå®ƒè¿˜å¯ä»¥é˜²æ­¢ <code>JVM</code> è¿›è¡ŒæŒ‡ä»¤é‡æ’ä¼˜åŒ–ã€‚</p>
<p>ä¸¾ä¸€ä¸ªä¼ªä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> a=<span class="number">10</span> ;<span class="comment">//1</span></div><div class="line"><span class="keyword">int</span> b=<span class="number">20</span> ;<span class="comment">//2</span></div><div class="line"><span class="keyword">int</span> c= a+b ;<span class="comment">//3</span></div></pre></td></tr></table></figure>
<p>ä¸€æ®µç‰¹åˆ«ç®€å•çš„ä»£ç ï¼Œç†æƒ³æƒ…å†µä¸‹å®ƒçš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š<code>1&gt;2&gt;3</code>ã€‚ä½†æœ‰å¯èƒ½ç»è¿‡ JVM ä¼˜åŒ–ä¹‹åçš„æ‰§è¡Œé¡ºåºå˜ä¸ºäº† <code>2&gt;1&gt;3</code>ã€‚</p>
<p>å¯ä»¥å‘ç°ä¸ç®¡ JVM æ€ä¹ˆä¼˜åŒ–ï¼Œå‰æéƒ½æ˜¯ä¿è¯å•çº¿ç¨‹ä¸­æœ€ç»ˆç»“æœä¸å˜çš„æƒ…å†µä¸‹è¿›è¡Œçš„ã€‚</p>
<p>å¯èƒ½è¿™é‡Œè¿˜çœ‹ä¸å‡ºæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œé‚£çœ‹ä¸‹ä¸€æ®µä¼ªä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String,String&gt; value ;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = fasle ;</div><div class="line"></div><div class="line"><span class="comment">//ä»¥ä¸‹æ–¹æ³•å‘ç”Ÿåœ¨çº¿ç¨‹ A ä¸­ åˆå§‹åŒ– Map</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMap</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="comment">//è€—æ—¶æ“ä½œ</span></div><div class="line">	value = getMapValue() ;<span class="comment">//1</span></div><div class="line">	flag = <span class="keyword">true</span> ;<span class="comment">//2</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//å‘ç”Ÿåœ¨çº¿ç¨‹ Bä¸­ ç­‰åˆ° Map åˆå§‹åŒ–æˆåŠŸè¿›è¡Œå…¶ä»–æ“ä½œ</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomeThing</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">while</span>(!flag)&#123;</div><div class="line">		sleep() ;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//dosomething</span></div><div class="line">	doSomeThing(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±èƒ½çœ‹å‡ºé—®é¢˜äº†ï¼Œå½“ <code>flag</code> æ²¡æœ‰è¢« <code>volatile</code> ä¿®é¥°æ—¶ï¼Œ<code>JVM</code> å¯¹ 1 å’Œ 2 è¿›è¡Œé‡æ’ï¼Œå¯¼è‡´ <code>value</code> éƒ½è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–å°±æœ‰å¯èƒ½è¢«çº¿ç¨‹ B ä½¿ç”¨äº†ã€‚</p>
<p>æ‰€ä»¥åŠ ä¸Š <code>volatile</code> ä¹‹åå¯ä»¥é˜²æ­¢è¿™æ ·çš„é‡æ’ä¼˜åŒ–ï¼Œä¿è¯ä¸šåŠ¡çš„æ­£ç¡®æ€§ã€‚</p>
<h3 id="æŒ‡ä»¤é‡æ’çš„çš„åº”ç”¨"><a href="#æŒ‡ä»¤é‡æ’çš„çš„åº”ç”¨" class="headerlink" title="æŒ‡ä»¤é‡æ’çš„çš„åº”ç”¨"></a>æŒ‡ä»¤é‡æ’çš„çš„åº”ç”¨</h3><p>ä¸€ä¸ªç»å…¸çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯åŒé‡æ‡’åŠ è½½çš„å•ä¾‹æ¨¡å¼äº†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton singleton;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</div><div class="line">                <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">//é˜²æ­¢æŒ‡ä»¤é‡æ’</span></div><div class="line">                    singleton = <span class="keyword">new</span> Singleton();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> singleton;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ <code>volatile</code> å…³é”®å­—ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢æŒ‡ä»¤é‡æ’ã€‚ </p>
<p>å¦‚æœä¸ç”¨ ï¼Œ<code>singleton = new Singleton();</code>ï¼Œè¿™æ®µä»£ç å…¶å®æ˜¯åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ul>
<li>åˆ†é…å†…å­˜ç©ºé—´ã€‚(1)</li>
<li>åˆå§‹åŒ–å¯¹è±¡ã€‚(2)</li>
<li>å°† <code>singleton</code> å¯¹è±¡æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€ã€‚(3)</li>
</ul>
<p>åŠ ä¸Š <code>volatile</code> æ˜¯ä¸ºäº†è®©ä»¥ä¸Šçš„ä¸‰æ­¥æ“ä½œé¡ºåºæ‰§è¡Œï¼Œåä¹‹æœ‰å¯èƒ½ç¬¬äºŒæ­¥åœ¨ç¬¬ä¸‰æ­¥ä¹‹å‰è¢«æ‰§è¡Œå°±æœ‰å¯èƒ½æŸä¸ªçº¿ç¨‹æ‹¿åˆ°çš„å•ä¾‹å¯¹è±¡æ˜¯è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„ï¼Œä»¥è‡´äºæŠ¥é”™ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>volatile</code> åœ¨ <code>Java</code> å¹¶å‘ä¸­ç”¨çš„å¾ˆå¤šï¼Œæ¯”å¦‚åƒ <code>Atomic</code> åŒ…ä¸­çš„ <code>value</code>ã€ä»¥åŠ <code>AbstractQueuedLongSynchronizer</code> ä¸­çš„ <code>state</code> éƒ½æ˜¯è¢«å®šä¹‰ä¸º <code>volatile</code> æ¥ç”¨äºä¿è¯å†…å­˜å¯è§æ€§ã€‚</p>
<p>å°†è¿™å—ç†è§£é€å½»å¯¹æˆ‘ä»¬ç¼–å†™å¹¶å‘ç¨‹åºæ—¶å¯ä»¥æä¾›å¾ˆå¤§å¸®åŠ©ã€‚</p>
<h2 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h2><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws3.sinaimg.cn/large/006tNc79gy1fp5xm7uykoj30v90kugng.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ä¸ç®¡æ˜¯åœ¨é¢è¯•è¿˜æ˜¯å®é™…å¼€å‘ä¸­ &lt;code&gt;volatile&lt;/code&gt; éƒ½æ˜¯ä¸€ä¸ªåº”è¯¥æŒæ¡çš„æŠ€èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆæ¥çœ‹çœ‹ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªå…³é”®å­—ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å†…å­˜å¯è§æ€§&quot;&gt;&lt;a href=&quot;#å†…å­˜å¯è§æ€§&quot; class=&quot;headerlink&quot; title=&quot;å†…å­˜å¯è§æ€§&quot;&gt;&lt;/a&gt;å†…å­˜å¯è§æ€§&lt;/h2&gt;&lt;p&gt;ç”±äº &lt;code&gt;Java&lt;/code&gt; å†…å­˜æ¨¡å‹(&lt;code&gt;JMM&lt;/code&gt;)è§„å®šï¼Œæ‰€æœ‰çš„å˜é‡éƒ½å­˜æ”¾åœ¨ä¸»å†…å­˜ä¸­ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç€è‡ªå·±çš„å·¥ä½œå†…å­˜(é«˜é€Ÿç¼“å­˜)ã€‚&lt;/p&gt;
&lt;p&gt;çº¿ç¨‹åœ¨å·¥ä½œæ—¶ï¼Œéœ€è¦å°†ä¸»å†…å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°å·¥ä½œå†…å­˜ä¸­ã€‚è¿™æ ·å¯¹æ•°æ®çš„ä»»ä½•æ“ä½œéƒ½æ˜¯åŸºäºå·¥ä½œå†…å­˜(æ•ˆç‡æé«˜)ï¼Œå¹¶ä¸”ä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä»¥åŠå…¶ä»–çº¿ç¨‹å·¥ä½œå†…å­˜ä¸­çš„æ•°æ®ï¼Œä¹‹åå†å°†æ›´æ–°ä¹‹åçš„æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;è¿™é‡Œæ‰€æåˆ°çš„ä¸»å†…å­˜å¯ä»¥ç®€å•è®¤ä¸ºæ˜¯&lt;strong&gt;å †å†…å­˜&lt;/strong&gt;ï¼Œè€Œå·¥ä½œå†…å­˜åˆ™å¯ä»¥è®¤ä¸ºæ˜¯&lt;strong&gt;æ ˆå†…å­˜&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tKfTcly1fmouu3fpokj31ae0osjt1.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥åœ¨å¹¶å‘è¿è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°çº¿ç¨‹ B æ‰€è¯»å–åˆ°çš„æ•°æ®æ˜¯çº¿ç¨‹ A æ›´æ–°ä¹‹å‰çš„æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;æ˜¾ç„¶è¿™è‚¯å®šæ˜¯ä¼šå‡ºé—®é¢˜çš„ï¼Œå› æ­¤ &lt;code&gt;volatile&lt;/code&gt; çš„ä½œç”¨å‡ºç°äº†ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å½“ä¸€ä¸ªå˜é‡è¢« &lt;code&gt;volatile&lt;/code&gt; ä¿®é¥°æ—¶ï¼Œä»»ä½•çº¿ç¨‹å¯¹å®ƒçš„å†™æ“ä½œéƒ½ä¼šç«‹å³åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œå¹¶ä¸”ä¼šå¼ºåˆ¶è®©ç¼“å­˜äº†è¯¥å˜é‡çš„çº¿ç¨‹ä¸­çš„æ•°æ®æ¸…ç©ºï¼Œå¿…é¡»ä»ä¸»å†…å­˜é‡æ–°è¯»å–æœ€æ–°æ•°æ®ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Java è¿›é˜¶" scheme="http://crossoverjie.top/categories/Java-%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Java" scheme="http://crossoverjie.top/tags/Java/"/>
    
      <category term="volatile" scheme="http://crossoverjie.top/tags/volatile/"/>
    
      <category term="concurrent" scheme="http://crossoverjie.top/tags/concurrent/"/>
    
  </entry>
  
  <entry>
    <title>LinkedHashMap åº•å±‚åˆ†æ</title>
    <link href="http://crossoverjie.top/2018/02/06/LinkedHashMap/"/>
    <id>http://crossoverjie.top/2018/02/06/LinkedHashMap/</id>
    <published>2018-02-06T15:01:36.000Z</published>
    <updated>2018-03-19T05:04:40.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fo6w785brkj31g80ytjx5.jpg" alt=""></p>
<p>ä¼—æ‰€å‘¨çŸ¥ <a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/HashMap.md" target="_blank" rel="external">HashMap</a> æ˜¯ä¸€ä¸ªæ— åºçš„ <code>Map</code>ï¼Œå› ä¸ºæ¯æ¬¡æ ¹æ® <code>key</code> çš„ <code>hashcode</code> æ˜ å°„åˆ° <code>Entry</code> æ•°ç»„ä¸Šï¼Œæ‰€ä»¥éå†å‡ºæ¥çš„é¡ºåºå¹¶ä¸æ˜¯å†™å…¥çš„é¡ºåºã€‚</p>
<p>å› æ­¤ JDK æ¨å‡ºä¸€ä¸ªåŸºäº <code>HashMap</code> ä½†å…·æœ‰é¡ºåºçš„ <code>LinkedHashMap</code> æ¥è§£å†³æœ‰æ’åºéœ€æ±‚çš„åœºæ™¯ã€‚</p>
<p>å®ƒçš„åº•å±‚æ˜¯ç»§æ‰¿äº <code>HashMap</code> å®ç°çš„ï¼Œç”±ä¸€ä¸ªåŒå‘é“¾è¡¨æ‰€æ„æˆã€‚</p>
<p><code>LinkedHashMap</code> çš„æ’åºæ–¹å¼æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>æ ¹æ®å†™å…¥é¡ºåºæ’åºã€‚</li>
<li>æ ¹æ®è®¿é—®é¡ºåºæ’åºã€‚</li>
</ul>
<p>å…¶ä¸­æ ¹æ®è®¿é—®é¡ºåºæ’åºæ—¶ï¼Œæ¯æ¬¡ <code>get</code> éƒ½ä¼šå°†è®¿é—®çš„å€¼ç§»åŠ¨åˆ°é“¾è¡¨æœ«å°¾ï¼Œè¿™æ ·é‡å¤æ“ä½œå°±èƒ½çš„åˆ°ä¸€ä¸ªæŒ‰ç…§è®¿é—®é¡ºåºæ’åºçš„é“¾è¡¨ã€‚</p>
<a id="more"></a>
<h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</div><div class="line">	Map&lt;String, Integer&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;String, Integer&gt;();</div><div class="line">	map.put(<span class="string">"1"</span>,<span class="number">1</span>) ;</div><div class="line">	map.put(<span class="string">"2"</span>,<span class="number">2</span>) ;</div><div class="line">	map.put(<span class="string">"3"</span>,<span class="number">3</span>) ;</div><div class="line">	map.put(<span class="string">"4"</span>,<span class="number">4</span>) ;</div><div class="line">	map.put(<span class="string">"5"</span>,<span class="number">5</span>) ;</div><div class="line">	System.out.println(map.toString());</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è°ƒè¯•å¯ä»¥çœ‹åˆ° <code>map</code> çš„ç»„æˆï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fo6l9xp91lj319m0s4tgi.jpg" alt=""></p>
<p>æ‰“å¼€æºç å¯ä»¥çœ‹åˆ°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The head of the doubly linked list.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Entry&lt;K,V&gt; header;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * The iteration ordering method for this linked hash map: &lt;tt&gt;true&lt;/tt&gt;</div><div class="line"> * for access-order, &lt;tt&gt;false&lt;/tt&gt; for insertion-order.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@serial</span></div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> accessOrder;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMap</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">// These fields comprise the doubly linked list used for iteration.</span></div><div class="line">    Entry&lt;K,V&gt; before, after;</div><div class="line"></div><div class="line">    Entry(<span class="keyword">int</span> hash, K key, V value, HashMap.Entry&lt;K,V&gt; next) &#123;</div><div class="line">        <span class="keyword">super</span>(hash, key, value, next);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>Entry</code> ç»§æ‰¿äº <code>HashMap</code> çš„ <code>Entry</code>ï¼Œå¹¶æ–°å¢äº†ä¸Šä¸‹èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œä¹Ÿå°±å½¢æˆäº†åŒå‘é“¾è¡¨ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ª <code>header</code> çš„æˆå‘˜å˜é‡ï¼Œæ˜¯è¿™ä¸ªåŒå‘é“¾è¡¨çš„å¤´ç»“ç‚¹ã€‚ </p>
<p>ä¸Šè¾¹çš„ demo æ€»ç»“æˆä¸€å¼ å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fodggwc523j30za0n4wgj.jpg" alt=""></p>
<p>ç¬¬ä¸€ä¸ªç±»ä¼¼äº <code>HashMap</code> çš„ç»“æ„ï¼Œåˆ©ç”¨ <code>Entry</code> ä¸­çš„ <code>next</code> æŒ‡é’ˆè¿›è¡Œå…³è”ã€‚</p>
<p>ä¸‹è¾¹åˆ™æ˜¯ <code>LinkedHashMap</code> å¦‚ä½•è¾¾åˆ°æœ‰åºçš„å…³é”®ã€‚</p>
<p>å°±æ˜¯åˆ©ç”¨äº†å¤´èŠ‚ç‚¹å’Œå…¶ä½™çš„å„ä¸ªèŠ‚ç‚¹ä¹‹é—´é€šè¿‡ <code>Entry</code> ä¸­çš„ <code>after</code> å’Œ <code>before</code> æŒ‡é’ˆè¿›è¡Œå…³è”ã€‚</p>
<p>å…¶ä¸­è¿˜æœ‰ä¸€ä¸ª <code>accessOrder</code> æˆå‘˜å˜é‡ï¼Œé»˜è®¤æ˜¯ <code>false</code>ï¼Œé»˜è®¤æŒ‰ç…§æ’å…¥é¡ºåºæ’åºï¼Œä¸º <code>true</code> æ—¶æŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼Œä¹Ÿå¯ä»¥è°ƒç”¨:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public LinkedHashMap(int initialCapacity,</div><div class="line">                     float loadFactor,</div><div class="line">                     boolean accessOrder) &#123;</div><div class="line">    super(initialCapacity, loadFactor);</div><div class="line">    this.accessOrder = accessOrder;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ„é€ æ–¹æ³•å¯ä»¥æ˜¾ç¤ºçš„ä¼ å…¥ <code>accessOrder</code>ã€‚</p>
<h2 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h2><p><code>LinkedHashMap</code> çš„æ„é€ æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    accessOrder = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯è°ƒç”¨çš„ <code>HashMap</code> çš„æ„é€ æ–¹æ³•:</p>
<p><code>HashMap</code> å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</div><div class="line">                                           initialCapacity);</div><div class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</div><div class="line">        initialCapacity = MAXIMUM_CAPACITY;</div><div class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</div><div class="line">                                           loadFactor);</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</div><div class="line">    threshold = initialCapacity;</div><div class="line">    <span class="comment">//HashMap åªæ˜¯å®šä¹‰äº†æ”¹æ–¹æ³•ï¼Œå…·ä½“å®ç°äº¤ç»™äº† LinkedHashMap</span></div><div class="line">    init();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°é‡Œé¢æœ‰ä¸€ä¸ªç©ºçš„ <code>init()</code>ï¼Œå…·ä½“æ˜¯ç”± <code>LinkedHashMap</code> æ¥å®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">    header = <span class="keyword">new</span> Entry&lt;&gt;(-<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    header.before = header.after = header;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶å®ä¹Ÿå°±æ˜¯å¯¹ <code>header</code> è¿›è¡Œäº†åˆå§‹åŒ–ã€‚</p>
<h2 id="put-æ–¹æ³•"><a href="#put-æ–¹æ³•" class="headerlink" title="put æ–¹æ³•"></a>put æ–¹æ³•</h2><p>çœ‹ <code>LinkedHashMap</code> çš„ <code>put()</code> æ–¹æ³•ä¹‹å‰å…ˆçœ‹çœ‹ <code>HashMap</code> çš„ <code>put</code> æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">public V put(K key, V value) &#123;</div><div class="line">    if (table == EMPTY_TABLE) &#123;</div><div class="line">        inflateTable(threshold);</div><div class="line">    &#125;</div><div class="line">    if (key == null)</div><div class="line">        return putForNullKey(value);</div><div class="line">    int hash = hash(key);</div><div class="line">    int i = indexFor(hash, table.length);</div><div class="line">    for (Entry&lt;K,V&gt; e = table[i]; e != null; e = e.next) &#123;</div><div class="line">        Object k;</div><div class="line">        if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</div><div class="line">            V oldValue = e.value;</div><div class="line">            e.value = value;</div><div class="line">            //ç©ºå®ç°ï¼Œäº¤ç»™ LinkedHashMap è‡ªå·±å®ç°</div><div class="line">            e.recordAccess(this);</div><div class="line">            return oldValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    modCount++;</div><div class="line">    // LinkedHashMap å¯¹å…¶é‡å†™</div><div class="line">    addEntry(hash, key, value, i);</div><div class="line">    return null;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// LinkedHashMap å¯¹å…¶é‡å†™</div><div class="line">void addEntry(int hash, K key, V value, int bucketIndex) &#123;</div><div class="line">    if ((size &gt;= threshold) &amp;&amp; (null != table[bucketIndex])) &#123;</div><div class="line">        resize(2 * table.length);</div><div class="line">        hash = (null != key) ? hash(key) : 0;</div><div class="line">        bucketIndex = indexFor(hash, table.length);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    createEntry(hash, key, value, bucketIndex);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// LinkedHashMap å¯¹å…¶é‡å†™</div><div class="line">void createEntry(int hash, K key, V value, int bucketIndex) &#123;</div><div class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</div><div class="line">    table[bucketIndex] = new Entry&lt;&gt;(hash, key, value, e);</div><div class="line">    size++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸»ä½“çš„å®ç°éƒ½æ˜¯å€ŸåŠ©äº <code>HashMap</code> æ¥å®Œæˆçš„ï¼Œåªæ˜¯å¯¹å…¶ä¸­çš„ <code>recordAccess(), addEntry(), createEntry()</code> è¿›è¡Œäº†é‡å†™ã€‚</p>
<p><code>LinkedHashMap</code> çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">//å°±æ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯æ ¹æ®è®¿é—®é¡ºåºæ’åºï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦å°†å½“å‰è¿™ä¸ª Entry ç§»åŠ¨åˆ°é“¾è¡¨çš„æœ«å°¾</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recordAccess</span><span class="params">(HashMap&lt;K,V&gt; m)</span> </span>&#123;</div><div class="line">        LinkedHashMap&lt;K,V&gt; lm = (LinkedHashMap&lt;K,V&gt;)m;</div><div class="line">        <span class="keyword">if</span> (lm.accessOrder) &#123;</div><div class="line">            lm.modCount++;</div><div class="line">            remove();</div><div class="line">            addBefore(lm.header);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line"><span class="comment">//è°ƒç”¨äº† HashMap çš„å®ç°ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ é™¤æœ€å°‘ä½¿ç”¨çš„ Entry(é»˜è®¤ä¸åˆ é™¤)    </span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.addEntry(hash, key, value, bucketIndex);</div><div class="line"></div><div class="line">    <span class="comment">// Remove eldest entry if instructed</span></div><div class="line">    Entry&lt;K,V&gt; eldest = header.after;</div><div class="line">    <span class="keyword">if</span> (removeEldestEntry(eldest)) &#123;</div><div class="line">        removeEntryForKey(eldest.key);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">    HashMap.Entry&lt;K,V&gt; old = table[bucketIndex];</div><div class="line">    Entry&lt;K,V&gt; e = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, old);</div><div class="line">    <span class="comment">//å°±å¤šäº†è¿™ä¸€æ­¥ï¼Œå°†æ–°å¢çš„ Entry åŠ å…¥åˆ° header åŒå‘é“¾è¡¨ä¸­</span></div><div class="line">    table[bucketIndex] = e;</div><div class="line">    e.addBefore(header);</div><div class="line">    size++;</div><div class="line">&#125;</div><div class="line"></div><div class="line">    <span class="comment">//å†™å…¥åˆ°åŒå‘é“¾è¡¨ä¸­</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addBefore</span><span class="params">(Entry&lt;K,V&gt; existingEntry)</span> </span>&#123;</div><div class="line">        after  = existingEntry;</div><div class="line">        before = existingEntry.before;</div><div class="line">        before.after = <span class="keyword">this</span>;</div><div class="line">        after.before = <span class="keyword">this</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="get-æ–¹æ³•"><a href="#get-æ–¹æ³•" class="headerlink" title="get æ–¹æ³•"></a>get æ–¹æ³•</h2><p>LinkedHashMap çš„ <code>get()</code> æ–¹æ³•ä¹Ÿé‡å†™äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)getEntry(key);</div><div class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        </div><div class="line">    <span class="comment">//å¤šäº†ä¸€ä¸ªåˆ¤æ–­æ˜¯å¦æ˜¯æŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼Œæ˜¯åˆ™å°†å½“å‰çš„ Entry ç§»åŠ¨åˆ°é“¾è¡¨å¤´éƒ¨ã€‚</span></div><div class="line">    e.recordAccess(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> e.value;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">recordAccess</span><span class="params">(HashMap&lt;K,V&gt; m)</span> </span>&#123;</div><div class="line">    LinkedHashMap&lt;K,V&gt; lm = (LinkedHashMap&lt;K,V&gt;)m;</div><div class="line">    <span class="keyword">if</span> (lm.accessOrder) &#123;</div><div class="line">        lm.modCount++;</div><div class="line">        </div><div class="line">        <span class="comment">//åˆ é™¤</span></div><div class="line">        remove();</div><div class="line">        <span class="comment">//æ·»åŠ åˆ°å¤´éƒ¨</span></div><div class="line">        addBefore(lm.header);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>clear()</code> æ¸…ç©ºå°±è¦æ¯”è¾ƒç®€å•äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//åªéœ€è¦æŠŠæŒ‡é’ˆéƒ½æŒ‡å‘è‡ªå·±å³å¯ï¼ŒåŸæœ¬é‚£äº› Entry æ²¡æœ‰å¼•ç”¨ä¹‹åå°±ä¼šè¢« JVM è‡ªåŠ¨å›æ”¶ã€‚</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.clear();</div><div class="line">    header.before = header.after = header;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€»çš„æ¥è¯´ <code>LinkedHashMap</code> å…¶å®å°±æ˜¯å¯¹ <code>HashMap</code> è¿›è¡Œäº†æ‹“å±•ï¼Œä½¿ç”¨äº†åŒå‘é“¾è¡¨æ¥ä¿è¯äº†é¡ºåºæ€§ã€‚</p>
<p>å› ä¸ºæ˜¯ç»§æ‰¿ä¸ <code>HashMap</code> çš„ï¼Œæ‰€ä»¥ä¸€äº› <code>HashMap</code> å­˜åœ¨çš„é—®é¢˜ <code>LinkedHashMap</code> ä¹Ÿä¼šå­˜åœ¨ï¼Œæ¯”å¦‚ä¸æ”¯æŒå¹¶å‘ç­‰ã€‚</p>
<h2 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h2><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tNc79ly1fo6w785brkj31g80ytjx5.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ &lt;a href=&quot;https://github.com/crossoverJie/Java-Interview/blob/master/MD/HashMap.md&quot;&gt;HashMap&lt;/a&gt; æ˜¯ä¸€ä¸ªæ— åºçš„ &lt;code&gt;Map&lt;/code&gt;ï¼Œå› ä¸ºæ¯æ¬¡æ ¹æ® &lt;code&gt;key&lt;/code&gt; çš„ &lt;code&gt;hashcode&lt;/code&gt; æ˜ å°„åˆ° &lt;code&gt;Entry&lt;/code&gt; æ•°ç»„ä¸Šï¼Œæ‰€ä»¥éå†å‡ºæ¥çš„é¡ºåºå¹¶ä¸æ˜¯å†™å…¥çš„é¡ºåºã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤ JDK æ¨å‡ºä¸€ä¸ªåŸºäº &lt;code&gt;HashMap&lt;/code&gt; ä½†å…·æœ‰é¡ºåºçš„ &lt;code&gt;LinkedHashMap&lt;/code&gt; æ¥è§£å†³æœ‰æ’åºéœ€æ±‚çš„åœºæ™¯ã€‚&lt;/p&gt;
&lt;p&gt;å®ƒçš„åº•å±‚æ˜¯ç»§æ‰¿äº &lt;code&gt;HashMap&lt;/code&gt; å®ç°çš„ï¼Œç”±ä¸€ä¸ªåŒå‘é“¾è¡¨æ‰€æ„æˆã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;LinkedHashMap&lt;/code&gt; çš„æ’åºæ–¹å¼æœ‰ä¸¤ç§ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ ¹æ®å†™å…¥é¡ºåºæ’åºã€‚&lt;/li&gt;
&lt;li&gt;æ ¹æ®è®¿é—®é¡ºåºæ’åºã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å…¶ä¸­æ ¹æ®è®¿é—®é¡ºåºæ’åºæ—¶ï¼Œæ¯æ¬¡ &lt;code&gt;get&lt;/code&gt; éƒ½ä¼šå°†è®¿é—®çš„å€¼ç§»åŠ¨åˆ°é“¾è¡¨æœ«å°¾ï¼Œè¿™æ ·é‡å¤æ“ä½œå°±èƒ½çš„åˆ°ä¸€ä¸ªæŒ‰ç…§è®¿é—®é¡ºåºæ’åºçš„é“¾è¡¨ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Java è¿›é˜¶" scheme="http://crossoverjie.top/categories/Java-%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Java" scheme="http://crossoverjie.top/tags/Java/"/>
    
      <category term="LinkedHashMap" scheme="http://crossoverjie.top/tags/LinkedHashMap/"/>
    
  </entry>
  
  <entry>
    <title>ReentrantLock å®ç°åŸç†</title>
    <link href="http://crossoverjie.top/2018/01/25/ReentrantLock/"/>
    <id>http://crossoverjie.top/2018/01/25/ReentrantLock/</id>
    <published>2018-01-25T15:01:36.000Z</published>
    <updated>2018-01-26T07:38:08.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fnt9p6qc88j31g80yu41d.jpg" alt=""></p>
<p>ä½¿ç”¨ <code>synchronize</code> æ¥åšåŒæ­¥å¤„ç†æ—¶ï¼Œé”çš„è·å–å’Œé‡Šæ”¾éƒ½æ˜¯éšå¼çš„ï¼Œå®ç°çš„åŸç†æ˜¯é€šè¿‡ç¼–è¯‘ååŠ ä¸Šä¸åŒçš„æœºå™¨æŒ‡ä»¤æ¥å®ç°ã€‚</p>
<p>è€Œ <code>ReentrantLock</code> å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ï¼Œå®ƒæ˜¯åŸºäº <code>AQS(AbstractQueuedSynchronizer)</code>æ¥å®ç°çš„ã€‚</p>
<p>æ˜¯ä¸€ä¸ª<strong>é‡å…¥é”</strong>ï¼šä¸€ä¸ªçº¿ç¨‹è·å¾—äº†é”ä¹‹åä»ç„¶å¯ä»¥<strong>åå¤</strong>çš„åŠ é”ï¼Œä¸ä¼šå‡ºç°è‡ªå·±é˜»å¡è‡ªå·±çš„æƒ…å†µã€‚</p>
<blockquote>
<p><code>AQS</code> æ˜¯ <code>Java</code> å¹¶å‘åŒ…é‡Œå®ç°é”ã€åŒæ­¥çš„ä¸€ä¸ªé‡è¦çš„åŸºç¡€æ¡†æ¶ã€‚</p>
</blockquote>
<h2 id="é”ç±»å‹"><a href="#é”ç±»å‹" class="headerlink" title="é”ç±»å‹"></a>é”ç±»å‹</h2><p>ReentrantLock åˆ†ä¸º<strong>å…¬å¹³é”</strong>å’Œ<strong>éå…¬å¹³é”</strong>ï¼Œå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•æ¥æŒ‡å®šå…·ä½“ç±»å‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//é»˜è®¤éå…¬å¹³é”</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</div><div class="line">    sync = <span class="keyword">new</span> NonfairSync();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å…¬å¹³é”</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</div><div class="line">    sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é»˜è®¤ä¸€èˆ¬ä½¿ç”¨<strong>éå…¬å¹³é”</strong>ï¼Œå®ƒçš„æ•ˆç‡å’Œååé‡éƒ½æ¯”å…¬å¹³é”é«˜çš„å¤š(åé¢ä¼šåˆ†æå…·ä½“åŸå› )ã€‚</p>
<a id="more"></a>
<h2 id="è·å–é”"><a href="#è·å–é”" class="headerlink" title="è·å–é”"></a>è·å–é”</h2><p>é€šå¸¸çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    lock.lock();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//do bussiness</span></div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        lock.unlock();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å…¬å¹³é”è·å–é”"><a href="#å…¬å¹³é”è·å–é”" class="headerlink" title="å…¬å¹³é”è·å–é”"></a>å…¬å¹³é”è·å–é”</h3><p>é¦–å…ˆçœ‹ä¸‹è·å–é”çš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">    sync.lock();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ˜¯ä½¿ç”¨ <code>sync</code>çš„æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“æ˜¯ç”±å…¶å­ç±»(<code>FairSync</code>)æ¥å®ç°çš„ï¼Œä»¥ä¸‹æ˜¯å…¬å¹³é”çš„å®ç°:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">       acquire(<span class="number">1</span>);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="comment">//AbstractQueuedSynchronizer ä¸­çš„ acquire()</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</div><div class="line">       acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</div><div class="line">       selfInterrupt();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸€æ­¥æ˜¯å°è¯•è·å–é”(<code>tryAcquire(arg)</code>),è¿™ä¸ªä¹Ÿæ˜¯ç”±å…¶å­ç±»å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</div><div class="line">        <span class="keyword">int</span> c = getState();</div><div class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</div><div class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</div><div class="line">                setExclusiveOwnerThread(current);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</div><div class="line">            <span class="keyword">int</span> nextc = c + acquires;</div><div class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">            setState(nextc);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆä¼šåˆ¤æ–­ <code>AQS</code> ä¸­çš„ <code>state</code> æ˜¯å¦ç­‰äº 0ï¼Œ0 è¡¨ç¤ºç›®å‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹è·å¾—é”ï¼Œå½“å‰çº¿ç¨‹å°±å¯ä»¥å°è¯•è·å–é”ã€‚</p>
<p><strong>æ³¨æ„</strong>:å°è¯•ä¹‹å‰ä¼šåˆ©ç”¨ <code>hasQueuedPredecessors()</code> æ–¹æ³•æ¥åˆ¤æ–­ AQS çš„é˜Ÿåˆ—ä¸­ä¸­æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹ï¼Œå¦‚æœæœ‰åˆ™ä¸ä¼šå°è¯•è·å–é”(<strong>è¿™æ˜¯å…¬å¹³é”ç‰¹æœ‰çš„æƒ…å†µ</strong>)ã€‚</p>
<p>å¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰çº¿ç¨‹å°±åˆ©ç”¨ CAS æ¥å°† AQS ä¸­çš„ state ä¿®æ”¹ä¸º1ï¼Œä¹Ÿå°±æ˜¯è·å–é”ï¼Œè·å–æˆåŠŸåˆ™å°†å½“å‰çº¿ç¨‹ç½®ä¸ºè·å¾—é”çš„ç‹¬å çº¿ç¨‹(<code>setExclusiveOwnerThread(current)</code>)ã€‚</p>
<p>å¦‚æœ <code>state</code> å¤§äº 0 æ—¶ï¼Œè¯´æ˜é”å·²ç»è¢«è·å–äº†ï¼Œåˆ™éœ€è¦åˆ¤æ–­è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹(<code>ReentrantLock</code> æ”¯æŒé‡å…¥)ï¼Œæ˜¯åˆ™éœ€è¦å°† <code>state + 1</code>ï¼Œå¹¶å°†å€¼æ›´æ–°ã€‚</p>
<h4 id="å†™å…¥é˜Ÿåˆ—"><a href="#å†™å…¥é˜Ÿåˆ—" class="headerlink" title="å†™å…¥é˜Ÿåˆ—"></a>å†™å…¥é˜Ÿåˆ—</h4><p>å¦‚æœ <code>tryAcquire(arg)</code> è·å–é”å¤±è´¥ï¼Œåˆ™éœ€è¦ç”¨ <code>addWaiter(Node.EXCLUSIVE)</code> å°†å½“å‰çº¿ç¨‹å†™å…¥é˜Ÿåˆ—ä¸­ã€‚</p>
<p>å†™å…¥ä¹‹å‰éœ€è¦å°†å½“å‰çº¿ç¨‹åŒ…è£…ä¸ºä¸€ä¸ª <code>Node</code> å¯¹è±¡(<code>addWaiter(Node.EXCLUSIVE)</code>)ã€‚</p>
<blockquote>
<p>AQS ä¸­çš„é˜Ÿåˆ—æ˜¯ç”± Node èŠ‚ç‚¹ç»„æˆçš„åŒå‘é“¾è¡¨å®ç°çš„ã€‚</p>
</blockquote>
<p>åŒ…è£…ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</div><div class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</div><div class="line">    <span class="comment">// Try the fast path of enq; backup to full enq on failure</span></div><div class="line">    Node pred = tail;</div><div class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</div><div class="line">        node.prev = pred;</div><div class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</div><div class="line">            pred.next = node;</div><div class="line">            <span class="keyword">return</span> node;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    enq(node);</div><div class="line">    <span class="keyword">return</span> node;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºæ—¶åˆ™å°†å°è£…å¥½çš„ <code>Node</code> åˆ©ç”¨ <code>CAS</code> å†™å…¥é˜Ÿå°¾ï¼Œå¦‚æœå‡ºç°å¹¶å‘å†™å…¥å¤±è´¥å°±éœ€è¦è°ƒç”¨ <code>enq(node);</code> æ¥å†™å…¥äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        Node t = tail;</div><div class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></div><div class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</div><div class="line">                tail = head;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            node.prev = t;</div><div class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</div><div class="line">                t.next = node;</div><div class="line">                <span class="keyword">return</span> t;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªå¤„ç†é€»è¾‘å°±ç›¸å½“äº<code>è‡ªæ—‹</code>åŠ ä¸Š <code>CAS</code> ä¿è¯ä¸€å®šèƒ½å†™å…¥é˜Ÿåˆ—ã€‚</p>
<h4 id="æŒ‚èµ·ç­‰å¾…çº¿ç¨‹"><a href="#æŒ‚èµ·ç­‰å¾…çº¿ç¨‹" class="headerlink" title="æŒ‚èµ·ç­‰å¾…çº¿ç¨‹"></a>æŒ‚èµ·ç­‰å¾…çº¿ç¨‹</h4><p>å†™å…¥é˜Ÿåˆ—ä¹‹åéœ€è¦å°†å½“å‰çº¿ç¨‹æŒ‚èµ·(åˆ©ç”¨<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code>)ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">final</span> Node p = node.predecessor();</div><div class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</div><div class="line">                setHead(node);</div><div class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></div><div class="line">                failed = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">return</span> interrupted;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</div><div class="line">                parkAndCheckInterrupt())</div><div class="line">                interrupted = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (failed)</div><div class="line">            cancelAcquire(node);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆä¼šæ ¹æ® <code>node.predecessor()</code> è·å–åˆ°ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™å°è¯•è·å–ä¸€æ¬¡é”ï¼Œè·å–æˆåŠŸå°±ä¸‡äº‹å¤§å‰äº†ã€‚</p>
<p>å¦‚æœä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæˆ–è€…è·å–é”å¤±è´¥ï¼Œåˆ™ä¼šæ ¹æ®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„ <code>waitStatus</code> çŠ¶æ€æ¥å¤„ç†(<code>shouldParkAfterFailedAcquire(p, node)</code>)ã€‚</p>
<p><code>waitStatus</code> ç”¨äºè®°å½•å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¦‚èŠ‚ç‚¹å–æ¶ˆã€èŠ‚ç‚¹ç­‰å¾…ç­‰ã€‚</p>
<p><code>shouldParkAfterFailedAcquire(p, node)</code> è¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦æŒ‚èµ·ï¼Œå¦‚æœéœ€è¦åˆ™è°ƒç”¨ <code>parkAndCheckInterrupt()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</div><div class="line">    LockSupport.park(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> Thread.interrupted();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»–æ˜¯åˆ©ç”¨ <code>LockSupport</code> çš„ <code>part</code> æ–¹æ³•æ¥æŒ‚èµ·å½“å‰çº¿ç¨‹çš„ï¼Œç›´åˆ°è¢«å”¤é†’ã€‚</p>
<h3 id="éå…¬å¹³é”è·å–é”"><a href="#éå…¬å¹³é”è·å–é”" class="headerlink" title="éå…¬å¹³é”è·å–é”"></a>éå…¬å¹³é”è·å–é”</h3><p>å…¬å¹³é”ä¸éå…¬å¹³é”çš„å·®å¼‚ä¸»è¦åœ¨è·å–é”ï¼š</p>
<p>å…¬å¹³é”å°±ç›¸å½“äºä¹°ç¥¨ï¼Œåæ¥çš„äººéœ€è¦æ’åˆ°é˜Ÿå°¾ä¾æ¬¡ä¹°ç¥¨ï¼Œ<strong>ä¸èƒ½æ’é˜Ÿ</strong>ã€‚</p>
<p>è€Œéå…¬å¹³é”åˆ™æ²¡æœ‰è¿™äº›è§„åˆ™ï¼Œæ˜¯<strong>æŠ¢å æ¨¡å¼</strong>ï¼Œæ¯æ¥ä¸€ä¸ªäººä¸ä¼šå»ç®¡é˜Ÿåˆ—å¦‚ä½•ï¼Œç›´æ¥å°è¯•è·å–é”ã€‚</p>
<p>éå…¬å¹³é”:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//ç›´æ¥å°è¯•è·å–é”</span></div><div class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</div><div class="line">        setExclusiveOwnerThread(Thread.currentThread());</div><div class="line">    <span class="keyword">else</span></div><div class="line">        acquire(<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…¬å¹³é”:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">    acquire(<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿˜è¦ä¸€ä¸ªé‡è¦çš„åŒºåˆ«æ˜¯åœ¨å°è¯•è·å–é”æ—¶<code>tryAcquire(arg)</code>ï¼Œéå…¬å¹³é”æ˜¯ä¸éœ€è¦åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰å…¶ä»–çº¿ç¨‹ï¼Œä¹Ÿæ˜¯ç›´æ¥å°è¯•è·å–é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</div><div class="line">    <span class="keyword">int</span> c = getState();</div><div class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//æ²¡æœ‰ !hasQueuedPredecessors() åˆ¤æ–­</span></div><div class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</div><div class="line">            setExclusiveOwnerThread(current);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</div><div class="line">        <span class="keyword">int</span> nextc = c + acquires;</div><div class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">        setState(nextc);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="é‡Šæ”¾é”"><a href="#é‡Šæ”¾é”" class="headerlink" title="é‡Šæ”¾é”"></a>é‡Šæ”¾é”</h2><p>å…¬å¹³é”å’Œéå…¬å¹³é”çš„é‡Šæ”¾æµç¨‹éƒ½æ˜¯ä¸€æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</div><div class="line">    sync.release(<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</div><div class="line">        Node h = head;</div><div class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</div><div class="line">        	   <span class="comment">//å”¤é†’è¢«æŒ‚èµ·çš„çº¿ç¨‹</span></div><div class="line">            unparkSuccessor(h);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å°è¯•é‡Šæ”¾é”</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> c = getState() - releases;</div><div class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</div><div class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">        free = <span class="keyword">true</span>;</div><div class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    setState(c);</div><div class="line">    <span class="keyword">return</span> free;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆä¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºè·å¾—é”çš„çº¿ç¨‹ï¼Œç”±äºæ˜¯é‡å…¥é”æ‰€ä»¥éœ€è¦å°† <code>state</code> å‡åˆ° 0 æ‰è®¤ä¸ºå®Œå…¨é‡Šæ”¾é”ã€‚</p>
<p>é‡Šæ”¾ä¹‹åéœ€è¦è°ƒç”¨ <code>unparkSuccessor(h)</code> æ¥å”¤é†’è¢«æŒ‚èµ·çš„çº¿ç¨‹ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç”±äºå…¬å¹³é”éœ€è¦å…³å¿ƒé˜Ÿåˆ—çš„æƒ…å†µï¼Œå¾—æŒ‰ç…§é˜Ÿåˆ—é‡Œçš„å…ˆåé¡ºåºæ¥è·å–é”(ä¼šé€ æˆå¤§é‡çš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢)ï¼Œè€Œéå…¬å¹³é”åˆ™æ²¡æœ‰è¿™ä¸ªé™åˆ¶ã€‚</p>
<p>æ‰€ä»¥ä¹Ÿå°±èƒ½è§£é‡Šéå…¬å¹³é”çš„æ•ˆç‡ä¼šè¢«å…¬å¹³é”æ›´é«˜ã€‚</p>
<h2 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h2><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws1.sinaimg.cn/large/006tKfTcly1fnt9p6qc88j31g80yu41d.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨ &lt;code&gt;synchronize&lt;/code&gt; æ¥åšåŒæ­¥å¤„ç†æ—¶ï¼Œé”çš„è·å–å’Œé‡Šæ”¾éƒ½æ˜¯éšå¼çš„ï¼Œå®ç°çš„åŸç†æ˜¯é€šè¿‡ç¼–è¯‘ååŠ ä¸Šä¸åŒçš„æœºå™¨æŒ‡ä»¤æ¥å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;è€Œ &lt;code&gt;ReentrantLock&lt;/code&gt; å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ï¼Œå®ƒæ˜¯åŸºäº &lt;code&gt;AQS(AbstractQueuedSynchronizer)&lt;/code&gt;æ¥å®ç°çš„ã€‚&lt;/p&gt;
&lt;p&gt;æ˜¯ä¸€ä¸ª&lt;strong&gt;é‡å…¥é”&lt;/strong&gt;ï¼šä¸€ä¸ªçº¿ç¨‹è·å¾—äº†é”ä¹‹åä»ç„¶å¯ä»¥&lt;strong&gt;åå¤&lt;/strong&gt;çš„åŠ é”ï¼Œä¸ä¼šå‡ºç°è‡ªå·±é˜»å¡è‡ªå·±çš„æƒ…å†µã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;AQS&lt;/code&gt; æ˜¯ &lt;code&gt;Java&lt;/code&gt; å¹¶å‘åŒ…é‡Œå®ç°é”ã€åŒæ­¥çš„ä¸€ä¸ªé‡è¦çš„åŸºç¡€æ¡†æ¶ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;é”ç±»å‹&quot;&gt;&lt;a href=&quot;#é”ç±»å‹&quot; class=&quot;headerlink&quot; title=&quot;é”ç±»å‹&quot;&gt;&lt;/a&gt;é”ç±»å‹&lt;/h2&gt;&lt;p&gt;ReentrantLock åˆ†ä¸º&lt;strong&gt;å…¬å¹³é”&lt;/strong&gt;å’Œ&lt;strong&gt;éå…¬å¹³é”&lt;/strong&gt;ï¼Œå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•æ¥æŒ‡å®šå…·ä½“ç±»å‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//é»˜è®¤éå…¬å¹³é”&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ReentrantLock&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sync = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; NonfairSync();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//å…¬å¹³é”&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ReentrantLock&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; fair)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    sync = fair ? &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; FairSync() : &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; NonfairSync();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;é»˜è®¤ä¸€èˆ¬ä½¿ç”¨&lt;strong&gt;éå…¬å¹³é”&lt;/strong&gt;ï¼Œå®ƒçš„æ•ˆç‡å’Œååé‡éƒ½æ¯”å…¬å¹³é”é«˜çš„å¤š(åé¢ä¼šåˆ†æå…·ä½“åŸå› )ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Java è¿›é˜¶" scheme="http://crossoverjie.top/categories/Java-%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Java" scheme="http://crossoverjie.top/tags/Java/"/>
    
      <category term="ReentrantLock" scheme="http://crossoverjie.top/tags/ReentrantLock/"/>
    
  </entry>
  
  <entry>
    <title>å¯¹è±¡çš„åˆ›å»ºä¸å†…å­˜åˆ†é…</title>
    <link href="http://crossoverjie.top/2018/01/18/newObject/"/>
    <id>http://crossoverjie.top/2018/01/18/newObject/</id>
    <published>2018-01-17T18:01:36.000Z</published>
    <updated>2018-01-19T16:43:13.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fnkuy01igij31g80tetfy.jpg" alt=""></p>
<h2 id="åˆ›å»ºå¯¹è±¡"><a href="#åˆ›å»ºå¯¹è±¡" class="headerlink" title="åˆ›å»ºå¯¹è±¡"></a>åˆ›å»ºå¯¹è±¡</h2><p>å½“ <code>JVM</code> æ”¶åˆ°ä¸€ä¸ª <code>new</code> æŒ‡ä»¤æ—¶ï¼Œä¼šæ£€æŸ¥æŒ‡ä»¤ä¸­çš„å‚æ•°åœ¨å¸¸é‡æ± æ˜¯å¦æœ‰è¿™ä¸ªç¬¦å·çš„å¼•ç”¨ï¼Œè¿˜ä¼šæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»è¢«<a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/ClassLoad.md" target="_blank" rel="external">åŠ è½½</a>è¿‡äº†ï¼Œå¦‚æœæ²¡æœ‰çš„è¯åˆ™è¦è¿›è¡Œä¸€æ¬¡ç±»åŠ è½½ã€‚</p>
<p>æ¥ç€å°±æ˜¯åˆ†é…å†…å­˜äº†ï¼Œé€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>æŒ‡é’ˆç¢°æ’</li>
<li>ç©ºé—²åˆ—è¡¨</li>
</ul>
<p>ä½¿ç”¨æŒ‡é’ˆç¢°æ’çš„å‰ææ˜¯å †å†…å­˜æ˜¯<strong>å®Œå…¨å·¥æ•´</strong>çš„ï¼Œç”¨è¿‡çš„å†…å­˜å’Œæ²¡ç”¨çš„å†…å­˜å„åœ¨ä¸€è¾¹æ¯æ¬¡åˆ†é…çš„æ—¶å€™åªéœ€è¦å°†æŒ‡é’ˆå‘ç©ºé—²å†…å­˜ä¸€æ–¹ç§»åŠ¨ä¸€æ®µå’Œå†…å­˜å¤§å°ç›¸ç­‰åŒºåŸŸå³å¯ã€‚</p>
<p>å½“å †ä¸­å·²ç»ä½¿ç”¨çš„å†…å­˜å’Œæœªä½¿ç”¨çš„å†…å­˜<strong>äº’ç›¸äº¤é”™</strong>æ—¶ï¼ŒæŒ‡é’ˆç¢°æ’çš„æ–¹å¼å°±è¡Œä¸é€šäº†ï¼Œè¿™æ—¶å°±éœ€è¦é‡‡ç”¨ç©ºé—²åˆ—è¡¨çš„æ–¹å¼ã€‚è™šæ‹Ÿæœºä¼šç»´æŠ¤ä¸€ä¸ªç©ºé—²çš„åˆ—è¡¨ï¼Œç”¨äºè®°å½•å“ªäº›å†…å­˜æ˜¯å¯ä»¥è¿›è¡Œåˆ†é…çš„ï¼Œåˆ†é…æ—¶ç›´æ¥ä»å¯ç”¨å†…å­˜ä¸­ç›´æ¥åˆ†é…å³å¯ã€‚</p>
<p>å †ä¸­çš„å†…å­˜æ˜¯å¦å·¥æ•´æ˜¯æœ‰<strong>åƒåœ¾æ”¶é›†å™¨</strong>æ¥å†³å®šçš„ï¼Œå¦‚æœå¸¦æœ‰å‹ç¼©åŠŸèƒ½çš„åƒåœ¾æ”¶é›†å™¨å°±æ˜¯é‡‡ç”¨æŒ‡é’ˆç¢°æ’çš„æ–¹å¼æ¥è¿›è¡Œå†…å­˜åˆ†é…çš„ã€‚</p>
<a id="more"></a>
<p>åˆ†é…å†…å­˜æ—¶ä¹Ÿä¼šå‡ºç°å¹¶å‘é—®é¢˜:</p>
<p>è¿™æ ·å¯ä»¥åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ä½¿ç”¨ <code>CAS</code> è¿™æ ·çš„ä¹è§‚é”æ¥ä¿è¯ã€‚</p>
<p>ä¹Ÿå¯ä»¥å°†å†…å­˜åˆ†é…å®‰æ’åœ¨æ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰çš„ç©ºé—´è¿›è¡Œï¼Œæ¯ä¸ªçº¿ç¨‹é¦–å…ˆåœ¨å †å†…å­˜ä¸­åˆ†é…ä¸€å°å—å†…å­˜ï¼Œç§°ä¸ºæœ¬åœ°åˆ†é…ç¼“å­˜(<code>TLAB : Thread Local Allocation Buffer</code>)ã€‚</p>
<p>åˆ†é…å†…å­˜æ—¶ï¼Œåªéœ€è¦åœ¨è‡ªå·±çš„åˆ†é…ç¼“å­˜ä¸­åˆ†é…å³å¯ï¼Œç”±äºè¿™ä¸ªå†…å­˜åŒºåŸŸæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ <code>-XX:+/-UseTLAB</code> å‚æ•°æ¥è®¾å®š JVM æ˜¯å¦å¼€å¯ <code>TLAB</code> ã€‚</p>
<p>å†…å­˜åˆ†é…ä¹‹åéœ€è¦å¯¹è¯¥å¯¹è±¡è¿›è¡Œè®¾ç½®ï¼Œå¦‚å¯¹è±¡å¤´ã€‚å¯¹è±¡å¤´çš„ä¸€äº›åº”ç”¨å¯ä»¥æŸ¥çœ‹ <a href="https://github.com/crossoverJie/Java-Interview/blob/master/MD/Synchronize.md" target="_blank" rel="external">Synchronize å…³é”®å­—åŸç†</a>ã€‚</p>
<h3 id="å¯¹è±¡è®¿é—®"><a href="#å¯¹è±¡è®¿é—®" class="headerlink" title="å¯¹è±¡è®¿é—®"></a>å¯¹è±¡è®¿é—®</h3><p>ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºä¹‹åè‡ªç„¶æ˜¯ä¸ºäº†ä½¿ç”¨ï¼Œåœ¨ Java ä¸­æ˜¯é€šè¿‡æ ˆæ¥å¼•ç”¨å †å†…å­˜ä¸­çš„å¯¹è±¡æ¥è¿›è¡Œæ“ä½œçš„ã€‚</p>
<p>å¯¹äºæˆ‘ä»¬å¸¸ç”¨çš„ <code>HotSpot</code> è™šæ‹Ÿæœºæ¥è¯´ï¼Œè¿™æ ·å¼•ç”¨å…³ç³»æ˜¯é€šè¿‡ç›´æ¥æŒ‡é’ˆæ¥å…³è”çš„ã€‚</p>
<p>å¦‚å›¾:</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fnkmy0bvu3j30o60heaaq.jpg" alt=""></p>
<p>è¿™æ ·çš„å¥½å¤„å°±æ˜¯ï¼šåœ¨ Java é‡Œè¿›è¡Œé¢‘ç¹çš„å¯¹è±¡è®¿é—®å¯ä»¥æå‡è®¿é—®é€Ÿåº¦(ç›¸å¯¹äºä½¿ç”¨å¥æŸ„æ± æ¥è¯´)ã€‚</p>
<h2 id="å†…å­˜åˆ†é…"><a href="#å†…å­˜åˆ†é…" class="headerlink" title="å†…å­˜åˆ†é…"></a>å†…å­˜åˆ†é…</h2><h3 id="Eden-åŒºåˆ†é…"><a href="#Eden-åŒºåˆ†é…" class="headerlink" title="Eden åŒºåˆ†é…"></a>Eden åŒºåˆ†é…</h3><p>ç®€å•çš„æ¥è¯´å¯¹è±¡éƒ½æ˜¯åœ¨å †å†…å­˜ä¸­åˆ†é…çš„ï¼Œå¾€ç»†ä¸€ç‚¹çœ‹åˆ™æ˜¯ä¼˜å…ˆåœ¨ <code>Eden</code> åŒºåˆ†é…ã€‚</p>
<p>è¿™é‡Œå°±æ¶‰åŠåˆ°å †å†…å­˜çš„åˆ’åˆ†äº†ï¼Œä¸ºäº†æ–¹ä¾¿åƒåœ¾å›æ”¶ï¼ŒJVM å°†å¯¹å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚</p>
<p>è€Œæ–°ç”Ÿä»£ä¸­åˆä¼šåˆ’åˆ†ä¸º <code>Eden</code> åŒºï¼Œ<code>from Survivorã€to Survivor</code> åŒºã€‚</p>
<p>å…¶ä¸­ <code>Eden</code> å’Œ <code>Survivor</code> åŒºçš„æ¯”ä¾‹é»˜è®¤æ˜¯ <code>8:1:1</code>ï¼Œå½“ç„¶ä¹Ÿæ”¯æŒå‚æ•°è°ƒæ•´ <code>-XX:SurvivorRatio=8</code>ã€‚</p>
<p>å½“åœ¨ <code>Eden</code> åŒºåˆ†é…å†…å­˜ä¸è¶³æ—¶ï¼Œåˆ™ä¼šå‘ç”Ÿ <code>minorGC</code> ï¼Œç”±äº <code>Java</code> å¯¹è±¡å¤šæ•°æ˜¯<strong>æœç”Ÿå¤•ç­</strong>çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ <code>minorGC</code> é€šå¸¸ä¼šæ¯”è¾ƒé¢‘ç¹ï¼Œæ•ˆç‡ä¹Ÿæ¯”è¾ƒé«˜ã€‚</p>
<p>å½“å‘ç”Ÿ <code>minorGC</code> æ—¶ï¼ŒJVM ä¼šæ ¹æ®<a href="https://github.com/crossoverJie/Java-Interview/blob/145064ecf867e898ad025f3467b7ada9086fc8dd/MD/GarbageCollection.md#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AE%97%E6%B3%95" target="_blank" rel="external">å¤åˆ¶ç®—æ³•</a>å°†å­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ°å¦ä¸€ä¸ªæœªä½¿ç”¨çš„ <code>Survivor</code> åŒºï¼Œå¦‚æœ <code>Survivor</code> åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œåˆ™ä¼šä½¿ç”¨åˆ†é…æ‹…ä¿ç­–ç•¥å°†å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚</p>
<p>è°ˆåˆ° <code>minorGC</code> æ—¶ï¼Œå°±ä¸å¾—ä¸æåˆ° <code>fullGC(majorGC)</code> ï¼Œè¿™æ˜¯æŒ‡å‘ç”Ÿåœ¨è€å¹´ä»£çš„ <code>GC</code> ï¼Œä¸è®ºæ˜¯æ•ˆç‡è¿˜æ˜¯é€Ÿåº¦éƒ½æ¯” <code>minorGC</code> æ…¢çš„å¤šï¼Œå›æ”¶æ—¶è¿˜ä¼šå‘ç”Ÿ <code>stop the world</code> ä½¿ç¨‹åºå‘ç”Ÿåœé¡¿ï¼Œæ‰€ä»¥åº”å½“å°½é‡é¿å…å‘ç”Ÿ <code>fullGC</code> ã€‚</p>
<h3 id="è€å¹´ä»£åˆ†é…"><a href="#è€å¹´ä»£åˆ†é…" class="headerlink" title="è€å¹´ä»£åˆ†é…"></a>è€å¹´ä»£åˆ†é…</h3><p>ä¹Ÿæœ‰ä¸€äº›æƒ…å†µä¼šå¯¼è‡´å¯¹è±¡ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…ï¼Œæ¯”å¦‚å½“åˆ†é…ä¸€ä¸ªå¤§å¯¹è±¡æ—¶(å¤§çš„æ•°ç»„ï¼Œå¾ˆé•¿çš„å­—ç¬¦ä¸²)ï¼Œç”±äº <code>Eden</code> åŒºæ²¡æœ‰è¶³å¤Ÿå¤§çš„è¿ç»­ç©ºé—´æ¥åˆ†é…æ—¶ï¼Œä¼šå¯¼è‡´æå‰è§¦å‘ä¸€æ¬¡ <code>GC</code>ï¼Œæ‰€ä»¥å°½é‡åˆ«é¢‘ç¹çš„åˆ›å»ºå¤§å¯¹è±¡ã€‚</p>
<p>å› æ­¤ <code>JVM</code> ä¼šæ ¹æ®ä¸€ä¸ªé˜ˆå€¼æ¥åˆ¤æ–­å¤§äºè¯¥é˜ˆå€¼å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ï¼Œè¿™æ ·å¯ä»¥é¿å…åœ¨æ–°ç”Ÿä»£é¢‘ç¹çš„å‘ç”Ÿ <code>GC</code>ã€‚</p>
<p>å¯¹äºä¸€äº›åœ¨æ–°ç”Ÿä»£çš„è€å¯¹è±¡ <code>JVM</code> ä¹Ÿä¼šæ ¹æ®æŸç§æœºåˆ¶ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚</p>
<p>JVM æ˜¯æ ¹æ®è®°å½•å¯¹è±¡å¹´é¾„çš„æ–¹å¼æ¥åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦åº”è¯¥ç§»åŠ¨åˆ°è€å¹´ä»£ï¼Œæ ¹æ®æ–°ç”Ÿä»£çš„å¤åˆ¶ç®—æ³•ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«ç§»åŠ¨åˆ° <code>Survivor</code> åŒºä¹‹å JVM å°±ç»™è¯¥å¯¹è±¡çš„å¹´é¾„è®°ä¸º1ï¼Œæ¯å½“ç†¬è¿‡ä¸€æ¬¡ <code>minorGC</code> åå¯¹è±¡çš„å¹´é¾„å°± +1 ï¼Œç›´åˆ°è¾¾åˆ°é˜ˆå€¼(é»˜è®¤ä¸º15)å°±ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚</p>
<blockquote>
<p>å¯ä»¥ä½¿ç”¨ <code>-XX:MaxTenuringThreshold=15</code> æ¥é…ç½®è¿™ä¸ªé˜ˆå€¼ã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è™½è¯´è¿™äº›å†…å®¹ç•¥æ˜¾æ¯ç‡¥ï¼Œä½†å½“åº”ç”¨å‘ç”Ÿä¸æ­£å¸¸çš„ <code>GC</code> æ—¶ï¼Œå¯ä»¥æ–¹ä¾¿æ›´å¿«çš„å®šä½é—®é¢˜ã€‚</p>
<h2 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h2><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tKfTcly1fnkuy01igij31g80tetfy.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;åˆ›å»ºå¯¹è±¡&quot;&gt;&lt;a href=&quot;#åˆ›å»ºå¯¹è±¡&quot; class=&quot;headerlink&quot; title=&quot;åˆ›å»ºå¯¹è±¡&quot;&gt;&lt;/a&gt;åˆ›å»ºå¯¹è±¡&lt;/h2&gt;&lt;p&gt;å½“ &lt;code&gt;JVM&lt;/code&gt; æ”¶åˆ°ä¸€ä¸ª &lt;code&gt;new&lt;/code&gt; æŒ‡ä»¤æ—¶ï¼Œä¼šæ£€æŸ¥æŒ‡ä»¤ä¸­çš„å‚æ•°åœ¨å¸¸é‡æ± æ˜¯å¦æœ‰è¿™ä¸ªç¬¦å·çš„å¼•ç”¨ï¼Œè¿˜ä¼šæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»è¢«&lt;a href=&quot;https://github.com/crossoverJie/Java-Interview/blob/master/MD/ClassLoad.md&quot;&gt;åŠ è½½&lt;/a&gt;è¿‡äº†ï¼Œå¦‚æœæ²¡æœ‰çš„è¯åˆ™è¦è¿›è¡Œä¸€æ¬¡ç±»åŠ è½½ã€‚&lt;/p&gt;
&lt;p&gt;æ¥ç€å°±æ˜¯åˆ†é…å†…å­˜äº†ï¼Œé€šå¸¸æœ‰ä¸¤ç§æ–¹å¼ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŒ‡é’ˆç¢°æ’&lt;/li&gt;
&lt;li&gt;ç©ºé—²åˆ—è¡¨&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä½¿ç”¨æŒ‡é’ˆç¢°æ’çš„å‰ææ˜¯å †å†…å­˜æ˜¯&lt;strong&gt;å®Œå…¨å·¥æ•´&lt;/strong&gt;çš„ï¼Œç”¨è¿‡çš„å†…å­˜å’Œæ²¡ç”¨çš„å†…å­˜å„åœ¨ä¸€è¾¹æ¯æ¬¡åˆ†é…çš„æ—¶å€™åªéœ€è¦å°†æŒ‡é’ˆå‘ç©ºé—²å†…å­˜ä¸€æ–¹ç§»åŠ¨ä¸€æ®µå’Œå†…å­˜å¤§å°ç›¸ç­‰åŒºåŸŸå³å¯ã€‚&lt;/p&gt;
&lt;p&gt;å½“å †ä¸­å·²ç»ä½¿ç”¨çš„å†…å­˜å’Œæœªä½¿ç”¨çš„å†…å­˜&lt;strong&gt;äº’ç›¸äº¤é”™&lt;/strong&gt;æ—¶ï¼ŒæŒ‡é’ˆç¢°æ’çš„æ–¹å¼å°±è¡Œä¸é€šäº†ï¼Œè¿™æ—¶å°±éœ€è¦é‡‡ç”¨ç©ºé—²åˆ—è¡¨çš„æ–¹å¼ã€‚è™šæ‹Ÿæœºä¼šç»´æŠ¤ä¸€ä¸ªç©ºé—²çš„åˆ—è¡¨ï¼Œç”¨äºè®°å½•å“ªäº›å†…å­˜æ˜¯å¯ä»¥è¿›è¡Œåˆ†é…çš„ï¼Œåˆ†é…æ—¶ç›´æ¥ä»å¯ç”¨å†…å­˜ä¸­ç›´æ¥åˆ†é…å³å¯ã€‚&lt;/p&gt;
&lt;p&gt;å †ä¸­çš„å†…å­˜æ˜¯å¦å·¥æ•´æ˜¯æœ‰&lt;strong&gt;åƒåœ¾æ”¶é›†å™¨&lt;/strong&gt;æ¥å†³å®šçš„ï¼Œå¦‚æœå¸¦æœ‰å‹ç¼©åŠŸèƒ½çš„åƒåœ¾æ”¶é›†å™¨å°±æ˜¯é‡‡ç”¨æŒ‡é’ˆç¢°æ’çš„æ–¹å¼æ¥è¿›è¡Œå†…å­˜åˆ†é…çš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Java è¿›é˜¶" scheme="http://crossoverjie.top/categories/Java-%E8%BF%9B%E9%98%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>Synchronize å…³é”®å­—åŸç†</title>
    <link href="http://crossoverjie.top/2018/01/14/Synchronize/"/>
    <id>http://crossoverjie.top/2018/01/14/Synchronize/</id>
    <published>2018-01-14T14:13:22.000Z</published>
    <updated>2018-04-28T13:39:12.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fngjnyotvcj30z00jpn0d.jpg" alt=""></p>
<p>ä¼—æ‰€å‘¨çŸ¥ <code>Synchronize</code> å…³é”®å­—æ˜¯è§£å†³å¹¶å‘é—®é¢˜å¸¸ç”¨è§£å†³æ–¹æ¡ˆï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§ä½¿ç”¨æ–¹å¼:</p>
<ul>
<li>åŒæ­¥æ™®é€šæ–¹æ³•ï¼Œé”çš„æ˜¯å½“å‰å¯¹è±¡ã€‚</li>
<li>åŒæ­¥é™æ€æ–¹æ³•ï¼Œé”çš„æ˜¯å½“å‰ <code>Class</code> å¯¹è±¡ã€‚</li>
<li>åŒæ­¥å—ï¼Œé”çš„æ˜¯ <code>{}</code> ä¸­çš„å¯¹è±¡ã€‚</li>
</ul>
<p>å®ç°åŸç†ï¼š<br><code>JVM</code> æ˜¯é€šè¿‡è¿›å…¥ã€é€€å‡ºå¯¹è±¡ç›‘è§†å™¨( <code>Monitor</code> )æ¥å®ç°å¯¹æ–¹æ³•ã€åŒæ­¥å—çš„åŒæ­¥çš„ã€‚</p>
<p>å…·ä½“å®ç°æ˜¯åœ¨ç¼–è¯‘ä¹‹ååœ¨åŒæ­¥æ–¹æ³•è°ƒç”¨å‰åŠ å…¥ä¸€ä¸ª <code>monitor.enter</code> æŒ‡ä»¤ï¼Œåœ¨é€€å‡ºæ–¹æ³•å’Œå¼‚å¸¸å¤„æ’å…¥ <code>monitor.exit</code> çš„æŒ‡ä»¤ã€‚</p>
<p>å…¶æœ¬è´¨å°±æ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡ç›‘è§†å™¨( <code>Monitor</code> )è¿›è¡Œè·å–ï¼Œè€Œè¿™ä¸ªè·å–è¿‡ç¨‹å…·æœ‰æ’ä»–æ€§ä»è€Œè¾¾åˆ°äº†åŒä¸€æ—¶åˆ»åªèƒ½ä¸€ä¸ªçº¿ç¨‹è®¿é—®çš„ç›®çš„ã€‚</p>
<p>è€Œå¯¹äºæ²¡æœ‰è·å–åˆ°é”çš„çº¿ç¨‹å°†ä¼šé˜»å¡åˆ°æ–¹æ³•å…¥å£å¤„ï¼Œç›´åˆ°è·å–é”çš„çº¿ç¨‹ <code>monitor.exit</code> ä¹‹åæ‰èƒ½å°è¯•ç»§ç»­è·å–é”ã€‚</p>
<p>æµç¨‹å›¾å¦‚ä¸‹:</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fn27fkl07jj31e80hyn0n.jpg" alt=""></p>
<a id="more"></a>
<p>é€šè¿‡ä¸€æ®µä»£ç æ¥æ¼”ç¤º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (Synchronize.class)&#123;</div><div class="line">        System.out.println(<span class="string">"Synchronize"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <code>javap -c Synchronize</code> å¯ä»¥æŸ¥çœ‹ç¼–è¯‘ä¹‹åçš„å…·ä½“ä¿¡æ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class com.crossoverjie.synchronize.Synchronize &#123;</div><div class="line">  public com.crossoverjie.synchronize.Synchronize();</div><div class="line">    Code:</div><div class="line">       0: aload_0</div><div class="line">       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</div><div class="line">       4: return</div><div class="line"></div><div class="line">  public static void main(java.lang.String[]);</div><div class="line">    Code:</div><div class="line">       0: ldc           #2                  // class com/crossoverjie/synchronize/Synchronize</div><div class="line">       2: dup</div><div class="line">       3: astore_1</div><div class="line">       **4: monitorenter**</div><div class="line">       5: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;</div><div class="line">       8: ldc           #4                  // String Synchronize</div><div class="line">      10: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</div><div class="line">      13: aload_1</div><div class="line">      **14: monitorexit**</div><div class="line">      15: goto          23</div><div class="line">      18: astore_2</div><div class="line">      19: aload_1</div><div class="line">      20: monitorexit</div><div class="line">      21: aload_2</div><div class="line">      22: athrow</div><div class="line">      23: return</div><div class="line">    Exception table:</div><div class="line">       from    to  target type</div><div class="line">           5    15    18   any</div><div class="line">          18    21    18   any</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åœ¨åŒæ­¥å—çš„å…¥å£å’Œå‡ºå£åˆ†åˆ«æœ‰ <code>monitorenter,monitorexit</code><br>æŒ‡ä»¤ã€‚</p>
<h2 id="é”ä¼˜åŒ–"><a href="#é”ä¼˜åŒ–" class="headerlink" title="é”ä¼˜åŒ–"></a>é”ä¼˜åŒ–</h2><p><code>synchronize</code>  å¾ˆå¤šéƒ½ç§°ä¹‹ä¸ºé‡é‡é”ï¼Œ<code>JDK1.6</code> ä¸­å¯¹ <code>synchronize</code> è¿›è¡Œäº†å„ç§ä¼˜åŒ–ï¼Œä¸ºäº†èƒ½å‡å°‘è·å–å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ¶ˆè€—å¼•å…¥äº†<code>åå‘é”</code>å’Œ<code>è½»é‡é”</code>ã€‚</p>
<h3 id="è½»é‡é”"><a href="#è½»é‡é”" class="headerlink" title="è½»é‡é”"></a>è½»é‡é”</h3><p>å½“ä»£ç è¿›å…¥åŒæ­¥å—æ—¶ï¼Œå¦‚æœåŒæ­¥å¯¹è±¡ä¸ºæ— é”çŠ¶æ€æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šåœ¨æ ˆå¸§ä¸­åˆ›å»ºä¸€ä¸ªé”è®°å½•(<code>Lock Record</code>)åŒºåŸŸï¼ŒåŒæ—¶å°†é”å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­ <code>Mark Word</code> æ‹·è´åˆ°é”è®°å½•ä¸­ï¼Œå†å°è¯•ä½¿ç”¨ <code>CAS</code> å°† <code>Mark Word</code> æ›´æ–°ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆã€‚</p>
<p>å¦‚æœæ›´æ–°<strong>æˆåŠŸ</strong>ï¼Œå½“å‰çº¿ç¨‹å°±è·å¾—äº†é”ã€‚</p>
<p>å¦‚æœæ›´æ–°<strong>å¤±è´¥</strong> <code>JVM</code> ä¼šå…ˆæ£€æŸ¥é”å¯¹è±¡çš„ <code>Mark Word</code> æ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„é”è®°å½•ã€‚</p>
<p>å¦‚æœæ˜¯åˆ™è¯´æ˜å½“å‰çº¿ç¨‹æ‹¥æœ‰é”å¯¹è±¡çš„é”ï¼Œå¯ä»¥ç›´æ¥è¿›å…¥åŒæ­¥å—ã€‚</p>
<p>ä¸æ˜¯åˆ™è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æŠ¢å äº†é”ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶ç«äº‰ä¸€æŠŠé”ï¼Œ<strong>è½»é‡é”å°±ä¼šè†¨èƒ€ä¸ºé‡é‡é”</strong>ã€‚</p>
<h4 id="è§£é”"><a href="#è§£é”" class="headerlink" title="è§£é”"></a>è§£é”</h4><p>è½»é‡é”çš„è§£é”è¿‡ç¨‹ä¹Ÿæ˜¯åˆ©ç”¨ <code>CAS</code> æ¥å®ç°çš„ï¼Œä¼šå°è¯•é”è®°å½•æ›¿æ¢å›é”å¯¹è±¡çš„ <code>Mark Word</code> ã€‚å¦‚æœæ›¿æ¢æˆåŠŸåˆ™è¯´æ˜æ•´ä¸ªåŒæ­¥æ“ä½œå®Œæˆï¼Œå¤±è´¥åˆ™è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è·å–é”ï¼Œè¿™æ—¶å°±ä¼šå”¤é†’è¢«æŒ‚èµ·çš„çº¿ç¨‹(æ­¤æ—¶å·²ç»è†¨èƒ€ä¸º<code>é‡é‡é”</code>)</p>
<p>è½»é‡é”èƒ½æå‡æ€§èƒ½çš„åŸå› ï¼š</p>
<p>è®¤ä¸ºå¤§å¤šæ•°é”åœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸéƒ½ä¸å­˜åœ¨ç«äº‰ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>CAS</code> æ¯”ä½¿ç”¨äº’æ–¥å¼€é”€æ›´å°‘ã€‚ä½†å¦‚æœé”ç«äº‰æ¿€çƒˆï¼Œè½»é‡é”å°±ä¸ä½†æœ‰äº’æ–¥çš„å¼€é”€ï¼Œè¿˜æœ‰ <code>CAS</code> çš„å¼€é”€ï¼Œç”šè‡³æ¯”é‡é‡é”æ›´æ…¢ã€‚</p>
<h3 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h3><p>ä¸ºäº†è¿›ä¸€æ­¥çš„é™ä½è·å–é”çš„ä»£ä»·ï¼Œ<code>JDK1.6</code> ä¹‹åè¿˜å¼•å…¥äº†åå‘é”ã€‚</p>
<p>åå‘é”çš„ç‰¹å¾æ˜¯:é”ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œå¹¶ä¸”åº”ç”±ä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å¾—é”ã€‚</p>
<p>å½“çº¿ç¨‹è®¿é—®åŒæ­¥å—æ—¶ï¼Œä¼šä½¿ç”¨ <code>CAS</code> å°†çº¿ç¨‹ ID æ›´æ–°åˆ°é”å¯¹è±¡çš„ <code>Mark Word</code> ä¸­ï¼Œå¦‚æœæ›´æ–°æˆåŠŸåˆ™è·å¾—åå‘é”ï¼Œå¹¶ä¸”ä¹‹åæ¯æ¬¡è¿›å…¥è¿™ä¸ªå¯¹è±¡é”ç›¸å…³çš„åŒæ­¥å—æ—¶éƒ½ä¸éœ€è¦å†æ¬¡è·å–é”äº†ã€‚</p>
<h4 id="é‡Šæ”¾é”"><a href="#é‡Šæ”¾é”" class="headerlink" title="é‡Šæ”¾é”"></a>é‡Šæ”¾é”</h4><p>å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹è·å–è¿™ä¸ªé”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹å°±ä¼šé‡Šæ”¾é”ï¼Œé‡Šæ”¾æ—¶ä¼šç­‰å¾…å…¨å±€å®‰å…¨ç‚¹(è¿™ä¸€æ—¶åˆ»æ²¡æœ‰å­—èŠ‚ç è¿è¡Œ)ï¼Œæ¥ç€ä¼šæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œæ ¹æ®é”å¯¹è±¡ç›®å‰æ˜¯å¦è¢«é”æ¥åˆ¤å®šå°†å¯¹è±¡å¤´ä¸­çš„ <code>Mark Word</code> è®¾ç½®ä¸ºæ— é”æˆ–è€…æ˜¯è½»é‡é”çŠ¶æ€ã€‚</p>
<p>åå‘é”å¯ä»¥æé«˜å¸¦æœ‰åŒæ­¥å´æ²¡æœ‰ç«äº‰çš„ç¨‹åºæ€§èƒ½ï¼Œä½†å¦‚æœç¨‹åºä¸­å¤§å¤šæ•°é”éƒ½å­˜åœ¨ç«äº‰æ—¶ï¼Œé‚£åå‘é”å°±èµ·ä¸åˆ°å¤ªå¤§ä½œç”¨ã€‚å¯ä»¥ä½¿ç”¨ <code>-XX:-userBiasedLocking=false</code> æ¥å…³é—­åå‘é”ï¼Œå¹¶é»˜è®¤è¿›å…¥è½»é‡é”ã€‚</p>
<h3 id="å…¶ä»–ä¼˜åŒ–"><a href="#å…¶ä»–ä¼˜åŒ–" class="headerlink" title="å…¶ä»–ä¼˜åŒ–"></a>å…¶ä»–ä¼˜åŒ–</h3><h4 id="é€‚åº”æ€§è‡ªæ—‹"><a href="#é€‚åº”æ€§è‡ªæ—‹" class="headerlink" title="é€‚åº”æ€§è‡ªæ—‹"></a>é€‚åº”æ€§è‡ªæ—‹</h4><p>åœ¨ä½¿ç”¨ <code>CAS</code> æ—¶ï¼Œå¦‚æœæ“ä½œå¤±è´¥ï¼Œ<code>CAS</code> ä¼šè‡ªæ—‹å†æ¬¡å°è¯•ã€‚ç”±äºè‡ªæ—‹æ˜¯éœ€è¦æ¶ˆè€— <code>CPU</code> èµ„æºçš„ï¼Œæ‰€ä»¥å¦‚æœé•¿æœŸè‡ªæ—‹å°±ç™½ç™½æµªè´¹äº† <code>CPU</code>ã€‚<code>JDK1.6</code>åŠ å…¥äº†é€‚åº”æ€§è‡ªæ—‹:</p>
<blockquote>
<p>å¦‚æœæŸä¸ªé”è‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å¾—ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡å°±ä¼šå‡å°‘è‡ªæ—‹ã€‚</p>
</blockquote>
<h2 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h2><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws1.sinaimg.cn/large/006tKfTcly1fngjnyotvcj30z00jpn0d.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ &lt;code&gt;Synchronize&lt;/code&gt; å…³é”®å­—æ˜¯è§£å†³å¹¶å‘é—®é¢˜å¸¸ç”¨è§£å†³æ–¹æ¡ˆï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§ä½¿ç”¨æ–¹å¼:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŒæ­¥æ™®é€šæ–¹æ³•ï¼Œé”çš„æ˜¯å½“å‰å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;åŒæ­¥é™æ€æ–¹æ³•ï¼Œé”çš„æ˜¯å½“å‰ &lt;code&gt;Class&lt;/code&gt; å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;åŒæ­¥å—ï¼Œé”çš„æ˜¯ &lt;code&gt;{}&lt;/code&gt; ä¸­çš„å¯¹è±¡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å®ç°åŸç†ï¼š&lt;br&gt;&lt;code&gt;JVM&lt;/code&gt; æ˜¯é€šè¿‡è¿›å…¥ã€é€€å‡ºå¯¹è±¡ç›‘è§†å™¨( &lt;code&gt;Monitor&lt;/code&gt; )æ¥å®ç°å¯¹æ–¹æ³•ã€åŒæ­¥å—çš„åŒæ­¥çš„ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“å®ç°æ˜¯åœ¨ç¼–è¯‘ä¹‹ååœ¨åŒæ­¥æ–¹æ³•è°ƒç”¨å‰åŠ å…¥ä¸€ä¸ª &lt;code&gt;monitor.enter&lt;/code&gt; æŒ‡ä»¤ï¼Œåœ¨é€€å‡ºæ–¹æ³•å’Œå¼‚å¸¸å¤„æ’å…¥ &lt;code&gt;monitor.exit&lt;/code&gt; çš„æŒ‡ä»¤ã€‚&lt;/p&gt;
&lt;p&gt;å…¶æœ¬è´¨å°±æ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡ç›‘è§†å™¨( &lt;code&gt;Monitor&lt;/code&gt; )è¿›è¡Œè·å–ï¼Œè€Œè¿™ä¸ªè·å–è¿‡ç¨‹å…·æœ‰æ’ä»–æ€§ä»è€Œè¾¾åˆ°äº†åŒä¸€æ—¶åˆ»åªèƒ½ä¸€ä¸ªçº¿ç¨‹è®¿é—®çš„ç›®çš„ã€‚&lt;/p&gt;
&lt;p&gt;è€Œå¯¹äºæ²¡æœ‰è·å–åˆ°é”çš„çº¿ç¨‹å°†ä¼šé˜»å¡åˆ°æ–¹æ³•å…¥å£å¤„ï¼Œç›´åˆ°è·å–é”çš„çº¿ç¨‹ &lt;code&gt;monitor.exit&lt;/code&gt; ä¹‹åæ‰èƒ½å°è¯•ç»§ç»­è·å–é”ã€‚&lt;/p&gt;
&lt;p&gt;æµç¨‹å›¾å¦‚ä¸‹:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tNc79ly1fn27fkl07jj31e80hyn0n.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Java è¿›é˜¶" scheme="http://crossoverjie.top/categories/Java-%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Java" scheme="http://crossoverjie.top/tags/Java/"/>
    
      <category term="synchronize" scheme="http://crossoverjie.top/tags/synchronize/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€è‡´ Hash ç®—æ³•åˆ†æ</title>
    <link href="http://crossoverjie.top/2018/01/08/Consistent-Hash/"/>
    <id>http://crossoverjie.top/2018/01/08/Consistent-Hash/</id>
    <published>2018-01-07T18:01:36.000Z</published>
    <updated>2018-01-07T18:16:11.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fn8l7h65v6j30v90kujsd.jpg" alt=""></p>
<p>å½“æˆ‘ä»¬åœ¨åšæ•°æ®åº“åˆ†åº“åˆ†è¡¨æˆ–è€…æ˜¯åˆ†å¸ƒå¼ç¼“å­˜æ—¶ï¼Œä¸å¯é¿å…çš„éƒ½ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜:</p>
<p>å¦‚ä½•å°†æ•°æ®å‡åŒ€çš„åˆ†æ•£åˆ°å„ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”å°½é‡çš„åœ¨åŠ å‡èŠ‚ç‚¹æ—¶èƒ½ä½¿å—å½±å“çš„æ•°æ®æœ€å°‘ã€‚</p>
<h2 id="Hash-å–æ¨¡"><a href="#Hash-å–æ¨¡" class="headerlink" title="Hash å–æ¨¡"></a>Hash å–æ¨¡</h2><p>éšæœºæ”¾ç½®å°±ä¸è¯´äº†ï¼Œä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜ã€‚é€šå¸¸æœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹æ¡ˆå°±æ˜¯ <code>hash å–æ¨¡</code>äº†ã€‚</p>
<p>å¯ä»¥å°†ä¼ å…¥çš„ Key æŒ‰ç…§ <code>index = hash(key) % N</code> è¿™æ ·æ¥è®¡ç®—å‡ºéœ€è¦å­˜æ”¾çš„èŠ‚ç‚¹ã€‚å…¶ä¸­ hash å‡½æ•°æ˜¯ä¸€ä¸ªå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ­£æ•´æ•°çš„å“ˆå¸Œæ˜ å°„æ–¹æ³•ï¼ŒN å°±æ˜¯èŠ‚ç‚¹çš„æ•°é‡ã€‚</p>
<p>è¿™æ ·å¯ä»¥æ»¡è¶³æ•°æ®çš„å‡åŒ€åˆ†é…ï¼Œä½†æ˜¯è¿™ä¸ªç®—æ³•çš„å®¹é”™æ€§å’Œæ‰©å±•æ€§éƒ½è¾ƒå·®ã€‚</p>
<p>æ¯”å¦‚å¢åŠ æˆ–åˆ é™¤äº†ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œæ‰€æœ‰çš„ Key éƒ½éœ€è¦é‡æ–°è®¡ç®—ï¼Œæ˜¾ç„¶è¿™æ ·æˆæœ¬è¾ƒé«˜ï¼Œä¸ºæ­¤éœ€è¦ä¸€ä¸ªç®—æ³•æ»¡è¶³åˆ†å¸ƒå‡åŒ€åŒæ—¶ä¹Ÿè¦æœ‰è‰¯å¥½çš„å®¹é”™æ€§å’Œæ‹“å±•æ€§ã€‚</p>
<a id="more"></a>
<h2 id="ä¸€è‡´-Hash-ç®—æ³•"><a href="#ä¸€è‡´-Hash-ç®—æ³•" class="headerlink" title="ä¸€è‡´ Hash ç®—æ³•"></a>ä¸€è‡´ Hash ç®—æ³•</h2><p>ä¸€è‡´ Hash ç®—æ³•æ˜¯å°†æ‰€æœ‰çš„å“ˆå¸Œå€¼æ„æˆäº†ä¸€ä¸ªç¯ï¼Œå…¶èŒƒå›´åœ¨ <code>0 ~ 2^32-1</code>ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fn8kbmd4ncj30ad08y3yn.jpg" alt=""></p>
<p>ä¹‹åå°†å„ä¸ªèŠ‚ç‚¹æ•£åˆ—åˆ°è¿™ä¸ªç¯ä¸Šï¼Œå¯ä»¥ç”¨èŠ‚ç‚¹çš„ IPã€hostname è¿™æ ·çš„å”¯ä¸€æ€§å­—æ®µä½œä¸º Key è¿›è¡Œ <code>hash(key)</code>ï¼Œæ•£åˆ—ä¹‹åå¦‚ä¸‹ï¼š</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fn8kf72uwuj30a40a70t5.jpg" alt=""></p>
<p>ä¹‹åéœ€è¦å°†æ•°æ®å®šä½åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨åŒæ ·çš„ <code>hash å‡½æ•°</code> å°† Key ä¹Ÿæ˜ å°„åˆ°è¿™ä¸ªç¯ä¸Šã€‚</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fn8kj9kd4oj30ax0aomxq.jpg" alt=""></p>
<p>è¿™æ ·æŒ‰ç…§é¡ºæ—¶é’ˆæ–¹å‘å°±å¯ä»¥æŠŠ k1 å®šä½åˆ° <code>N1èŠ‚ç‚¹</code>ï¼Œk2 å®šä½åˆ° <code>N3èŠ‚ç‚¹</code>ï¼Œk3 å®šä½åˆ° <code>N2èŠ‚ç‚¹</code>ã€‚</p>
<h3 id="å®¹é”™æ€§"><a href="#å®¹é”™æ€§" class="headerlink" title="å®¹é”™æ€§"></a>å®¹é”™æ€§</h3><p>è¿™æ—¶å‡è®¾ N1 å®•æœºäº†ï¼š</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fn8kl9pp06j30a409waaj.jpg" alt=""></p>
<p>ä¾ç„¶æ ¹æ®é¡ºæ—¶é’ˆæ–¹å‘ï¼Œk2 å’Œ k3 ä¿æŒä¸å˜ï¼Œåªæœ‰ k1 è¢«é‡æ–°æ˜ å°„åˆ°äº† N3ã€‚è¿™æ ·å°±å¾ˆå¥½çš„ä¿è¯äº†å®¹é”™æ€§ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹å®•æœºæ—¶åªä¼šå½±å“åˆ°å°‘å°‘éƒ¨åˆ†çš„æ•°æ®ã€‚</p>
<h3 id="æ‹“å±•æ€§"><a href="#æ‹“å±•æ€§" class="headerlink" title="æ‹“å±•æ€§"></a>æ‹“å±•æ€§</h3><p>å½“æ–°å¢ä¸€ä¸ªèŠ‚ç‚¹æ—¶:</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fn8kp1fc9xj30ca0abt9c.jpg" alt=""></p>
<p>åœ¨ N2 å’Œ N3 ä¹‹é—´æ–°å¢äº†ä¸€ä¸ªèŠ‚ç‚¹ N4 ï¼Œè¿™æ—¶ä¼šå‘ç°å—å°è±¡çš„æ•°æ®åªæœ‰ k3ï¼Œå…¶ä½™æ•°æ®ä¹Ÿæ˜¯ä¿æŒä¸å˜ï¼Œæ‰€ä»¥è¿™æ ·ä¹Ÿå¾ˆå¥½çš„ä¿è¯äº†æ‹“å±•æ€§ã€‚</p>
<h2 id="è™šæ‹ŸèŠ‚ç‚¹"><a href="#è™šæ‹ŸèŠ‚ç‚¹" class="headerlink" title="è™šæ‹ŸèŠ‚ç‚¹"></a>è™šæ‹ŸèŠ‚ç‚¹</h2><p>åˆ°ç›®å‰ä¸ºæ­¢è¯¥ç®—æ³•ä¾ç„¶ä¹Ÿæœ‰ç‚¹é—®é¢˜:</p>
<p>å½“èŠ‚ç‚¹è¾ƒå°‘æ—¶ä¼šå‡ºç°æ•°æ®åˆ†å¸ƒä¸å‡åŒ€çš„æƒ…å†µï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fn8krttekbj30c10a5dg5.jpg" alt=""></p>
<p>è¿™æ ·ä¼šå¯¼è‡´å¤§éƒ¨åˆ†æ•°æ®éƒ½åœ¨ N1 èŠ‚ç‚¹ï¼Œåªæœ‰å°‘é‡çš„æ•°æ®åœ¨ N2 èŠ‚ç‚¹ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€è‡´å“ˆå¸Œç®—æ³•å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹ã€‚å°†æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½è¿›è¡Œå¤šæ¬¡ hashï¼Œç”Ÿæˆå¤šä¸ªèŠ‚ç‚¹æ”¾ç½®åœ¨ç¯ä¸Šç§°ä¸ºè™šæ‹ŸèŠ‚ç‚¹:</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fn8ktzuswkj30ae0abdgb.jpg" alt=""></p>
<p>è®¡ç®—æ—¶å¯ä»¥åœ¨ IP ååŠ ä¸Šç¼–å·æ¥ç”Ÿæˆå“ˆå¸Œå€¼ã€‚</p>
<p>è¿™æ ·åªéœ€è¦åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šå¤šä¸€æ­¥ç”±è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å®é™…èŠ‚ç‚¹çš„æ­¥éª¤å³å¯è®©å°‘é‡èŠ‚ç‚¹ä¹Ÿèƒ½æ»¡è¶³å‡åŒ€æ€§ã€‚</p>
<h2 id="å·å¤–"><a href="#å·å¤–" class="headerlink" title="å·å¤–"></a>å·å¤–</h2><p>æœ€è¿‘åœ¨æ€»ç»“ä¸€äº› Java ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸€èµ·ç»´æŠ¤ã€‚</p>
<blockquote>
<p>åœ°å€: <a href="https://github.com/crossoverJie/Java-Interview" target="_blank" rel="external">https://github.com/crossoverJie/Java-Interview</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws3.sinaimg.cn/large/006tNc79gy1fn8l7h65v6j30v90kujsd.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;å½“æˆ‘ä»¬åœ¨åšæ•°æ®åº“åˆ†åº“åˆ†è¡¨æˆ–è€…æ˜¯åˆ†å¸ƒå¼ç¼“å­˜æ—¶ï¼Œä¸å¯é¿å…çš„éƒ½ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜:&lt;/p&gt;
&lt;p&gt;å¦‚ä½•å°†æ•°æ®å‡åŒ€çš„åˆ†æ•£åˆ°å„ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”å°½é‡çš„åœ¨åŠ å‡èŠ‚ç‚¹æ—¶èƒ½ä½¿å—å½±å“çš„æ•°æ®æœ€å°‘ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Hash-å–æ¨¡&quot;&gt;&lt;a href=&quot;#Hash-å–æ¨¡&quot; class=&quot;headerlink&quot; title=&quot;Hash å–æ¨¡&quot;&gt;&lt;/a&gt;Hash å–æ¨¡&lt;/h2&gt;&lt;p&gt;éšæœºæ”¾ç½®å°±ä¸è¯´äº†ï¼Œä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜ã€‚é€šå¸¸æœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹æ¡ˆå°±æ˜¯ &lt;code&gt;hash å–æ¨¡&lt;/code&gt;äº†ã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥å°†ä¼ å…¥çš„ Key æŒ‰ç…§ &lt;code&gt;index = hash(key) % N&lt;/code&gt; è¿™æ ·æ¥è®¡ç®—å‡ºéœ€è¦å­˜æ”¾çš„èŠ‚ç‚¹ã€‚å…¶ä¸­ hash å‡½æ•°æ˜¯ä¸€ä¸ªå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ­£æ•´æ•°çš„å“ˆå¸Œæ˜ å°„æ–¹æ³•ï¼ŒN å°±æ˜¯èŠ‚ç‚¹çš„æ•°é‡ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ ·å¯ä»¥æ»¡è¶³æ•°æ®çš„å‡åŒ€åˆ†é…ï¼Œä½†æ˜¯è¿™ä¸ªç®—æ³•çš„å®¹é”™æ€§å’Œæ‰©å±•æ€§éƒ½è¾ƒå·®ã€‚&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚å¢åŠ æˆ–åˆ é™¤äº†ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œæ‰€æœ‰çš„ Key éƒ½éœ€è¦é‡æ–°è®¡ç®—ï¼Œæ˜¾ç„¶è¿™æ ·æˆæœ¬è¾ƒé«˜ï¼Œä¸ºæ­¤éœ€è¦ä¸€ä¸ªç®—æ³•æ»¡è¶³åˆ†å¸ƒå‡åŒ€åŒæ—¶ä¹Ÿè¦æœ‰è‰¯å¥½çš„å®¹é”™æ€§å’Œæ‹“å±•æ€§ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="ç®—æ³•" scheme="http://crossoverjie.top/categories/%E7%AE%97%E6%B3%95/"/>
    
    
  </entry>
  
  <entry>
    <title>sbc(å…­) Zuul GateWay ç½‘å…³åº”ç”¨</title>
    <link href="http://crossoverjie.top/2017/11/28/sbc6/"/>
    <id>http://crossoverjie.top/2017/11/28/sbc6/</id>
    <published>2017-11-27T17:13:22.000Z</published>
    <updated>2017-11-28T05:14:13.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1flrejb4pbpj30qo0cuq5s.jpg" alt=""></p>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>çœ‹è¿‡ä¹‹å‰<a href="https://crossoverjie.top/categories/sbc/">SBC</a>ç³»åˆ—çš„å°ä¼™ä¼´åº”è¯¥éƒ½å¯ä»¥æ­å»ºä¸€ä¸ªé«˜å¯ç”¨ã€åˆ†å¸ƒå¼çš„å¾®æœåŠ¡äº†ã€‚ ç›®å‰çš„ç»“æ„å›¾åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:<br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1flvyjrv2unj30dc0gwaaw.jpg" alt=""></p>
<p>å„ä¸ªå¾®æœåŠ¡ä¹‹é—´éƒ½ä¸å­˜åœ¨å•ç‚¹ï¼Œå¹¶ä¸”éƒ½æ³¨å†Œäº <code>Eureka</code> ï¼ŒåŸºäºæ­¤è¿›è¡ŒæœåŠ¡çš„æ³¨å†Œäºå‘ç°ï¼Œå†é€šè¿‡ <code>Ribbon</code> è¿›è¡ŒæœåŠ¡è°ƒç”¨ï¼Œå¹¶å…·æœ‰å®¢æˆ·ç«¯è´Ÿè½½åŠŸèƒ½ã€‚</p>
<p>ä¸€åˆ‡çœ‹èµ·æ¥éƒ½æ¯”è¾ƒç¾å¥½ï¼Œä½†è¿™é‡Œå´å¿˜äº†ä¸€ä¸ªé‡è¦çš„ç»†èŠ‚ï¼š</p>
<blockquote>
<p>å½“æˆ‘ä»¬éœ€è¦å¯¹å¤–æä¾›æœåŠ¡æ—¶æ€ä¹ˆå¤„ç†ï¼Ÿ</p>
</blockquote>
<p>è¿™å½“ç„¶ä¹Ÿèƒ½å®ç°ï¼Œæ— éå°±æ˜¯å°†æˆ‘ä»¬å…·ä½“çš„å¾®æœåŠ¡åœ°å€åŠ ç«¯å£æš´éœ²å‡ºå»å³å¯ã€‚</p>
<p>é‚£åˆå¦‚ä½•æ¥å®ç°è´Ÿè½½å‘¢ï¼Ÿ</p>
<p>ç®€å•ï¼å¯ä»¥é€šè¿‡ <code>Nginx F5</code> ä¹‹ç±»çš„å·¥å…·è¿›è¡Œè´Ÿè½½ã€‚</p>
<p>ä½†æ˜¯å¦‚æœç³»ç»Ÿåºå¤§ï¼ŒæœåŠ¡æ‹†åˆ†çš„è¶³å¤Ÿå¤šé‚£åˆæœ‰è°æ¥ç»´æŠ¤è¿™äº›è·¯ç”±å…³ç³»å‘¢ï¼Ÿ</p>
<p>å½“ç„¶è¿™æ˜¯è¿ç»´çš„æ´»ï¼Œä¸è¿‡è¿™æ—¶å€™è¿ç»´å¯èƒ½å°±è¦å‘é£™äº†ï¼</p>
<p>å¹¶ä¸”è¿˜æœ‰ä¸€ç³»åˆ—çš„é—®é¢˜:</p>
<ul>
<li>æœåŠ¡è°ƒç”¨ä¹‹é—´çš„ä¸€äº›é‰´æƒã€ç­¾åæ ¡éªŒæ€ä¹ˆåšï¼Ÿ</li>
<li>ç”±äºæœåŠ¡ç«¯åœ°å€è¾ƒå¤šï¼Œå®¢æˆ·ç«¯è¯·æ±‚éš¾ä»¥ç»´æŠ¤ã€‚</li>
</ul>
<p>é’ˆå¯¹äºè¿™ä¸€äº›é—®é¢˜ <code>SpringCloud</code> å…¨å®¶æ¡¶è‡ªç„¶ä¹Ÿæœ‰å¯¹åº”çš„è§£å†³æ–¹æ¡ˆ: <code>Zuul</code>ã€‚<br>å½“æˆ‘ä»¬ç³»ç»Ÿæ•´åˆ Zuul ç½‘å…³ä¹‹åæ¶æ„å›¾åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1flw0fbfukxj30mp0icdgk.jpg" alt=""></p>
<a id="more"></a>
<p>æˆ‘ä»¬åœ¨æ‰€æœ‰çš„è¯·æ±‚è¿›æ¥ä¹‹å‰æŠ½å‡ºä¸€å±‚ç½‘å…³åº”ç”¨ï¼Œå°†æœåŠ¡æä¾›çš„æ‰€æœ‰ç»†èŠ‚éƒ½è¿›è¡Œäº†åŒ…è£…ï¼Œè¿™æ ·æ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½æ˜¯å’Œç½‘å…³è¿›è¡Œäº¤äº’ï¼Œç®€åŒ–äº†å®¢æˆ·ç«¯å¼€å‘ã€‚</p>
<p>åŒæ—¶å…·æœ‰å¦‚ä¸‹åŠŸèƒ½:</p>
<ul>
<li>Zuul æ³¨å†Œäº <code>Eureka</code> å¹¶é›†æˆäº† <code>Ribbon</code> æ‰€ä»¥è‡ªç„¶ä¹Ÿæ˜¯å¯ä»¥ä»æ³¨å†Œä¸­å¿ƒè·å–åˆ°æœåŠ¡åˆ—è¡¨è¿›è¡Œå®¢æˆ·ç«¯è´Ÿè½½ã€‚</li>
<li>åŠŸèƒ½ä¸°å¯Œçš„è·¯ç”±åŠŸèƒ½ï¼Œè§£æ”¾è¿ç»´ã€‚</li>
<li>å…·æœ‰è¿‡æ»¤å™¨ï¼Œæ‰€ä»¥é‰´æƒã€éªŒç­¾éƒ½å¯ä»¥é›†æˆã€‚</li>
</ul>
<p>åŸºäºæ­¤æˆ‘ä»¬æ¥çœ‹çœ‹ä¹‹å‰çš„æ¶æ„ä¸­å¦‚ä½•é›†æˆ <code>Zuul</code> ã€‚</p>
<h1 id="é›†æˆ-Zuul"><a href="#é›†æˆ-Zuul" class="headerlink" title="é›†æˆ Zuul"></a>é›†æˆ Zuul</h1><p>ä¸ºæ­¤æˆ‘æ–°å»ºäº†ä¸€ä¸ªé¡¹ç›® <code>sbc-gateway-zuul</code> å°±æ˜¯ä¸€ä¸ªåŸºç¡€çš„ <code>SpringBoot</code> ç»“æ„ã€‚å…¶ä¸­åŠ å…¥äº† Zuul çš„ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>ç”±äºéœ€è¦å°†ç½‘å…³ä¹Ÿæ³¨å†Œåˆ° <code>Eureka</code> ä¸­ï¼Œæ‰€ä»¥è‡ªç„¶ä¹Ÿéœ€è¦:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>ç´§æ¥ç€é…ç½®ä¸€äº›é¡¹ç›®åŸºæœ¬ä¿¡æ¯:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># é¡¹ç›®é…ç½®</div><div class="line">spring.application.name=sbc-gateway-zuul</div><div class="line">server.context-path=/</div><div class="line">server.port=8383</div><div class="line"></div><div class="line"># eurekaåœ°å€</div><div class="line">eureka.client.serviceUrl.defaultZone=http://node1:8888/eureka/</div><div class="line">eureka.instance.prefer-ip-address=true</div></pre></td></tr></table></figure>
<p>åœ¨å¯åŠ¨ç±»ä¸­åŠ å…¥å¼€å¯ <code>Zuul</code> çš„æ³¨è§£ï¼Œä¸€ä¸ªç½‘å…³åº”ç”¨å°±ç®—æ˜¯æ­å¥½äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"></div><div class="line"><span class="comment">//å¼€å¯zuulä»£ç†</span></div><div class="line"><span class="meta">@EnableZuulProxy</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SbcGateWayZuulApplication</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯åŠ¨ <code>Eureka</code> å’Œç½‘å…³çœ‹åˆ°å·²ç»æ³¨å†ŒæˆåŠŸé‚£å°±å¤§åŠŸå‘Šæˆäº†:</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1flx2fwc3v2j314y085dgp.jpg" alt=""></p>
<h1 id="è·¯ç”±"><a href="#è·¯ç”±" class="headerlink" title="è·¯ç”±"></a>è·¯ç”±</h1><p>è·¯ç”±æ˜¯ç½‘å…³çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå¯ä»¥ä½¿ç³»ç»Ÿæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¯¹å¤–æ¥å£ï¼Œä¸‹é¢æ¥çœ‹çœ‹å…·ä½“çš„åº”ç”¨ã€‚</p>
<h2 id="ä¼ ç»Ÿè·¯ç”±"><a href="#ä¼ ç»Ÿè·¯ç”±" class="headerlink" title="ä¼ ç»Ÿè·¯ç”±"></a>ä¼ ç»Ÿè·¯ç”±</h2><p>ä¼ ç»Ÿè·¯ç”±éå¸¸ç®€å•ï¼Œå’Œ <code>Nginx</code> ç±»ä¼¼ï¼Œç”±å¼€å‘ã€è¿ç»´äººå‘˜æ¥ç»´æŠ¤è¯·æ±‚åœ°å€å’Œå¯¹åº”æœåŠ¡çš„æ˜ å°„å…³ç³»ï¼Œç±»ä¼¼äº:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">zuul.routes.user-service.path=/user-service/**</div><div class="line">zuul.routes.user-sercice.url=http://localhost:8080/</div></pre></td></tr></table></figure>
<p>è¿™æ ·å½“æˆ‘ä»¬è®¿é—® <code>http://localhost:8383/user-service/getUserInfo/1</code> ç½‘å…³å°±ä¼šè‡ªåŠ¨ç»™æˆ‘ä»¬è·¯ç”±åˆ° <code>http://localhost:8080/getUserInfo/1</code> ä¸Šã€‚</p>
<p>å¯è§åªè¦æˆ‘ä»¬ç»´æŠ¤å¥½è¿™ä¸ªæ˜ å°„å…³ç³»å³å¯è‡ªç”±çš„é…ç½®è·¯ç”±ä¿¡æ¯(<code>user-sercice å¯è‡ªå®šä¹‰</code>)ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾è¿™ç§æ–¹å¼ä¸ç®¡æ˜¯å¯¹è¿ç»´è¿˜æ˜¯å¼€å‘éƒ½ä¸å‹å¥½ã€‚ç”±äºå®é™…è¿™ç§æ–¹å¼ç”¨çš„ä¸å¤šå°±å†è¿‡å¤šå±•å¼€ã€‚</p>
<h2 id="æœåŠ¡è·¯ç”±"><a href="#æœåŠ¡è·¯ç”±" class="headerlink" title="æœåŠ¡è·¯ç”±"></a>æœåŠ¡è·¯ç”±</h2><p>å¯¹æ­¤ <code>Zuul</code> æä¾›äº†ä¸€ç§åŸºäºæœåŠ¡çš„è·¯ç”±æ–¹å¼ã€‚æˆ‘ä»¬åªéœ€è¦ç»´æŠ¤è¯·æ±‚åœ°å€ä¸æœåŠ¡ ID ä¹‹é—´çš„æ˜ å°„å…³ç³»å³å¯ï¼Œå¹¶ä¸”ç”±äºé›†æˆäº† <code>Ribbon</code> , Zuul è¿˜å¯ä»¥åœ¨è·¯ç”±çš„æ—¶å€™é€šè¿‡ Eureka å®ç°è´Ÿè½½è°ƒç”¨ã€‚</p>
<p>å…·ä½“é…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">zuul.routes.sbc-user.path=/api/user/**</div><div class="line">zuul.routes.sbc-user.serviceId=sbc-user</div></pre></td></tr></table></figure>
<p>è¿™æ ·å½“è¾“å…¥ <code>http://localhost:8383/api/user/getUserInfo/1</code> æ—¶å°±ä¼šè·¯ç”±åˆ°æ³¨å†Œåˆ° <code>Eureka</code> ä¸­æœåŠ¡ ID ä¸º <code>sbc-user</code> çš„æœåŠ¡èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰å¤šèŠ‚ç‚¹å°±ä¼šæŒ‰ç…§ Ribbon çš„è´Ÿè½½ç®—æ³•è·¯ç”±åˆ°å…¶ä¸­ä¸€å°ä¸Šã€‚</p>
<p>ä»¥ä¸Šé…ç½®è¿˜å¯ä»¥ç®€å†™ä¸º:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># æœåŠ¡è·¯ç”± ç®€åŒ–é…ç½®</div><div class="line">zuul.routes.sbc-user=/api/user/**</div></pre></td></tr></table></figure>
<p>è¿™æ ·è®©æˆ‘ä»¬è®¿é—® <code>http://127.0.0.1:8383/api/user/userService/getUserByHystrix</code> æ—¶å€™å°±ä¼šæ ¹æ®è´Ÿè½½ç®—æ³•å¸®æˆ‘ä»¬è·¯ç”±åˆ° sbc-user åº”ç”¨ä¸Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1flx4pbe3nsj31ga0e5gnq.jpg" alt=""><br>å¯åŠ¨äº†ä¸¤ä¸ª sbc-user æœåŠ¡ã€‚</p>
<p>è¯·æ±‚ç»“æœ:<br><img src="https://ws4.sinaimg.cn/large/006tKfTcly1flx4q2zktbj30yd0ll79b.jpg" alt=""></p>
<p>ä¸€æ¬¡è·¯ç”±å°±ç®—å®Œæˆäº†ã€‚</p>
<p>åœ¨ä¸Šé¢çš„é…ç½®ä¸­æœ‰çœ‹åˆ° <code>/api/user/**</code> è¿™æ ·çš„é€šé…ç¬¦é…ç½®ï¼Œå…·ä½“æœ‰ä»¥ä¸‹ä¸‰ç§é…ç½®éœ€è¦äº†è§£:</p>
<ul>
<li><code>?</code> åªèƒ½åŒ¹é…ä»»æ„çš„å•ä¸ªå­—ç¬¦ï¼Œå¦‚ <code>/api/user/?</code> å°±åªèƒ½åŒ¹é… <code>/api/user/x  /api/user/y /api/user/z</code> è¿™æ ·çš„è·¯å¾„ã€‚</li>
<li><code>*</code> åªèƒ½åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œå¦‚ <code>/api/user/*</code> å°±åªèƒ½åŒ¹é… <code>/api/user/x /api/user/xy /api/user/xyz</code>ã€‚</li>
<li><code>**</code> å¯ä»¥åŒ¹é…ä»»æ„å­—ç¬¦ã€ä»»æ„å±‚çº§ã€‚ç»“åˆäº†ä»¥ä¸Šä¸¤ç§é€šé…ç¬¦çš„ç‰¹ç‚¹ï¼Œå¦‚ <code>/api/user/**</code> åˆ™å¯ä»¥åŒ¹é… <code>/api/user/x /api/user/x/y /api/user/x/y/zzz</code>è¿™æ ·çš„è·¯å¾„ï¼Œæœ€ç®€å•ç²—æš´ï¼</li>
</ul>
<p>è°ˆåˆ°é€šé…ç¬¦åŒ¹é…å°±ä¸å¾—ä¸æåˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä¸Šé¢çš„ <code>sbc-user</code> æœåŠ¡ç”±äºåæœŸè¿­ä»£æ›´æ–°ï¼Œå°† sbc-user ä¸­çš„ä¸€éƒ¨åˆ†é€»è¾‘æŠ½æˆäº†å¦ä¸€ä¸ªæœåŠ¡ <code>sbc-user-pro</code>ã€‚æ–°åº”ç”¨çš„è·¯ç”±è§„åˆ™æ˜¯ <code>/api/user/pro/**</code>,å¦‚æœæˆ‘ä»¬æŒ‰ç…§:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">zuul.routes.sbc-user=/api/user/**</div><div class="line">zuul.routes.sbc-user-pro=/api/user/pro/**</div></pre></td></tr></table></figure>
<p>è¿›è¡Œé…ç½®çš„è¯ï¼Œæˆ‘ä»¬æƒ³é€šè¿‡ <code>/api/user/pro/</code> æ¥è®¿é—® <code>sbc-user-pro</code> åº”ç”¨ï¼Œå´ç”±äºæ»¡è¶³ç¬¬ä¸€ä¸ªè·¯ç”±è§„åˆ™ï¼Œæ‰€ä»¥ä¼šè¢« Zuul è·¯ç”±åˆ° <code>sbc-user</code> è¿™ä¸ªåº”ç”¨ä¸Šï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ã€‚è¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>
<p>ç¿»çœ‹è·¯ç”±æºç  <code>org.springframework.cloud.netflix.zuul.filters.SimpleRouteLocator</code> ä¸­çš„ <code>locateRoutes()</code> æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Compute a map of path pattern to route. The default is just a static map from the</div><div class="line"> * &#123;<span class="doctag">@link</span> ZuulProperties&#125;, but subclasses can add dynamic calculations.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> Map&lt;String, ZuulRoute&gt; <span class="title">locateRoutes</span><span class="params">()</span> </span>&#123;</div><div class="line">	LinkedHashMap&lt;String, ZuulRoute&gt; routesMap = <span class="keyword">new</span> LinkedHashMap&lt;String, ZuulRoute&gt;();</div><div class="line">	<span class="keyword">for</span> (ZuulRoute route : <span class="keyword">this</span>.properties.getRoutes().values()) &#123;</div><div class="line">		routesMap.put(route.getPath(), route);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> routesMap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‘ç°è·¯ç”±è§„åˆ™æ˜¯éå†é…ç½®æ–‡ä»¶å¹¶æ”¾å…¥ <strong><code>LinkedHashMap</code></strong> ä¸­ï¼Œç”±äº <code>LinkedHashMap</code> æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥ä¸ºäº†è¾¾åˆ°ä¸Šæ–‡çš„æ•ˆæœï¼Œé…ç½®æ–‡ä»¶çš„åŠ è½½é¡ºåºéå¸¸é‡è¦ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å°†ä¼˜å…ˆåŒ¹é…çš„è·¯ç”±è§„åˆ™æ”¾å‰å³å¯è§£å†³ã€‚</p>
<h1 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h1><p>è¿‡æ»¤å™¨å¯ä»¥è¯´æ˜¯æ•´ä¸ª Zuul æœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¸Šæ–‡æåˆ°è·¯ç”±åŠŸèƒ½ä¹Ÿæ˜¯ç”±è¿‡æ»¤å™¨æ¥å®ç°çš„ã€‚</p>
<p>æ‘˜æŠ„å®˜æ–¹çš„è§£é‡Š: Zuul çš„æ ¸å¿ƒå°±æ˜¯ä¸€ç³»åˆ—çš„è¿‡æ»¤å™¨ï¼Œä»–èƒ½å¤Ÿåœ¨æ•´ä¸ª <code>HTTP</code> è¯·æ±‚ã€å“åº”è¿‡ç¨‹ä¸­æ‰§è¡Œå„æ ·çš„æ“ä½œã€‚</p>
<p>å…¶å®æ€»ç»“ä¸‹æ¥å°±æ˜¯å››ä¸ªç‰¹å¾:</p>
<ul>
<li>è¿‡æ»¤ç±»å‹</li>
<li>è¿‡æ»¤é¡ºåº</li>
<li>æ‰§è¡Œæ¡ä»¶</li>
<li>å…·ä½“å®ç°</li>
</ul>
<p>å…¶å®å°±æ˜¯ <code>ZuulFilter</code> æ¥å£ä¸­æ‰€å®šä¹‰çš„å››ä¸ªæ¥å£:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">String filterType();</div><div class="line"></div><div class="line">int filterOrder();</div><div class="line"></div><div class="line">boolean shouldFilter();</div><div class="line"></div><div class="line">Object run();</div></pre></td></tr></table></figure>
<p>å®˜æ–¹æµç¨‹å›¾(ç”Ÿå‘½å‘¨æœŸ):</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1flx65zw2qpj30qo0k0tae.jpg" alt=""></p>
<p>ç®€å•ç†è§£ä¸‹å°±æ˜¯:</p>
<p>å½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥æ—¶ï¼Œé¦–å…ˆæ˜¯è¿›å…¥ <code>pre</code> è¿‡æ»¤å™¨ï¼Œå¯ä»¥åšä¸€äº›é‰´æƒï¼Œè®°å½•è°ƒè¯•æ—¥å¿—ç­‰æ“ä½œã€‚ä¹‹åè¿›å…¥ <code>routing</code> è¿‡æ»¤å™¨è¿›è¡Œè·¯ç”±è½¬å‘ï¼Œè½¬å‘å¯ä»¥ä½¿ç”¨ <code>Apache HttpClient</code> æˆ–è€…æ˜¯ <code>Ribbon</code> ã€‚<br><code>post</code> è¿‡æ»¤å™¨å‘¢åˆ™æ˜¯å¤„ç†æœåŠ¡å“åº”ä¹‹åçš„æ•°æ®ï¼Œå¯ä»¥è¿›è¡Œä¸€äº›åŒ…è£…æ¥è¿”å›å®¢æˆ·ç«¯ã€‚ <code>error</code> åˆ™æ˜¯åœ¨æœ‰å¼‚å¸¸å‘ç”Ÿæ—¶æ‰ä¼šè°ƒç”¨ï¼Œç›¸å½“äºæ˜¯å…¨å±€å¼‚å¸¸æ‹¦æˆªå™¨ã€‚</p>
<h2 id="è‡ªå®šä¹‰è¿‡æ»¤å™¨"><a href="#è‡ªå®šä¹‰è¿‡æ»¤å™¨" class="headerlink" title="è‡ªå®šä¹‰è¿‡æ»¤å™¨"></a>è‡ªå®šä¹‰è¿‡æ»¤å™¨</h2><p>æ¥ä¸‹æ¥å®ç°ä¸€ä¸ªæ–‡åˆæ‰€æåˆ°çš„é‰´æƒæ“ä½œ:</p>
<p>æ–°å»ºä¸€ä¸ª <code>RequestFilter</code> ç±»ç»§æ‰¿ä¸ <code>ZuulFilter</code> æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Function: è¯·æ±‚æ‹¦æˆª</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> crossoverJie</div><div class="line"> *         Date: 2017/11/20 00:33</div><div class="line"> * <span class="doctag">@since</span> JDK 1.8</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(RequestFilter.class) ;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¯·æ±‚è·¯ç”±ä¹‹å‰è¢«æ‹¦æˆª å®ç° pre æ‹¦æˆªå™¨</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"pre"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        RequestContext currentContext = RequestContext.getCurrentContext();</div><div class="line">        HttpServletRequest request = currentContext.getRequest();</div><div class="line">        String token = request.getParameter(<span class="string">"token"</span>);</div><div class="line">        <span class="keyword">if</span> (StringUtil.isEmpty(token))&#123;</div><div class="line">            logger.warn(<span class="string">"need token"</span>);</div><div class="line">            <span class="comment">//è¿‡æ»¤è¯·æ±‚</span></div><div class="line">            currentContext.setSendZuulResponse(<span class="keyword">false</span>);</div><div class="line">            currentContext.setResponseStatusCode(<span class="number">400</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span> ;</div><div class="line">        &#125;</div><div class="line">        logger.info(<span class="string">"token =&#123;&#125;"</span>,token) ;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>éå¸¸ easyï¼Œå°±ç®€å•æ ¡éªŒä¸‹è¯·æ±‚ä¸­æ˜¯å¦åŒ…å« <code>token</code>ï¼Œä¸åŒ…å«å°±è¿”å› 401 codeã€‚</p>
<p>ä¸ä½†å¦‚æ­¤ï¼Œè¿˜éœ€è¦å°†è¯¥ç±»åŠ å…¥åˆ° Spring è¿›è¡Œç®¡ç†:</p>
<p>æ–°å»ºäº† <code>FilterConf</code> ç±»:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterConf</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> RequestFilter <span class="title">filter</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> RequestFilter() ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·é‡å¯ä¹‹åå°±å¯ä»¥çœ‹åˆ°æ•ˆæœäº†:</p>
<p>ä¸ä¼  token æ—¶ï¼š<br><img src="https://ws1.sinaimg.cn/large/006tKfTcly1flx6pypmzqj30pt0f1jsq.jpg" alt=""></p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1flx6qeu2nfj310l03jjtc.jpg" alt=""></p>
<p>ä¼ å…¥ token æ—¶ï¼š<br><img src="https://ws2.sinaimg.cn/large/006tKfTcly1flx6rad3ffj30q00bpjsn.jpg" alt=""></p>
<p>å¯è§ä¸€äº›é‰´æƒæ“ä½œæ˜¯å¯ä»¥æ”¾åˆ°è¿™é‡Œæ¥è¿›è¡Œç»Ÿä¸€å¤„ç†çš„ã€‚</p>
<p>å…¶ä½™å‡ ä¸ªè¿‡æ»¤å™¨ä¹Ÿæ˜¯å¤§åŒå°å¼‚ï¼Œå¯ä»¥æ ¹æ®å®é™…åœºæ™¯æ¥è‡ªå®šä¹‰ã€‚</p>
<h1 id="Zuul-é«˜å¯ç”¨"><a href="#Zuul-é«˜å¯ç”¨" class="headerlink" title="Zuul é«˜å¯ç”¨"></a>Zuul é«˜å¯ç”¨</h1><p>Zuul ç°åœ¨æ—¢ç„¶ä½œä¸ºäº†å¯¹å¤–çš„ç¬¬ä¸€å…¥å£ï¼Œé‚£è‚¯å®šä¸èƒ½æ˜¯å•èŠ‚ç‚¹ï¼Œå¯¹äº Zuul çš„é«˜å¯ç”¨æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼å®ç°ã€‚</p>
<h2 id="Eureka-é«˜å¯ç”¨"><a href="#Eureka-é«˜å¯ç”¨" class="headerlink" title="Eureka é«˜å¯ç”¨"></a>Eureka é«˜å¯ç”¨</h2><p>ç¬¬ä¸€ç§æœ€å®¹æ˜“æƒ³åˆ°å’Œå®ç°:<br>æˆ‘ä»¬å¯ä»¥éƒ¨ç½²å¤šä¸ª Zuul èŠ‚ç‚¹ï¼Œå¹¶ä¸”éƒ½æ³¨å†Œäº Eureka ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1flx73gaco0j30o80jgq3p.jpg" alt=""></p>
<p>è¿™æ ·è™½ç„¶ç®€å•æ˜“ç»´æŠ¤ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªä¸¥é‡çš„ç¼ºç‚¹ï¼šé‚£å°±æ˜¯å®¢æˆ·ç«¯ä¹Ÿå¾—æ³¨å†Œåˆ° Eureka ä¸Šæ‰èƒ½å¯¹ Zuul çš„è°ƒç”¨åšåˆ°è´Ÿè½½ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸ç°å®çš„ã€‚</p>
<p>æ‰€ä»¥ä¸‹é¢è¿™ç§åšæ³•æ›´ä¸ºå¸¸è§ã€‚</p>
<h2 id="åŸºäº-Nginx-é«˜å¯ç”¨"><a href="#åŸºäº-Nginx-é«˜å¯ç”¨" class="headerlink" title="åŸºäº Nginx é«˜å¯ç”¨"></a>åŸºäº Nginx é«˜å¯ç”¨</h2><p>åœ¨è°ƒç”¨ Zuul ä¹‹å‰ä½¿ç”¨ Nginx ä¹‹ç±»çš„è´Ÿè½½å‡è¡¡å·¥å…·è¿›è¡Œè´Ÿè½½ï¼Œè¿™æ · Zuul æ—¢èƒ½æ³¨å†Œåˆ° Eureka ï¼Œå®¢æˆ·ç«¯ä¹Ÿèƒ½å®ç°å¯¹ Zuul çš„è´Ÿè½½ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1flx79q95c0j30o80m8757.jpg" alt=""></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™æ ·åœ¨åŸæœ‰çš„å¾®æœåŠ¡æ¶æ„çš„åŸºç¡€ä¸ŠåŠ ä¸Šç½‘å…³ä¹‹åå¦æ•´ä¸ªç³»ç»Ÿæ›´åŠ å®Œå–„äº†ï¼Œä»ç½‘å…³çš„è®¾è®¡æ¥çœ‹ï¼šå¤§å¤šæ•°ç³»ç»Ÿæ¶æ„éƒ½æœ‰åˆ†å±‚çš„æ¦‚å¿µï¼Œä¸èƒ½è§£å†³é—®é¢˜é‚£å°±å¤šåˆ†å‡ å±‚ğŸ¤“ã€‚</p>
<blockquote>
<p>é¡¹ç›®ï¼š<a href="https://github.com/crossoverJie/springboot-cloud" target="_blank" rel="external">https://github.com/crossoverJie/springboot-cloud</a></p>
<p>åšå®¢ï¼š<a href="http://crossoverjie.top">http://crossoverjie.top</a>ã€‚</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws1.sinaimg.cn/large/006tNc79gy1flrejb4pbpj30qo0cuq5s.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;çœ‹è¿‡ä¹‹å‰&lt;a href=&quot;https://crossoverjie.top/categories/sbc/&quot;&gt;SBC&lt;/a&gt;ç³»åˆ—çš„å°ä¼™ä¼´åº”è¯¥éƒ½å¯ä»¥æ­å»ºä¸€ä¸ªé«˜å¯ç”¨ã€åˆ†å¸ƒå¼çš„å¾®æœåŠ¡äº†ã€‚ ç›®å‰çš„ç»“æ„å›¾åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:&lt;br&gt;&lt;img src=&quot;https://ws1.sinaimg.cn/large/006tKfTcly1flvyjrv2unj30dc0gwaaw.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;å„ä¸ªå¾®æœåŠ¡ä¹‹é—´éƒ½ä¸å­˜åœ¨å•ç‚¹ï¼Œå¹¶ä¸”éƒ½æ³¨å†Œäº &lt;code&gt;Eureka&lt;/code&gt; ï¼ŒåŸºäºæ­¤è¿›è¡ŒæœåŠ¡çš„æ³¨å†Œäºå‘ç°ï¼Œå†é€šè¿‡ &lt;code&gt;Ribbon&lt;/code&gt; è¿›è¡ŒæœåŠ¡è°ƒç”¨ï¼Œå¹¶å…·æœ‰å®¢æˆ·ç«¯è´Ÿè½½åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€åˆ‡çœ‹èµ·æ¥éƒ½æ¯”è¾ƒç¾å¥½ï¼Œä½†è¿™é‡Œå´å¿˜äº†ä¸€ä¸ªé‡è¦çš„ç»†èŠ‚ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å½“æˆ‘ä»¬éœ€è¦å¯¹å¤–æä¾›æœåŠ¡æ—¶æ€ä¹ˆå¤„ç†ï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™å½“ç„¶ä¹Ÿèƒ½å®ç°ï¼Œæ— éå°±æ˜¯å°†æˆ‘ä»¬å…·ä½“çš„å¾®æœåŠ¡åœ°å€åŠ ç«¯å£æš´éœ²å‡ºå»å³å¯ã€‚&lt;/p&gt;
&lt;p&gt;é‚£åˆå¦‚ä½•æ¥å®ç°è´Ÿè½½å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;ç®€å•ï¼å¯ä»¥é€šè¿‡ &lt;code&gt;Nginx F5&lt;/code&gt; ä¹‹ç±»çš„å·¥å…·è¿›è¡Œè´Ÿè½½ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯å¦‚æœç³»ç»Ÿåºå¤§ï¼ŒæœåŠ¡æ‹†åˆ†çš„è¶³å¤Ÿå¤šé‚£åˆæœ‰è°æ¥ç»´æŠ¤è¿™äº›è·¯ç”±å…³ç³»å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;å½“ç„¶è¿™æ˜¯è¿ç»´çš„æ´»ï¼Œä¸è¿‡è¿™æ—¶å€™è¿ç»´å¯èƒ½å°±è¦å‘é£™äº†ï¼&lt;/p&gt;
&lt;p&gt;å¹¶ä¸”è¿˜æœ‰ä¸€ç³»åˆ—çš„é—®é¢˜:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœåŠ¡è°ƒç”¨ä¹‹é—´çš„ä¸€äº›é‰´æƒã€ç­¾åæ ¡éªŒæ€ä¹ˆåšï¼Ÿ&lt;/li&gt;
&lt;li&gt;ç”±äºæœåŠ¡ç«¯åœ°å€è¾ƒå¤šï¼Œå®¢æˆ·ç«¯è¯·æ±‚éš¾ä»¥ç»´æŠ¤ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é’ˆå¯¹äºè¿™ä¸€äº›é—®é¢˜ &lt;code&gt;SpringCloud&lt;/code&gt; å…¨å®¶æ¡¶è‡ªç„¶ä¹Ÿæœ‰å¯¹åº”çš„è§£å†³æ–¹æ¡ˆ: &lt;code&gt;Zuul&lt;/code&gt;ã€‚&lt;br&gt;å½“æˆ‘ä»¬ç³»ç»Ÿæ•´åˆ Zuul ç½‘å…³ä¹‹åæ¶æ„å›¾åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws2.sinaimg.cn/large/006tKfTcly1flw0fbfukxj30mp0icdgk.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="sbc" scheme="http://crossoverjie.top/categories/sbc/"/>
    
    
      <category term="Java" scheme="http://crossoverjie.top/tags/Java/"/>
    
      <category term="SpringBoot" scheme="http://crossoverjie.top/tags/SpringBoot/"/>
    
      <category term="SpringCloud" scheme="http://crossoverjie.top/tags/SpringCloud/"/>
    
      <category term="Zuul" scheme="http://crossoverjie.top/tags/Zuul/"/>
    
  </entry>
  
  <entry>
    <title>ã€è¯‘ã€‘ä½ å¯ä»¥ç”¨GitHubåšçš„12ä»¶ Cool äº‹æƒ…</title>
    <link href="http://crossoverjie.top/2017/11/05/translation1-12%20cool%20things%20you%20can%20do%20with%20GitHub/"/>
    <id>http://crossoverjie.top/2017/11/05/translation1-12 cool things you can do with GitHub/</id>
    <published>2017-11-04T17:01:54.000Z</published>
    <updated>2017-11-28T12:45:10.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1flef224anmj31kw0ebgnt.jpg" alt=""></p>
<h3 id="åŸæ–‡é“¾æ¥"><a href="#åŸæ–‡é“¾æ¥" class="headerlink" title="åŸæ–‡é“¾æ¥"></a><a href="https://hackernoon.com/12-cool-things-you-can-do-with-github-f3e0424cf2f0" target="_blank" rel="external">åŸæ–‡é“¾æ¥</a></h3><h2 id="1-åœ¨-GitHub-com-ç¼–è¾‘ä»£ç "><a href="#1-åœ¨-GitHub-com-ç¼–è¾‘ä»£ç " class="headerlink" title="1 åœ¨ GitHub.com ç¼–è¾‘ä»£ç "></a>1 åœ¨ GitHub.com ç¼–è¾‘ä»£ç </h2><p>æˆ‘å°†ä»æˆ‘è®¤ä¸ºå¤§å®¶éƒ½çŸ¥é“çš„ä¸€ä»¶äº‹æƒ…å¼€å§‹(å°½ç®¡æˆ‘æ˜¯ç›´åˆ°ä¸€å‘¨å‰æ‰çŸ¥é“)ã€‚</p>
<p>å½“ä½ åœ¨ GitHub æŸ¥çœ‹æ–‡ä»¶æ—¶(ä»»ä½•æ–‡æœ¬æ–‡ä»¶ï¼Œä»»ä½•ä»“åº“ä¸­)ï¼Œå³ä¸Šè§’ä¼šæœ‰ä¸€ä¸ªå°é“…ç¬”å›¾æ ‡ï¼Œç‚¹å‡»å®ƒå°±å¯ä»¥ç¼–è¾‘æ–‡ä»¶äº†ã€‚å®Œæˆä¹‹åç‚¹å‡» <strong>Propose file change</strong> æŒ‰é’® GitHub å°†ä¼šè‡ªåŠ¨å¸®ä½  fork è¯¥é¡¹ç›®å¹¶ä¸”åˆ›å»ºä¸€ä¸ª <code>pull request</code> ã€‚</p>
<p>å¾ˆå‰å®³å§ï¼ä»–è‡ªåŠ¨å¸®ä½  <code>fork</code> äº†è¯¥ repoã€‚</p>
<p>ä¸å†éœ€è¦ <code>fork</code> , <code>pull</code> ,æœ¬åœ°ç¼–è¾‘å† <code>push</code> ä»¥åŠåˆ›å»ºä¸€ä¸ª <code>PR</code> è¿™æ ·çš„æµç¨‹äº†ã€‚<br><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fl5eo3789hj30m80mjwhy.jpg" alt=""></p>
<p>è¿™éå¸¸é€‚åˆä¿®å¤ç¼–å†™ä»£ç ä¸­å‡ºç°çš„æ‹¼å†™é”™è¯¯å’Œä¿®æ­£ä¸€ä¸ªä¸å¤ªç†æƒ³çš„æƒ³æ³•ã€‚</p>
<h2 id="2-ç²˜è´´å›¾ç‰‡"><a href="#2-ç²˜è´´å›¾ç‰‡" class="headerlink" title="2 ç²˜è´´å›¾ç‰‡"></a>2 ç²˜è´´å›¾ç‰‡</h2><p>ä½ ä¸ä»…ä»…å—é™äºè¾“å…¥æ–‡æœ¬å’Œæè¿°é—®é¢˜ï¼Œä½ çŸ¥é“ä½ å¯ä»¥ç›´æ¥ä»ç²˜è´´æ¿ä¸­ç²˜è´´å›¾ç‰‡å—ï¼Ÿå½“ä½ ç²˜è´´æ—¶ï¼Œä½ ä¼šçœ‹åˆ°å›¾ç‰‡å·²ç»è¢«ä¸Šä¼ äº†(æ¯«æ— ç–‘é—®è¢«ä¸Šä¼ åˆ°äº‘ç«¯)ä¹‹åä¼šå˜æˆ <code>Markdown</code> è¯­æ³•æ¥æ˜¾ç¤ºå›¾ç‰‡ã€‚</p>
<h2 id="3-æ ¼å¼åŒ–ä»£ç "><a href="#3-æ ¼å¼åŒ–ä»£ç " class="headerlink" title="3 æ ¼å¼åŒ–ä»£ç "></a>3 æ ¼å¼åŒ–ä»£ç </h2><p>å¦‚æœä½ æƒ³å†™ä¸€æ®µä»£ç ï¼Œä½ å¯ä»¥ä¸‰ä¸ªåå¼•å·å¼€å§‹ â€”â€” å°±åƒä½ åœ¨<a href="https://guides.github.com/features/mastering-markdown/" target="_blank" rel="external">ç ”ç©¶<code>MarkDown</code></a>æ—¶æ‰€å­¦åˆ°çš„ â€”â€” ä¹‹å GitHub ä¼šè¯•ç€çŒœæµ‹ä½ å†™çš„è¯­è¨€ã€‚</p>
<p>ä½†å¦‚æœä½ å†™äº†ä¸€äº›ç±»ä¼¼äº Vue, Typescript, JSX è¿™æ ·çš„è¯­è¨€ï¼Œä½ å¯ä»¥æ˜ç¡®æŒ‡å®šå¾—åˆ°æ­£ç¡®çš„é«˜äº®ã€‚</p>
<p>æ³¨æ„ç¬¬ä¸€è¡Œä¸­çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">```jsx</div></pre></td></tr></table></figure></p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fl5fe2vu3rj30b607kq39.jpg" alt=""></p>
<a id="more"></a>
<p>è¿™æ„å‘³ç€ä»£ç æ®µå°†ä¼šå‘ˆç°å‡º:</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fl5ffl8q7sj30bz06gq36.jpg" alt=""></p>
<p>(è¿™ä¸ªæ‰©å±•äº <code>gists</code> ã€‚é¡ºä¾¿è¯´ä¸€å¥ï¼Œå¦‚æœä½ ä½¿ç”¨ <code>.jsx</code> åç¼€ï¼Œå°±ä¼šå¾—åˆ°JSXçš„è¯­æ³•é«˜äº®)</p>
<p>è¿™æ˜¯ä¸€ä¸ªæ‰€æœ‰å—æ”¯æŒçš„<a href="https://github.com/github/linguist/blob/fc1404985abb95d5bc33a0eba518724f1c3c252e/vendor/README.md" target="_blank" rel="external">è¯­æ³•åˆ—è¡¨</a>ã€‚</p>
<h2 id="4-åœ¨-PR-ä¸­ç”¨å…³é”®è¯å…³é—­-Issues"><a href="#4-åœ¨-PR-ä¸­ç”¨å…³é”®è¯å…³é—­-Issues" class="headerlink" title="4 åœ¨ PR ä¸­ç”¨å…³é”®è¯å…³é—­ Issues"></a>4 åœ¨ PR ä¸­ç”¨å…³é”®è¯å…³é—­ Issues</h2><p>å‡è®¾ä½ åˆ›å»ºäº†ä¸€ä¸ªç”¨äºä¿®å¤ <code>Issues #234</code> çš„ PR ,ä½ å¯ä»¥åœ¨ä½  PR çš„æè¿°ä¸­å¡«å†™ <code>fixes #234</code> (æˆ–æ˜¯åœ¨ä½  PR ä»»æ„è¯„è®ºä¸­å¡«å†™éƒ½æ˜¯å¯ä»¥çš„)ã€‚<br>ä¹‹ååˆå¹¶è¿™ä¸ª <code>PR</code> æ—¶å°†ä¼šè‡ªåŠ¨å…³é—­å¡«å†™çš„ <code>Issues</code>ã€‚æ€ä¹ˆæ ·,å¾ˆ cool å§ã€‚</p>
<p>äº†è§£æ˜¯æ›´å¤šç›¸å…³çš„<a href="https://help.github.com/articles/closing-issues-using-keywords/" target="_blank" rel="external">å†…å®¹</a>ã€‚</p>
<h2 id="5-é“¾æ¥åˆ°è¯„è®º"><a href="#5-é“¾æ¥åˆ°è¯„è®º" class="headerlink" title="5 é“¾æ¥åˆ°è¯„è®º"></a>5 é“¾æ¥åˆ°è¯„è®º</h2><p>ä½ æ˜¯å¦æœ‰è¿‡æƒ³è¦é“¾æ¥åˆ°ç‰¹æ®Š <code>comment</code> çš„æƒ³æ³•ä½†å´æ— æ³•å®ç°ï¼Ÿé‚£æ˜¯å› ä¸ºä½ ä¸çŸ¥é“æ€ä¹ˆåšã€‚æœ‹å‹é‚£éƒ½æ˜¯è¿‡å»å¼äº†ï¼Œç°åœ¨æˆ‘å°±å‘Šè¯‰ä½ ï¼Œç‚¹å‡»ç”¨æˆ·åæ—è¾¹çš„æ—¥æœŸ/æ—¶é—´å³å¯é“¾æ¥åˆ°è¯¥ <code>comment</code> ã€‚</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fl69xkm5rtj30d003zq37.jpg" alt=""></p>
<h2 id="6-é“¾æ¥åˆ°ä»£ç "><a href="#6-é“¾æ¥åˆ°ä»£ç " class="headerlink" title="6 é“¾æ¥åˆ°ä»£ç "></a>6 é“¾æ¥åˆ°ä»£ç </h2><p>æˆ‘çŸ¥é“ä½ æƒ³é“¾æ¥åˆ°å…·ä½“çš„ä»£ç è¡Œä¸Šã€‚</p>
<p>å°è¯•:æŸ¥çœ‹æ–‡ä»¶æ—¶ï¼Œç‚¹å‡»ä»£ç æ—è¾¹çš„è¡Œå·ã€‚</p>
<p>çœ‹åˆ°äº†å§ï¼Œæµè§ˆå™¨çš„ <code>URL</code> å·²ç»è¢«æ›´æ–°ä¸ºè¡Œå·äº†ã€‚å¦‚æœä½ æŒ‰ä½ <code>shift</code>,åŒæ—¶ç‚¹å‡»å…¶ä»–è¡Œå·ï¼Œ<code>URL</code> å†æ¬¡è¢«æ›´æ–°ï¼Œå¹¶ä¸”ä½ ä¹Ÿé«˜äº®æ˜¾ç¤ºé¡µé¢ä¸­çš„ä¸€æ®µä»£ç ã€‚</p>
<p>åˆ†äº«è¿™ä¸ª URL ï¼Œè®¿é—®æ—¶å°†ä¼šé“¾æ¥åˆ°è¯¥æ–‡ä»¶å·²ç»é€‰ä¸­çš„é‚£äº›ä»£ç æ®µã€‚</p>
<p>ä½†ç­‰ä¸€ä¸‹ï¼Œé‚£æŒ‡å‘çš„æ˜¯å½“å‰çš„åˆ†æ”¯ï¼Œå¦‚æœæ–‡ä»¶å‘ç”Ÿäº†æ”¹å˜å‘¢ï¼Ÿä¹Ÿè®¸ä¸€ä¸ªåœ¨å½“å‰çŠ¶æ€è¿æ¥åˆ°æ–‡ä»¶çš„æ°¸ä¹…è¿æ¥æ­£æ˜¯ä½ æƒ³è¦çš„ã€‚</p>
<p>æˆ‘å¾ˆæ‡’ï¼Œæ‰€ä»¥ç”¨ä¸€å¼ æˆªå›¾å±•ç¤ºä»¥ä¸Šçš„æ‰€æœ‰æ“ä½œã€‚</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fl6lw7ji6uj30m80a6mym.jpg" alt=""></p>
<p>è°ˆåˆ°ç½‘å€ã€‚ã€‚ã€‚</p>
<h2 id="7-åƒå‘½ä»¤è¡Œä¸€æ ·ä½¿ç”¨-GitHub-é“¾æ¥"><a href="#7-åƒå‘½ä»¤è¡Œä¸€æ ·ä½¿ç”¨-GitHub-é“¾æ¥" class="headerlink" title="7 åƒå‘½ä»¤è¡Œä¸€æ ·ä½¿ç”¨ GitHub é“¾æ¥"></a>7 åƒå‘½ä»¤è¡Œä¸€æ ·ä½¿ç”¨ GitHub é“¾æ¥</h2><p>ä½¿ç”¨ GitHub è‡ªå¸¦çš„ UI æµè§ˆä¹Ÿè¿˜ä¸é”™ï¼Œä½†æœ‰æ—¶ç›´æ¥åœ¨ URL ä¸­è¾“å…¥æ˜¯æœ€å¿«çš„æ–¹æ³•ã€‚æ¯”å¦‚ï¼Œæˆ‘æƒ³è·³è½¬åˆ°æˆ‘æ­£åœ¨ç¼–è¾‘çš„åˆ†æ”¯å¹¶å’Œ <code>master</code> è¿›è¡Œå¯¹æ¯”ï¼Œå°±å¯ä»¥åœ¨é¡¹ç›®åç§°åé¢æ¥ä¸Š <code>/compare/branch-name</code> ã€‚</p>
<p>ä¸é€‰ä¸­åˆ†æ”¯çš„å¯¹æ¯”é¡µå°†ä¼šæ˜¾ç¤ºå‡ºæ¥:<br><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fl8rqb8egpj30u50pbaea.jpg" alt=""></p>
<p>ä»¥ä¸Šå°±æ˜¯å’Œ master åˆ†æ”¯çš„å·®å¼‚ï¼Œå¦‚æœæƒ³è¦åˆå¹¶åˆ†æ”¯çš„è¯ï¼Œåªéœ€è¦è¾“å…¥ <code>/compare/integration-branch...my-branch</code> å³å¯ã€‚</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fl8s3yraqrj30u50pbgpx.jpg" alt=""></p>
<p>ä½ è¿˜å¯ä»¥åˆ©ç”¨å¿«æ·é”®è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä½¿ç”¨ <code>ctrl + L</code> æˆ–è€… <code>cmd + L</code> å¯ä»¥å°†å…‰æ ‡ç§»åŠ¨åˆ° <code>URL</code> ä¸Š(è‡³å°‘åœ¨ Chrome ä¸­å¯ä»¥)ã€‚ åŠ ä¸Šæµè§ˆå™¨çš„è‡ªåŠ¨è¡¥å…¨ â€”â€” ä½ å°±å¯ä»¥åœ¨ä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´è½»æ¾åˆ‡æ¢äº†ã€‚</p>
<h2 id="8-åœ¨Issuesåˆ›å»ºåˆ—è¡¨"><a href="#8-åœ¨Issuesåˆ›å»ºåˆ—è¡¨" class="headerlink" title="8 åœ¨Issuesåˆ›å»ºåˆ—è¡¨"></a>8 åœ¨Issuesåˆ›å»ºåˆ—è¡¨</h2><p>ä½ æƒ³åœ¨ä½ çš„ issue ä¸­çœ‹åˆ°å¤é€‰æ¡†åˆ—è¡¨å—?</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1fl8snpyb0jj30e708sdgl.jpg" alt=""></p>
<p>ä½ æƒ³åœ¨æŸ¥çœ‹ issue åˆ—è¡¨æ˜¯å®ƒä»¬ä»¥å¥½çœ‹çš„ <code>2 of 5</code> è¿›åº¦æ¡å‘ˆç°å—ï¼Ÿ</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1fl8u3bn88hj30dn06jdg9.jpg" alt=""></p>
<p>å¤ªå¥½äº†ï¼ä½ å¯ä»¥ç”¨ä»¥ä¸‹è¯­æ³•æ¥åˆ›å»ºä¸€ä¸ªäº¤äº’æ€§çš„å¤é€‰æ¡†:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- [ ] Screen width (integer)</div><div class="line">- [x] Service worker support</div><div class="line">- [x] Fetch support</div><div class="line">- [ ] CSS flexbox support</div><div class="line">- [ ] Custom elements</div></pre></td></tr></table></figure>
<p>æ˜¯ç”±ä¸€ä¸ªç©ºæ ¼ã€ä¸­æ¨ªçº¿ã€ç©ºæ ¼ã€å·¦æ‹¬å·ã€ç©ºæ ¼(æˆ–è€…æ˜¯ X )ã€å³æ‹¬å·ã€ç©ºæ ¼ä»¥åŠä¸€äº›æ–‡æœ¬ç»„æˆã€‚</p>
<p>ä½ ç”šè‡³å¯ä»¥çœŸæ­£çš„ é€‰ä¸­/å–æ¶ˆ è¿™äº›å¤é€‰æ¡†ï¼åŸºäºæŸäº›åŸå› ï¼Œå¯¹äºæˆ‘æ¥è¯´ä½ çœ‹èµ·æ¥åƒæ˜¯æŠ€æœ¯é­”åŠ›ã€‚æ˜¯çœŸçš„èƒ½å¤Ÿé€‰ä¸­è¿™äº›å¤é€‰æ¡†ï¼ç”šè‡³å®ƒè¿˜æ›´æ–°äº†åº•å±‚æºç ã€‚</p>
<blockquote>
<p>psï¼šä»¥ä¸‹åŒ…æ‹¬ç¬¬ä¹ç‚¹ åŸºäºGitHubçš„é¡¹ç›®é¢æ¿ ç”±äºç”¨çš„ä¸å¤šå°±æ²¡æœ‰ç¿»è¯‘ã€‚</p>
</blockquote>
<h2 id="10-GitHub-wiki"><a href="#10-GitHub-wiki" class="headerlink" title="10 GitHub wiki"></a>10 GitHub wiki</h2><p>ä½œä¸ºä¸€ä¸ªåƒç»´åŸºç™¾ç§‘é‚£æ ·çš„éç»“æ„åŒ–çš„é¡µé¢é›†åˆï¼Œ <code>GitHub Wiki</code>çš„ä¾›ç»™(æˆ‘æŠŠå®ƒç§°ä¹‹ä¸º <code>Gwiki</code> ) æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„åŠŸèƒ½ã€‚</p>
<p>å¯¹äºç»“æ„åŒ–çš„é¡µé¢æ¥è¯´ â€”â€” ä¾‹å¦‚ä½ çš„æ–‡æ¡£ï¼šä¸èƒ½è¯´è¿™ä¸ªé¡µé¢æ˜¯å…¶ä»–é¡µé¢çš„å­é¡µé¢ï¼Œæˆ–åˆ™æ˜¯æœ‰ â€œä¸‹ä¸€èŠ‚â€ï¼Œâ€œä¸Šä¸€èŠ‚â€ è¿™æ ·çš„ä¾¿æ·æŒ‰é’®ã€‚å¹¶ä¸” <code>Hansel</code> å’Œ <code>Gretel</code> ä¹Ÿæ²¡æœ‰ï¼Œå› ä¸ºç»“æ„åŒ–é¡µé¢å¹¶æ²¡æœ‰ <code>breadcrumbs</code> è¿™æ ·çš„è®¾è®¡ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­ï¼Œè®© Gwiki åŠ¨èµ·æ¥ï¼Œæˆ‘ä» <code>NodeJS</code> çš„æ–‡æ¡£ä¸­å¤åˆ¶äº†å‡ é¡µæ¥ä½œä¸º wiki é¡µé¢ã€‚ç„¶ååˆ›å»ºäº†ä¸€ä¸ªè‡ªå®šä¹‰ä¾§è¾¹æ ï¼Œå¸®åŠ©æˆ‘æ›´å¥½åœ°æ¨¡æ‹Ÿä¸€äº›å®é™…çš„ç›®å½•ç»“æ„ã€‚å°½ç®¡å®ƒä¸ä¼šçªå‡ºæ˜¾ç¤ºä½ å½“å‰çš„é¡µé¢ä½ç½®ï¼Œä½†ä¾§è¾¹æ ä¼šä¸€ç›´å­˜åœ¨ã€‚</p>
<p>è¿™äº›é“¾æ¥éœ€è¦ä½ æ‰‹åŠ¨ç»´æŠ¤ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œæˆ‘è®¤ä¸ºå®ƒå¯ä»¥åšå¾—å¾ˆå¥½ã€‚ å¦‚æœéœ€è¦çš„è¯å¯ä»¥<a href="https://github.com/davidgilbertson/about-github/wiki" target="_blank" rel="external">çœ‹çœ‹</a>ã€‚</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fl9yl6mhlzj30rw0dqwgn.jpg" alt=""></p>
<p>è™½ç„¶å®ƒä¸ <code>GitBook</code> ( <a href="http://redux.js.org/" target="_blank" rel="external">Redux æ–‡æ¡£</a>æ‰€ä½¿ç”¨çš„)æˆ–è€…æ˜¯å®šåˆ¶ç½‘ç«™ç›¸æ¯”ä»æœ‰å·®è·ã€‚ä½†åœ¨ä½ çš„ repo ä¸­å®ƒæœ‰ 80% å®Œå…¨å€¼å¾—ä¿¡èµ–çš„ã€‚</p>
<p>æˆ‘çš„å»ºè®®æ˜¯: å¦‚æœä½ å·²ç»æœ‰å¤šä¸ª <code>README.md</code> æ–‡ä»¶ï¼Œå¹¶ä¸”æƒ³è¦ä¸€äº›å…³äºç”¨æˆ·æŒ‡å—æˆ–æ›´è¯¦ç»†çš„æ–‡æ¡£çš„ä¸åŒçš„é¡µé¢ï¼Œé‚£ä¹ˆä½ åº”è¯¥é€‰æ‹© <code>Gwiki</code>ã€‚</p>
<p>å¦‚æœç¼ºä¹ç»“æ„åŒ–/å¯¼èˆªå¼€å§‹è®©ä½ ä¸çˆ½çš„è¯ï¼Œé‚£å°±è¯•è¯•å…¶ä»–çš„å§ã€‚</p>
<h2 id="11-GitHub-Pages"><a href="#11-GitHub-Pages" class="headerlink" title="11 GitHub Pages"></a>11 GitHub Pages</h2><p>ä½ å¯èƒ½å·²ç»çŸ¥é“ä½¿ç”¨ <code>GitHub Pages</code> æ¥æ‰˜ç®¡ä¸€ä¸ªé™æ€ç½‘ç«™ã€‚å¦‚æœä½ ä¸çŸ¥é“ï¼Œç°åœ¨å°±æ¥å­¦ä¹ ï¼Œè¿™ä¸€èŠ‚æ˜¯ä¸“é—¨ç”¨äºè®¨è®ºä½¿ç”¨ <code>Jekyll</code> æ¥æ„å»ºä¸€ä¸ªç«™ç‚¹çš„ã€‚</p>
<p>æœ€ç®€å•çš„å°±æ˜¯ï¼š <code>GitHub Pages + Jekyll</code>ä¼šé€šè¿‡ä¸€ä¸ªæ¼‚äº®çš„ä¸»é¢˜æ¥æ¸²æŸ“ä½ çš„ <code>README.md</code> æ–‡ä»¶ã€‚ä¾‹å¦‚:é€šè¿‡ <a href="https://github.com/davidgilbertson/about-github" target="_blank" rel="external">about-github</a>  æ¥æŸ¥çœ‹çš„æˆ‘çš„ <code>README</code> é¡µé¢ã€‚</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fle60d5j7hj311l0np78i.jpg" alt=""></p>
<p>å¦‚æœæˆ‘åœ¨ GitHub ä¸­ç‚¹å‡»äº† <code>settings</code>é€‰é¡¹ï¼Œåˆ‡æ¢åˆ° <code>Github Pages</code> è®¾ç½®ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ª <code>Jekyll theme</code>ã€‚ã€‚ã€‚</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fle73empc8j30l30bcdh1.jpg" alt=""></p>
<p>æˆ‘å°±å¯ä»¥å¾—åˆ° <a href="https://davidgilbertson.github.io/about-github/" target="_blank" rel="external">Jekyll-themed é¡µé¢</a>ã€‚</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fle74nogxlj311l0npgos.jpg" alt=""></p>
<p>ä»è¿™ç‚¹ä¸Šæˆ‘å¯ä»¥ä¸»è¦ä¾æ®æ˜“ç¼–è¾‘çš„ <code>Markdown</code> æ–‡ä»¶æ¥æ„å»ºä¸€ä¸ªå®Œæ•´çš„é™æ€ç«™ç‚¹ã€‚æœ¬è´¨ä¸Šæ˜¯æŠŠ GitHub å˜æˆäº† <code>CMS</code>ã€‚</p>
<p>è™½ç„¶æˆ‘æ²¡æœ‰å®é™…ä½¿ç”¨è¿‡ï¼Œä½†æ˜¯ <code>React Bootstrap</code> çš„ç½‘ç«™éƒ½æ˜¯ä½¿ç”¨å®ƒæ¥æ„å»ºçš„ã€‚æ‰€ä»¥å®ƒä¸ä¼šç³Ÿç³•ã€‚</p>
<p>æ³¨æ„:å®ƒè¦æ±‚ <code>Ruby</code> è¿è¡Œæœ¬åœ°ç¯å¢ƒ( Windows è‡ªè¡Œå®‰è£…ï¼Œ macOS è‡ªå¸¦)ã€‚</p>
<h2 id="12-æŠŠ-GitHub-å½“åš-CRM-ä½¿ç”¨"><a href="#12-æŠŠ-GitHub-å½“åš-CRM-ä½¿ç”¨" class="headerlink" title="12 æŠŠ GitHub å½“åš CRM ä½¿ç”¨"></a>12 æŠŠ GitHub å½“åš CRM ä½¿ç”¨</h2><p>å‡è®¾ä½ æœ‰ä¸€ä¸ªå­˜æœ‰ä¸€äº›æ–‡æœ¬å†…å®¹çš„ç½‘ç«™ï¼Œä½ ä¸æƒ³å°†æ–‡æœ¬å†…å®¹å­˜å‚¨äºçœŸæ­£çš„ <code>HTML</code> æºç ä¸­ã€‚</p>
<p>ç›¸åçš„ï¼Œä½ æƒ³è¦å°†è¿™äº›æ–‡æœ¬å—å­˜å‚¨äºéå¼€å‘äººå‘˜èƒ½è½»æ¾çš„è¿›è¡Œç¼–è¾‘çš„åœ°æ–¹ã€‚å¯èƒ½æ˜¯ä¸€ä¸ªç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œç”šè‡³æ˜¯ä¸€ä¸ªå®¡æ ¸æµç¨‹ã€‚</p>
<p>æˆ‘çš„å»ºè®®æ˜¯:ä½¿ç”¨ GitHub å‚åº“ä¸­çš„ Markdown æ–‡ä»¶æ¥å­˜å‚¨è¿™äº›æ–‡æœ¬å†…å®¹ï¼Œç„¶åä½¿ç”¨å‰ç«¯ç»„ä»¶æ¥æ‹‰å–è¿™äº›æ–‡æœ¬å—å¹¶å±•ç¤ºåœ¨é¡µé¢ä¸Šã€‚</p>
<p>æˆ‘æ˜¯æ <code>React</code> çš„ï¼Œæ‰€ä»¥è¿™æœ‰ä¸€ä¸ª è§£æ <code>Markdown</code> çš„ç»„ä»¶ä¾‹å­ï¼Œç»™å®šä¸€äº› <code>Markdown</code> æ–‡ä»¶è·¯å¾„ï¼Œå®ƒå°†ä¼šè‡ªåŠ¨æ‹‰å–å¹¶ä½œä¸º <code>HTML</code> æ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">class Markdown extends React.Component &#123;</div><div class="line">    constructor(props) &#123;</div><div class="line">      super(props);</div><div class="line">      </div><div class="line">      // replace with your URL, obviously</div><div class="line">      this.baseUrl = &apos;https://raw.githubusercontent.com/davidgilbertson/about-github/master/text-snippets&apos;;</div><div class="line">      </div><div class="line">      this.state = &#123;</div><div class="line">        markdown: &apos;&apos;,</div><div class="line">      &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    componentDidMount() &#123;</div><div class="line">      fetch(`$&#123;this.baseUrl&#125;/$&#123;this.props.url&#125;`)</div><div class="line">        .then(response =&gt; response.text())</div><div class="line">        .then((markdown) =&gt; &#123;</div><div class="line">          this.setState(&#123;markdown&#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    render() &#123;</div><div class="line">      return (</div><div class="line">        &lt;div dangerouslySetInnerHTML=&#123;&#123;__html: marked(this.state.markdown)&#125;&#125; /&gt;</div><div class="line">      );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å¥–åŠ±ç¯èŠ‚-â€”â€”-GitHub-å·¥å…·"><a href="#å¥–åŠ±ç¯èŠ‚-â€”â€”-GitHub-å·¥å…·" class="headerlink" title="å¥–åŠ±ç¯èŠ‚ â€”â€” GitHub å·¥å…·"></a>å¥–åŠ±ç¯èŠ‚ â€”â€” GitHub å·¥å…·</h3><p>æˆ‘å·²ç»ä½¿ç”¨äº† <a href="https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc?hl=en-US" target="_blank" rel="external">Octotree Chrome extension</a> æœ‰æ®µæ—¶é—´äº†ï¼Œç°åœ¨æˆ‘å‘å¤§å®¶æ¨èå®ƒï¼<br>æ— è®ºä½ æ˜¯åœ¨æŸ¥çœ‹å“ªä¸ª repo å®ƒéƒ½ä¼šåœ¨å·¦ä¾§ç»™ä½ ä¸€ä¸ªæ ‘çŠ¶é¢æ¿ã€‚</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1flee4cevv3j30rs0hygnv.jpg" alt=""></p>
<p>é€šè¿‡è¿™ä¸ª<a href="https://www.youtube.com/watch?v=NhlzMcSyQek&amp;index=2&amp;list=PLNYkxOF6rcIB3ci6nwNyLYNU6RDOU3YyL" target="_blank" rel="external">è§†é¢‘</a>æˆ‘äº†è§£åˆ°äº† octoboxï¼Œå®ƒæ˜¯ç”¨äºç®¡ç†ä½ çš„ <code>GitHub Issues</code> æ”¶ä»¶ç®±ï¼Œçœ‹èµ·æ¥ç›¸å½“ä¸é”™ï¼<br>ä»¥ä¸Šå°±æ˜¯æˆ‘é’ˆå¯¹äº<code>octobox</code>çš„å…¨éƒ¨æƒ³æ³•ã€‚</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>å°±æ˜¯è¿™æ ·äº†ï¼æˆ‘å¸Œæœ›è¿™é‡Œè‡³å°‘æœ‰ä¸‰ä»¶äº‹æ˜¯ä½ è¿˜ä¸çŸ¥é“çš„ã€‚</p>
<p>æœ€å: hava a nice dayï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws3.sinaimg.cn/large/006tNc79ly1flef224anmj31kw0ebgnt.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h3 id=&quot;åŸæ–‡é“¾æ¥&quot;&gt;&lt;a href=&quot;#åŸæ–‡é“¾æ¥&quot; class=&quot;headerlink&quot; title=&quot;åŸæ–‡é“¾æ¥&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://hackernoon.com/12-cool-things-you-can-do-with-github-f3e0424cf2f0&quot;&gt;åŸæ–‡é“¾æ¥&lt;/a&gt;&lt;/h3&gt;&lt;h2 id=&quot;1-åœ¨-GitHub-com-ç¼–è¾‘ä»£ç &quot;&gt;&lt;a href=&quot;#1-åœ¨-GitHub-com-ç¼–è¾‘ä»£ç &quot; class=&quot;headerlink&quot; title=&quot;1 åœ¨ GitHub.com ç¼–è¾‘ä»£ç &quot;&gt;&lt;/a&gt;1 åœ¨ GitHub.com ç¼–è¾‘ä»£ç &lt;/h2&gt;&lt;p&gt;æˆ‘å°†ä»æˆ‘è®¤ä¸ºå¤§å®¶éƒ½çŸ¥é“çš„ä¸€ä»¶äº‹æƒ…å¼€å§‹(å°½ç®¡æˆ‘æ˜¯ç›´åˆ°ä¸€å‘¨å‰æ‰çŸ¥é“)ã€‚&lt;/p&gt;
&lt;p&gt;å½“ä½ åœ¨ GitHub æŸ¥çœ‹æ–‡ä»¶æ—¶(ä»»ä½•æ–‡æœ¬æ–‡ä»¶ï¼Œä»»ä½•ä»“åº“ä¸­)ï¼Œå³ä¸Šè§’ä¼šæœ‰ä¸€ä¸ªå°é“…ç¬”å›¾æ ‡ï¼Œç‚¹å‡»å®ƒå°±å¯ä»¥ç¼–è¾‘æ–‡ä»¶äº†ã€‚å®Œæˆä¹‹åç‚¹å‡» &lt;strong&gt;Propose file change&lt;/strong&gt; æŒ‰é’® GitHub å°†ä¼šè‡ªåŠ¨å¸®ä½  fork è¯¥é¡¹ç›®å¹¶ä¸”åˆ›å»ºä¸€ä¸ª &lt;code&gt;pull request&lt;/code&gt; ã€‚&lt;/p&gt;
&lt;p&gt;å¾ˆå‰å®³å§ï¼ä»–è‡ªåŠ¨å¸®ä½  &lt;code&gt;fork&lt;/code&gt; äº†è¯¥ repoã€‚&lt;/p&gt;
&lt;p&gt;ä¸å†éœ€è¦ &lt;code&gt;fork&lt;/code&gt; , &lt;code&gt;pull&lt;/code&gt; ,æœ¬åœ°ç¼–è¾‘å† &lt;code&gt;push&lt;/code&gt; ä»¥åŠåˆ›å»ºä¸€ä¸ª &lt;code&gt;PR&lt;/code&gt; è¿™æ ·çš„æµç¨‹äº†ã€‚&lt;br&gt;&lt;img src=&quot;https://ws3.sinaimg.cn/large/006tKfTcgy1fl5eo3789hj30m80mjwhy.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;è¿™éå¸¸é€‚åˆä¿®å¤ç¼–å†™ä»£ç ä¸­å‡ºç°çš„æ‹¼å†™é”™è¯¯å’Œä¿®æ­£ä¸€ä¸ªä¸å¤ªç†æƒ³çš„æƒ³æ³•ã€‚&lt;/p&gt;
&lt;h2 id=&quot;2-ç²˜è´´å›¾ç‰‡&quot;&gt;&lt;a href=&quot;#2-ç²˜è´´å›¾ç‰‡&quot; class=&quot;headerlink&quot; title=&quot;2 ç²˜è´´å›¾ç‰‡&quot;&gt;&lt;/a&gt;2 ç²˜è´´å›¾ç‰‡&lt;/h2&gt;&lt;p&gt;ä½ ä¸ä»…ä»…å—é™äºè¾“å…¥æ–‡æœ¬å’Œæè¿°é—®é¢˜ï¼Œä½ çŸ¥é“ä½ å¯ä»¥ç›´æ¥ä»ç²˜è´´æ¿ä¸­ç²˜è´´å›¾ç‰‡å—ï¼Ÿå½“ä½ ç²˜è´´æ—¶ï¼Œä½ ä¼šçœ‹åˆ°å›¾ç‰‡å·²ç»è¢«ä¸Šä¼ äº†(æ¯«æ— ç–‘é—®è¢«ä¸Šä¼ åˆ°äº‘ç«¯)ä¹‹åä¼šå˜æˆ &lt;code&gt;Markdown&lt;/code&gt; è¯­æ³•æ¥æ˜¾ç¤ºå›¾ç‰‡ã€‚&lt;/p&gt;
&lt;h2 id=&quot;3-æ ¼å¼åŒ–ä»£ç &quot;&gt;&lt;a href=&quot;#3-æ ¼å¼åŒ–ä»£ç &quot; class=&quot;headerlink&quot; title=&quot;3 æ ¼å¼åŒ–ä»£ç &quot;&gt;&lt;/a&gt;3 æ ¼å¼åŒ–ä»£ç &lt;/h2&gt;&lt;p&gt;å¦‚æœä½ æƒ³å†™ä¸€æ®µä»£ç ï¼Œä½ å¯ä»¥ä¸‰ä¸ªåå¼•å·å¼€å§‹ â€”â€” å°±åƒä½ åœ¨&lt;a href=&quot;https://guides.github.com/features/mastering-markdown/&quot;&gt;ç ”ç©¶&lt;code&gt;MarkDown&lt;/code&gt;&lt;/a&gt;æ—¶æ‰€å­¦åˆ°çš„ â€”â€” ä¹‹å GitHub ä¼šè¯•ç€çŒœæµ‹ä½ å†™çš„è¯­è¨€ã€‚&lt;/p&gt;
&lt;p&gt;ä½†å¦‚æœä½ å†™äº†ä¸€äº›ç±»ä¼¼äº Vue, Typescript, JSX è¿™æ ·çš„è¯­è¨€ï¼Œä½ å¯ä»¥æ˜ç¡®æŒ‡å®šå¾—åˆ°æ­£ç¡®çš„é«˜äº®ã€‚&lt;/p&gt;
&lt;p&gt;æ³¨æ„ç¬¬ä¸€è¡Œä¸­çš„&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;```jsx&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://ws1.sinaimg.cn/large/006tKfTcgy1fl5fe2vu3rj30b607kq39.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ç¿»è¯‘" scheme="http://crossoverjie.top/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
      <category term="GitHub" scheme="http://crossoverjie.top/tags/GitHub/"/>
    
  </entry>
  
  <entry>
    <title>SSM(åä¸ƒ) MQåº”ç”¨</title>
    <link href="http://crossoverjie.top/2017/10/20/SSM17/"/>
    <id>http://crossoverjie.top/2017/10/20/SSM17/</id>
    <published>2017-10-19T17:01:54.000Z</published>
    <updated>2017-11-01T18:18:10.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fkpzk7hcz4j31kw11xhbz.jpg" alt=""></p>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å†™è¿™ç¯‡æ–‡ç« çš„èµ·å› æ˜¯ç”±äºä¹‹å‰çš„ä¸€ç¯‡å…³äº<code>Kafka</code><a href="http://crossoverjie.top/2017/09/05/SSM16/">å¼‚å¸¸æ¶ˆè´¹</a>ï¼Œå½“æ—¶ä¸ºäº†è§£å†³é—®é¢˜ä¸å¾—ä¸ä½¿ç”¨ä¸´æ—¶çš„æ–¹æ¡ˆã€‚</p>
<p>æ€»ç»“èµ·æ¥å½’æ ¹ç»“åº•è¿˜æ˜¯å¯¹Kafkaä¸ç†Ÿæ‚‰å¯¼è‡´çš„ï¼ŒåŠ ä¸Šå¹³æ—¶å·¥ä½œçš„éœ€è¦ï¼Œä¹‹åå°±èŠ±äº›æ—¶é—´çœ‹äº†<code>Kafka</code>ç›¸å…³çš„èµ„æ–™ã€‚</p>
<h1 id="ä½•æ—¶ä½¿ç”¨MQ"><a href="#ä½•æ—¶ä½¿ç”¨MQ" class="headerlink" title="ä½•æ—¶ä½¿ç”¨MQ"></a>ä½•æ—¶ä½¿ç”¨MQ</h1><p>è°ˆåˆ°<code>Kafka</code>å°±ä¸å¾—ä¸æåˆ°MQï¼Œæ˜¯å±äºæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€ç§ã€‚ä½œä¸ºä¸€ç§åŸºç¡€ä¸­é—´ä»¶åœ¨äº’è”ç½‘é¡¹ç›®ä¸­æœ‰ç€å¤§é‡çš„ä½¿ç”¨ã€‚</p>
<p>ä¸€ç§æŠ€æœ¯çš„äº§ç”Ÿè‡ªç„¶æ˜¯ä¸ºäº†è§£å†³æŸç§éœ€æ±‚ï¼Œé€šå¸¸æ¥è¯´æ˜¯ä»¥ä¸‹åœºæ™¯ï¼š</p>
<blockquote>
<ul>
<li>éœ€è¦è·¨è¿›ç¨‹é€šä¿¡ï¼šBç³»ç»Ÿéœ€è¦Aç³»ç»Ÿçš„è¾“å‡ºä½œä¸ºè¾“å…¥å‚æ•°ã€‚</li>
<li>å½“Aç³»ç»Ÿçš„è¾“å‡ºèƒ½åŠ›è¿œè¿œå¤§äºBç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ã€‚</li>
</ul>
</blockquote>
<p>é’ˆå¯¹äºç¬¬ä¸€ç§æƒ…å†µæœ‰ä¸¤ç§æ–¹æ¡ˆ:</p>
<ul>
<li>ä½¿ç”¨<code>RPC</code>è¿œç¨‹è°ƒç”¨,Aç›´æ¥è°ƒç”¨Bã€‚</li>
<li>ä½¿ç”¨<code>MQ</code>,Aå‘å¸ƒæ¶ˆæ¯åˆ°<code>MQ</code>,Bè®¢é˜…è¯¥æ¶ˆæ¯ã€‚</li>
</ul>
<p>å½“æˆ‘ä»¬çš„éœ€æ±‚æ˜¯:Aè°ƒç”¨Bå®æ—¶å“åº”ï¼Œå¹¶ä¸”å®æ—¶å…³å¿ƒå“åº”ç»“æœåˆ™ä½¿ç”¨<code>RPC</code>ï¼Œè¿™ç§æƒ…å†µå°±å¾—ä½¿ç”¨åŒæ­¥è°ƒç”¨ã€‚</p>
<a id="more"></a>
<p>åä¹‹å½“æˆ‘ä»¬å¹¶ä¸å…³å¿ƒè°ƒç”¨ä¹‹åçš„æ‰§è¡Œç»“æœï¼Œå¹¶ä¸”æœ‰å¯èƒ½è¢«è°ƒç”¨æ–¹çš„æ‰§è¡Œéå¸¸è€—æ—¶ï¼Œè¿™ç§æƒ…å†µå°±éå¸¸é€‚åˆç”¨<code>MQ</code>æ¥è¾¾åˆ°å¼‚æ­¥è°ƒç”¨ç›®çš„ã€‚</p>
<p>æ¯”å¦‚å¸¸è§çš„ç™»å½•åœºæ™¯å°±åªèƒ½ç”¨åŒæ­¥è°ƒç”¨çš„æ–¹å¼ï¼Œå› ä¸ºè¿™ä¸ªè¿‡ç¨‹éœ€è¦å®æ—¶çš„å“åº”ç»“æœï¼Œæ€»ä¸èƒ½åœ¨ç”¨æˆ·ç‚¹äº†ç™»å½•ä¹‹åæ’é™¤ç½‘ç»œåŸå› ä¹‹å¤–å†é¢å¤–çš„ç­‰å‡ ç§’å§ã€‚</p>
<p>ä½†ç±»ä¼¼äºç”¨æˆ·ç™»å½•éœ€è¦å¥–åŠ±ç§¯åˆ†çš„æƒ…å†µåˆ™ä½¿ç”¨<code>MQ</code>ä¼šæ›´å¥½ï¼Œå› ä¸ºç™»å½•å¹¶ä¸å…³ç³»ç§¯åˆ†çš„æƒ…å†µï¼Œåªéœ€è¦å‘ä¸ªæ¶ˆæ¯åˆ°<code>MQ</code>,å¤„ç†ç§¯åˆ†çš„æœåŠ¡è®¢é˜…å¤„ç†å³å¯ï¼Œè¿™æ ·è¿˜å¯ä»¥è§£å†³ç§¯åˆ†ç³»ç»Ÿæ•…éšœå¸¦æ¥çš„é›ªå´©æ•ˆåº”ã€‚</p>
<p><code>MQ</code>è¿˜æœ‰ä¸€ä¸ªåŸºç¡€åŠŸèƒ½åˆ™æ˜¯<strong>é™æµå‰Šå³°</strong>ï¼Œè¿™å¯¹äºå¤§æµé‡çš„åœºæ™¯å¦‚æœå°†è¯·æ±‚ç›´æ¥è°ƒç”¨åˆ°Bç³»ç»Ÿåˆ™éå¸¸æœ‰å¯èƒ½ä½¿Bç³»ç»Ÿå‡ºç°ä¸å¯ç”¨çš„æƒ…å†µã€‚è¿™ç§åœºæ™¯å°±éå¸¸é€‚åˆå°†è¯·æ±‚æ”¾å…¥<code>MQ</code>ï¼Œä¸ä½†å¯ä»¥åˆ©ç”¨<code>MQ</code>å‰Šå³°è¿˜å°½å¯èƒ½çš„ä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨ã€‚</p>
<h1 id="Kafkaç®€ä»‹"><a href="#Kafkaç®€ä»‹" class="headerlink" title="Kafkaç®€ä»‹"></a>Kafkaç®€ä»‹</h1><p>æœ¬æ¬¡é‡ç‚¹è®¨è®ºä¸‹<code>Kafka</code>ã€‚<br>ç®€å•æ¥è¯´<code>Kafka</code>æ˜¯ä¸€ä¸ªæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œé«˜ååç‡çš„åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿã€‚</p>
<p><code>Kafka</code>çš„å¸¸ç”¨çŸ¥è¯†:</p>
<ul>
<li><p><code>Topic</code>:ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„äº¤äº’éƒ½æ˜¯å›´ç»•ç€ä¸€ä¸ª<code>Topic</code>è¿›è¡Œçš„ï¼Œé€šå¸¸æ¥è¯´æ˜¯ç”±ä¸šåŠ¡æ¥è¿›è¡ŒåŒºåˆ†ï¼Œç”±ç”Ÿäº§æ¶ˆè´¹è€…åå•†ä¹‹åè¿›è¡Œåˆ›å»ºã€‚</p>
</li>
<li><p><code>Partition</code>(åˆ†åŒº):æ˜¯<code>Topic</code>ä¸‹çš„ç»„æˆï¼Œé€šå¸¸ä¸€ä¸ª<code>Topic</code>ä¸‹æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†åŒºï¼Œæ¶ˆæ¯ç”Ÿäº§ä¹‹åä¼šæŒ‰ç…§ä¸€å®šçš„ç®—æ³•è´Ÿè½½åˆ°æ¯ä¸ªåˆ†åŒºï¼Œæ‰€ä»¥åˆ†åŒºä¹Ÿæ˜¯<code>Kafka</code>æ€§èƒ½çš„å…³é”®ã€‚å½“å‘ç°æ€§èƒ½ä¸é«˜æ—¶ä¾¿å¯è€ƒè™‘æ–°å¢åˆ†åŒºã€‚</p>
</li>
</ul>
<p>ç»“æ„å›¾å¦‚ä¸‹:<br><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fl314m0pe7j30bi086dge.jpg" alt=""></p>
<h1 id="åˆ›å»ºTopic"><a href="#åˆ›å»ºTopic" class="headerlink" title="åˆ›å»ºTopic"></a>åˆ›å»º<code>Topic</code></h1><p><code>Kafka</code>çš„å®‰è£…å®˜ç½‘æœ‰éå¸¸è¯¦ç»†çš„è®²è§£ã€‚è¿™é‡Œè°ˆä¸€ä¸‹åœ¨æ—¥å¸¸å¼€å‘ä¸­å¸¸è§çš„ä¸€äº›æ“ä½œï¼Œæ¯”å¦‚åˆ›å»º<code>Topic</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sh bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 3 --topic `test`</div></pre></td></tr></table></figure>
<p>åˆ›å»ºäº†ä¸‰ä¸ªåˆ†åŒºçš„<code>test</code>ä¸»é¢˜ã€‚</p>
<p>ä½¿ç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sh bin/kafka-topics.sh --list --zookeeper localhost:2181</div></pre></td></tr></table></figure>
<p>å¯ä»¥åˆ—å‡ºæ‰€æœ‰çš„<code>Topic</code>ã€‚</p>
<h1 id="Kafkaç”Ÿäº§è€…"><a href="#Kafkaç”Ÿäº§è€…" class="headerlink" title="Kafkaç”Ÿäº§è€…"></a>Kafkaç”Ÿäº§è€…</h1><p>ä½¿ç”¨<code>kafka</code>å®˜æ–¹æ‰€æä¾›çš„<code>Java API</code>æ¥è¿›è¡Œæ¶ˆæ¯ç”Ÿäº§ï¼Œå®é™…ä½¿ç”¨ä¸­ç¼–ç å®ç°æ›´ä¸ºå¸¸ç”¨:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Kafkaç”Ÿäº§è€…</span></div><div class="line"> * <span class="doctag">@author</span> crossoverJie</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(Producer.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¶ˆè´¹é…ç½®æ–‡ä»¶</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String consumerProPath;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">// set up the producer</span></div><div class="line">        consumerProPath = System.getProperty(<span class="string">"product_path"</span>);</div><div class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(consumerProPath));</div><div class="line">            Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">            properties.load(inputStream);</div><div class="line">            producer = <span class="keyword">new</span> KafkaProducer&lt;String, String&gt;(properties);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"load config error"</span>, e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// send lots of messages</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span> ;i&lt;<span class="number">100</span> ; i++)&#123;</div><div class="line">                producer.send(<span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(</div><div class="line">                        <span class="string">"topic_optimization"</span>, i+<span class="string">""</span>, i+<span class="string">""</span>));</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</div><div class="line">            System.out.printf(<span class="string">"%s"</span>, throwable.getStackTrace());</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            producer.close();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å†é…åˆä»¥ä¸‹å¯åŠ¨å‚æ•°å³å¯å‘é€æ¶ˆæ¯:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-Dproduct_path=/xxx/producer.properties</div></pre></td></tr></table></figure></p>
<p>ä»¥åŠç”Ÿäº§è€…çš„é…ç½®æ–‡ä»¶:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#é›†ç¾¤åœ°å€ï¼Œå¯ä»¥å¤šä¸ª</div><div class="line">bootstrap.servers=10.19.13.51:9094</div><div class="line">acks=all</div><div class="line">retries=0</div><div class="line">batch.size=16384</div><div class="line">auto.commit.interval.ms=1000</div><div class="line">linger.ms=0</div><div class="line">key.serializer=org.apache.kafka.common.serialization.StringSerializer</div><div class="line">value.serializer=org.apache.kafka.common.serialization.StringSerializer</div><div class="line">block.on.buffer.full=true</div></pre></td></tr></table></figure></p>
<p>å…·ä½“çš„é…ç½®è¯´æ˜è¯¦è§æ­¤å¤„:<a href="https://kafka.apache.org/0100/documentation.html#theproducer" target="_blank" rel="external">https://kafka.apache.org/0100/documentation.html#theproducer</a></p>
<p>æµç¨‹éå¸¸ç®€å•ï¼Œå…¶å®å°±æ˜¯ä¸€äº›<code>API</code>çš„è°ƒç”¨ã€‚</p>
<p>æ¶ˆæ¯å‘å®Œä¹‹åå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹é˜Ÿåˆ—å†…çš„æƒ…å†µ:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sh kafka-consumer-groups.sh --bootstrap-server localhost:9094 --describe --group group1</div></pre></td></tr></table></figure></p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fl305wgpuej310z0e744u.jpg" alt=""><br>å…¶ä¸­çš„<code>lag</code>ä¾¿æ˜¯é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯æ•°é‡ã€‚</p>
<h1 id="Kafkaæ¶ˆè´¹è€…"><a href="#Kafkaæ¶ˆè´¹è€…" class="headerlink" title="Kafkaæ¶ˆè´¹è€…"></a>Kafkaæ¶ˆè´¹è€…</h1><p>æœ‰äº†ç”Ÿäº§è€…è‡ªç„¶ä¹Ÿå°‘ä¸äº†æ¶ˆè´¹è€…ï¼Œè¿™é‡Œé¦–å…ˆé’ˆå¯¹å•çº¿ç¨‹æ¶ˆè´¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Function:kafkaå®˜æ–¹æ¶ˆè´¹</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> crossoverJie</div><div class="line"> *         Date: 2017/10/19 01:11</div><div class="line"> * <span class="doctag">@since</span> JDK 1.8</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaOfficialConsumer</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(KafkaOfficialConsumer.class);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ—¥å¿—æ–‡ä»¶åœ°å€</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String logPath;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¸»é¢˜åç§°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String topic;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * æ¶ˆè´¹é…ç½®æ–‡ä»¶</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String consumerProPath ;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆå§‹åŒ–å‚æ•°æ ¡éªŒ</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">initCheck</span><span class="params">()</span> </span>&#123;</div><div class="line">        topic = System.getProperty(<span class="string">"topic"</span>) ;</div><div class="line">        logPath = System.getProperty(<span class="string">"log_path"</span>) ;</div><div class="line">        consumerProPath = System.getProperty(<span class="string">"consumer_pro_path"</span>) ;</div><div class="line">        <span class="keyword">if</span> (StringUtil.isEmpty(topic) || logPath.isEmpty()) &#123;</div><div class="line">            LOGGER.error(<span class="string">"system property topic ,consumer_pro_path, log_path is required !"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * åˆå§‹åŒ–kafkaé…ç½®</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> KafkaConsumer&lt;String, String&gt; <span class="title">initKafkaConsumer</span><span class="params">()</span> </span>&#123;</div><div class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(consumerProPath)) ;</div><div class="line">            Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">            properties.load(inputStream);</div><div class="line">            consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</div><div class="line">            consumer.subscribe(Arrays.asList(topic));</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"åŠ è½½consumer.propsæ–‡ä»¶å‡ºé”™"</span>, e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> consumer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (initCheck())&#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> totalCount = <span class="number">0</span> ;</div><div class="line">        <span class="keyword">long</span> totalMin = <span class="number">0L</span> ;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">        KafkaConsumer&lt;String, String&gt; consumer = initKafkaConsumer();</div><div class="line"></div><div class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis() ;</div><div class="line">        <span class="comment">//æ¶ˆè´¹æ¶ˆæ¯</span></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="number">200</span>);</div><div class="line">            <span class="keyword">if</span> (records.count() &lt;= <span class="number">0</span>)&#123;</div><div class="line">                <span class="keyword">continue</span> ;</div><div class="line">            &#125;</div><div class="line">            LOGGER.debug(<span class="string">"æœ¬æ¬¡è·å–:"</span>+records.count());</div><div class="line">            count += records.count() ;</div><div class="line"></div><div class="line">            <span class="keyword">long</span> endTime = System.currentTimeMillis() ;</div><div class="line">            LOGGER.debug(<span class="string">"count="</span> +count) ;</div><div class="line">            <span class="keyword">if</span> (count &gt;= <span class="number">10000</span> )&#123;</div><div class="line">                totalCount += count ;</div><div class="line">                LOGGER.info(<span class="string">"this consumer &#123;&#125; recordï¼Œuse &#123;&#125; milliseconds"</span>,count,endTime-startTime);</div><div class="line">                totalMin += (endTime-startTime) ;</div><div class="line">                startTime = System.currentTimeMillis() ;</div><div class="line">                count = <span class="number">0</span> ;</div><div class="line">            &#125;</div><div class="line">            LOGGER.debug(<span class="string">"end totalCount=&#123;&#125;,min=&#123;&#125;"</span>,totalCount,totalMin);</div><div class="line"></div><div class="line">            <span class="comment">/*for (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span></div><div class="line">                record.value() ;</div><div class="line">                JsonNode msg = null;</div><div class="line">                try &#123;</div><div class="line">                    msg = mapper.readTree(record.value());</div><div class="line">                &#125; catch (IOException e) &#123;</div><div class="line">                    LOGGER.error("æ¶ˆè´¹æ¶ˆæ¯å‡ºé”™", e);</div><div class="line">                &#125;</div><div class="line">                LOGGER.info("kafka receive = "+msg.toString());</div><div class="line">            &#125;*/</div><div class="line"></div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é…åˆä»¥ä¸‹å¯åŠ¨å‚æ•°:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-Dlog_path=/log/consumer.log -Dtopic=test -Dconsumer_pro_path=consumer.properties</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­é‡‡ç”¨äº†è½®è¯¢çš„æ–¹å¼è·å–æ¶ˆæ¯ï¼Œå¹¶ä¸”è®°å½•äº†æ¶ˆè´¹è¿‡ç¨‹ä¸­çš„æ•°æ®ã€‚</p>
<p>æ¶ˆè´¹è€…é‡‡ç”¨çš„é…ç½®:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">bootstrap.servers=192.168.1.2:9094</div><div class="line">group.id=group1</div><div class="line"></div><div class="line"># è‡ªåŠ¨æäº¤</div><div class="line">enable.auto.commit=true</div><div class="line">key.deserializer=org.apache.kafka.common.serialization.StringDeserializer</div><div class="line">value.deserializer=org.apache.kafka.common.serialization.StringDeserializer</div><div class="line"></div><div class="line"># fast session timeout makes it more fun to play with failover</div><div class="line">session.timeout.ms=10000</div><div class="line"></div><div class="line"># These buffer sizes seem to be needed to avoid consumer switching to</div><div class="line"># a mode where it processes one bufferful every 5 seconds with multiple</div><div class="line"># timeouts along the way.  No idea why this happens.</div><div class="line">fetch.min.bytes=50000</div><div class="line">receive.buffer.bytes=262144</div><div class="line">max.partition.fetch.bytes=2097152</div></pre></td></tr></table></figure></p>
<p>ä¸ºäº†ç®€ä¾¿æˆ‘é‡‡ç”¨çš„æ˜¯è‡ªåŠ¨æäº¤<code>offset</code>ã€‚</p>
<h2 id="æ¶ˆæ¯å­˜æ”¾æœºåˆ¶"><a href="#æ¶ˆæ¯å­˜æ”¾æœºåˆ¶" class="headerlink" title="æ¶ˆæ¯å­˜æ”¾æœºåˆ¶"></a>æ¶ˆæ¯å­˜æ”¾æœºåˆ¶</h2><p>è°ˆåˆ°<code>offset</code>å°±å¿…é¡»å¾—è°ˆè°ˆKafkaçš„æ¶ˆæ¯å­˜æ”¾æœºåˆ¶.</p>
<p><code>Kafka</code>çš„æ¶ˆæ¯ä¸ä¼šå› ä¸ºæ¶ˆè´¹äº†å°±ä¼šç«‹å³åˆ é™¤ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¼šæŒä¹…åŒ–åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶é…ç½®æœ‰è¿‡æœŸæ—¶é—´ï¼Œåˆ°äº†æ—¶é—´ä¼šè‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®ï¼Œ<em>å¹¶ä¸”ä¸ä¼šç®¡å…¶ä¸­çš„æ•°æ®æ˜¯å¦è¢«æ¶ˆè´¹è¿‡ã€‚</em></p>
<p>ç”±äºè¿™æ ·çš„æœºåˆ¶å°±å¿…é¡»çš„æœ‰ä¸€ä¸ªæ ‡å¿—æ¥è¡¨æ˜å“ªäº›æ•°æ®å·²ç»è¢«æ¶ˆè´¹è¿‡äº†ï¼Œ<code>offset(åç§»é‡)</code>å°±æ˜¯è¿™æ ·çš„ä½œç”¨ï¼Œå®ƒç±»ä¼¼äºæŒ‡é’ˆæŒ‡å‘æŸä¸ªæ•°æ®ï¼Œå½“æ¶ˆè´¹ä¹‹å<code>offset</code>å°±ä¼šçº¿æ€§çš„å‘å‰ç§»åŠ¨ï¼Œè¿™æ ·ä¸€æ¥çš„è¯æ¶ˆæ¯æ˜¯å¯ä»¥è¢«ä»»æ„æ¶ˆè´¹çš„ï¼Œåªè¦æˆ‘ä»¬ä¿®æ”¹<code>offset</code>çš„å€¼å³å¯ã€‚</p>
<p>æ¶ˆè´¹è¿‡ç¨‹ä¸­è¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ˜¯:</p>
<blockquote>
<p>åŒä¸€ä¸ªconsumer group(group.idç›¸ç­‰)ä¸‹åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ï¼Œè¿™ä¸ªåˆšå¼€å§‹ç¡®å®ä¼šè®©å¾ˆå¤šäººè¸©å‘ã€‚</p>
</blockquote>
<h1 id="å¤šçº¿ç¨‹æ¶ˆè´¹"><a href="#å¤šçº¿ç¨‹æ¶ˆè´¹" class="headerlink" title="å¤šçº¿ç¨‹æ¶ˆè´¹"></a>å¤šçº¿ç¨‹æ¶ˆè´¹</h1><p>é’ˆå¯¹äºå•çº¿ç¨‹æ¶ˆè´¹å®ç°èµ·æ¥è‡ªç„¶æ˜¯æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æ•ˆç‡ä¹Ÿæ˜¯è¦å¤§æ‰“æŠ˜æ‰£çš„ã€‚</p>
<p>ä¸ºæ­¤æˆ‘åšäº†ä¸€ä¸ªæµ‹è¯•ï¼Œä½¿ç”¨ä¹‹å‰çš„å•çº¿ç¨‹æ¶ˆè´¹120009æ¡æ•°æ®çš„ç»“æœå¦‚ä¸‹:</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fl31iq6v9mj30t608479f.jpg" alt=""><br>æ€»å…±èŠ±äº†12450æ¯«ç§’ã€‚</p>
<p>é‚£ä¹ˆæ¢æˆå¤šçº¿ç¨‹æ¶ˆè´¹æ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>partition</code>çš„åˆ†åŒºç‰¹æ€§æ¥æé«˜æ¶ˆè´¹èƒ½åŠ›ï¼Œå•çº¿ç¨‹çš„æ—¶å€™ç­‰äºæ˜¯ä¸€ä¸ªçº¿ç¨‹è¦æŠŠæ‰€æœ‰åˆ†åŒºé‡Œçš„æ•°æ®éƒ½æ¶ˆè´¹ä¸€éï¼Œå¦‚æœæ¢æˆå¤šçº¿ç¨‹å°±å¯ä»¥è®©ä¸€ä¸ªçº¿ç¨‹åªæ¶ˆè´¹ä¸€ä¸ªåˆ†åŒº,è¿™æ ·æ•ˆç‡è‡ªç„¶å°±æé«˜äº†ï¼Œæ‰€ä»¥çº¿ç¨‹æ•°<code>coreSize&lt;=partition</code>ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹ä¸‹å…¥å£:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public class ConsumerThreadMain &#123;</div><div class="line">    private static String brokerList = &quot;localhost:9094&quot;;</div><div class="line">    private static String groupId = &quot;group1&quot;;</div><div class="line">    private static String topic = &quot;test&quot;;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * çº¿ç¨‹æ•°é‡</div><div class="line">     */</div><div class="line">    private static int threadNum = 3;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line"></div><div class="line"></div><div class="line">        ConsumerGroup consumerGroup = new ConsumerGroup(threadNum, groupId, topic, brokerList);</div><div class="line">        consumerGroup.execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„<code>ConsumerGroup</code>ç±»:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">public class ConsumerGroup &#123;</div><div class="line">    private static Logger LOGGER = LoggerFactory.getLogger(ConsumerGroup.class);</div><div class="line">    /**</div><div class="line">     * çº¿ç¨‹æ± </div><div class="line">     */</div><div class="line">    private ExecutorService threadPool;</div><div class="line"></div><div class="line">    private List&lt;ConsumerCallable&gt; consumers ;</div><div class="line"></div><div class="line">    public ConsumerGroup(int threadNum, String groupId, String topic, String brokerList) &#123;</div><div class="line">        ThreadFactory namedThreadFactory = new ThreadFactoryBuilder()</div><div class="line">                .setNameFormat(&quot;consumer-pool-%d&quot;).build();</div><div class="line"></div><div class="line">        threadPool = new ThreadPoolExecutor(threadNum, threadNum,</div><div class="line">                0L, TimeUnit.MILLISECONDS,</div><div class="line">                new LinkedBlockingQueue&lt;Runnable&gt;(1024), namedThreadFactory, new ThreadPoolExecutor.AbortPolicy());</div><div class="line"></div><div class="line"></div><div class="line">        consumers = new ArrayList&lt;ConsumerCallable&gt;(threadNum);</div><div class="line">        for (int i = 0; i &lt; threadNum; i++) &#123;</div><div class="line">            ConsumerCallable consumerThread = new ConsumerCallable(brokerList, groupId, topic);</div><div class="line">            consumers.add(consumerThread);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * æ‰§è¡Œä»»åŠ¡</div><div class="line">     */</div><div class="line">    public void execute() &#123;</div><div class="line">        long startTime = System.currentTimeMillis() ;</div><div class="line">        for (ConsumerCallable runnable : consumers) &#123;</div><div class="line">            Future&lt;ConsumerFuture&gt; future = threadPool.submit(runnable) ;</div><div class="line">        &#125;</div><div class="line">        if (threadPool.isShutdown())&#123;</div><div class="line">            long endTime = System.currentTimeMillis() ;</div><div class="line">            LOGGER.info(&quot;main thread use &#123;&#125; Millis&quot; ,endTime -startTime) ;</div><div class="line">        &#125;</div><div class="line">        threadPool.shutdown();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æœ€åçœŸæ­£çš„æ‰§è¡Œé€»è¾‘<code>ConsumerCallable</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">public class ConsumerCallable implements Callable&lt;ConsumerFuture&gt; &#123;</div><div class="line">    private static Logger LOGGER = LoggerFactory.getLogger(ConsumerCallable.class);</div><div class="line"></div><div class="line">    private AtomicInteger totalCount = new AtomicInteger() ;</div><div class="line">    private AtomicLong totalTime = new AtomicLong() ;</div><div class="line"></div><div class="line">    private AtomicInteger count = new AtomicInteger() ;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤KafkaConsumerå®ä¾‹</div><div class="line">     */</div><div class="line">    private final KafkaConsumer&lt;String, String&gt; consumer;</div><div class="line"></div><div class="line">    public ConsumerCallable(String brokerList, String groupId, String topic) &#123;</div><div class="line">        Properties props = new Properties();</div><div class="line">        props.put(&quot;bootstrap.servers&quot;, brokerList);</div><div class="line">        props.put(&quot;group.id&quot;, groupId);</div><div class="line">        //è‡ªåŠ¨æäº¤ä½ç§»</div><div class="line">        props.put(&quot;enable.auto.commit&quot;, &quot;true&quot;);</div><div class="line">        props.put(&quot;auto.commit.interval.ms&quot;, &quot;1000&quot;);</div><div class="line">        props.put(&quot;session.timeout.ms&quot;, &quot;30000&quot;);</div><div class="line">        props.put(&quot;key.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);</div><div class="line">        props.put(&quot;value.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);</div><div class="line">        this.consumer = new KafkaConsumer&lt;&gt;(props);</div><div class="line">        consumer.subscribe(Arrays.asList(topic));</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    /**</div><div class="line">     * Computes a result, or throws an exception if unable to do so.</div><div class="line">     *</div><div class="line">     * @return computed result</div><div class="line">     * @throws Exception if unable to compute a result</div><div class="line">     */</div><div class="line">    @Override</div><div class="line">    public ConsumerFuture call() throws Exception &#123;</div><div class="line">        boolean flag = true;</div><div class="line">        int failPollTimes = 0 ;</div><div class="line">        long startTime = System.currentTimeMillis() ;</div><div class="line">        while (flag) &#123;</div><div class="line">            // ä½¿ç”¨200msä½œä¸ºè·å–è¶…æ—¶æ—¶é—´</div><div class="line">            ConsumerRecords&lt;String, String&gt; records = consumer.poll(200);</div><div class="line">            if (records.count() &lt;= 0)&#123;</div><div class="line">                failPollTimes ++ ;</div><div class="line"></div><div class="line">                if (failPollTimes &gt;= 20)&#123;</div><div class="line">                    LOGGER.debug(&quot;è¾¾åˆ°&#123;&#125;æ¬¡æ•°ï¼Œé€€å‡º &quot;,failPollTimes);</div><div class="line">                    flag = false ;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                continue ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            //è·å–åˆ°ä¹‹ååˆ™æ¸…é›¶</div><div class="line">            failPollTimes = 0 ;</div><div class="line"></div><div class="line">            LOGGER.debug(&quot;æœ¬æ¬¡è·å–:&quot;+records.count());</div><div class="line">            count.addAndGet(records.count()) ;</div><div class="line">            totalCount.addAndGet(count.get()) ;</div><div class="line">            long endTime = System.currentTimeMillis() ;</div><div class="line">            if (count.get() &gt;= 10000 )&#123;</div><div class="line">                LOGGER.info(&quot;this consumer &#123;&#125; recordï¼Œuse &#123;&#125; milliseconds&quot;,count,endTime-startTime);</div><div class="line">                totalTime.addAndGet(endTime-startTime) ;</div><div class="line">                startTime = System.currentTimeMillis() ;</div><div class="line">                count = new AtomicInteger();</div><div class="line">            &#125;</div><div class="line">            LOGGER.debug(&quot;end totalCount=&#123;&#125;,min=&#123;&#125;&quot;,totalCount,totalTime);</div><div class="line"></div><div class="line">            /*for (ConsumerRecord&lt;String, String&gt; record : records) &#123;</div><div class="line">                // ç®€å•åœ°æ‰“å°æ¶ˆæ¯</div><div class="line">                LOGGER.debug(record.value() + &quot; consumed &quot; + record.partition() +</div><div class="line">                        &quot; message with offset: &quot; + record.offset());</div><div class="line">            &#125;*/</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ConsumerFuture consumerFuture = new ConsumerFuture(totalCount.get(),totalTime.get()) ;</div><div class="line">        return consumerFuture ;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç†ä¸€ä¸‹é€»è¾‘:</p>
<blockquote>
<p>å…¶å®å°±æ˜¯åˆå§‹åŒ–å‡ºä¸‰ä¸ªæ¶ˆè´¹è€…å®ä¾‹ï¼Œç”¨äºä¸‰ä¸ªçº¿ç¨‹æ¶ˆè´¹ã€‚å…¶ä¸­åŠ å…¥äº†ä¸€äº›ç»Ÿè®¡ï¼Œæœ€åä¹Ÿæ˜¯æ¶ˆè´¹120009æ¡æ•°æ®ç»“æœå¦‚ä¸‹ã€‚</p>
</blockquote>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fl32335qxgj30sb04dq59.jpg" alt=""></p>
<p>ç”±äºæ˜¯å¹¶è¡Œè¿è¡Œï¼Œå¯è§æ¶ˆè´¹120009æ¡æ•°æ®å¯ä»¥æé«˜2ç§’å·¦å³ï¼Œå½“æ•°æ®ä»¥æ›´é«˜çš„æ•°é‡çº§æå‡åæ•ˆæœä¼šæ›´åŠ æ˜æ˜¾ã€‚</p>
<p>ä½†è¿™ä¹Ÿæœ‰ä¸€äº›å¼Šç«¯:</p>
<ul>
<li>çµæ´»åº¦ä¸é«˜ï¼Œå½“åˆ†åŒºæ•°é‡å˜æ›´ä¹‹åä¸èƒ½è‡ªé€‚åº”è°ƒæ•´ã€‚</li>
<li>æ¶ˆè´¹é€»è¾‘å’Œå¤„ç†é€»è¾‘åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœå¤„ç†é€»è¾‘è¾ƒä¸ºå¤æ‚ä¼šå½±å“æ•ˆç‡ï¼Œè€¦åˆä¹Ÿè¾ƒé«˜ã€‚å½“ç„¶è¿™ä¸ªå¤„ç†é€»è¾‘å¯ä»¥å†é€šè¿‡ä¸€ä¸ªå†…éƒ¨é˜Ÿåˆ—å‘å‡ºå»ç”±å¦å¤–çš„ç¨‹åºæ¥å¤„ç†ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</li>
</ul>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p><code>Kafka</code>çš„çŸ¥è¯†ç‚¹è¿˜æ˜¯è¾ƒå¤šï¼Œ<code>Kafka</code>çš„ä½¿ç”¨ä¹Ÿè¿œä¸è¿™äº›ã€‚ä¹‹åä¼šç»§ç»­åˆ†äº«ä¸€äº›å…³äº<code>Kafka</code>ç›‘æ§ç­‰ç›¸å…³å†…å®¹ã€‚</p>
<blockquote>
<p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/crossoverJie/SSM.git" target="_blank" rel="external">https://github.com/crossoverJie/SSM.git</a></p>
<p>ä¸ªäººåšå®¢ï¼š<a href="http://crossoverjie.top">http://crossoverjie.top</a>ã€‚</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ws3.sinaimg.cn/large/006tKfTcly1fkpzk7hcz4j31kw11xhbz.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å†™è¿™ç¯‡æ–‡ç« çš„èµ·å› æ˜¯ç”±äºä¹‹å‰çš„ä¸€ç¯‡å…³äº&lt;code&gt;Kafka&lt;/code&gt;&lt;a href=&quot;http://crossoverjie.top/2017/09/05/SSM16/&quot;&gt;å¼‚å¸¸æ¶ˆè´¹&lt;/a&gt;ï¼Œå½“æ—¶ä¸ºäº†è§£å†³é—®é¢˜ä¸å¾—ä¸ä½¿ç”¨ä¸´æ—¶çš„æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;p&gt;æ€»ç»“èµ·æ¥å½’æ ¹ç»“åº•è¿˜æ˜¯å¯¹Kafkaä¸ç†Ÿæ‚‰å¯¼è‡´çš„ï¼ŒåŠ ä¸Šå¹³æ—¶å·¥ä½œçš„éœ€è¦ï¼Œä¹‹åå°±èŠ±äº›æ—¶é—´çœ‹äº†&lt;code&gt;Kafka&lt;/code&gt;ç›¸å…³çš„èµ„æ–™ã€‚&lt;/p&gt;
&lt;h1 id=&quot;ä½•æ—¶ä½¿ç”¨MQ&quot;&gt;&lt;a href=&quot;#ä½•æ—¶ä½¿ç”¨MQ&quot; class=&quot;headerlink&quot; title=&quot;ä½•æ—¶ä½¿ç”¨MQ&quot;&gt;&lt;/a&gt;ä½•æ—¶ä½¿ç”¨MQ&lt;/h1&gt;&lt;p&gt;è°ˆåˆ°&lt;code&gt;Kafka&lt;/code&gt;å°±ä¸å¾—ä¸æåˆ°MQï¼Œæ˜¯å±äºæ¶ˆæ¯é˜Ÿåˆ—çš„ä¸€ç§ã€‚ä½œä¸ºä¸€ç§åŸºç¡€ä¸­é—´ä»¶åœ¨äº’è”ç½‘é¡¹ç›®ä¸­æœ‰ç€å¤§é‡çš„ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€ç§æŠ€æœ¯çš„äº§ç”Ÿè‡ªç„¶æ˜¯ä¸ºäº†è§£å†³æŸç§éœ€æ±‚ï¼Œé€šå¸¸æ¥è¯´æ˜¯ä»¥ä¸‹åœºæ™¯ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;éœ€è¦è·¨è¿›ç¨‹é€šä¿¡ï¼šBç³»ç»Ÿéœ€è¦Aç³»ç»Ÿçš„è¾“å‡ºä½œä¸ºè¾“å…¥å‚æ•°ã€‚&lt;/li&gt;
&lt;li&gt;å½“Aç³»ç»Ÿçš„è¾“å‡ºèƒ½åŠ›è¿œè¿œå¤§äºBç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;é’ˆå¯¹äºç¬¬ä¸€ç§æƒ…å†µæœ‰ä¸¤ç§æ–¹æ¡ˆ:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;RPC&lt;/code&gt;è¿œç¨‹è°ƒç”¨,Aç›´æ¥è°ƒç”¨Bã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;MQ&lt;/code&gt;,Aå‘å¸ƒæ¶ˆæ¯åˆ°&lt;code&gt;MQ&lt;/code&gt;,Bè®¢é˜…è¯¥æ¶ˆæ¯ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å½“æˆ‘ä»¬çš„éœ€æ±‚æ˜¯:Aè°ƒç”¨Bå®æ—¶å“åº”ï¼Œå¹¶ä¸”å®æ—¶å…³å¿ƒå“åº”ç»“æœåˆ™ä½¿ç”¨&lt;code&gt;RPC&lt;/code&gt;ï¼Œè¿™ç§æƒ…å†µå°±å¾—ä½¿ç”¨åŒæ­¥è°ƒç”¨ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="SSM" scheme="http://crossoverjie.top/categories/SSM/"/>
    
    
      <category term="Java" scheme="http://crossoverjie.top/tags/Java/"/>
    
      <category term="Kafka" scheme="http://crossoverjie.top/tags/Kafka/"/>
    
  </entry>
  
</feed>
